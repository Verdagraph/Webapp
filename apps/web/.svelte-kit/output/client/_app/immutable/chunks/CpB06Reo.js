var cp=Object.defineProperty;var lp=(t,e,r)=>e in t?cp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var b=(t,e,r)=>lp(t,typeof e!="symbol"?e+"":e,r);import{g as up,b as Qo,d as dp}from"./BwwL9Z8J.js";import{c as Qt}from"./CxR0UCY4.js";import{n as Zo}from"./OxPLOBIU.js";import"./Boh5s-Fb.js";import"./CR0Tndyg.js";import{w as fp,g as Go}from"./CspeSXRu.js";const hp=!0,pp=hp;class Hr extends Error{constructor(r,n){var e=(...UP)=>(super(...UP),b(this,"defaultMessage","A failure has occurred."),b(this,"details",{}),this);r?e(r):(e(""),this.message=this.defaultMessage),n&&(n.fieldErrors&&(this.details.fieldErrors=n.fieldErrors),n.nonFieldErrors&&(this.details.nonFieldErrors=n.nonFieldErrors),n.nonFormErrors&&(this.details.nonFormErrors=n.nonFormErrors))}}var Tr=function(t){return t&&t.Math===Math&&t},ne=Tr(typeof globalThis=="object"&&globalThis)||Tr(typeof window=="object"&&window)||Tr(typeof self=="object"&&self)||Tr(typeof Qt=="object"&&Qt)||Tr(typeof Qt=="object"&&Qt)||function(){return this}()||Function("return this")(),hn={},Ee=function(t){try{return!!t()}catch{return!0}},yp=Ee,Be=!yp(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),mp=Ee,ws=!mp(function(){var t=(function(){}).bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),gp=ws,Cn=Function.prototype.call,V=gp?Cn.bind(Cn):function(){return Cn.apply(Cn,arguments)},yu={},mu={}.propertyIsEnumerable,gu=Object.getOwnPropertyDescriptor,vp=gu&&!mu.call({1:2},1);yu.f=vp?function(e){var r=gu(this,e);return!!r&&r.enumerable}:mu;var Ua=function(t,e){return{enumerable:!(t&1),configurable:!(t&2),writable:!(t&4),value:e}},vu=ws,bu=Function.prototype,Gi=bu.call,bp=vu&&bu.bind.bind(Gi,Gi),Ce=vu?bp:function(t){return function(){return Gi.apply(t,arguments)}},wu=Ce,wp=wu({}.toString),Sp=wu("".slice),za=function(t){return Sp(wp(t),8,-1)},Ip=Ce,Ep=Ee,$p=za,Gs=Object,_p=Ip("".split),Tp=Ep(function(){return!Gs("z").propertyIsEnumerable(0)})?function(t){return $p(t)==="String"?_p(t,""):Gs(t)}:Gs,Va=function(t){return t==null},Op=Va,Cp=TypeError,Ha=function(t){if(Op(t))throw new Cp("Can't call method on "+t);return t},Rp=Tp,xp=Ha,Ss=function(t){return Rp(xp(t))},qs=typeof document=="object"&&document.all,ie=typeof qs>"u"&&qs!==void 0?function(t){return typeof t=="function"||t===qs}:function(t){return typeof t=="function"},kp=ie,$e=function(t){return typeof t=="object"?t!==null:kp(t)},Js=ne,Ap=ie,Pp=function(t){return Ap(t)?t:void 0},Ue=function(t,e){return arguments.length<2?Pp(Js[t]):Js[t]&&Js[t][e]},Np=Ce,yr=Np({}.isPrototypeOf),Dp=ne,qo=Dp.navigator,Jo=qo&&qo.userAgent,jp=Jo?String(Jo):"",Su=ne,Ys=jp,Yo=Su.process,Xo=Su.Deno,ec=Yo&&Yo.versions||Xo&&Xo.version,tc=ec&&ec.v8,Ne,Xn;tc&&(Ne=tc.split("."),Xn=Ne[0]>0&&Ne[0]<4?1:+(Ne[0]+Ne[1]));!Xn&&Ys&&(Ne=Ys.match(/Edge\/(\d+)/),(!Ne||Ne[1]>=74)&&(Ne=Ys.match(/Chrome\/(\d+)/),Ne&&(Xn=+Ne[1])));var Fp=Xn,rc=Fp,Mp=Ee,Lp=ne,Bp=Lp.String,Iu=!!Object.getOwnPropertySymbols&&!Mp(function(){var t=Symbol("symbol detection");return!Bp(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&rc&&rc<41}),Up=Iu,Eu=Up&&!Symbol.sham&&typeof Symbol.iterator=="symbol",zp=Ue,Vp=ie,Hp=yr,Wp=Eu,Kp=Object,$u=Wp?function(t){return typeof t=="symbol"}:function(t){var e=zp("Symbol");return Vp(e)&&Hp(e.prototype,Kp(t))},Qp=String,pn=function(t){try{return Qp(t)}catch{return"Object"}},Zp=ie,Gp=pn,qp=TypeError,ae=function(t){if(Zp(t))return t;throw new qp(Gp(t)+" is not a function")},Jp=ae,Yp=Va,it=function(t,e){var r=t[e];return Yp(r)?void 0:Jp(r)},Xs=V,ei=ie,ti=$e,Xp=TypeError,ey=function(t,e){var r,n;if(e==="string"&&ei(r=t.toString)&&!ti(n=Xs(r,t))||ei(r=t.valueOf)&&!ti(n=Xs(r,t))||e!=="string"&&ei(r=t.toString)&&!ti(n=Xs(r,t)))return n;throw new Xp("Can't convert object to primitive value")},_u={exports:{}},Tu=!1,nc=ne,ty=Object.defineProperty,Wa=function(t,e){try{ty(nc,t,{value:e,configurable:!0,writable:!0})}catch{nc[t]=e}return e},ry=ne,ny=Wa,sc="__core-js_shared__",ic=_u.exports=ry[sc]||ny(sc,{});(ic.versions||(ic.versions=[])).push({version:"3.42.0",mode:"global",copyright:"Â© 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.42.0/LICENSE",source:"https://github.com/zloirock/core-js"});var Is=_u.exports,ac=Is,Ou=function(t,e){return ac[t]||(ac[t]=e||{})},sy=Ha,iy=Object,yn=function(t){return iy(sy(t))},ay=Ce,oy=yn,cy=ay({}.hasOwnProperty),Pe=Object.hasOwn||function(e,r){return cy(oy(e),r)},ly=Ce,uy=0,dy=Math.random(),fy=ly(1 .toString),Ka=function(t){return"Symbol("+(t===void 0?"":t)+")_"+fy(++uy+dy,36)},hy=ne,py=Ou,oc=Pe,yy=Ka,my=Iu,gy=Eu,Zt=hy.Symbol,ri=py("wks"),vy=gy?Zt.for||Zt:Zt&&Zt.withoutSetter||yy,he=function(t){return oc(ri,t)||(ri[t]=my&&oc(Zt,t)?Zt[t]:vy("Symbol."+t)),ri[t]},by=V,cc=$e,lc=$u,wy=it,Sy=ey,Iy=he,Ey=TypeError,$y=Iy("toPrimitive"),_y=function(t,e){if(!cc(t)||lc(t))return t;var r=wy(t,$y),n;if(r){if(e===void 0&&(e="default"),n=by(r,t,e),!cc(n)||lc(n))return n;throw new Ey("Can't convert object to primitive value")}return e===void 0&&(e="number"),Sy(t,e)},Ty=_y,Oy=$u,Cu=function(t){var e=Ty(t,"string");return Oy(e)?e:e+""},Cy=ne,uc=$e,qi=Cy.document,Ry=uc(qi)&&uc(qi.createElement),Ru=function(t){return Ry?qi.createElement(t):{}},xy=Be,ky=Ee,Ay=Ru,xu=!xy&&!ky(function(){return Object.defineProperty(Ay("div"),"a",{get:function(){return 7}}).a!==7}),Py=Be,Ny=V,Dy=yu,jy=Ua,Fy=Ss,My=Cu,Ly=Pe,By=xu,dc=Object.getOwnPropertyDescriptor;hn.f=Py?dc:function(e,r){if(e=Fy(e),r=My(r),By)try{return dc(e,r)}catch{}if(Ly(e,r))return jy(!Ny(Dy.f,e,r),e[r])};var at={},Uy=Be,zy=Ee,ku=Uy&&zy(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),Vy=$e,Hy=String,Wy=TypeError,H=function(t){if(Vy(t))return t;throw new Wy(Hy(t)+" is not an object")},Ky=Be,Qy=xu,Zy=ku,Rn=H,fc=Cu,Gy=TypeError,ni=Object.defineProperty,qy=Object.getOwnPropertyDescriptor,si="enumerable",ii="configurable",ai="writable";at.f=Ky?Zy?function(e,r,n){if(Rn(e),r=fc(r),Rn(n),typeof e=="function"&&r==="prototype"&&"value"in n&&ai in n&&!n[ai]){var s=qy(e,r);s&&s[ai]&&(e[r]=n.value,n={configurable:ii in n?n[ii]:s[ii],enumerable:si in n?n[si]:s[si],writable:!1})}return ni(e,r,n)}:ni:function(e,r,n){if(Rn(e),r=fc(r),Rn(n),Qy)try{return ni(e,r,n)}catch{}if("get"in n||"set"in n)throw new Gy("Accessors not supported");return"value"in n&&(e[r]=n.value),e};var Jy=Be,Yy=at,Xy=Ua,mr=Jy?function(t,e,r){return Yy.f(t,e,Xy(1,r))}:function(t,e,r){return t[e]=r,t},Au={exports:{}},Ji=Be,em=Pe,Pu=Function.prototype,tm=Ji&&Object.getOwnPropertyDescriptor,rm=em(Pu,"name"),nm=rm&&(!Ji||Ji&&tm(Pu,"name").configurable),sm={CONFIGURABLE:nm},im=Ce,am=ie,Yi=Is,om=im(Function.toString);am(Yi.inspectSource)||(Yi.inspectSource=function(t){return om(t)});var Nu=Yi.inspectSource,cm=ne,lm=ie,hc=cm.WeakMap,um=lm(hc)&&/native code/.test(String(hc)),dm=Ou,fm=Ka,pc=dm("keys"),Qa=function(t){return pc[t]||(pc[t]=fm(t))},Za={},hm=um,Du=ne,pm=$e,ym=mr,oi=Pe,ci=Is,mm=Qa,gm=Za,yc="Object already initialized",Xi=Du.TypeError,vm=Du.WeakMap,es,Wr,ts,bm=function(t){return ts(t)?Wr(t):es(t,{})},wm=function(t){return function(e){var r;if(!pm(e)||(r=Wr(e)).type!==t)throw new Xi("Incompatible receiver, "+t+" required");return r}};if(hm||ci.state){var He=ci.state||(ci.state=new vm);He.get=He.get,He.has=He.has,He.set=He.set,es=function(t,e){if(He.has(t))throw new Xi(yc);return e.facade=t,He.set(t,e),e},Wr=function(t){return He.get(t)||{}},ts=function(t){return He.has(t)}}else{var Vt=mm("state");gm[Vt]=!0,es=function(t,e){if(oi(t,Vt))throw new Xi(yc);return e.facade=t,ym(t,Vt,e),e},Wr=function(t){return oi(t,Vt)?t[Vt]:{}},ts=function(t){return oi(t,Vt)}}var mn={set:es,get:Wr,has:ts,enforce:bm,getterFor:wm},Ga=Ce,Sm=Ee,Im=ie,xn=Pe,ea=Be,Em=sm.CONFIGURABLE,$m=Nu,ju=mn,_m=ju.enforce,Tm=ju.get,mc=String,Un=Object.defineProperty,Om=Ga("".slice),Cm=Ga("".replace),Rm=Ga([].join),xm=ea&&!Sm(function(){return Un(function(){},"length",{value:8}).length!==8}),km=String(String).split("String"),Am=Au.exports=function(t,e,r){Om(mc(e),0,7)==="Symbol("&&(e="["+Cm(mc(e),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),r&&r.getter&&(e="get "+e),r&&r.setter&&(e="set "+e),(!xn(t,"name")||Em&&t.name!==e)&&(ea?Un(t,"name",{value:e,configurable:!0}):t.name=e),xm&&r&&xn(r,"arity")&&t.length!==r.arity&&Un(t,"length",{value:r.arity});try{r&&xn(r,"constructor")&&r.constructor?ea&&Un(t,"prototype",{writable:!1}):t.prototype&&(t.prototype=void 0)}catch{}var n=_m(t);return xn(n,"source")||(n.source=Rm(km,typeof e=="string"?e:"")),t};Function.prototype.toString=Am(function(){return Im(this)&&Tm(this).source||$m(this)},"toString");var Fu=Au.exports,Pm=ie,Nm=at,Dm=Fu,jm=Wa,gn=function(t,e,r,n){n||(n={});var s=n.enumerable,i=n.name!==void 0?n.name:e;if(Pm(r)&&Dm(r,i,n),n.global)s?t[e]=r:jm(e,r);else{try{n.unsafe?t[e]&&(s=!0):delete t[e]}catch{}s?t[e]=r:Nm.f(t,e,{value:r,enumerable:!1,configurable:!n.nonConfigurable,writable:!n.nonWritable})}return t},Mu={},Fm=Math.ceil,Mm=Math.floor,Lm=Math.trunc||function(e){var r=+e;return(r>0?Mm:Fm)(r)},Bm=Lm,qa=function(t){var e=+t;return e!==e||e===0?0:Bm(e)},Um=qa,zm=Math.max,Vm=Math.min,Hm=function(t,e){var r=Um(t);return r<0?zm(r+e,0):Vm(r,e)},Wm=qa,Km=Math.min,Qm=function(t){var e=Wm(t);return e>0?Km(e,9007199254740991):0},Zm=Qm,Ja=function(t){return Zm(t.length)},Gm=Ss,qm=Hm,Jm=Ja,Ym=function(t){return function(e,r,n){var s=Gm(e),i=Jm(s);if(i===0)return!t&&-1;var a=qm(n,i),o;if(t&&r!==r){for(;i>a;)if(o=s[a++],o!==o)return!0}else for(;i>a;a++)if((t||a in s)&&s[a]===r)return t||a||0;return!t&&-1}},Xm={indexOf:Ym(!1)},eg=Ce,li=Pe,tg=Ss,rg=Xm.indexOf,ng=Za,gc=eg([].push),Lu=function(t,e){var r=tg(t),n=0,s=[],i;for(i in r)!li(ng,i)&&li(r,i)&&gc(s,i);for(;e.length>n;)li(r,i=e[n++])&&(~rg(s,i)||gc(s,i));return s},Ya=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],sg=Lu,ig=Ya,ag=ig.concat("length","prototype");Mu.f=Object.getOwnPropertyNames||function(e){return sg(e,ag)};var Bu={};Bu.f=Object.getOwnPropertySymbols;var og=Ue,cg=Ce,lg=Mu,ug=Bu,dg=H,fg=cg([].concat),hg=og("Reflect","ownKeys")||function(e){var r=lg.f(dg(e)),n=ug.f;return n?fg(r,n(e)):r},vc=Pe,pg=hg,yg=hn,mg=at,gg=function(t,e,r){for(var n=pg(e),s=mg.f,i=yg.f,a=0;a<n.length;a++){var o=n[a];!vc(t,o)&&!(r&&vc(r,o))&&s(t,o,i(e,o))}},vg=Ee,bg=ie,wg=/#|\.prototype\./,vn=function(t,e){var r=Ig[Sg(t)];return r===$g?!0:r===Eg?!1:bg(e)?vg(e):!!e},Sg=vn.normalize=function(t){return String(t).replace(wg,".").toLowerCase()},Ig=vn.data={},Eg=vn.NATIVE="N",$g=vn.POLYFILL="P",_g=vn,kn=ne,Tg=hn.f,Og=mr,Cg=gn,Rg=Wa,xg=gg,kg=_g,W=function(t,e){var r=t.target,n=t.global,s=t.stat,i,a,o,c,l,u;if(n?a=kn:s?a=kn[r]||Rg(r,{}):a=kn[r]&&kn[r].prototype,a)for(o in e){if(l=e[o],t.dontCallGetSet?(u=Tg(a,o),c=u&&u.value):c=a[o],i=kg(n?o:r+(s?".":"#")+o,t.forced),!i&&c!==void 0){if(typeof l==typeof c)continue;xg(l,c)}(t.sham||c&&c.sham)&&Og(l,"sham",!0),Cg(a,o,l,t)}},Ag=yr,Pg=TypeError,Uu=function(t,e){if(Ag(e,t))return t;throw new Pg("Incorrect invocation")},Ng=Ee,Dg=!Ng(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),jg=Pe,Fg=ie,Mg=yn,Lg=Qa,Bg=Dg,bc=Lg("IE_PROTO"),ta=Object,Ug=ta.prototype,bn=Bg?ta.getPrototypeOf:function(t){var e=Mg(t);if(jg(e,bc))return e[bc];var r=e.constructor;return Fg(r)&&e instanceof r?r.prototype:e instanceof ta?Ug:null},zu={},zg=Lu,Vg=Ya,Hg=Object.keys||function(e){return zg(e,Vg)},Wg=Be,Kg=ku,Qg=at,Zg=H,Gg=Ss,qg=Hg;zu.f=Wg&&!Kg?Object.defineProperties:function(e,r){Zg(e);for(var n=Gg(r),s=qg(r),i=s.length,a=0,o;i>a;)Qg.f(e,o=s[a++],n[o]);return e};var Jg=Ue,Yg=Jg("document","documentElement"),Xg=H,ev=zu,wc=Ya,tv=Za,rv=Yg,nv=Ru,sv=Qa,Sc=">",Ic="<",ra="prototype",na="script",Vu=sv("IE_PROTO"),ui=function(){},Hu=function(t){return Ic+na+Sc+t+Ic+"/"+na+Sc},Ec=function(t){t.write(Hu("")),t.close();var e=t.parentWindow.Object;return t=null,e},iv=function(){var t=nv("iframe"),e="java"+na+":",r;return t.style.display="none",rv.appendChild(t),t.src=String(e),r=t.contentWindow.document,r.open(),r.write(Hu("document.F=Object")),r.close(),r.F},An,zn=function(){try{An=new ActiveXObject("htmlfile")}catch{}zn=typeof document<"u"?document.domain&&An?Ec(An):iv():Ec(An);for(var t=wc.length;t--;)delete zn[ra][wc[t]];return zn()};tv[Vu]=!0;var Xa=Object.create||function(e,r){var n;return e!==null?(ui[ra]=Xg(e),n=new ui,ui[ra]=null,n[Vu]=e):n=zn(),r===void 0?n:ev.f(n,r)},Wu=ne,Ku=Is,Qu=ie,Pn=bn,av=gn,ov=he,$c="USE_FUNCTION_CONSTRUCTOR",_c=ov("asyncIterator"),Tc=Wu.AsyncIterator,Oc=Ku.AsyncIteratorPrototype,vt,di;if(Oc)vt=Oc;else if(Qu(Tc))vt=Tc.prototype;else if(Ku[$c]||Wu[$c])try{di=Pn(Pn(Pn(Function("return async function*(){}()")()))),Pn(di)===Object.prototype&&(vt=di)}catch{}vt||(vt={});Qu(vt[_c])||av(vt,_c,function(){return this});var Es=vt,cv=W,lv=Uu,uv=bn,Zu=mr,Gu=Pe,dv=he,bt=Es,fv=Tu,Cc=dv("toStringTag"),hv=TypeError,eo=function(){if(lv(this,bt),uv(this)===bt)throw new hv("Abstract class AsyncIterator not directly constructable")};eo.prototype=bt;Gu(bt,Cc)||Zu(bt,Cc,"AsyncIterator");(!Gu(bt,"constructor")||bt.constructor===Object)&&Zu(bt,"constructor",eo);cv({global:!0,constructor:!0,forced:fv},{AsyncIterator:eo});var J=function(t){return{iterator:t,next:t.next,done:!1}},pv=RangeError,$s=function(t){if(t===t)return t;throw new pv("NaN is not allowed")},yv=qa,mv=RangeError,_s=function(t){var e=yv(t);if(e<0)throw new mv("The argument can't be less than 0");return e},gv=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},vv=gn,to=function(t,e,r){for(var n in e)vv(t,n,e[n],r);return t},Ot=function(t,e){return{value:t,done:e}},bv=V,Rc=H,wv=it,ye=function(t,e,r){var n,s;Rc(t);try{if(n=wv(t,"return"),!n){if(e==="throw")throw r;return r}n=bv(n,t)}catch(i){s=!0,n=i}if(e==="throw")throw r;if(s)throw n;return Rc(n),r},Sv=V,Nn=gv,xc=H,Iv=Xa,Ev=mr,$v=to,_v=he,qu=mn,Tv=Ue,Ov=it,Cv=Es,fi=Ot,kc=ye,We=Tv("Promise"),Rv=_v("toStringTag"),Ju="AsyncIteratorHelper",Yu="WrapForValidAsyncIterator",xv=qu.set,Xu=function(t){var e=!t,r=qu.getterFor(t?Yu:Ju),n=function(s){var i=Nn(function(){return r(s)}),a=i.error,o=i.value;return a||e&&o.done?{exit:!0,value:a?We.reject(o):We.resolve(fi(void 0,!0))}:{exit:!1,value:o}};return $v(Iv(Cv),{next:function(){var i=n(this),a=i.value;if(i.exit)return a;var o=Nn(function(){return xc(a.nextHandler(We))}),c=o.error,l=o.value;return c&&(a.done=!0),c?We.reject(l):We.resolve(l)},return:function(){var s=n(this),i=s.value;if(s.exit)return i;i.done=!0;var a=i.iterator,o,c,l=Nn(function(){if(i.inner)try{kc(i.inner.iterator,"normal")}catch(u){return kc(a,"throw",u)}return Ov(a,"return")});return o=c=l.value,l.error?We.reject(c):o===void 0?We.resolve(fi(void 0,!0)):(l=Nn(function(){return Sv(o,a)}),c=l.value,l.error?We.reject(c):t?We.resolve(c):We.resolve(c).then(function(u){return xc(u),fi(void 0,!0)}))}})},kv=Xu(!0),ed=Xu(!1);Ev(ed,Rv,"Async Iterator Helper");var gr=function(t,e){var r=function(s,i){i?(i.iterator=s.iterator,i.next=s.next):i=s,i.type=e?Yu:Ju,i.nextHandler=t,i.counter=0,i.done=!1,xv(this,i)};return r.prototype=e?kv:ed,r},Av=W,Pv=V,sa=H,Nv=J,Dv=$s,jv=_s,Fv=gr,Ac=Ot,Mv=Fv(function(t){var e=this;return new t(function(r,n){var s=function(a){e.done=!0,n(a)},i=function(){try{t.resolve(sa(Pv(e.next,e.iterator))).then(function(a){try{sa(a).done?(e.done=!0,r(Ac(void 0,!0))):e.remaining?(e.remaining--,i()):r(Ac(a.value,!1))}catch(o){s(o)}},s)}catch(a){s(a)}};i()})});Av({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{drop:function(e){sa(this);var r=jv(Dv(+e));return new Mv(Nv(this),{remaining:r})}});var Lv=TypeError,Bv=9007199254740991,Uv=function(t){if(t>Bv)throw Lv("Maximum allowed index exceeded");return t},zv=V,Vv=Ue,Hv=it,wn=function(t,e,r,n){try{var s=Hv(t,"return");if(s)return Vv("Promise").resolve(zv(s,t)).then(function(){e(r)},function(i){n(i)})}catch(i){return n(i)}e(r)},Wv=V,Kv=ae,hi=H,Qv=$e,Zv=Uv,Gv=Ue,qv=J,pi=wn,Or=function(t){var e=t===0,r=t===1,n=t===2,s=t===3;return function(i,a,o){hi(i);var c=a!==void 0;(c||!e)&&Kv(a);var l=qv(i),u=Gv("Promise"),d=l.iterator,y=l.next,h=0;return new u(function(f,m){var v=function(S){pi(d,m,S,m)},g=function(){try{if(c)try{Zv(h)}catch(S){v(S)}u.resolve(hi(Wv(y,d))).then(function(S){try{if(hi(S).done)e?(o.length=h,f(o)):f(s?!1:n||void 0);else{var C=S.value;try{if(c){var N=a(C,h),U=function(P){if(r)g();else if(n)P?g():pi(d,f,!1,m);else if(e)try{o[h++]=P,g()}catch(K){v(K)}else P?pi(d,f,s||C,m):g()};Qv(N)?u.resolve(N).then(U,v):U(N)}else o[h++]=C,g()}catch(P){v(P)}}}catch(P){m(P)}},m)}catch(S){m(S)}};g()})}},vr={toArray:Or(0),forEach:Or(1),every:Or(2),some:Or(3),find:Or(4)},Jv=W,Yv=vr.every;Jv({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{every:function(e){return Yv(this,e)}});var Xv=W,eb=V,tb=ae,ia=H,rb=$e,nb=J,sb=gr,Pc=Ot,ib=wn,ab=sb(function(t){var e=this,r=e.iterator,n=e.predicate;return new t(function(s,i){var a=function(l){e.done=!0,i(l)},o=function(l){ib(r,a,l,a)},c=function(){try{t.resolve(ia(eb(e.next,r))).then(function(l){try{if(ia(l).done)e.done=!0,s(Pc(void 0,!0));else{var u=l.value;try{var d=n(u,e.counter++),y=function(h){h?s(Pc(u,!1)):c()};rb(d)?t.resolve(d).then(y,o):y(d)}catch(h){o(h)}}}catch(h){a(h)}},a)}catch(l){a(l)}};c()})});Xv({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{filter:function(e){return ia(this),tb(e),new ab(nb(this),{predicate:e})}});var ob=W,cb=vr.find;ob({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{find:function(e){return cb(this,e)}});var lb=he,ub=lb("toStringTag"),td={};td[ub]="z";var db=String(td)==="[object z]",fb=db,hb=ie,Vn=za,pb=he,yb=pb("toStringTag"),mb=Object,gb=Vn(function(){return arguments}())==="Arguments",vb=function(t,e){try{return t[e]}catch{}},ro=fb?Vn:function(t){var e,r,n;return t===void 0?"Undefined":t===null?"Null":typeof(r=vb(e=mb(t),yb))=="string"?r:gb?Vn(e):(n=Vn(e))==="Object"&&hb(e.callee)?"Arguments":n},rd={},bb=ro,Nc=it,wb=Va,Sb=rd,Ib=he,Eb=Ib("iterator"),Sn=function(t){if(!wb(t))return Nc(t,Eb)||Nc(t,"@@iterator")||Sb[bb(t)]},Dc=V,jc=H,$b=Xa,_b=it,Tb=to,nd=mn,Ob=ye,Cb=Ue,Rb=Es,sd=Ot,aa=Cb("Promise"),id="AsyncFromSyncIterator",xb=nd.set,Fc=nd.getterFor(id),Mc=function(t,e,r,n,s){var i=t.done;aa.resolve(t.value).then(function(a){e(sd(a,i))},function(a){if(!i&&s)try{Ob(n,"throw",a)}catch(o){a=o}r(a)})},ad=function(e){e.type=id,xb(this,e)};ad.prototype=Tb($b(Rb),{next:function(){var e=Fc(this);return new aa(function(r,n){var s=jc(Dc(e.next,e.iterator));Mc(s,r,n,e.iterator,!0)})},return:function(){var t=Fc(this).iterator;return new aa(function(e,r){var n=_b(t,"return");if(n===void 0)return e(sd(void 0,!0));var s=jc(Dc(n,t));Mc(s,e,r,t)})}});var Ts=ad,kb=V,Ab=ie,Lc=H,Bc=J,Pb=Sn,Nb=it,Db=he,jb=Ts,Fb=Db("asyncIterator"),od=function(t){var e=Lc(t),r=!0,n=Nb(e,Fb),s;return Ab(n)||(n=Pb(e),r=!1),n!==void 0?s=kb(n,e):(s=e,r=!0),Lc(s),Bc(r?s:new jb(Bc(s)))},Mb=W,Uc=V,Lb=ae,Dr=H,Bb=$e,Ub=J,zb=gr,zc=Ot,Vb=od,Hb=wn,Wb=zb(function(t){var e=this,r=e.iterator,n=e.mapper;return new t(function(s,i){var a=function(u){e.done=!0,i(u)},o=function(u){Hb(r,a,u,a)},c=function(){try{t.resolve(Dr(Uc(e.next,r))).then(function(u){try{if(Dr(u).done)e.done=!0,s(zc(void 0,!0));else{var d=u.value;try{var y=n(d,e.counter++),h=function(f){try{e.inner=Vb(f),l()}catch(m){o(m)}};Bb(y)?t.resolve(y).then(h,o):h(y)}catch(f){o(f)}}}catch(f){a(f)}},a)}catch(u){a(u)}},l=function(){var u=e.inner;if(u)try{t.resolve(Dr(Uc(u.next,u.iterator))).then(function(d){try{Dr(d).done?(e.inner=null,c()):s(zc(d.value,!1))}catch(y){o(y)}},o)}catch(d){o(d)}else c()};l()})});Mb({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{flatMap:function(e){return Dr(this),Lb(e),new Wb(Ub(this),{mapper:e,inner:null})}});var Kb=W,Qb=vr.forEach;Kb({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{forEach:function(e){return Qb(this,e)}});var Zb=V,Gb=gr,cd=Gb(function(){return Zb(this.next,this.iterator)},!0),qb=W,Jb=yn,Yb=yr,Xb=od,ew=Es,tw=cd;qb({target:"AsyncIterator",stat:!0,forced:!0},{from:function(e){var r=Xb(typeof e=="string"?Jb(e):e);return Yb(ew,r.iterator)?r.iterator:new tw(r)}});var rw=V,nw=ae,oa=H,sw=$e,iw=J,aw=gr,Vc=Ot,ow=wn,cw=aw(function(t){var e=this,r=e.iterator,n=e.mapper;return new t(function(s,i){var a=function(c){e.done=!0,i(c)},o=function(c){ow(r,a,c,a)};t.resolve(oa(rw(e.next,r))).then(function(c){try{if(oa(c).done)e.done=!0,s(Vc(void 0,!0));else{var l=c.value;try{var u=n(l,e.counter++),d=function(y){s(Vc(y,!1))};sw(u)?t.resolve(u).then(d,o):d(u)}catch(y){o(y)}}}catch(y){a(y)}},a)})}),ld=function(e){return oa(this),nw(e),new cw(iw(this),{mapper:e})},lw=W,uw=ld;lw({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{map:uw});var dw=W,fw=V,hw=ae,yi=H,pw=$e,yw=Ue,mw=J,gw=wn,mi=yw("Promise"),vw=TypeError;dw({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{reduce:function(e){yi(this),hw(e);var r=mw(this),n=r.iterator,s=r.next,i=arguments.length<2,a=i?void 0:arguments[1],o=0;return new mi(function(c,l){var u=function(y){gw(n,l,y,l)},d=function(){try{mi.resolve(yi(fw(s,n))).then(function(y){try{if(yi(y).done)i?l(new vw("Reduce of empty iterator with no initial value")):c(a);else{var h=y.value;if(i)i=!1,a=h,d();else try{var f=e(a,h,o),m=function(v){a=v,d()};pw(f)?mi.resolve(f).then(m,u):m(f)}catch(v){u(v)}}o++}catch(v){l(v)}},l)}catch(y){l(y)}};d()})}});var bw=W,ww=vr.some;bw({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{some:function(e){return ww(this,e)}});var Sw=W,Hc=V,ud=H,Iw=J,Ew=$s,$w=_s,_w=gr,gi=Ot,Tw=_w(function(t){var e=this,r=e.iterator,n;if(!e.remaining--){var s=gi(void 0,!0);return e.done=!0,n=r.return,n!==void 0?t.resolve(Hc(n,r,void 0)).then(function(){return s}):s}return t.resolve(Hc(e.next,r)).then(function(i){return ud(i).done?(e.done=!0,gi(void 0,!0)):gi(i.value,!1)}).then(null,function(i){throw e.done=!0,i})});Sw({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{take:function(e){ud(this);var r=$w(Ew(+e));return new Tw(Iw(this),{remaining:r})}});var Ow=W,Cw=vr.toArray;Ow({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{toArray:function(){return Cw(this,void 0,[])}});var Wc=Fu,Rw=at,dd=function(t,e,r){return r.get&&Wc(r.get,e,{getter:!0}),r.set&&Wc(r.set,e,{setter:!0}),Rw.f(t,e,r)},xw=Be,kw=at,Aw=Ua,Pw=function(t,e,r){xw?kw.f(t,e,Aw(0,r)):t[e]=r},Nw=Ee,Dw=ie,jw=$e,Kc=bn,Fw=gn,Mw=he,ca=Mw("iterator"),Pt,vi,bi;[].keys&&(bi=[].keys(),"next"in bi&&(vi=Kc(Kc(bi)),vi!==Object.prototype&&(Pt=vi)));var Lw=!jw(Pt)||Nw(function(){var t={};return Pt[ca].call(t)!==t});Lw&&(Pt={});Dw(Pt[ca])||Fw(Pt,ca,function(){return this});var Os={IteratorPrototype:Pt},Bw=W,Uw=ne,zw=Uu,Vw=H,Hw=ie,Ww=bn,Kw=dd,Qw=Pw,Zw=Ee,no=Pe,Gw=he,Ye=Os.IteratorPrototype,qw=Be,wi="constructor",fd="Iterator",Qc=Gw("toStringTag"),hd=TypeError,Si=Uw[fd],pd=!Hw(Si)||Si.prototype!==Ye||!Zw(function(){Si({})}),so=function(){if(zw(this,Ye),Ww(this)===Ye)throw new hd("Abstract class Iterator not directly constructable")},yd=function(t,e){qw?Kw(Ye,t,{configurable:!0,get:function(){return e},set:function(r){if(Vw(this),this===Ye)throw new hd("You can't redefine this property");no(this,t)?this[t]=r:Qw(this,t,r)}}):Ye[t]=e};no(Ye,Qc)||yd(Qc,fd);(pd||!no(Ye,wi)||Ye[wi]===Object)&&yd(wi,so);so.prototype=Ye;Bw({global:!0,constructor:!0,forced:pd},{Iterator:so});var Jw=V,Yw=Xa,Xw=mr,eS=to,tS=he,md=mn,rS=it,nS=Os.IteratorPrototype,Dn=Ot,Ii=ye,sS=tS("toStringTag"),gd="IteratorHelper",vd="WrapForValidIterator",iS=md.set,bd=function(t){var e=md.getterFor(t?vd:gd);return eS(Yw(nS),{next:function(){var n=e(this);if(t)return n.nextHandler();if(n.done)return Dn(void 0,!0);try{var s=n.nextHandler();return n.returnHandlerResult?s:Dn(s,n.done)}catch(i){throw n.done=!0,i}},return:function(){var r=e(this),n=r.iterator;if(r.done=!0,t){var s=rS(n,"return");return s?Jw(s,n):Dn(void 0,!0)}if(r.inner)try{Ii(r.inner.iterator,"normal")}catch(i){return Ii(n,"throw",i)}return n&&Ii(n,"normal"),Dn(void 0,!0)}})},aS=bd(!0),wd=bd(!1);Xw(wd,sS,"Iterator Helper");var br=function(t,e,r){var n=function(i,a){a?(a.iterator=i.iterator,a.next=i.next):a=i,a.type=e?vd:gd,a.returnHandlerResult=!!r,a.nextHandler=t,a.counter=0,a.done=!1,iS(this,a)};return n.prototype=e?aS:wd,n},oS=ne,ot=function(t,e){var r=oS.Iterator,n=r&&r.prototype,s=n&&n[t],i=!1;if(s)try{s.call({next:function(){return{done:!0}},return:function(){i=!0}},-1)}catch(a){a instanceof e||(i=!1)}if(!i)return s},cS=W,la=V,ua=H,lS=J,uS=$s,dS=_s,fS=ye,hS=br,pS=ot,Ei=pS("drop",RangeError),yS=hS(function(){for(var t=this.iterator,e=this.next,r,n;this.remaining;)if(this.remaining--,r=ua(la(e,t)),n=this.done=!!r.done,n)return;if(r=ua(la(e,t)),n=this.done=!!r.done,!n)return r.value});cS({target:"Iterator",proto:!0,real:!0,forced:Ei},{drop:function(e){ua(this);var r;try{r=dS(uS(+e))}catch(n){fS(this,"throw",n)}return Ei?la(Ei,this,r):new yS(lS(this),{remaining:r})}});var mS=za,gS=Ce,vS=function(t){if(mS(t)==="Function")return gS(t)},Zc=vS,bS=ae,wS=ws,SS=Zc(Zc.bind),Sd=function(t,e){return bS(t),e===void 0?t:wS?SS(t,e):function(){return t.apply(e,arguments)}},IS=he,ES=rd,$S=IS("iterator"),_S=Array.prototype,TS=function(t){return t!==void 0&&(ES.Array===t||_S[$S]===t)},OS=V,CS=ae,RS=H,xS=pn,kS=Sn,AS=TypeError,io=function(t,e){var r=arguments.length<2?kS(t):e;if(CS(r))return RS(OS(r,t));throw new AS(xS(t)+" is not iterable")},PS=Sd,NS=V,DS=H,jS=pn,FS=TS,MS=Ja,Gc=yr,LS=io,BS=Sn,qc=ye,US=TypeError,Hn=function(t,e){this.stopped=t,this.result=e},Jc=Hn.prototype,wr=function(t,e,r){var n=r&&r.that,s=!!(r&&r.AS_ENTRIES),i=!!(r&&r.IS_RECORD),a=!!(r&&r.IS_ITERATOR),o=!!(r&&r.INTERRUPTED),c=PS(e,n),l,u,d,y,h,f,m,v=function(S){return l&&qc(l,"normal",S),new Hn(!0,S)},g=function(S){return s?(DS(S),o?c(S[0],S[1],v):c(S[0],S[1])):o?c(S,v):c(S)};if(i)l=t.iterator;else if(a)l=t;else{if(u=BS(t),!u)throw new US(jS(t)+" is not iterable");if(FS(u)){for(d=0,y=MS(t);y>d;d++)if(h=g(t[d]),h&&Gc(Jc,h))return h;return new Hn(!1)}l=LS(t,u)}for(f=i?t.next:l.next;!(m=NS(f,l)).done;){try{h=g(m.value)}catch(S){qc(l,"throw",S)}if(typeof h=="object"&&h&&Gc(Jc,h))return h}return new Hn(!1)},zS=W,VS=V,HS=wr,WS=ae,KS=H,QS=J,ZS=ye,GS=ot,$i=GS("every",TypeError);zS({target:"Iterator",proto:!0,real:!0,forced:$i},{every:function(e){KS(this);try{WS(e)}catch(s){ZS(this,"throw",s)}if($i)return VS($i,this,e);var r=QS(this),n=0;return!HS(r,function(s,i){if(!e(s,n++))return i()},{IS_RECORD:!0,INTERRUPTED:!0}).stopped}});var qS=H,JS=ye,Id=function(t,e,r,n){try{return n?e(qS(r)[0],r[1]):e(r)}catch(s){JS(t,"throw",s)}},YS=W,Ed=V,XS=ae,$d=H,eI=J,tI=br,rI=Id,nI=ye,sI=ot,_i=sI("filter",TypeError),iI=tI(function(){for(var t=this.iterator,e=this.predicate,r=this.next,n,s,i;;){if(n=$d(Ed(r,t)),s=this.done=!!n.done,s)return;if(i=n.value,rI(t,e,[i,this.counter++],!0))return i}});YS({target:"Iterator",proto:!0,real:!0,forced:_i},{filter:function(e){$d(this);try{XS(e)}catch(r){nI(this,"throw",r)}return _i?Ed(_i,this,e):new iI(eI(this),{predicate:e})}});var aI=W,oI=V,cI=wr,lI=ae,uI=H,dI=J,fI=ye,hI=ot,Ti=hI("find",TypeError);aI({target:"Iterator",proto:!0,real:!0,forced:Ti},{find:function(e){uI(this);try{lI(e)}catch(s){fI(this,"throw",s)}if(Ti)return oI(Ti,this,e);var r=dI(this),n=0;return cI(r,function(s,i){if(e(s,n++))return i(s)},{IS_RECORD:!0,INTERRUPTED:!0}).result}});var pI=V,Yc=H,yI=J,mI=Sn,_d=function(t,e){(!e||typeof t!="string")&&Yc(t);var r=mI(t);return yI(Yc(r!==void 0?pI(r,t):t))},gI=W,da=V,vI=ae,fa=H,bI=J,wI=_d,SI=br,ha=ye,II=ot,Oi=II("flatMap",TypeError),EI=SI(function(){for(var t=this.iterator,e=this.mapper,r,n;;){if(n=this.inner)try{if(r=fa(da(n.next,n.iterator)),!r.done)return r.value;this.inner=null}catch(s){ha(t,"throw",s)}if(r=fa(da(this.next,t)),this.done=!!r.done)return;try{this.inner=wI(e(r.value,this.counter++),!1)}catch(s){ha(t,"throw",s)}}});gI({target:"Iterator",proto:!0,real:!0,forced:Oi},{flatMap:function(e){fa(this);try{vI(e)}catch(r){ha(this,"throw",r)}return Oi?da(Oi,this,e):new EI(bI(this),{mapper:e,inner:null})}});var $I=W,_I=V,TI=wr,OI=ae,CI=H,RI=J,xI=ye,kI=ot,Ci=kI("forEach",TypeError);$I({target:"Iterator",proto:!0,real:!0,forced:Ci},{forEach:function(e){CI(this);try{OI(e)}catch(s){xI(this,"throw",s)}if(Ci)return _I(Ci,this,e);var r=RI(this),n=0;TI(r,function(s){e(s,n++)},{IS_RECORD:!0})}});var AI=W,PI=V,NI=yn,DI=yr,jI=Os.IteratorPrototype,FI=br,MI=_d,LI=Tu,BI=FI(function(){return PI(this.next,this.iterator)},!0);AI({target:"Iterator",stat:!0,forced:LI},{from:function(e){var r=MI(typeof e=="string"?NI(e):e,!0);return DI(jI,r.iterator)?r.iterator:new BI(r)}});var UI=W,Td=V,zI=ae,Od=H,VI=J,HI=br,WI=Id,KI=ye,QI=ot,Ri=QI("map",TypeError),ZI=HI(function(){var t=this.iterator,e=Od(Td(this.next,t)),r=this.done=!!e.done;if(!r)return WI(t,this.mapper,[e.value,this.counter++],!0)});UI({target:"Iterator",proto:!0,real:!0,forced:Ri},{map:function(e){Od(this);try{zI(e)}catch(r){KI(this,"throw",r)}return Ri?Td(Ri,this,e):new ZI(VI(this),{mapper:e})}});var GI=ws,Cd=Function.prototype,Xc=Cd.apply,el=Cd.call,qI=typeof Reflect=="object"&&Reflect.apply||(GI?el.bind(Xc):function(){return el.apply(Xc,arguments)}),JI=W,YI=wr,XI=ae,eE=H,tE=J,rE=ye,nE=ot,sE=qI,iE=Ee,Rd=TypeError,xd=iE(function(){[].keys().reduce(function(){},void 0)}),xi=!xd&&nE("reduce",Rd);JI({target:"Iterator",proto:!0,real:!0,forced:xd||xi},{reduce:function(e){eE(this);try{XI(e)}catch(a){rE(this,"throw",a)}var r=arguments.length<2,n=r?void 0:arguments[1];if(xi)return sE(xi,this,r?[e]:[e,n]);var s=tE(this),i=0;if(YI(s,function(a){r?(r=!1,n=a):n=e(n,a,i),i++},{IS_RECORD:!0}),r)throw new Rd("Reduce of empty iterator with no initial value");return n}});var aE=W,oE=V,cE=wr,lE=ae,uE=H,dE=J,fE=ye,hE=ot,ki=hE("some",TypeError);aE({target:"Iterator",proto:!0,real:!0,forced:ki},{some:function(e){uE(this);try{lE(e)}catch(s){fE(this,"throw",s)}if(ki)return oE(ki,this,e);var r=dE(this),n=0;return cE(r,function(s,i){if(e(s,n++))return i()},{IS_RECORD:!0,INTERRUPTED:!0}).stopped}});var pE=W,kd=V,Ad=H,yE=J,mE=$s,gE=_s,vE=br,Pd=ye,bE=ot,Ai=bE("take",RangeError),wE=vE(function(){var t=this.iterator;if(!this.remaining--)return this.done=!0,Pd(t,"normal",void 0);var e=Ad(kd(this.next,t)),r=this.done=!!e.done;if(!r)return e.value});pE({target:"Iterator",proto:!0,real:!0,forced:Ai},{take:function(e){Ad(this);var r;try{r=gE(mE(+e))}catch(n){Pd(this,"throw",n)}return Ai?kd(Ai,this,r):new wE(yE(this),{remaining:r})}});var SE=W,IE=H,EE=wr,$E=J,_E=[].push;SE({target:"Iterator",proto:!0,real:!0},{toArray:function(){var e=[];return EE($E(IE(this)),_E,{that:e,IS_RECORD:!0}),e}});var TE=W,OE=H,CE=Ts,RE=cd,tl=J;TE({target:"Iterator",proto:!0,real:!0,forced:!0},{toAsync:function(){return new RE(tl(new CE(tl(OE(this)))))}});var xE=V,kE=ld,AE=function(t,e){return[e,t]},Nd=function(){return xE(kE,this,AE)},PE=W,NE=Nd;PE({target:"AsyncIterator",name:"indexed",proto:!0,real:!0,forced:!0},{asIndexedPairs:NE});var DE=W,jE=Nd;DE({target:"AsyncIterator",proto:!0,real:!0,forced:!0},{indexed:jE});var FE=V,ME=Os.IteratorPrototype.map,LE=function(t,e){return[e,t]},Dd=function(){return FE(ME,this,LE)},BE=W,UE=Dd;BE({target:"Iterator",name:"indexed",proto:!0,real:!0,forced:!0},{asIndexedPairs:UE});var zE=W,VE=Dd;zE({target:"Iterator",proto:!0,real:!0,forced:!0},{indexed:VE});var jd={},rl=ae,HE=TypeError,WE=function(t){var e,r;this.promise=new t(function(n,s){if(e!==void 0||r!==void 0)throw new HE("Bad Promise constructor");e=n,r=s}),this.resolve=rl(e),this.reject=rl(r)};jd.f=function(t){return new WE(t)};var KE=W,QE=jd;KE({target:"Promise",stat:!0},{withResolvers:function(){var e=QE.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var ZE=ne,GE=ZE,Cs={},qE=he;Cs.f=qE;var nl=GE,JE=Pe,YE=Cs,XE=at.f,Fd=function(t){var e=nl.Symbol||(nl.Symbol={});JE(e,t)||XE(e,t,{value:YE.f(t)})},e$=ne,t$=Fd,r$=at.f,n$=hn.f,Pi=e$.Symbol;t$("asyncDispose");if(Pi){var jn=n$(Pi,"asyncDispose");jn.enumerable&&jn.configurable&&jn.writable&&r$(Pi,"asyncDispose",{value:jn.value,enumerable:!1,configurable:!1,writable:!1})}var s$=Cs;s$.f("asyncDispose");var i$=ne,a$=Fd,o$=at.f,c$=hn.f,Ni=i$.Symbol;a$("dispose");if(Ni){var Fn=c$(Ni,"dispose");Fn.enumerable&&Fn.configurable&&Fn.writable&&o$(Ni,"dispose",{value:Fn.value,enumerable:!1,configurable:!1,writable:!1})}var l$=Cs;l$.f("dispose");var u$=Ce,d$=Ee,Md=ie,f$=ro,h$=Ue,p$=Nu,Ld=function(){},Bd=h$("Reflect","construct"),ao=/^\s*(?:class|function)\b/,y$=u$(ao.exec),m$=!ao.test(Ld),Cr=function(e){if(!Md(e))return!1;try{return Bd(Ld,[],e),!0}catch{return!1}},Ud=function(e){if(!Md(e))return!1;switch(f$(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return m$||!!y$(ao,p$(e))}catch{return!0}};Ud.sham=!0;var zd=!Bd||d$(function(){var t;return Cr(Cr.call)||!Cr(Object)||!Cr(function(){t=!0})||t})?Ud:Cr,g$=V,v$=Ts,b$=H,w$=io,S$=J,I$=it,E$=he,$$=E$("asyncIterator"),_$=function(t,e){var r=arguments.length<2?I$(t,$$):e;return r?b$(g$(r,t)):new v$(S$(w$(t)))},T$=ne,O$=function(t,e){var r=T$[t],n=r&&r.prototype;return n&&n[e]},C$=Sd,Vd=Ce,R$=yn,x$=zd,k$=_$,A$=io,P$=J,N$=Sn,D$=it,j$=Ue,F$=O$,M$=he,L$=Ts,B$=vr.toArray,U$=M$("asyncIterator"),Hd=Vd(F$("Array","values")),z$=Vd(Hd([]).next),V$=function(){return new Wd(this)},Wd=function(t){this.iterator=Hd(t)};Wd.prototype.next=function(){return z$(this.iterator)};var Kd=function(e){var r=this,n=arguments.length,s=n>1?arguments[1]:void 0,i=n>2?arguments[2]:void 0;return new(j$("Promise"))(function(a){var o=R$(e);s!==void 0&&(s=C$(s,i));var c=D$(o,U$),l=c?void 0:N$(o)||V$,u=x$(r)?new r:[],d=c?k$(o,c):new L$(P$(A$(o,l)));a(B$(d,s,u))})},H$=W,W$=Kd,K$=Ee,sl=Array.fromAsync,Q$=!sl||K$(function(){var t=0;return sl.call(function(){return t++,[]},{length:0}),t!==1});H$({target:"Array",stat:!0,forced:Q$},{fromAsync:W$});var Z$=zd,G$=pn,q$=TypeError,J$=function(t){if(Z$(t))return t;throw new q$(G$(t)+" is not a constructor")},Y$=typeof ArrayBuffer<"u"&&typeof DataView<"u",X$=Ce,e_=ae,t_=function(t,e,r){try{return X$(e_(Object.getOwnPropertyDescriptor(t,e)[r]))}catch{}},r_=$e,n_=function(t){return r_(t)||t===null},s_=n_,i_=String,a_=TypeError,o_=function(t){if(s_(t))return t;throw new a_("Can't set "+i_(t)+" as a prototype")},c_=t_,l_=$e,u_=Ha,d_=o_,f_=Object.setPrototypeOf||("__proto__"in{}?function(){var t=!1,e={},r;try{r=c_(Object.prototype,"__proto__","set"),r(e,[]),t=e instanceof Array}catch{}return function(s,i){return u_(s),d_(i),l_(s)&&(t?r(s,i):s.__proto__=i),s}}():void 0),h_=Y$,Qd=Be,Se=ne,Zd=ie,p_=$e,Gd=Pe,y_=ro,m_=pn,g_=mr,il=gn,v_=dd,b_=yr,oo=bn,Sr=f_,w_=he,S_=Ka,qd=mn,Jd=qd.enforce;qd.get;var rs=Se.Int8Array,al=rs&&rs.prototype,ol=Se.Uint8ClampedArray,cl=ol&&ol.prototype,ft=rs&&oo(rs),mt=al&&oo(al),I_=Object.prototype,Yd=Se.TypeError,ll=w_("toStringTag"),ul=S_("TYPED_ARRAY_TAG"),Xd="TypedArrayConstructor",Nt=h_&&!!Sr&&y_(Se.opera)!=="Opera",ve,gt,Xt,sr={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},E_={BigInt64Array:8,BigUint64Array:8},$_=function(t){if(Zd(t)&&(!Sr||b_(ft,t)))return t;throw new Yd(m_(t)+" is not a typed array constructor")},__=function(t,e,r){var n,s;if(Qd){if(Sr){if(r){for(n in sr)if(s=Se[n],s&&Gd(s,t))try{delete s[t]}catch{}}if(!ft[t]||r)try{return il(ft,t,r?e:Nt&&ft[t]||e)}catch{}else return}for(n in sr)s=Se[n],s&&(!s[t]||r)&&il(s,t,e)}};for(ve in sr)gt=Se[ve],Xt=gt&&gt.prototype,Xt?Jd(Xt)[Xd]=gt:Nt=!1;for(ve in E_)gt=Se[ve],Xt=gt&&gt.prototype,Xt&&(Jd(Xt)[Xd]=gt);if((!Nt||!Zd(ft)||ft===Function.prototype)&&(ft=function(){throw new Yd("Incorrect invocation")},Nt))for(ve in sr)Se[ve]&&Sr(Se[ve],ft);if((!Nt||!mt||mt===I_)&&(mt=ft.prototype,Nt))for(ve in sr)Se[ve]&&Sr(Se[ve].prototype,mt);Nt&&oo(cl)!==mt&&Sr(cl,mt);if(Qd&&!Gd(mt,ll)){v_(mt,ll,{configurable:!0,get:function(){return p_(this)?this[ul]:void 0}});for(ve in sr)Se[ve]&&g_(Se[ve],ul,ve)}var T_={aTypedArrayConstructor:$_,exportTypedArrayStaticMethod:__},O_=Ja,C_=function(t,e,r){for(var n=0,s=arguments.length>2?r:O_(e),i=new t(s);s>n;)i[n]=e[n++];return i},R_=Ue,x_=J$,k_=Kd,ef=T_,A_=C_,P_=ef.aTypedArrayConstructor,N_=ef.exportTypedArrayStaticMethod;N_("fromAsync",function(e){var r=this,n=arguments.length,s=n>1?arguments[1]:void 0,i=n>2?arguments[2]:void 0;return new(R_("Promise"))(function(a){x_(r),a(k_(e,s,i))}).then(function(a){return A_(P_(r),a)})},!0);const pa=null;class tf extends Error{constructor(e,r){super((r+": "||"Unreachable: ")+e)}}function Di(t){if(t===null||typeof t!="object")return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}function Gt(t,e){return t>e?1:t<e?-1:0}const yt={null:"b",object:"c",array:"d",number:"e",string:"f",boolean:"g"},dl=new Map(Object.entries(yt).sort((t,e)=>t[1]<e[1]?-1:1).map(([t],e)=>[t,e]));function fl(t){if(t===null)return"null";if(t===!0||t===!1)return"boolean";if(typeof t=="string")return"string";if(typeof t=="number")return"number";if(Array.isArray(t))return"array";if(typeof t=="object")return"object";throw new tf(t,"Unknown value type")}Object.fromEntries(Object.entries(yt).map(([t,e])=>[e,t]));function ke(t,e){const r=fl(t),n=fl(e);if(r===n){if(r==="array")return ns(t,e);if(r==="object")return t===e?0:Di(t)?Di(e)?D_(t,e):-1:(Di(e),1);if(r==="boolean")return Gt(t,e);if(r==="null")return 0;if(r==="number")return Gt(t,e);if(r==="string")return Gt(t,e);throw new tf(r)}return Gt(dl.get(r),dl.get(n))}function D_(t,e){const r=Object.entries(t).filter(([i,a])=>a!==void 0).sort(([i],[a])=>Gt(i,a)),n=Object.entries(e).filter(([i,a])=>a!==void 0).sort(([i],[a])=>Gt(i,a)),s=Math.min(r.length,n.length);for(let i=0;i<s;i++){const[a,o]=r[i],[c,l]=n[i],u=ke(a,c);if(u===0){const d=ke(o,l);if(d===0)continue;return d}return u}return r.length>n.length?1:r.length<n.length?-1:0}function ns(t,e){const r=Math.min(t.length,e.length);for(let n=0;n<r;n++){const s=ke(t[n],e[n]);if(s!==0)return s}return t.length>e.length?1:t.length<e.length?-1:0}function hl(t){return{type:"string",config:{enum:t==null?void 0:t.enum,nullable:t==null?void 0:t.nullable,default:t==null?void 0:t.default}}}function j_(t){return{type:"number",config:{nullable:t==null?void 0:t.nullable,default:t==null?void 0:t.default}}}function F_(t){return{type:"boolean",config:{nullable:t==null?void 0:t.nullable,default:t==null?void 0:t.default}}}function M_(t){return{type:"date",config:{nullable:t==null?void 0:t.nullable,default:t==null?void 0:t.default}}}function pl(t,e){return{type:"record",config:{nullable:e==null?void 0:e.nullable},properties:t}}function L_(t,e){return{type:"set",items:t,config:{nullable:e==null?void 0:e.nullable,default:e==null?void 0:e.default}}}function B_(t){return{type:"json",config:{nullable:t==null?void 0:t.nullable,default:t==null?void 0:t.default}}}const ge=class ge{static Schema(e){return pl(e)}static get Default(){return{Set:{empty:()=>({func:"Set.empty",args:null})},uuid:e=>({func:"uuid",args:e?[e]:null}),now:()=>({func:"now",args:null})}}static Optional(e){return{...e,config:e.config?{...e.config,optional:!0}:{optional:!0}}}static Collections(e){return e}static Filter(e){return e}};b(ge,"Id",()=>hl({nullable:!1,default:ge.Default.uuid()})),b(ge,"String",hl),b(ge,"Number",j_),b(ge,"Boolean",F_),b(ge,"Date",M_),b(ge,"Record",pl),b(ge,"Set",L_),b(ge,"Json",B_),b(ge,"RelationMany",(e,r)=>({query:{collectionName:e,...r},cardinality:"many"})),b(ge,"RelationOne",(e,r)=>({query:{collectionName:e,...r},cardinality:"one"})),b(ge,"RelationById",(e,r)=>({query:{collectionName:e,where:[["id","=",r]]},cardinality:"one"}));let p=ge;const rf=Object.freeze(["string","number","boolean","date"]),U_=new Set(rf),z_=Object.freeze(["string","number","boolean","date","set","json"]),V_=new Set(z_),nf=Object.freeze([...rf,"set","json","record"]);new Set(nf);const H_=Object.freeze(["now","uuid","Set.empty"]),Ir=["isDefined"],Rs=["=","!=","<",">","<=",">="],sf=["has","!has"],af=["in","nin"],ir="SET_",of=[...Ir,...Rs],W_=[...Ir,...Rs],cf=[...Ir,...Rs,...af],lf=[...Ir],K_=df([...Ir,...sf],ir),uf=[...Ir,...Rs,...af,"like","nlike"],Q_=Array.from(new Set([...of,...cf,...uf,...lf,...sf])),Rt={boolean:of,date:W_,json:Q_,number:cf,record:lf,set:K_,string:uf};function df(t,e){return t.map(r=>`${e}${r}`)}function Z_(t){if(t==="=")return"=";if(t==="!=")return"!=";if(t==="<")return">";if(t===">")return"<";if(t==="<=")return">=";if(t===">=")return"<=";if(t==="in")return"SET_has";if(t==="nin")return"SET_!has";if(t==="SET_has")return"in";if(t==="SET_!has")return"nin";throw new O(`Cannot flip operator ${t}`)}var te;(function(t){function e(h){switch(h.type){case"record":const f={};for(const m in h.properties)f[m]=t.struct(h.properties[m]);return f;default:return}}t.struct=e;function r(h){if(G_(h))return q_(h.config);if(h.type==="record"){const f={};for(const m in h.properties)f[m]=t.defaultValue(h.properties[m]);return f}}t.defaultValue=r;function n(h,f,m){switch(h.type){case"record":for(const v in h.properties){const g=h.properties[v];if(ut(g)&&_(m[v])){f[v]=m[v];continue}f[v]=t.assign(g,f[v],m[v])}return f;default:return m===void 0?t.defaultValue(h):m}}t.assign=n;function s(h,f){var m,v;if(!(ut(h)&&_(f))){switch(h.type){case"boolean":if(typeof f=="boolean")return f;throw new ct("boolean",f);case"date":if(f instanceof Date&&!isNaN(f.getTime()))return f.toISOString();if(typeof f=="string"&&!Number.isNaN(Date.parse(f)))return new Date(f).toISOString();if(typeof f=="number"&&!Number.isNaN(f))return new Date(f).toISOString();throw new ct("date",f);case"json":if(!_(f))return f;throw new ct("json",f);case"number":if(typeof f=="number")return f;throw new ct("number",f);case"record":if(typeof f=="object"&&f!==null){for(const g in f){const S=h.properties[g];if(!S)throw new ct("record",f,`Unrecognized property: ${g}`);ut(S)&&_(f[g])||(f[g]=t.encode(S,f[g]))}return f}throw new ct("record",f);case"string":if(typeof f=="string")if((m=h.config)!=null&&m.enum){if((v=h.config)!=null&&v.enum.includes(f))return f}else return f;throw new ct("string",f);case"set":if(Array.isArray(f))return Object.fromEntries(f.map(g=>[t.collectionKeyEncode(h.items,g),!0]));if(f instanceof Set)return Object.fromEntries(Array.from(f).map(g=>[t.collectionKeyEncode(h.items,g),!0]));if(typeof f=="object"&&f!==null)return f;throw new ct(`set<${h.items.type}>`,f)}throw new Mn(h.type,"Failed to encode value")}}t.encode=s;function i(h,f,m){switch(h.type){case"boolean":return typeof f=="boolean"?{valid:!0}:{valid:!1,error:Ht("boolean",f)};case"date":return typeof f=="string"?{valid:!0}:{valid:!1,error:Ht("date",f)};case"json":return typeof f<"u"?{valid:!0}:{valid:!1,error:Ht("json",f)};case"number":return typeof f=="number"?{valid:!0}:{valid:!1,error:Ht("number",f)};case"record":for(const v in h.properties){const g=h.properties[v];if(ut(g)&&_(f[v])||m.partial&&!(v in f))continue;const S=t.validateEncoded(g,f[v],m);if(!S.valid)return S}return{valid:!0};case"string":return typeof f=="string"?{valid:!0}:{valid:!1,error:Ht("string",f)};case"set":return typeof f=="object"&&f!==null?{valid:!0}:{valid:!1,error:Ht(`set<${h.items.type}>`,f)}}throw new Mn(h.type,"Failed to validate value")}t.validateEncoded=i;function a(h,f){switch(h.type){case"boolean":if(typeof f=="boolean")return f;throw new xr("boolean",f);case"date":if(typeof f=="string")return new Date(f);throw new xr("date",f);case"json":return f;case"number":if(typeof f=="number")return f;throw new xr("number",f);case"record":const m={};for(const v in f){const g=h.properties[v];if(g){if(ut(g)&&_(f[v])){f[v]===null&&(m[v]=null);continue}m[v]=t.decode(g,f[v])}}return m;case"string":if(typeof f=="string")return f;throw new xr("string",f);case"set":if(typeof f=="object")return new Set(Object.entries(f).filter(([v,g])=>g).map(([v,g])=>t.collectionKeyDecode(h.items,v)));throw new xr(`set<${h.items.type}>`,f)}throw new Mn(h.type,"Failed to decode value")}t.decode=a;function o(h,f){if(!ya(h))throw new O("Cannot encode collection key for non-primitive type");return t.encode(h,f).toString()}t.collectionKeyEncode=o;function c(h,f){if(!ya(h))throw new O("Cannot decode collection key for non-primitive type");return h.type==="number"?Number(f):h.type==="boolean"?f==="true":t.decode(h,f)}t.collectionKeyDecode=c;function l(h,f){return h.type==="boolean"&&f.type==="boolean"?Y_(h,f):h.type==="date"&&f.type==="date"?X_(h,f):h.type==="number"&&f.type==="number"?eT(h,f):h.type==="record"&&f.type==="record"?J_(h,f):h.type==="set"&&f.type==="set"?tT(h,f):h.type==="string"&&f.type==="string"?rT(h,f):!1}t.equal=l;function u(h,f,m){if(h.type==="date"){if(m==="encoded")return f;if(m==="decoded")return t.encode(h,f);throw new O("Invalid data format: "+m)}if(h.type==="record"){const v={};for(const g in f){const S=h.properties[g];if(!S)throw new jT("record",f,`Unrecognized property: ${g}`);ut(S)&&_(f[g])||(v[g]=t.serialize(S,f[g],m))}return v}if(h.type==="set"){if(m==="encoded")return Object.entries(f).filter(([v,g])=>g).map(([v,g])=>t.serialize(h.items,t.collectionKeyDecode(h.items,v),m));if(m==="decoded"){const v=[];for(const g of f)v.push(t.serialize(h.items,g,m));return v}throw new O("Invalid data format: "+m)}return f}t.serialize=u;function d(h,f,m){if(h.type==="date"){if(m==="encoded")return f;if(m==="decoded")return t.decode(h,f);throw new O("Invalid data format: "+m)}if(h.type==="record"){for(const v in f){const g=h.properties[v];if(!g)throw new FT("record",f,`Unrecognized property: ${v}`);ut(g)&&_(f[v])||(f[v]=t.deserialize(g,f[v],m))}return f}if(h.type==="set"){if(m==="encoded"){const v={};for(const g of f)v[t.collectionKeyEncode(h.items,g)]=!0;return v}if(m==="decoded"){const v=[];for(const g of f)v.push(t.deserialize(h.items,g,m));return new Set(v)}throw new O("Invalid data format: "+m)}return f}t.deserialize=d;function y(h){if(h.type==="boolean")return Rt.boolean;if(h.type==="date")return Rt.date;if(h.type==="json")return Rt.json;if(h.type==="number")return Rt.number;if(h.type==="record")return Rt.record;if(h.type==="set")return[...Rt.set,...df(t.supportedOperations(h.items),ir)];if(h.type==="string")return Rt.string;throw new Mn(h.type,"Failed to get supported operations")}t.supportedOperations=y})(te||(te={}));function G_(t){return V_.has(t.type)}function ya(t){return U_.has(t.type)}function q_(t){let e=t.default;if(!_(e)){if(typeof e!="object"||e===null)return e;{const{args:r,func:n}=e;if(n===void 0)return e;if(n==="uuid")return r&&typeof r[0]=="number"?Zo(r[0]):Zo();if(n==="now")return new Date().toISOString();if(n==="Set.empty")return{}}}}function _(t){return t==null}function ut(t){var e,r;return((e=t.config)==null?void 0:e.optional)===!0||((r=t.config)==null?void 0:r.nullable)===!0}function Ht(t,e){return`Encoded value ${e} is not valid for type ${t}`}function J_(t,e){return!!nT(t.properties,e.properties)}function Y_(t,e){return In(t.config,e.config)}function X_(t,e){return In(t.config,e.config)}function eT(t,e){return In(t.config,e.config)}function tT(t,e){return!(!In(t.config,e.config)||!te.equal(t.items,e.items))}function rT(t,e){var r,n,s,i,a,o;if((r=t.config)!=null&&r.enum&&!((n=e.config)!=null&&n.enum)||!((s=t.config)!=null&&s.enum)&&((i=e.config)!=null&&i.enum))return!1;if((a=t.config)!=null&&a.enum&&((o=e.config)!=null&&o.enum)){if(t.config.enum.length!==e.config.enum.length)return!1;for(const c of t.config.enum)if(!e.config.enum.includes(c))return!1}return In(t.config,e.config)}function nT(t,e){const r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(const s of r)if(!e[s]||!te.equal(t[s],e[s]))return!1;return!0}function In(t,e){return!(!!(t!=null&&t.optional)!=!!(e!=null&&e.optional)||!!(t!=null&&t.nullable)!=!!(e!=null&&e.nullable)||!sT(t==null?void 0:t.default,e==null?void 0:e.default))}function sT(t,e){return typeof t!=typeof e?!1:yl(t)&&yl(e)?iT(t,e):t===e}function yl(t){return typeof t=="object"&&t!==null&&"func"in t}function iT(t,e){var r,n;if(t.func!==e.func||((r=t.args)==null?void 0:r.length)!==((n=e.args)==null?void 0:n.length))return!1;if(t.args&&e.args){for(let s=0;s<t.args.length;s++)if(t.args[s]!==e.args[s])return!1}return!0}function ff(t,e){if(!t)return;const r=t[e];if(r)return r.permissions}function aT(t){return t==="read"}function oT(t){return!aT(t)}function cT(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;const r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(const s of r){const i=t[s],a=e[s];if(!lT(i,a))return!1}return!0}function lT(t,e){return!t&&!e?!0:!(!t||!e||!Rr(t.read,e.read)||!Rr(t.insert,e.insert)||!Rr(t.update,e.update)||!Rr(t.postUpdate,e.postUpdate)||!Rr(t.delete,e.delete))}function Rr(t,e){return!t&&!e?!0:!(!t||!e||!uT(t.filter,e.filter))}function uT(t,e){return!t&&!e?!0:!t||!e?!1:JSON.stringify(t)===JSON.stringify(e)}function dT(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;const r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(const s of r){const i=t[s],a=e[s];if(!fT(i,a))return!1}return!0}function fT(t,e){return!t&&!e?!0:!(!t||!e||!hT(t.match,e.match))}function hT(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;const r=Object.keys(t),n=Object.keys(e);if(r.length!==n.length)return!1;for(const s of r){const i=t[s],a=e[s];if(JSON.stringify(i)!==JSON.stringify(a))return!1}return!0}function pT(t){return t._diff==="collectionAttribute"}function hf(t,e,r=[]){if(t===void 0&&e===void 0)return[];const n=(t==null?void 0:t.properties)??{},s=(e==null?void 0:e.properties)??{},i=new Set([...Object.keys(n),...Object.keys(s)]),a=[];for(const o of i){if(!(o in n)){const c=[...r,o];a.push({type:"insert",attribute:c,dataType:s[o],isNewCollection:t===void 0});continue}if(!(o in s)){const c=[...r,o];a.push({type:"delete",attribute:c,dataType:n[o]});continue}if(o in n&&o in s){if(te.equal(n[o],s[o]))continue;const c=[...r,o];if(n[o].type==="record"&&s[o].type==="record"){a.push(...hf(n[o],s[o],c));continue}const l={type:"update",attribute:c,changes:{config:{}}};n[o].type!==s[o].type&&(l.changes.type=s[o].type),n[o].type==="set"&&s[o].type==="set"&&n[o].items.type!==s[o].items.type&&(l.changes.items={type:s[o].items.type}),l.changes.config=yT(n[o].config??{},s[o].config??{}),a.push(l);continue}}return a}function yT(t,e){var i;const r={};t.nullable!==e.nullable&&(r.nullable=!!e.nullable),t.optional!==e.optional&&(r.optional=!!e.optional),t.default!==e.default&&(r.default=e.default);const n=e.enum&&!t.enum,s=t.enum&&e.enum&&!((i=t.enum)!=null&&i.every(a=>{var o;return(o=e.enum)==null?void 0:o.includes(a)}));return(n||s)&&(r.enum=e.enum),r}function mT(t,e){const r=new Set([...Object.keys(t.collections),...Object.keys(e.collections)]),n=[];for(const i of r){const a=t.collections[i],o=e.collections[i];n.push(...hf(a==null?void 0:a.schema,o==null?void 0:o.schema).map(l=>({_diff:"collectionAttribute",collection:i,...l}))),!cT(a==null?void 0:a.permissions,o==null?void 0:o.permissions)&&n.push({_diff:"collectionPermissions",collection:i})}return!dT(t.roles,e.roles)&&n.push({_diff:"roles"}),n}function gT(t){return t.reduce((e,r)=>{if(!pT(r))return e;const n=vT.find(s=>s.matchesDiff(r));return n&&e.push({issue:n.description,dataConstraint:n.dataConstraint,context:r,attributeCure:n.attributeCure}),e},[])}const vT=[{description:"removed an optional attribute",matchesDiff:t=>t.type==="delete"&&ut(t.dataType),dataConstraint:"attribute_is_empty",attributeCure:()=>null},{description:"removed a required attribute",matchesDiff:t=>t.type==="delete",dataConstraint:"collection_is_empty",attributeCure:(t,e)=>`make '${e.join(".")}' optional`},{description:"changed a attribute from optional to required",matchesDiff:t=>{var e;return t.type==="update"?((e=t.changes.config)==null?void 0:e.optional)===!1:!1},dataConstraint:"attribute_has_no_undefined",attributeCure:()=>null},{description:"changed the type of an attribute",matchesDiff:t=>t.type==="update"?t.changes.type!==void 0:!1,dataConstraint:"attribute_is_empty",attributeCure:(t,e)=>`revert the change to '${e.join(".")}' and create a different, optional, attribute with the new type`},{description:"changed the type of a set's items",matchesDiff:t=>t.type==="update"?t.changes.items!==void 0:!1,dataConstraint:"attribute_is_empty",attributeCure:(t,e)=>`revert the change to '${e.join(".")}' and create a different, optional, attribute with the new type`},{description:"added an attribute where optional is not set",matchesDiff:t=>t.type==="insert"&&!t.isNewCollection&&!ut(t.dataType),dataConstraint:"collection_is_empty",attributeCure:(t,e)=>`make '${e.join(".")}' optional`},{description:"changed an attribute from nullable to non-nullable",matchesDiff:t=>{var e;return t.type==="update"?((e=t.changes.config)==null?void 0:e.nullable)===!1:!1},dataConstraint:"attribute_has_no_null",attributeCure:()=>null},{description:"added an enum to an attribute or removed an option from an existing enum",matchesDiff:t=>{var e;return t.type==="update"?((e=t.changes.config)==null?void 0:e.enum)!==void 0:!1},dataConstraint:"attribute_satisfies_enum",attributeCure:(t,e,r)=>`revert the change to '${e.join(".")}' and create a different, optional, attribute with the new enum OR ensure all values of '${e.join(".")} are in the new enum: ${r}`}];async function bT(t,e,r){var n;return await ST[r](t,e.collection,e.attribute,(e==null?void 0:e.type)==="update"?(n=e.changes.config)==null?void 0:n.enum:void 0)}async function wT(t,e){const r=gT(e);return await Promise.all(r.map(async s=>{const i=!await bT(t,s.context,s.dataConstraint),a=s.dataConstraint&&IT[s.dataConstraint](s.context.collection,s.context.attribute),o=s.attributeCure(s.context.collection,s.context.attribute);return{...s,violatesExistingData:i,cure:o&&a?o+" or "+a:a}}))}const ST={never:async()=>!1,none:async()=>!0,collection_is_empty:OT,attribute_is_empty:_T,attribute_has_no_undefined:$T,attribute_has_no_null:TT,attribute_satisfies_enum:ET},IT={never:()=>"This edit is never allowed",none:()=>"This edit does not violate any data constraints but can cause existing queries that reference this attribute to fail",collection_is_empty:t=>`delete all entities in '${t}' to allow this edit`,attribute_is_empty:(t,e)=>`set all values of '${e.join(".")}' to undefined to allow this edit`,attribute_has_no_undefined:(t,e)=>`ensure all values of '${e.join(".")}' are not undefined to allow this edit`,attribute_has_no_null:(t,e)=>`ensure all values of '${e.join(".")}' are not null to allow this edit`,attribute_satisfies_enum:(t,e)=>`ensure all values of '${e.join(".")}' are in the enum to allow this edit`};async function ET(t,e,r,n){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"nin",n]]})).length===0}async function $T(t,e,r){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"isDefined",!1]]})).length===0}async function _T(t,e,r){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"isDefined",!0]]})).length===0}async function TT(t,e,r){return(await t({collectionName:e,select:["id"],limit:1,where:[[r.join("."),"=",null]]})).length===0}async function OT(t,e){return(await t({collectionName:e,select:["id"],limit:1})).length===0}function CT(t,{logger:e,forcePrintIssues:r=!1}={}){const n=e??console;if(t.successful?n.info("Schema update successful"):n.error("Schema update failed. Please resolve the following issues:"),t.invalid){n.error(t.invalid);return}const s=`Found ${t.issues.length} backwards incompatible schema changes.`;if(t.issues.length>0?n.warn(s):n.info(s),!t.successful||r){const i=t.issues.filter(a=>r||a.violatesExistingData);RT(n,i)}}function RT(t,e){e.reduce((n,s)=>{const i=s.context.collection,a=n.get(i)??[];return n.set(i,[...a,s]),n},new Map).forEach((n,s)=>{t.error(`
Collection: '${s}'`),n.forEach(({issue:i,context:a,cure:o})=>{t.error(`	'${a.attribute.join(".")}'
		Issue: ${i}
		Fix:   ${o}`)})}),t.info("")}const L={"Bad Request":400,Unauthorized:401,Forbidden:403,"Not Found":404,"Internal Server Error":500,"Service Unavailable":503};class O extends Error{constructor(r,...n){super(...n);b(this,"status",L["Internal Server Error"]);b(this,"baseMessage");b(this,"contextMessage");b(this,"__isTriplitError",!0);this.name="TriplitError",this.baseMessage=n[0]||"Triplit Error",this.contextMessage=r}get message(){return this.contextMessage?`${this.baseMessage} | Context: ${this.contextMessage}`:this.baseMessage}toString(){return JSON.stringify(this.toJSON())}toJSON(){return{name:this.name,message:this.message,baseMessage:this.baseMessage,status:this.status,contextMessage:this.contextMessage}}static fromJson(r){const n=new O(r.contextMessage);return r.baseMessage&&(n.baseMessage=r.baseMessage),r.name&&(n.name=r.name),r.status&&(n.status=r.status),n}}class xT extends O{constructor(e,...r){super(...r),this.name="InvalidQueryInclusionError",this.baseMessage=`An inclusion was provided to a query that is not valid or could not be transformed into a valid inclusion. The inclusion was: ${JSON.stringify(e)}`,this.status=L["Bad Request"]}}class ml extends O{constructor(e,...r){super(...r),this.name="InvalidQueryLimitError",this.baseMessage=`A limit was provided to a query that is not valid or could not be transformed into a valid limit. The limit was: ${JSON.stringify(e)}`,this.status=L["Bad Request"]}}class kT extends O{constructor(e,...r){super(...r),this.name="InvalidQueryWhereError",this.baseMessage=`A where clause was provided to a query that is not valid or could not be transformed into a valid where clause. The where clause was: ${JSON.stringify(e)}`,this.status=L["Bad Request"]}}class xe extends O{constructor(e,...r){super(...r),this.name="InvalidQueryAfterError",this.baseMessage=`An after cursor was provided to a query that is not valid or could not be transformed into a valid after cursor. The after cursor was: ${JSON.stringify(e)}`,this.status=L["Bad Request"]}}class AT extends O{constructor(...e){super(...e),this.name="TransactionAlreadyCommittedError",this.baseMessage="This transaction has already been committed.",this.status=L["Bad Request"]}}class Wn extends O{constructor(...e){super(...e),this.name="TransactionAlreadyCanceledError",this.baseMessage="This transaction has already been canceled.",this.status=L["Bad Request"]}}class PT extends O{constructor(...e){super(...e),this.name="QueryNotPreparedError",this.baseMessage="The query has parameters that have not been prepared with the schema. This could indicate that the database does not have a schema or that it is not up-to-date. Run `npx triplit schema diff` to verify that the serverâs schema is in sync with the clientâs. If it is not, run `npx triplit schema push` to update the serverâs schema.",this.status=L["Internal Server Error"]}}class pf extends O{constructor(e,r,...n){super(...n),this.name="EntityNotFoundError",this.baseMessage=`Could not find entity with id ${e} in collection ${r}.`,this.status=L["Not Found"]}}class er extends O{constructor(e,...r){super(...r),this.name="InvalidCollectionNameError",this.baseMessage=`${e} is not a valid collection name.`,this.status=L["Bad Request"]}}class gl extends O{constructor(...e){super(...e),this.name="InvalidInsertDocumentError",this.baseMessage="The document you are attempting to insert is invalid.",this.status=L["Bad Request"]}}class NT extends O{constructor(...e){super(...e),this.name="InvalidOperationError",this.baseMessage="You are attempting to perform an operation that is not valid.",this.status=L["Bad Request"]}}class DT extends O{constructor(e,r,n,s,...i){super(...i),this.name="WritePermissionError",this.baseMessage=`'${n}' permission for the collection '${e}' prevented the ${n==="insert"?"insertion":n==="delete"?"deletion":"update"} of the entity with id '${r}'. The provided session roles were [${s.map(a=>a.key).join(", ")}].`,this.status=L.Unauthorized}}class ct extends O{constructor(e,r,...n){super(...n),this.name="DBSerializationError",this.baseMessage=`There was an error serializing an input to an acceptable format. Could not transform the data: ${r} as type: ${e}`,this.status=L["Bad Request"]}}class xr extends O{constructor(e,r,...n){super(...n),this.name="DBDeserializationError",this.baseMessage=`There was an error deserializing an database value to JS. Could not tranform the data: ${r} as type: ${e}`,this.status=L["Bad Request"]}}class jT extends O{constructor(e,r,...n){super(...n),this.name="JSONSerializationError",this.baseMessage=`There was an error serializing an input to JSON. Could not tranform the data: ${e} as type: ${r}`,this.status=L["Bad Request"]}}class FT extends O{constructor(e,r,...n){super(...n),this.name="JSONDeserializationError",this.baseMessage=`There was an error deserializing a JSON value. Could not tranform the data: ${e} as type: ${r}`,this.status=L["Bad Request"]}}class Mn extends O{constructor(e,...r){super(...r),this.name="UnrecognizedAttributeTypeError",this.baseMessage=`An attribute in the schema contains an unsupported type: ${e}. Valid types are ${[nf]}`,this.status=L["Bad Request"]}}class qe extends O{constructor(...e){super(...e),this.name="InvalidFilterError",this.baseMessage="Your query passed a filter that is invalid.",this.status=L["Bad Request"]}}class MT extends O{constructor(e,...r){super(...r),this.name="InvalidQueryCardinalityError",this.baseMessage=`The cardinality ${e} is not valid for the query type.`,this.status=L["Bad Request"]}}class vl extends O{constructor(...e){super(...e),this.name="InvalidOrderClauseError",this.baseMessage="An order clause has been determined to be invalid.",this.status=L["Bad Request"]}}class bl extends O{constructor(...e){super(...e),this.name="InvalidSelectClauseError",this.baseMessage="The select clause of this query has been determined to be invalid.",this.status=L["Bad Request"]}}class LT extends O{constructor(e,r,n,...s){super(...s),this.name="RelationDoesNotExistError",this.baseMessage=`Your attempt to load '${e}' at alias '${r}' failed because '${e}' does not exist in the schema for the collection '${n}'.`,this.status=L["Bad Request"]}}class BT extends O{constructor(e,r,n,...s){super(...s),this.name="IncludedNonRelationError",this.baseMessage=`Your attempt to load '${e}' at alias '${r}' failed because '${e}' in the collection '${n}' in not a query type.`,this.status=L["Bad Request"]}}class UT extends O{constructor(...e){super(...e),this.name="QueryCacheError",this.baseMessage="An error occurred inside the query cache",this.status=L["Bad Request"]}}class ji extends O{constructor(e,r,...n){super(...n),this.name="QueryClauseFormattingError",this.baseMessage=`The ${e} clause is not formatted correctly.
    
    Received: ${JSON.stringify(r)}`,this.status=L["Bad Request"]}}class zT extends O{constructor(...e){super(...e),this.name="AfterClauseWithNoOrderError",this.baseMessage="The 'after' clause must be used after an 'order' clause.",this.status=L["Bad Request"]}}class wl extends O{constructor(e,r,...n){super(...n),this.name="InvalidResultCardinalityError",this.baseMessage=`Expected cardinality ${e} but got ${r}. This indicates an issue with the query engine. Please report this issue to the Triplit team.`,this.status=L["Internal Server Error"]}}class tr{constructor(e){b(this,"lastPhysicalTimeMs");b(this,"lastLogicalTime");b(this,"clientId","");this.clientId=e.clientId,this.lastPhysicalTimeMs=e.lastPhysicalTimeMs||0,this.lastLogicalTime=e.lastLogicalTime||0}get currentPhysicalTimeMs(){return Date.now()}current(){return[this.currentPhysicalTimeMs,this.lastLogicalTime,this.clientId]}next(){const e=this.currentPhysicalTimeMs;return e>this.lastPhysicalTimeMs?(this.lastPhysicalTimeMs=e,this.lastLogicalTime=0):this.lastLogicalTime+=1,[this.lastPhysicalTimeMs,this.lastLogicalTime,this.clientId]}updatePhysicalTimeMs(e){this.lastPhysicalTimeMs=e}static compare(e,r){return e[0]===r[0]?e[1]===r[1]?e[2].localeCompare(r[2]):e[1]-r[1]:e[0]-r[0]}}b(tr,"MIN",Object.freeze([0,0,""]));class VT{constructor(e=[]){b(this,"storagePrefix");this.storagePrefix=e}async getHighestTimestamp(e){return await e.scope(this.storagePrefix).get(["highestTimestamp"])??tr.MIN}async applyChanges(e,r,n){const s=e.scope(this.storagePrefix),i=await this.getHighestTimestamp(e),a=[];for(const[c,l]of Object.entries(r)){const u=[...l.sets.keys(),...l.deletes];for(const d of u){const y={collectionName:c,id:d,delete:l.deletes.has(d),set:l.sets.get(d)};a.push(y)}}if(tr.compare(n,i)>0){for(const c of a)await s.set([c.collectionName,c.id],n);return await s.set(["highestTimestamp"],n),r}const o={};for(const c of a){const{collectionName:l,id:u,delete:d,set:y}=c,h=[l,u],f=await s.get(h);(!f||tr.compare(n,f)>0)&&(await s.set(h,n),o[l]||(o[l]={sets:new Map,deletes:new Set}),d&&o[l].deletes.add(u),y&&o[l].sets.set(u,y))}return o}async getTimestampForEntity(e,r,n){return e.scope(this.storagePrefix).get([r,n])??null}}function St(t,...e){if(e.length===0)return t;t=t??{};for(const r of e){if(r===null)return t=null,t;if(r){for(const n in r)if(Object.prototype.hasOwnProperty.call(r,n)){const s=r[n],i=t[n];if(Array.isArray(s)){t[n]=[...s];continue}if(s&&typeof s=="object"&&i&&typeof i=="object"&&!Array.isArray(i)){t[n]=St({},i,s);continue}t[n]=s}}}return t}class Sl{constructor(){b(this,"_changes",{})}clear(e){return this._changes={},Promise.resolve()}write(e,r){return ma(this._changes,r),Promise.resolve()}getChanges(e){return Promise.resolve(this._changes)}getChangesForCollection(e,r){return Promise.resolve(this._changes[r])}getChangesForEntity(e,r,n){const s=this._changes[r];if(!s)return Promise.resolve(void 0);const i=s.sets.get(n);return i?Promise.resolve({update:i,delete:s.deletes.has(n)}):Promise.resolve(void 0)}isEmpty(e){return Promise.resolve(ar(this._changes))}}function ma(t,...e){for(const r of e)for(const n of Object.keys(r)){const s=r[n];if(s){t[n]||(t[n]={sets:new Map,deletes:new Set});for(const i of s.deletes)t[n].sets.delete(i),t[n].deletes.add(i);for(const[i,a]of s.sets.entries()){const o=t[n].sets.get(i);o?St(o,a):t[n].sets.set(i,a)}}}return t}function ar(t){for(const e in t)if(Object.hasOwn(t,e))return!1;return!0}function yf(t){for(const e in t)if(Object.hasOwn(t,e))if(typeof t[e]=="object"&&t[e]!==null&&!Array.isArray(t[e])){if(!yf(t[e]))return!1}else return!1;return!0}class mf{constructor(e=[]){b(this,"storagePrefix");this.storagePrefix=e}getEntity(e,r,n){return e.scope(this.storagePrefix).get([r,n])}async getCollectionStats(e,r){const n=e.scope(this.storagePrefix),s=new Map;if(r)for(const i of r){const a=await n.count({prefix:[i]});s.set(i,a)}else for await(const[[i]]of n.scan({prefix:[]}))s.set(i,(s.get(i)||0)+1);return s}async applyChanges(e,r,n){const s=e.scope(this.storagePrefix),i={},a=[],o=async(u,d,y)=>{const h=await this.getEntity(e,u,d),f=!!h;return n.entityChangeValidator&&n.entityChangeValidator(u,y,{ignoreRequiredProperties:f}),{collection:u,id:d,...ss(h,y),operation:f?"upsert":"insert"}},c=async(u,d,y)=>{const h=await this.getEntity(e,u,d);if(!h)return;n.entityChangeValidator&&n.entityChangeValidator(u,y,{ignoreRequiredProperties:!0});const f=ss(h,y);return{collection:u,id:d,...f,operation:"update"}},l=async(u,d)=>{if(n.checkWritePermission){const y=await this.getEntity(e,u,d);return{collection:u,id:d,prev:y,next:void 0,change:void 0,operation:"delete"}}return{collection:u,id:d,prev:void 0,next:void 0,change:void 0,operation:"delete"}};for(const[u,d]of Object.entries(r)){for(const y of d.deletes){const h=await l(u,y);await s.delete([u,y]),a.push(h)}for(const[y,h]of d.sets.entries()){const m=!!h.id?await o(u,y,h):await c(u,y,h);if(!m)continue;const{prev:v,next:g,change:S}=m;await s.set([u,y],g),a.push(m)}}for(const u of a){if(n.checkWritePermission)if(u.operation==="insert")await n.checkWritePermission(e,u.collection,u.next,"insert");else if(u.operation==="update"||u.operation==="upsert")await n.checkWritePermission(e,u.collection,u.prev,"update"),await n.checkWritePermission(e,u.collection,u.next,"postUpdate");else if(u.operation==="delete")await n.checkWritePermission(e,u.collection,u.prev,"delete");else throw new O("An invalid delta was created and could not finish permission checks.");if(i[u.collection]||(i[u.collection]={deletes:new Set,sets:new Map}),u.operation==="delete")i[u.collection].deletes.add(u.id);else{if(ar(u.change))continue;i[u.collection].sets.set(u.id,u.change)}}return i}getEntitiesInCollection(e,r){return e.scope(this.storagePrefix).scanValues({prefix:[r]})}}function ss(t,e,r={clone:!0}){if(!t)return{prev:t,next:e,change:e};const n=r.clone?structuredClone(t):t,s={};for(const[i,a]of Object.entries(e)){const o=n[i];if(typeof o=="object"&&o!=null&&typeof a=="object"&&a!=null&&!Array.isArray(a)){const{next:c,change:l}=ss(o,a,r);ar(l)||(s[i]=St(s[i]??{},l),n[i]=c)}else n[i]!==a&&(s[i]=a,n[i]=a)}return{prev:t,next:n,change:s}}class ga{constructor(e=[]){b(this,"storagePrefix");b(this,"metadataStore");b(this,"dataStore");this.storagePrefix=e,this.metadataStore=new VT([...this.storagePrefix,"metadata"]),this.dataStore=new mf([...this.storagePrefix,"data"])}async applyChanges(e,r,n){return this.dataStore.applyChanges(e,r,n)}async applyChangesWithTimestamp(e,r,n,s){const i=await this.metadataStore.applyChanges(e,r,n);return this.dataStore.applyChanges(e,i,s)}async getEntity(e,r,n){return this.dataStore.getEntity(e,r,n)}getEntitiesInCollection(e,r){return this.dataStore.getEntitiesInCollection(e,r)}getCollectionStats(e,r){return this.dataStore.getCollectionStats(e,r)}}class de{static Get(e,r){const n=typeof r=="string"?r.split("."):r;let s=e;for(const i of n){if(s===void 0)return;if(Array.isArray(s)){const a=parseInt(i,10);isNaN(a)?s=s.map(o=>o==null?void 0:o[i]):s=s[a]}else{if(s[i]===void 0)return;s=s[i]}}return s}static Set(e,r,n){const s=Array.isArray(r)?r:r.split(".");let i=e;for(let a=0;a<s.length-1;a++){const o=s[a];i[o]===void 0&&(i[o]={}),i=i[o]}i[s[s.length-1]]=n}}const gf=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"],Il=Object.fromEntries(gf.map((t,e)=>[t,e]));class HT{constructor(e,r){b(this,"logger");b(this,"spans");this.logger=e,this.spans=r}[Symbol.dispose](){this.logger._endSpans(this.spans)}}class xs{constructor(e,r,n="INFO"){b(this,"handlers");b(this,"loggerContext");b(this,"resourceAttributes");b(this,"exclusiveHandlerMode",!1);b(this,"logLevel","INFO");this.handlers=e??[],this.resourceAttributes=r||{},this.logLevel=n}registerHandler(e,r){return this.exclusiveHandlerMode?!1:(this.handlers.push(e),r!=null&&r.exclusive&&(this.exclusiveHandlerMode=!0),!0)}context(e){const r=new xs(this.handlers,this.resourceAttributes,this.logLevel);return r.loggerContext=e,r}setLogLevel(e){const r=e.toUpperCase();(gf.includes(r)||r==="NONE")&&(this.logLevel=r)}_log(e,r,n){if(this.logLevel==="NONE"||Il[e]<Il[this.logLevel])return;const s={level:e,message:r,timestamp:Date.now(),context:this.loggerContext,attributes:n,resource:this.resourceAttributes};for(const i of this.handlers)try{i.log(s)}catch(a){console.error("Error in log handler:",a)}}spanTrace(e,r){const n=this.handlers.map(s=>s.startSpan(e,this.loggerContext,{...this.resourceAttributes,...r}));return new HT(this,n)}trace(e,r){this._log("TRACE",e,r)}debug(e,r){this._log("DEBUG",e,r)}log(e,r){this.info(e,r)}info(e,r){this._log("INFO",e,r)}warn(e,r){this._log("WARN",e,r)}error(e,r){this._log("ERROR",e,r)}fatal(e,r){this._log("FATAL",e,r)}metric(e,r,n){for(const s of this.handlers)s.recordMetric(e,r,{...this.resourceAttributes,...n})}_endSpans(e){for(let r=0;r<e.length;r++){const n=e[r],s=this.handlers[r];s&&s.endSpan(n)}}}const Kr=new xs,WT=new Set(["$global","$session","$token","$role","$query"]);function Ie(t){return typeof t=="string"&&t[0]==="$"}function tt(t){const e=t.split(".");if(e.length<1)throw new Error(`Invalid variable: ${t}`);if(e.length===1)return e.unshift(void 0),e[1]=e[1].slice(1),e;const r=KT(e[0]);return r===void 0?(e.unshift(void 0),e[1]=e[1].slice(1),e):(e[0]=r,e)}function KT(t){if(WT.has(t))return t==="$token"?"$session":t;const e=parseInt(t.slice(1),10);if(!isNaN(e))return e}function co(t){return typeof t=="number"}function vf(t,e=1){if(!Ie(t))return t;const r=tt(t),n=r[0];return co(n)?`$${n+e}.${r.slice(1).join(".")}`:t}function va(t,e=1){const r=[];for(const n of t){if(re(n)){let[s,i,a]=n;a=vf(a,e),r.push([s,i,a]);continue}if(le(n)){r.push({...n,filters:va(n.filters,e)});continue}if(oe(n)){r.push({exists:bf(n.exists,e)});continue}ks(n)&&r.push({exists:{...n.exists,where:n.exists.where?va(n.exists.where,e):void 0}}),r.push(n)}return r}function bf(t,e=1){return t.where?{...t,where:va(t.where,e)}:t}function lo(t,e){var i;if(t in e)return e[t];const[r,...n]=tt(t);if(typeof r=="number"){if(!e.entityStack||e.entityStack.length<r)throw new Error(`Variable reference is out of bounds. Tried to find ${t} in stack of size ${(i=e.entityStack)==null?void 0:i.length}`);return de.Get(e.entityStack[e.entityStack.length-r],n)}return de.Get(e,n)}function Mr(t,e){return t.map(r=>QT(r,e))}function QT(t,e){if(le(t))return{mod:t.mod,filters:Mr(t.filters,e)};if(re(t)&&Ie(t[2])){const r=t[2];let n=lo(r,e);return Array.isArray(n)&&(n=new Set(n)),[t[0],t[1],n]}return t}async function ba(t,e,r){let n=!0;const s=XT(e);for(const i of s){const a=e[i];if(n=await ZT(t,a,r),!n)break}return n}async function ZT(t,e,r){if(le(e)){if(e.mod==="and")return await ba(t,e.filters,r);{let n=!1;for(const s of e.filters)if(n=await ba(t,[s],r),n)break;return n}}else if(oe(e)){const n=await r.fetch(e.exists,{entityStack:[t]});return Array.isArray(n)?n.length>0:!!n}else return or(t,e)}function or(t,e,r=!1){if(Lt(e))return e;if(le(e)){const{mod:n,filters:s}=e;return n==="and"?s.every(i=>or(t,i,r)):n==="or"?s.some(i=>or(t,i,r)):!1}if(oe(e)){if(r)return!0;throw new Error(`Subquery filters should be filtered out before this point, found ${e}`)}return GT(t,e)}function GT(t,e){const[r,n,s]=e,i=de.Get(t,r);return wf(i,n,s)}function wf(t,e,r){if(e.startsWith(ir)){if(typeof t!="object"&&t!==null&&t!==void 0)throw new qe(`The operator requires a set value, but got ${t}`);const n=e.slice(ir.length);if(n==="has"){if(_(t))return!1;for(const s of Object.keys(t)){if(!t[s])continue;if(Fi(s,r)===r)return!0}return!1}else if(n==="!has"){if(_(t))return!0;for(const s of Object.keys(t)){if(!t[s])continue;if(Fi(s,r)===r)return!1}return!0}else{if(n==="isDefined")return r?!_(t):_(t);if(_(t))return!1;for(const s of Object.keys(t)){if(!t[s])continue;const i=Fi(s,r);if(wf(i,n,r))return!0}return!1}}switch(e){case"=":return _(t)&&_(r)?!0:ke(t??null,r??null)===0;case"!=":return _(t)&&_(r)?!1:ke(t??null,r??null)!==0;case">":return _(t)?!1:_(r)?!0:ke(t,r)>0;case">=":return _(t)&&_(r)?!0:_(t)?!1:_(r)?!0:ke(t,r)>=0;case"<":return _(r)?!1:_(t)?!0:ke(t,r)<0;case"<=":return _(t)&&_(r)?!0:_(r)?!1:_(t)?!0:ke(t,r)<=0;case"like":return _(r)||_(t)?!1:El(t,r);case"nlike":return _(r)||_(t)?!0:!El(t,r);case"in":return _(t)||_(r)?!1:r instanceof Set?r.has(t):r instanceof Array?r.includes(t):r instanceof Object?!!r[t]:(Kr.warn('Invalid filter value for "in" operator'),!1);case"nin":return _(t)||_(r)?!0:r instanceof Set?!r.has(t):r instanceof Array?r.includes(t):r instanceof Object?!r[t]:(Kr.warn('Invalid filter value for "in" operator'),!1);case"isDefined":return r?!_(t):_(t);default:throw new qe(`The operator ${e} is not recognized.`)}}function Fi(t,e){return typeof e=="boolean"?t==="true":typeof e=="number"?parseFloat(t):t}function El(t,e){return e=e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),e=e.replace(/%/g,".*"),e=e.replace(/_/g,"."),new RegExp(`^${e}$`,"i").test(t)}function re(t){return t instanceof Array&&t.length===3&&typeof t[0]=="string"&&typeof t[1]=="string"}function uo(t){return re(t)&&t[0]==="id"}function qT(t){return uo(t)&&(t[1]==="="||t[1]==="in")}function le(t){return t instanceof Object&&"mod"in t}function oe(t){return t instanceof Object&&"exists"in t&&"collectionName"in t.exists}function ks(t){return t instanceof Object&&"exists"in t&&"_extends"in t.exists}function Lt(t){return typeof t=="boolean"}function JT(t){return re(t)||le(t)||oe(t)||ks(t)||Lt(t)}function $l(t){if(!re(t))return!1;const[e,r,n]=t;return!(!Ie(n)||!["=","<","<=",">",">=","!="].includes(r))}function YT(t){if(re(t))return"basic";if(oe(t))return"relational";if(le(t))return"group";if(Lt(t))return"boolean";throw new Error(`Filter type could not be determined: ${JSON.stringify(t)}`)}function XT(t){if(!t)return[];const e=[],r=[],n=[],s=[];for(let i=0;i<t.length;i++){const a=t[i];switch(YT(a)){case"boolean":r.push(i);break;case"basic":e.push(i);break;case"group":n.push(i);break;case"relational":s.push(i);break}}return[...r,...e,...n,...s]}function x(t){return{mod:"or",filters:t}}function eO(t){return{mod:"and",filters:t}}function tO(t,e={}){return{exists:{_extends:t,...e}}}function rO(t,e){for(const r of Ct(t))if(e(r))return!0;return!1}function*Ct(t){for(const e of t)le(e)?yield*Ct(e.filters):yield e}function fo(t){if(Lt(t)||re(t))return!0;if(le(t)){const{mod:e,filters:r}=t;return r.every(n=>fo(n))}return!(oe(t)||ks(t))}class Qr{static canCacheQuery(e){return!e.where||e.where.length===0?!0:(e.where??[]).filter($l).length!==0}static resolveQueryFromView(e,[r,n,s]){let i,a;if(["=","<","<=",">",">="].includes(n)&&(i=Ln(e,s,o=>o.data[r],"start",(o,c)=>n==="<"?o<c?0:1:n==="<="?o<=c?0:1:n===">"?o>c?0:-1:n===">="?o>=c?0:-1:o===c?0:o<c?-1:1),a=Ln(e,s,o=>o.data[r],"end",(o,c)=>n==="<"?o<c?0:1:n==="<="?o<=c?0:1:n===">"?o>c?0:-1:n===">="?o>=c?0:-1:o===c?0:o<c?-1:1)),n==="!=")return i=Ln(e,s,c=>c.data[r],"start",(c,l)=>c===l?0:c<l?-1:1),a=Ln(e,s,c=>c.data[r],"end",(c,l)=>c===l?0:c<l?-1:1),[...e.slice(0,i+1),...e.slice(a)];if(i==null||a==null)throw new UT(`Queries with the operator "${n}" in a where clause can't be stored in the query cache. Currently, supported operators are: ${["=","!=","<","<=",">",">="]}`);return e.slice(i,a+1)}static queryToViews(e){const r=[],n=[],s=[];for(const i of e.where??[]){if($l(i)){r.push(i);continue}if(fo(i)){n.push(i);continue}s.push(i)}return{views:[{collectionName:e.collectionName,where:n,order:[...r.map(i=>[i[0],"ASC"]),...e.order??[]],limit:r.length>0?void 0:e.limit,include:e.include}],variableFilters:r,unusedFilters:s}}}function Ln(t,e,r,n="start",s=(i,a)=>i<a?-1:i>a?1:0){let i=0,a=t.length-1,o=-1;for(;i<=a;){const c=Math.floor((i+a)/2),l=r(t[c]);s(l,e)===0?(o=c,n==="start"?a=c-1:i=c+1):s(l,e)<0?i=c+1:a=c-1}return o}async function*nO(t,e){let r=0;for await(const n of t){if(r>=e)return;yield n,r++}}async function*_l(t,e){for await(const r of t)await e(r)&&(yield r)}async function*sO(...t){for(const e of t)for await(const r of e)yield r}async function*iO(t,e){const r=new Set;for await(const n of t){const s=e?e(n):n;r.has(s)||(r.add(s),yield n)}}async function*Tl(t,e){for await(const r of t)yield e(r)}function wa(t,e,r){const[n,s]=e;if(!r||r.length!==n.length)throw new PT("The order and after cursor are not compatible");let i=!0;for(let a=0;a<n.length;a++){const o=n[a],c=r[a][0],l=r[a][1],u=de.Get(t,c)??pa,d=ke(u,o)*(l==="ASC"?1:-1);if(d<0){i=!1;break}if(d>0){i=!0;break}if(a===n.length-1){i=s;break}}return i}function aO(t){if(!t.where)return[null,-1];const e=t.where.findIndex(r=>re(r)&&qT(r));return e===-1?[null,-1]:[t.where[e],e]}function oO(t,e){return t.every(e)}function Q(t,e=2166136261){let r=e;for(let n=0;n<t.length;n++)r^=t.charCodeAt(n),r=Math.imul(r,16777619);return r>>>0}function Z(t,e){let r=t^e;return r=Math.imul(r,16777619),r>>>0}function is(t){function e(n){return typeof n!="object"||n===null?String(n):Array.isArray(n)?"["+n.map(e).join(",")+"]":"{"+Object.keys(n).sort().map(i=>`${i}:${e(n[i])}`).join(",")+"}"}const r=e(t);return Q(r)}function cO(t){return is(t).toString()}const lO=["after","collectionName","select","include","limit","order","vars","where"];function Mi(t){const e=Object.fromEntries(Object.entries(t).filter(([n])=>lO.includes(n)));return is(e).toString()}const uO=Q("C");function Xe(t){let e=uO;if(e=Z(e,Q(t.collectionName)),t.where){const r=If(t.where);e=Z(e,r)}if(t.order){const r=gO(t.order);e=Z(e,r)}if(t.limit!=null){const r=OO(t.limit);e=Z(e,r)}if(t.after){const r=_O(t.after);e=Z(e,r)}if(t.include){const r=EO(t.include);e=Z(e,r)}if(t.select){const r=SO(t.select);e=Z(e,r)}return e}const dO=Q("B"),fO=Q("S"),hO=Q("G"),pO=Q("Q");function Sf(t){if(Lt(t)){let e=dO;const r=t.toString();return e=Z(e,Q(r)),{hash:e,sortKey:`B|${r}`}}else if(re(t)){let e=fO;e=Z(e,Q(t[0])),e=Z(e,Q(t[1]));const r=Ef(t[2]);return e=Z(e,Q(r)),{hash:e,sortKey:`S|${t[0]}|${t[1]}|${r}`}}else if(le(t)){let e=hO;e=Z(e,Q(t.mod));const r=If(t.filters);return e=Z(e,r),{hash:e,sortKey:`G|${t.mod}|${r}`}}else if(oe(t)){let e=pO;const r=Xe(t.exists);return e=Z(e,r),{hash:e,sortKey:`Q|${e}`}}throw new O("Could not hash filter, it is not a valid filter type")}const yO=Q("F");function If(t){let e=yO;const r=t.map(Sf);r.sort((n,s)=>n.sortKey<s.sortKey?-1:n.sortKey>s.sortKey?1:0);for(const n of r)e=Z(e,n.hash);return e}const mO=Q("O");function gO(t){let e=mO;for(const r of t)e=Z(e,bO(r));return e}const vO=Q("o");function bO(t){let e=vO;return e=Z(e,Q(t[0])),e=Z(e,Q(t[1])),t[2]&&(e=Z(e,Xe(t[2].subquery))),e}const wO=Q("P");function SO(t){let e=wO;const r=[...t].sort();for(const n of r)e=Z(e,Q(n));return e}const IO=Q("I");function EO(t){let e=IO;const r=Object.entries(t).sort(([n],[s])=>n<s?-1:n>s?1:0);for(const[n,s]of r)e=Z(e,Q(n)),e=Z(e,Q(s.cardinality)),e=Z(e,Xe(s.subquery));return e}const $O=Q("A");function _O(t){let e=$O;const[r,n]=t;for(const s of r)e=Z(e,Q(Ef(s)));return e=Z(e,Q(n.toString())),e}const TO=Q("L");function OO(t){let e=TO;return e=Z(e,Q(t.toString())),e}const Ol={undefined:"a",...yt};function Ef(t){if(t===void 0)return Ol.undefined;if(t===null)return Ol.null;if(t===!0||t===!1)return yt.boolean+t;if(typeof t=="string")return yt.string+t;if(typeof t=="number")return yt.number+t;if(Array.isArray(t))return yt.array+JSON.stringify(t);if(typeof t=="object")return yt.object+JSON.stringify(t);throw new O(`Failed to encode hash value: ${t}`)}function Zr(t,e){const r={views:{},rootQuery:t};if(t.where){const{where:n,views:s}=Sa(t.where,e);t.where=n,Object.assign(r.views,s)}if(t.include)for(const[n,s]of Object.entries(t.include)){const{newViews:i,rewrittenQuery:a}=Cl(s.subquery,e);Object.assign(r.views,i),t.include[n]={...t.include[n],subquery:a}}if(t.order)for(let n=0;n<t.order.length;n++){const[s,i,a]=t.order[n];if(a==null)continue;const{newViews:o,rewrittenQuery:c}=Cl(a.subquery,e);Object.assign(r.views,o),t.order[n][2]={...a,subquery:c}}return r}function Cl(t,e){let r=null,n=null;const s=t.include&&Object.keys(t.include).length>0;if(Qr.canCacheQuery(t)&&!s){const i=e(),a=Qr.queryToViews(t),o=Zr(a.views[0],e);r={[i]:o.rootQuery,...o.views},n={...t,collectionName:`$view_${i}`,where:a.variableFilters}}else{const i=Zr(t,e);r=i.views,n=i.rootQuery}return{newViews:r,rewrittenQuery:n}}function Sa(t,e){var s,i;const r={},n=[];for(const a of t)if(oe(a)){const o=a.exists,c=o.where&&ho(o.where),l=(o.where??[]).filter(u=>re(u)&&Ie(u[2])&&tt(u[2])[0]===1);if(!c&&l.length<2){const u=e(),d=Zr(o,e);r[u]=d.rootQuery,Object.assign(r,d.views),d.rootQuery.where=(s=o.where)==null?void 0:s.filter(h=>!l.includes(h));const y=l.map(h=>[tt(h[2])[1],"in",`$view_${u}.${h[0]}`]);n.push(...y)}else if(Qr.canCacheQuery(o)){const u=e(),d=Qr.queryToViews(o),y=Zr(d.views[0],e),{where:h,views:f}=Sa(d.unusedFilters,e);(i=y.rootQuery.where)==null||i.concat(h),r[u]=y.rootQuery,Object.assign(r,y.views),Object.assign(r,f),n.push({exists:{...o,collectionName:`$view_${u}`,where:[...d.variableFilters,...h]}})}else n.push(a)}else if(le(a)){const{where:o,views:c}=Sa(a.filters,e);n.push({...a,filters:o}),Object.assign(r,c)}else n.push(a);return{where:n,views:r}}function ho(t){for(const e of Ct(t))if(re(e)&&Ie(e[2])){const[r]=tt(e[2]);if(typeof r=="number"&&r>1)return!0}else if(oe(e)&&ho(e.exists.where||[]))return!0;return!1}function CO(t){let e=0;const n=Zr(t,()=>`${e++}`);return RO(n)}function RO(t){const e={};for(const[s,i]of Object.entries(t.views)){const a=qt(i);e[s]={steps:a,views:{}}}const r=qt(t.rootQuery),n=[];return n.push(...r),{steps:n,views:e}}function xO(t,e=new Set){for(const r of Ct(t))re(r)&&$f(r)&&e.add(r[2]);return e}function $f(t){return Ie(t[2])&&t[2].startsWith("$view_")}function qt(t){const e=[];let r=!1,n=!1,s=!1,i=!1;const a=[],o=[];if(t.where)for(const d of t.where)if(fo(d))o.push(d);else if(oe(d))a.push(d);else throw new O(`Could not compile query: Unsupported filter type in where clause: ${JSON.stringify(d)}`);const c=t.after?{after:t.after,order:t.order}:void 0,[l,u]=aO(t);if(t.collectionName.startsWith("$view_")){const d=t.collectionName.slice(6);if(!oO(o,re))throw new O(`Filters on view ${d} must be simple filter statements.`);if(e.push({type:"PREPARE_VIEW",viewId:d}),e.push({type:"RESOLVE_FROM_VIEW",viewId:d,filter:o}),a.length>0){for(const y of a)e.push({type:"ITERATOR_SUBQUERY_FILTER",subPlan:qt(y.exists)});e.push({type:"COLLECT"})}n=!0,s=!0,i=!0}else if(l){if(typeof l[2]=="string"&&l[2].startsWith("$view_")){const d=l[2].split(".")[0].slice(6);e.push({type:"PREPARE_VIEW",viewId:d})}e.push({type:"ID_LOOK_UP",collectionName:t.collectionName,ids:Ie(l[2])?l[2]:typeof l[2]=="string"?new Set().add(l[2]):l[2]}),o.splice(u,1)}else e.push({type:"SCAN",collectionName:t.collectionName});if(o.length>0){const d=xO(o);if(d.size>0)for(const y of d){const h=y.split(".")[0].slice(6);e.push({type:"PREPARE_VIEW",viewId:h})}}if(!n){(o.length>0||c)&&(e.push({type:"ITERATOR_FILTER",filter:o,after:c}),s=!0);for(const d of a)e.push({type:"ITERATOR_SUBQUERY_FILTER",subPlan:qt(d.exists)});t.limit&&!t.order&&(e.push({type:"ITERATOR_LIMIT",count:t.limit}),r=!0),e.push({type:"COLLECT"})}if((o.length>0||c)&&!s&&(e.push({type:"FILTER",filter:o,after:c}),s=!0),t.order&&t.order.length>0&&!i){const d=[];for(let y=0;y<t.order.length;y++){const[h,f,m]=t.order[y];if(m==null){d.push(t.order[y]);continue}const v=`_order_${y}`,g=qt(m.subquery);e.push({type:"SUBQUERY",alias:v,subPlan:g});const S=h.split(".").toSpliced(0,1,v).join(".");d.push([S,f,m])}e.push({type:"SORT",fields:d})}if(typeof t.limit=="number"&&!r&&e.push({type:"LIMIT",count:t.limit}),t.include)for(const[d,y]of Object.entries(t.include)){const h=qt(y.subquery);y.cardinality==="one"&&h.push({type:"PICK"}),e.push({type:"SUBQUERY",alias:d,subPlan:h})}return e}function as(t){const e={views:new Map,rewrittenQuery:t};if(t.where){const{where:r,views:n}=_f(t.where);t.where=r,Lr(e.views,n)}if(t.include)for(const[r,n]of Object.entries(t.include)){const{views:s,rewrittenQuery:i}=as(n.subquery);Lr(e.views,s),t.include[r]={...t.include[r],subquery:i}}if(t.order)for(let r=0;r<t.order.length;r++){const[n,s,i]=t.order[r];if(i==null)continue;const{views:a,rewrittenQuery:o}=as(i.subquery);Lr(e.views,a),t.order[r][2]={...i,subquery:o}}return e}function Lr(t,e){for(const[r,n]of e.entries())t.has(r)||t.set(r,n)}function _f(t){var n;const e=new Map,r=[];for(const s of t)if(oe(s)){const i=s.exists,a=i.where&&ho(i.where),o=(i.where??[]).filter(c=>re(c)&&Ie(c[2])&&tt(c[2])[0]===1);if(!a&&o.length<2){const c=as(i);c.rewrittenQuery.where=(n=i.where)==null?void 0:n.filter(d=>!o.includes(d));const l=Xe(c.rewrittenQuery);e.set(l,c.rewrittenQuery),Lr(e,c.views);const u=o.map(d=>[tt(d[2])[1],"in",`$view_${l}.${d[0]}`]);r.push(...u)}else r.push(s)}else if(le(s)){const{where:i,views:a}=_f(s.filters);r.push({...s,filters:i}),Lr(e,a)}else r.push(s);return{where:r,views:e}}function os(t){return{data:t,subqueries:{}}}function cr(t){if(!t)return t;if(!("data"in t)||!("subqueries"in t))throw new Error('View entity is not properly formatted, expected "data" and "subqueries" keys but instead got: '+Object.keys(t));if(Object.keys(t.subqueries).length===0)return t.data;const e={};for(const[r,n]of Object.entries(t.subqueries))e[r]=Array.isArray(n)?n.map(cr):cr(n);return{...t.data,...e}}function cs(t){return Object.fromEntries(Object.entries(t).map(([r,n])=>[r,Array.isArray(n)?n.map(cr):cr(n)]))}class Br{constructor(e,r){b(this,"storage");b(this,"store");this.storage=e,this.store=r}async fetch(e,r={}){const n=CO(structuredClone(e)),s=await this.executeSteps(n.steps,{vars:r,viewPlans:n.views});if(Array.isArray(s))return s;throw new wl("many","one")}async executeSteps(e,{vars:r,viewPlans:n,preparedViews:s={}}){r.entityStack=r.entityStack||[];let i=[],a,o;for(const c of e)switch(c.type){case"PREPARE_VIEW":{const l=`view_${c.viewId}`;if(l in s)break;const{steps:u}=n[c.viewId],d=await this.executeSteps(u,{vars:r,viewPlans:n,preparedViews:s});s[l]=d;break}case"RESOLVE_FROM_VIEW":{const l=`view_${c.viewId}`,u=s[l];if(!u)throw new Error(`View ${c.viewId} not found`);if(!Array.isArray(u))throw new wl("many","one");const d=Mr(c.filter,r);i=[...u];for(const y of d)i=Qr.resolveQueryFromView(i,y);o=i;break}case"SUBQUERY":{const l=c.subPlan;for(const u of i){c.alias in u.subqueries;const d=await this.executeSteps(l,{vars:{...r,entityStack:(r.entityStack??[]).concat(cr(u))},viewPlans:n,preparedViews:s});u.subqueries[c.alias]=d}break}case"SCAN":{a=c.collectionName,o=this.getCollectionCandidates({collectionName:a});break}case"ID_LOOK_UP":{let l=c.ids;if(typeof l=="string"){if(!Ie(l))throw new O("Invalid ID_LOOK_UP input, expected variable or string[]");const u=lo(l,{...r,...cs(s)});l=Tf(u)}a=c.collectionName,o=this.getCollectionCandidatesById(a,new Set(l));break}case"COLLECT":{if(!o)throw new Error("No candidate iterator found when trying to COLLECT");i=await Array.fromAsync(o);break}case"ITERATOR_LIMIT":{if(!o)throw new Error("No candidate iterator found when trying to ITERATOR_LIMIT");o=nO(o,c.count);break}case"ITERATOR_FILTER":{const u=Mr(c.filter,{...r,...cs(s)}).map(d=>y=>or(y.data,d));c.after&&u.push(({data:d})=>!!wa(d,c.after.after,c.after.order)),o=_l(o,d=>{for(const y of u)if(!y(d))return!1;return!0});break}case"ITERATOR_SUBQUERY_FILTER":{const l=c.subPlan;o=_l(o,async u=>{const d=await this.executeSteps(l,{vars:{...r,entityStack:(r.entityStack??[]).concat(cr(u))},viewPlans:n,preparedViews:s});return Array.isArray(d)?d.length>0:d!==null});break}case"FILTER":{if(a==null)throw new Error("No collection name found when trying to FILTER");const l=Mr(c.filter,{...r,...s});i=i.filter(u=>{for(const d of l){let y=d;if(!or(u.data,y))return!1}return!(c.after&&!wa(u.data,c.after.after,c.after.order))});break}case"SORT":{Of(i,c.fields);break}case"LIMIT":{i=i.slice(0,c.count);break}case"PICK":return i[0]??null;default:throw new Error(`Unknown step type: ${c.type}`)}return i}async*getCollectionCandidates(e){for await(const r of this.store.getEntitiesInCollection(this.storage,e.collectionName))yield os(r)}async*getCollectionCandidatesById(e,r){let n=[];for(const s of r){const i=await this.store.getEntity(this.storage,e,s);i&&(yield os(i))}return n}}function Tf(t){let e=[];if(typeof t=="string")e=[t];else if(Array.isArray(t))e=t.flatMap(Tf);else if(typeof t=="object"&&t!==null)for(const[r,n]of Object.entries(t))n===!0&&e.push(r);return e}function Of(t,e){const r=e.map(([n,s,i])=>{const a=n.split(".");if(i){const o=Cf(i.subquery);return[a.slice(0,o+1).flatMap(c=>["subqueries",c]).concat("data",a.slice(-1)),s,i]}return[["data",...a],s]});t.sort((n,s)=>{for(const[i,a]of r){const o=ke(de.Get(n,i)??pa,de.Get(s,i)??pa);if(o!==0)return a==="ASC"?o:-o}return 0})}function Cf(t){let e=0;if(!t.include)return e;for(const r in t.include){const n=t.include[r];e=Math.max(e,Cf(n.subquery)+1)}return e}var Je={},kO=Qt&&Qt.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,s){n.__proto__=s}||function(n,s){for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(n[i]=s[i])},t(e,r)};return function(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function n(){this.constructor=e}e.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(Je,"__esModule",{value:!0});Je.EmptyBTree=Je.asSet=Je.simpleComparator=Je.defaultComparator=void 0;function Rf(t,e){if(Number.isFinite(t)&&Number.isFinite(e))return t-e;var r=typeof t,n=typeof e;if(r!==n)return r<n?-1:1;if(r==="object"){if(t===null)return e===null?0:-1;if(e===null)return 1;if(t=t.valueOf(),e=e.valueOf(),r=typeof t,n=typeof e,r!==n)return r<n?-1:1}return t<e?-1:t>e?1:t===e?0:Number.isNaN(t)?Number.isNaN(e)?0:-1:Number.isNaN(e)?1:Array.isArray(t)?0:Number.NaN}Je.defaultComparator=Rf;function AO(t,e){return t>e?1:t<e?-1:0}Je.simpleComparator=AO;var rt=function(){function t(e,r,n){this._root=Bi,this._size=0,this._maxNodeSize=n>=4?Math.min(n,256):32,this._compare=r||Rf,e&&this.setPairs(e)}return Object.defineProperty(t.prototype,"size",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return this._size},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isEmpty",{get:function(){return this._size===0},enumerable:!1,configurable:!0}),t.prototype.clear=function(){this._root=Bi,this._size=0},t.prototype.forEach=function(e,r){var n=this;return r!==void 0&&(e=e.bind(r)),this.forEachPair(function(s,i){return e(i,s,n)})},t.prototype.forEachPair=function(e,r){var n=this.minKey(),s=this.maxKey();return this.forRange(n,s,!0,e,r)},t.prototype.get=function(e,r){return this._root.get(e,r,this)},t.prototype.set=function(e,r,n){this._root.isShared&&(this._root=this._root.clone());var s=this._root.set(e,r,n,this);return s===!0||s===!1?s:(this._root=new NO([this._root,s]),!0)},t.prototype.has=function(e){return this.forRange(e,e,!0,void 0)!==0},t.prototype.delete=function(e){return this.editRange(e,e,!0,Rl)!==0},t.prototype.with=function(e,r,n){var s=this.clone();return s.set(e,r,n)||n?s:this},t.prototype.withPairs=function(e,r){var n=this.clone();return n.setPairs(e,r)!==0||r?n:this},t.prototype.withKeys=function(e,r){for(var n=this.clone(),s=!1,i=0;i<e.length;i++)s=n.set(e[i],void 0,!1)||s;return r&&!s?this:n},t.prototype.without=function(e,r){return this.withoutRange(e,e,!0,r)},t.prototype.withoutKeys=function(e,r){var n=this.clone();return n.deleteKeys(e)||!r?n:this},t.prototype.withoutRange=function(e,r,n,s){var i=this.clone();return i.deleteRange(e,r,n)===0&&s?this:i},t.prototype.filter=function(e,r){var n=this.greedyClone(),s;return n.editAll(function(i,a,o){if(!e(i,a,o))return s=kf}),!s&&r?this:n},t.prototype.mapValues=function(e){var r={},n=this.greedyClone();return n.editAll(function(s,i,a){return r.value=e(i,s,a),r}),n},t.prototype.reduce=function(e,r){for(var n=0,s=r,i=this.entries(this.minKey(),kr),a;!(a=i.next()).done;)s=e(s,a.value,n++,this);return s},t.prototype.entries=function(e,r){var n=this.findPath(e);if(n===void 0)return Wt();var s=n.nodequeue,i=n.nodeindex,a=n.leaf,o=r!==void 0?1:0,c=e===void 0?-1:a.indexOf(e,0,this._compare)-1;return Wt(function(){e:for(;;)switch(o){case 0:if(++c<a.keys.length)return{done:!1,value:[a.keys[c],a.values[c]]};o=2;continue;case 1:if(++c<a.keys.length)return r[0]=a.keys[c],r[1]=a.values[c],{done:!1,value:r};o=2;case 2:for(var l=-1;;){if(++l>=s.length){o=3;continue e}if(++i[l]<s[l].length)break}for(;l>0;l--)s[l-1]=s[l][i[l]].children,i[l-1]=0;a=s[0][i[0]],c=-1,o=r!==void 0?1:0;continue;case 3:return{done:!0,value:void 0}}})},t.prototype.entriesReversed=function(e,r,n){if(e===void 0&&(e=this.maxKey(),n=void 0,e===void 0))return Wt();var s=this.findPath(e)||this.findPath(this.maxKey()),i=s.nodequeue,a=s.nodeindex,o=s.leaf;Te(!i[0]||o===i[0][a[0]],"wat!");var c=o.indexOf(e,0,this._compare);!n&&c<o.keys.length&&this._compare(o.keys[c],e)<=0&&c++;var l=r!==void 0?1:0;return Wt(function(){e:for(;;)switch(l){case 0:if(--c>=0)return{done:!1,value:[o.keys[c],o.values[c]]};l=2;continue;case 1:if(--c>=0)return r[0]=o.keys[c],r[1]=o.values[c],{done:!1,value:r};l=2;case 2:for(var u=-1;;){if(++u>=i.length){l=3;continue e}if(--a[u]>=0)break}for(;u>0;u--)i[u-1]=i[u][a[u]].children,a[u-1]=i[u-1].length-1;o=i[0][a[0]],c=o.keys.length,l=r!==void 0?1:0;continue;case 3:return{done:!0,value:void 0}}})},t.prototype.findPath=function(e){var r=this._root,n,s;if(r.isLeaf)n=xl,s=xl;else{n=[],s=[];for(var i=0;!r.isLeaf;i++){if(n[i]=r.children,s[i]=e===void 0?0:r.indexOf(e,0,this._compare),s[i]>=n[i].length)return;r=n[i][s[i]]}n.reverse(),s.reverse()}return{nodequeue:n,nodeindex:s,leaf:r}},t.prototype.diffAgainst=function(e,r,n,s){if(e._compare!==this._compare)throw new Error("Tree comparators are not the same.");if(this.isEmpty||e.isEmpty)return this.isEmpty&&e.isEmpty?void 0:this.isEmpty?n===void 0?void 0:t.stepToEnd(t.makeDiffCursor(e),n):r===void 0?void 0:t.stepToEnd(t.makeDiffCursor(this),r);for(var i=this._compare,a=t.makeDiffCursor(this),o=t.makeDiffCursor(e),c=!0,l=!0,u=t.compare(a,o,i);c&&l;){var d=t.compare(a,o,i),y=a.leaf,h=a.internalSpine,f=a.levelIndices,m=o.leaf,v=o.internalSpine,g=o.levelIndices;if(y||m){if(u!==0){if(d===0){if(y&&m&&s){var S=y.values[f[f.length-1]],C=m.values[g[g.length-1]];if(!Object.is(S,C)){var N=s(a.currentKey,S,C);if(N&&N.break)return N.break}}}else if(d>0){if(m&&n){var U=m.values[g[g.length-1]],N=n(o.currentKey,U);if(N&&N.break)return N.break}}else if(r&&y&&u!==0){var S=y.values[f[f.length-1]],N=r(a.currentKey,S);if(N&&N.break)return N.break}}}else if(!y&&!m&&d===0){var P=h.length-1,K=v.length-1,G=h[P][f[P]],se=v[K][g[K]];if(se===G){u=0,c=t.step(a,!0),l=t.step(o,!0);continue}}u=d,d<0?c=t.step(a):l=t.step(o)}if(c&&r)return t.finishCursorWalk(a,o,i,r);if(l&&n)return t.finishCursorWalk(o,a,i,n)},t.finishCursorWalk=function(e,r,n,s){var i=t.compare(e,r,n);if(i===0){if(!t.step(e))return}else i<0&&Te(!1,"cursor walk terminated early");return t.stepToEnd(e,s)},t.stepToEnd=function(e,r){for(var n=!0;n;){var s=e.leaf,i=e.levelIndices,a=e.currentKey;if(s){var o=s.values[i[i.length-1]],c=r(a,o);if(c&&c.break)return c.break}n=t.step(e)}},t.makeDiffCursor=function(e){var r=e._root,n=e.height;return{height:n,internalSpine:[[r]],levelIndices:[0],leaf:void 0,currentKey:r.maxKey()}},t.step=function(e,r){var n=e.internalSpine,s=e.levelIndices,i=e.leaf;if(r===!0||i){var a=s.length;if(r===!0||s[a-1]===0){var o=n.length;if(o===0)return!1;for(var c=o-1,l=c;l>=0;){if(s[l]>0)return l<a-1&&(e.leaf=void 0,s.pop()),l<c&&(e.internalSpine=n.slice(0,l+1)),e.currentKey=n[l][--s[l]].maxKey(),!0;l--}return!1}else{var u=--s[a-1];return e.currentKey=i.keys[u],!0}}else{var d=n.length,y=d-1,h=n[y][s[y]];if(h.isLeaf){e.leaf=h;var u=s[d]=h.values.length-1;e.currentKey=h.keys[u]}else{var f=h.children;n[d]=f;var m=f.length-1;s[d]=m,e.currentKey=f[m].maxKey()}return!0}},t.compare=function(e,r,n){var s=e.height,i=e.currentKey,a=e.levelIndices,o=r.height,c=r.currentKey,l=r.levelIndices,u=n(c,i);if(u!==0)return u;var d=s<o?s:o,y=a.length-(s-d),h=l.length-(o-d);return y-h},t.prototype.keys=function(e){var r=this.entries(e,kr);return Wt(function(){var n=r.next();return n.value&&(n.value=n.value[0]),n})},t.prototype.values=function(e){var r=this.entries(e,kr);return Wt(function(){var n=r.next();return n.value&&(n.value=n.value[1]),n})},Object.defineProperty(t.prototype,"maxNodeSize",{get:function(){return this._maxNodeSize},enumerable:!1,configurable:!0}),t.prototype.minKey=function(){return this._root.minKey()},t.prototype.maxKey=function(){return this._root.maxKey()},t.prototype.clone=function(){this._root.isShared=!0;var e=new t(void 0,this._compare,this._maxNodeSize);return e._root=this._root,e._size=this._size,e},t.prototype.greedyClone=function(e){var r=new t(void 0,this._compare,this._maxNodeSize);return r._root=this._root.greedyClone(e),r._size=this._size,r},t.prototype.toArray=function(e){e===void 0&&(e=2147483647);var r=this.minKey(),n=this.maxKey();return r!==void 0?this.getRange(r,n,!0,e):[]},t.prototype.keysArray=function(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,function(r,n){e.push(r)}),e},t.prototype.valuesArray=function(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,function(r,n){e.push(n)}),e},t.prototype.toString=function(){return this.toArray().toString()},t.prototype.setIfNotPresent=function(e,r){return this.set(e,r,!1)},t.prototype.nextHigherPair=function(e,r){return r=r||[],e===void 0?this._root.minPair(r):this._root.getPairOrNextHigher(e,this._compare,!1,r)},t.prototype.nextHigherKey=function(e){var r=this.nextHigherPair(e,kr);return r&&r[0]},t.prototype.nextLowerPair=function(e,r){return r=r||[],e===void 0?this._root.maxPair(r):this._root.getPairOrNextLower(e,this._compare,!1,r)},t.prototype.nextLowerKey=function(e){var r=this.nextLowerPair(e,kr);return r&&r[0]},t.prototype.getPairOrNextLower=function(e,r){return this._root.getPairOrNextLower(e,this._compare,!0,r||[])},t.prototype.getPairOrNextHigher=function(e,r){return this._root.getPairOrNextHigher(e,this._compare,!0,r||[])},t.prototype.changeIfPresent=function(e,r){return this.editRange(e,e,!0,function(n,s){return{value:r}})!==0},t.prototype.getRange=function(e,r,n,s){s===void 0&&(s=67108863);var i=[];return this._root.forRange(e,r,n,!1,this,0,function(a,o){return i.push([a,o]),i.length>s?DO:void 0}),i},t.prototype.setPairs=function(e,r){for(var n=0,s=0;s<e.length;s++)this.set(e[s][0],e[s][1],r)&&n++;return n},t.prototype.forRange=function(e,r,n,s,i){var a=this._root.forRange(e,r,n,!1,this,i||0,s);return typeof a=="number"?a:a.break},t.prototype.editRange=function(e,r,n,s,i){var a=this._root;a.isShared&&(this._root=a=a.clone());try{var o=a.forRange(e,r,n,!0,this,i||0,s);return typeof o=="number"?o:o.break}finally{for(var c=void 0;a.keys.length<=1&&!a.isLeaf;)c||(c=a.isShared),this._root=a=a.keys.length===0?Bi:a.children[0];c&&(a.isShared=!0)}},t.prototype.editAll=function(e,r){return this.editRange(this.minKey(),this.maxKey(),!0,e,r)},t.prototype.deleteRange=function(e,r,n){return this.editRange(e,r,n,Rl)},t.prototype.deleteKeys=function(e){for(var r=0,n=0;r<e.length;r++)this.delete(e[r])&&n++;return n},Object.defineProperty(t.prototype,"height",{get:function(){for(var e=this._root,r=-1;e;)r++,e=e.isLeaf?void 0:e.children[0];return r},enumerable:!1,configurable:!0}),t.prototype.freeze=function(){var e=this;e.clear=e.set=e.editRange=function(){throw new Error("Attempted to modify a frozen BTree")}},t.prototype.unfreeze=function(){delete this.clear,delete this.set,delete this.editRange},Object.defineProperty(t.prototype,"isFrozen",{get:function(){return this.hasOwnProperty("editRange")},enumerable:!1,configurable:!0}),t.prototype.checkValid=function(){var e=this._root.checkValid(0,this,0);Te(e===this.size,"size mismatch: counted ",e,"but stored",this.size)},t}(),Li=Je.default=rt;function PO(t){return t}Je.asSet=PO;Symbol&&Symbol.iterator&&(rt.prototype[Symbol.iterator]=rt.prototype.entries);rt.prototype.where=rt.prototype.filter;rt.prototype.setRange=rt.prototype.setPairs;rt.prototype.add=rt.prototype.set;function Wt(t){t===void 0&&(t=function(){return{done:!0,value:void 0}});var e={next:t};return Symbol&&Symbol.iterator&&(e[Symbol.iterator]=function(){return this}),e}var xf=function(){function t(e,r){e===void 0&&(e=[]),this.keys=e,this.values=r||ce,this.isShared=void 0}return Object.defineProperty(t.prototype,"isLeaf",{get:function(){return this.children===void 0},enumerable:!1,configurable:!0}),t.prototype.maxKey=function(){return this.keys[this.keys.length-1]},t.prototype.indexOf=function(e,r,n){for(var s=this.keys,i=0,a=s.length,o=a>>1;i<a;){var c=n(s[o],e);if(c<0)i=o+1;else if(c>0)a=o;else{if(c===0)return o;if(e===e)return s.length;throw new Error("BTree: NaN was used as a key")}o=i+a>>1}return o^r},t.prototype.minKey=function(){return this.keys[0]},t.prototype.minPair=function(e){if(this.keys.length!==0)return e[0]=this.keys[0],e[1]=this.values[0],e},t.prototype.maxPair=function(e){if(this.keys.length!==0){var r=this.keys.length-1;return e[0]=this.keys[r],e[1]=this.values[r],e}},t.prototype.clone=function(){var e=this.values;return new t(this.keys.slice(0),e===ce?e:e.slice(0))},t.prototype.greedyClone=function(e){return this.isShared&&!e?this:this.clone()},t.prototype.get=function(e,r,n){var s=this.indexOf(e,-1,n._compare);return s<0?r:this.values[s]},t.prototype.getPairOrNextLower=function(e,r,n,s){var i=this.indexOf(e,-1,r),a=i<0?~i-1:n?i:i-1;if(a>=0)return s[0]=this.keys[a],s[1]=this.values[a],s},t.prototype.getPairOrNextHigher=function(e,r,n,s){var i=this.indexOf(e,-1,r),a=i<0?~i:n?i:i+1,o=this.keys;if(a<o.length)return s[0]=o[a],s[1]=this.values[a],s},t.prototype.checkValid=function(e,r,n){var s=this.keys.length,i=this.values.length;return Te(this.values===ce?s<=i:s===i,"keys/values length mismatch: depth",e,"with lengths",s,i,"and baseIndex",n),Te(e==0||s>0,"empty leaf at depth",e,"and baseIndex",n),s},t.prototype.set=function(e,r,n,s){var i=this.indexOf(e,-1,s._compare);if(i<0){if(i=~i,s._size++,this.keys.length<s._maxNodeSize)return this.insertInLeaf(i,e,r,s);var a=this.splitOffRightSide(),o=this;return i>this.keys.length&&(i-=this.keys.length,o=a),o.insertInLeaf(i,e,r,s),a}else return n!==!1&&(r!==void 0&&this.reifyValues(),this.keys[i]=e,this.values[i]=r),!1},t.prototype.reifyValues=function(){return this.values===ce?this.values=this.values.slice(0,this.keys.length):this.values},t.prototype.insertInLeaf=function(e,r,n,s){if(this.keys.splice(e,0,r),this.values===ce){for(;ce.length<s._maxNodeSize;)ce.push(void 0);if(n===void 0)return!0;this.values=ce.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0},t.prototype.takeFromRight=function(e){var r=this.values;e.values===ce?r!==ce&&r.push(void 0):(r=this.reifyValues(),r.push(e.values.shift())),this.keys.push(e.keys.shift())},t.prototype.takeFromLeft=function(e){var r=this.values;e.values===ce?r!==ce&&r.unshift(void 0):(r=this.reifyValues(),r.unshift(e.values.pop())),this.keys.unshift(e.keys.pop())},t.prototype.splitOffRightSide=function(){var e=this.keys.length>>1,r=this.keys.splice(e),n=this.values===ce?ce:this.values.splice(e);return new t(r,n)},t.prototype.forRange=function(e,r,n,s,i,a,o){var c=i._compare,l,u;if(r===e){if(!n||(u=(l=this.indexOf(e,-1,c))+1,l<0))return a}else l=this.indexOf(e,0,c),u=this.indexOf(r,-1,c),u<0?u=~u:n===!0&&u++;var d=this.keys,y=this.values;if(o!==void 0)for(var h=l;h<u;h++){var f=d[h],m=o(f,y[h],a++);if(m!==void 0){if(s===!0){if(f!==d[h]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in editRange");m.delete?(this.keys.splice(h,1),this.values!==ce&&this.values.splice(h,1),i._size--,h--,u--):m.hasOwnProperty("value")&&(y[h]=m.value)}if(m.break!==void 0)return m}}else a+=u-l;return a},t.prototype.mergeSibling=function(e,r){if(this.keys.push.apply(this.keys,e.keys),this.values===ce){if(e.values===ce)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())},t}(),NO=function(t){kO(e,t);function e(r,n){var s=this;if(!n){n=[];for(var i=0;i<r.length;i++)n[i]=r[i].maxKey()}return s=t.call(this,n)||this,s.children=r,s}return e.prototype.clone=function(){for(var r=this.children.slice(0),n=0;n<r.length;n++)r[n].isShared=!0;return new e(r,this.keys.slice(0))},e.prototype.greedyClone=function(r){if(this.isShared&&!r)return this;for(var n=new e(this.children.slice(0),this.keys.slice(0)),s=0;s<n.children.length;s++)n.children[s]=n.children[s].greedyClone(r);return n},e.prototype.minKey=function(){return this.children[0].minKey()},e.prototype.minPair=function(r){return this.children[0].minPair(r)},e.prototype.maxPair=function(r){return this.children[this.children.length-1].maxPair(r)},e.prototype.get=function(r,n,s){var i=this.indexOf(r,0,s._compare),a=this.children;return i<a.length?a[i].get(r,n,s):void 0},e.prototype.getPairOrNextLower=function(r,n,s,i){var a=this.indexOf(r,0,n),o=this.children;if(a>=o.length)return this.maxPair(i);var c=o[a].getPairOrNextLower(r,n,s,i);return c===void 0&&a>0?o[a-1].maxPair(i):c},e.prototype.getPairOrNextHigher=function(r,n,s,i){var a=this.indexOf(r,0,n),o=this.children,c=o.length;if(!(a>=c)){var l=o[a].getPairOrNextHigher(r,n,s,i);return l===void 0&&a<c-1?o[a+1].minPair(i):l}},e.prototype.checkValid=function(r,n,s){var i=this.keys.length,a=this.children.length;Te(i===a,"keys/children length mismatch: depth",r,"lengths",i,a,"baseIndex",s),Te(i>1||r>0,"internal node has length",i,"at depth",r,"baseIndex",s);for(var o=0,c=this.children,l=this.keys,u=0,d=0;d<a;d++)o+=c[d].checkValid(r+1,n,s+o),u+=c[d].keys.length,Te(o>=u,"wtf",s),Te(d===0||c[d-1].constructor===c[d].constructor,"type mismatch, baseIndex:",s),c[d].maxKey()!=l[d]&&Te(!1,"keys[",d,"] =",l[d],"is wrong, should be ",c[d].maxKey(),"at depth",r,"baseIndex",s),d===0||n._compare(l[d-1],l[d])<0||Te(!1,"sort violation at depth",r,"index",d,"keys",l[d-1],l[d]);var y=u===0;return(y||u>n.maxNodeSize*a)&&Te(!1,y?"too few":"too many","children (",u,o,") at depth",r,"maxNodeSize:",n.maxNodeSize,"children.length:",a,"baseIndex:",s),o},e.prototype.set=function(r,n,s,i){var a=this.children,o=i._maxNodeSize,c=i._compare,l=Math.min(this.indexOf(r,0,c),a.length-1),u=a[l];if(u.isShared&&(a[l]=u=u.clone()),u.keys.length>=o){var d;l>0&&(d=a[l-1]).keys.length<o&&c(u.keys[0],r)<0?(d.isShared&&(a[l-1]=d=d.clone()),d.takeFromRight(u),this.keys[l-1]=d.maxKey()):(d=a[l+1])!==void 0&&d.keys.length<o&&c(u.maxKey(),r)<0&&(d.isShared&&(a[l+1]=d=d.clone()),d.takeFromLeft(u),this.keys[l]=a[l].maxKey())}var y=u.set(r,n,s,i);if(y===!1)return!1;if(this.keys[l]=u.maxKey(),y===!0)return!0;if(this.keys.length<o)return this.insert(l+1,y),!0;var h=this.splitOffRightSide(),f=this;return c(y.maxKey(),this.maxKey())>0&&(f=h,l-=this.keys.length),f.insert(l+1,y),h},e.prototype.insert=function(r,n){this.children.splice(r,0,n),this.keys.splice(r,0,n.maxKey())},e.prototype.splitOffRightSide=function(){var r=this.children.length>>1;return new e(this.children.splice(r),this.keys.splice(r))},e.prototype.takeFromRight=function(r){this.keys.push(r.keys.shift()),this.children.push(r.children.shift())},e.prototype.takeFromLeft=function(r){this.keys.unshift(r.keys.pop()),this.children.unshift(r.children.pop())},e.prototype.forRange=function(r,n,s,i,a,o,c){var l=a._compare,u=this.keys,d=this.children,y=this.indexOf(r,0,l),h=y,f=Math.min(n===r?y:this.indexOf(n,0,l),u.length-1);if(i){if(h<=f)try{for(;h<=f;h++){d[h].isShared&&(d[h]=d[h].clone());var m=d[h].forRange(r,n,s,i,a,o,c);if(u[h]=d[h].maxKey(),typeof m!="number")return m;o=m}}finally{var v=a._maxNodeSize>>1;for(y>0&&y--,h=f;h>=y;h--)d[h].keys.length<=v&&(d[h].keys.length!==0?this.tryMerge(h,a._maxNodeSize):(u.splice(h,1),d.splice(h,1)));d.length!==0&&d[0].keys.length===0&&Te(!1,"emptiness bug")}}else for(;h<=f;h++){var m=d[h].forRange(r,n,s,i,a,o,c);if(typeof m!="number")return m;o=m}return o},e.prototype.tryMerge=function(r,n){var s=this.children;return r>=0&&r+1<s.length&&s[r].keys.length+s[r+1].keys.length<=n?(s[r].isShared&&(s[r]=s[r].clone()),s[r].mergeSibling(s[r+1],n),s.splice(r+1,1),this.keys.splice(r+1,1),this.keys[r]=s[r].maxKey(),!0):!1},e.prototype.mergeSibling=function(r,n){var s=this.keys.length;this.keys.push.apply(this.keys,r.keys);var i=r.children;if(this.children.push.apply(this.children,i),r.isShared&&!this.isShared)for(var a=0;a<i.length;a++)i[a].isShared=!0;this.tryMerge(s-1,n)},e}(xf),ce=[],kf={delete:!0},Rl=function(){return kf},DO={break:!0},Bi=function(){var t=new xf;return t.isShared=!0,t}(),xl=[],kr=[];function Te(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(!t)throw e.unshift("B+ tree"),new Error(e.join(" "))}Je.EmptyBTree=function(){var t=new rt;return t.freeze(),t}();class As{constructor(e,r,n){b(this,"storage");b(this,"sets");b(this,"deletes");b(this,"_status","open");this.storage=e,this.sets=r??new lr,this.deletes=n??new lr}get status(){return this._status}scope(e){return new As(this.storage.scope(e),this.sets.scope(e),this.deletes.scope(e))}async clear(e){this.checkTxStatusBeforeOperation(),await this.sets.clear(e),await this.deletes.clear(e)}async get(e,r){this.checkTxStatusBeforeOperation();const n=await this.deletes.get(e,r)===null,s=await this.sets.get(e,r);if(n)return s;const i=await this.storage.get(e,r);return s===void 0?i:s}async set(e,r,n){return this.checkTxStatusBeforeOperation(),this.sets.set(e,r,n)}async delete(e,r){return this.checkTxStatusBeforeOperation(),await this.sets.delete(e,r),this.deletes.set(e,null,r)}async*scan(e,r){var n;this.checkTxStatusBeforeOperation();for await(const[s,i]of iO(sO(this.storage.scan(e,r),this.sets.scan(e,r),this.deletes.scan(e,r)),([a])=>JSON.stringify(a))){const a=(n=e.prefix)!=null&&n.length?[...e.prefix,...s]:s,o=await this.sets.get(a,r),c=await this.deletes.get(a,r)===null;if(!c&&o===void 0){yield[s,i];continue}c&&o===void 0||(yield[s,o])}}async*scanValues(e,r){yield*Tl(this.scan(e,r),([n,s])=>s)}async count(e,r){this.checkTxStatusBeforeOperation();let n=0;for await(const[s]of this.scan({prefix:e.prefix},r))n++;return Promise.resolve(n)}async commit(){this.checkTxStatusBeforeOperation(),await this.storage.applyEdits(this.sets.scan({prefix:[]}),Tl(this.deletes.scan({prefix:[]}),e=>e[0])),this._status="committed"}checkTxStatusBeforeOperation(){if(this._status!=="open"){if(this._status==="committed")throw new AT;if(this._status==="cancelled")throw new Wn}}cancel(){this.checkTxStatusBeforeOperation(),this._status="cancelled"}}class Ps{constructor(e,r){b(this,"store");b(this,"prefix");this.store=e,this.prefix=r}scope(e){return new Ps(this.store,[...this.prefix,...e])}get(e){return this.store.get(e,this.prefix)}set(e,r){return this.store.set(e,r,this.prefix)}delete(e){return this.store.delete(e,this.prefix)}scan(e){return this.store.scan(e,this.prefix)}scanValues(e){return this.store.scanValues(e,this.prefix)}clear(){return this.store.clear(this.prefix)}count(e){return this.store.count(e,this.prefix)}transact(){return new po(this.store.transact(),this.prefix)}applyEdits(e,r){return this.store.applyEdits(e,r)}}class po{constructor(e,r){b(this,"tx");b(this,"prefix");this.tx=e,this.prefix=r}scope(e){return new po(this.tx,[...this.prefix,...e])}get(e){return this.tx.get(e,this.prefix)}set(e,r){return this.tx.set(e,r,this.prefix)}delete(e){return this.tx.delete(e,this.prefix)}scan(e){return this.tx.scan(e,this.prefix)}scanValues(e){return this.tx.scanValues(e,this.prefix)}clear(){return this.tx.clear(this.prefix)}count(e){return this.tx.count(e,this.prefix)}commit(){return this.tx.commit()}cancel(){return this.tx.cancel()}get status(){return this.tx.status}}const jO="default"in Li?Li.default:Li;class lr{constructor(e){b(this,"data");this.data=e??new jO(void 0,ns)}get(e,r){const n=r?[...r,...e]:e;return Promise.resolve(this.data.get(n))}set(e,r,n){const s=n?[...n,...e]:e;return this.data.set(s,r),Promise.resolve()}delete(e,r){const n=r?[...r,...e]:e;return this.data.delete(n),Promise.resolve()}*scan(e,r){const n=r?[...r,...e.prefix]:e.prefix,s=[...n,"ï¿¿"],i=[];this.data.forRange(n,s,!1,(a,o)=>{const c=((r==null?void 0:r.length)??0)+e.prefix.length,l=c>0?a.slice(c):a;l.length!==0&&i.push([l,o])}),yield*i}*scanValues(e,r){const n=r?[...r,...e.prefix]:e.prefix,s=[...n,"ï¿¿"],i=[];this.data.forRange(n,s,!1,(a,o)=>{i.push(o)}),yield*i}count(e,r){const n=r?[...r,...e.prefix]:e.prefix;if(!n.length)return this.data.size;const s=[...n,"ï¿¿"];return this.data.forRange(n,s,!1)}transact(){return new As(this)}async clear(e){if(!(e!=null&&e.length)){this.data.clear();return}for await(const[r]of this.scan({prefix:e}))await this.delete(r,e)}scope(e){return new Ps(this,e)}async applyEdits(e,r){for await(const n of r)this.data.delete(n);for await(const[n,s]of e)this.data.set(n,s)}}class Af{constructor(e,r){b(this,"_buffers");b(this,"activeBufferIndex",0);this._buffers=[e,r]}get activeBuffer(){return this._buffers[this.activeBufferIndex]}get inactiveBuffer(){return this._buffers[1-this.activeBufferIndex]}async getChangesForCollection(e,r){const[n,s]=await Promise.all([this.inactiveBuffer.getChangesForCollection(e,r),this.activeBuffer.getChangesForCollection(e,r)]);if(!(!n&&!s))return n?s?ma({},{[r]:n},{[r]:s})[r]:n:s}async getChangesForEntity(e,r,n){const s=await this.inactiveBuffer.getChangesForEntity(e,r,n),i=await this.activeBuffer.getChangesForEntity(e,r,n);if(!s&&!i)return;const a=!!(s!=null&&s.delete||i!=null&&i.delete);return{update:St({},s==null?void 0:s.update,i==null?void 0:i.update),delete:a}}async clear(e){await Promise.all(this._buffers.map(r=>r.clear(e)))}async clearChangesForEntity(e,r,n){await Promise.all(this._buffers.map(s=>s.clearChangesForEntity(e,r,n)))}async write(e,r){await this.activeBuffer.write(e,r)}async isEmpty(e){return(await Promise.all([this.activeBuffer.isEmpty(e),this.inactiveBuffer.isEmpty(e)])).every(r=>r)}async getChanges(e){const r=await Promise.all([this.getLockedBuffer().getChanges(e),this.getUnlockedBuffer().getChanges(e)]);return ma({},r[0],r[1])}lockAndSwitchBuffers(){this.activeBufferIndex=this.activeBufferIndex===0?1:0}getLockedBuffer(){return this.inactiveBuffer}getUnlockedBuffer(){return this.activeBuffer}}function Kn(t,e=[],r=new Map){var n;if(e.push(t),t.where){for(const s of Ct(t.where))if(oe(s))Kn(s.exists,e,r);else if(re(s)&&Ie(s[2])){const[i,a]=tt(s[2]);if(co(i)){const o=e[e.length-i-1];if(o){const c=Xe(o);r.has(c)||r.set(c,new Set),(n=r.get(c))==null||n.add(a)}}}}if(t.include)for(const s in t.include){const{subquery:i}=t.include[s];Kn(i,e,r)}if(t.order)for(const s of t.order){const i=s[2];i&&Kn(i.subquery,e,r)}return e.pop(),r}function Qn(t,e=[],r=new Map){var s;for(const i of e)(s=r.get(i))==null||s.add(t.collectionName);const n=Xe(t);if(e.push(n),r.set(n,new Set().add(t.collectionName)),t.where){for(const i of Ct(t.where))if(oe(i)){const{exists:a}=i;Qn(a,e,r)}}if(t.include)for(const i in t.include){const{subquery:a}=t.include[i];Qn(a,e,r)}if(t.order)for(const i of t.order){const a=i[2];a&&Qn(a.subquery,e,r)}return e.pop(),r}function ls(t){if(t.where&&rO(t.where,oe))return!0;if(t.include)for(const e in t.include){const{subquery:r}=t.include[e];if(ls(r))return!0}if(t.order)for(const e of t.order){const r=e[2];if(r&&ls(r.subquery))return!0}return!1}function yo(t){if(t.order){for(const e of t.order)if(e[2])return!0}if(t.include)for(const e in t.include){const{subquery:r}=t.include[e];if(yo(r))return!0}return!1}function us(t,e,r=!0){if(r&&(t=JSON.parse(JSON.stringify(t))),t.where&&(t.where=Pf(t.where,e)),t.include)for(const n in t.include)t.include[n].subquery=us(t.include[n].subquery,e,!1);if(t.order)for(const n of t.order){const s=n[2];s&&(s.subquery=us(s.subquery,e,!1))}return t}function Pf(t,e){return t.map(r=>FO(r,e))}function FO(t,e){if(le(t))return{mod:t.mod,filters:Pf(t.filters,e)};if(re(t)&&Ie(t[2])&&t[2].startsWith("$view_")){const r=t[2];let n=lo(r,e);return Array.isArray(n)&&(n=new Set(n)),[t[0],t[1],n]}return t}function Nf(t){const e=structuredClone(t);let r=0;if(e.where)for(const n of Ct(e.where))oe(n)&&(e.include||(e.include={}),e.include[`_exists-${r}`]={subquery:Nf(n.exists),cardinality:"one"},r++);return e}function MO(t){if(!t.order)return t;const e=structuredClone(t);for(const[r,n,s]of e.order)s&&(e.include={...e.include,[r]:s});return e}function mo(t,e,r={}){const n=e.collectionName;r[n]||(r[n]={sets:new Map,deletes:new Set});const s=e.include??{};for(const i of t){r[n].sets.set(i.data.id,i.data);for(const[a,{subquery:o}]of Object.entries(s)){const c=i.subqueries[a];c!=null&&mo(Array.isArray(c)?c:[c],o,r)}}return r}function Ia(t){return{id:Xe(t),usedBy:new Set,dependsOn:new Map,results:void 0,query:t,shouldRefetch:ls(t)||yo(t),hasChanged:!1,cachedBoundQuery:void 0,referencedRelationalVariables:Kn(t),collectionsReferencedInSubqueries:Qn(t)}}function LO(t){for(const e of t.values())e.results=void 0,e.cachedBoundQuery=void 0,e.hasChanged=!0}function go(t,e,r){if(e.where){for(const n of Ct(e.where))if(re(n)&&$f(n)){const s=Number(n[2].split(".")[0].split("_")[1]);r.has(s)&&(t.dependsOn.set(n[2],r.get(s)),r.get(s).usedBy.add(t))}}if(e.include)for(const n in e.include){const s=e.include[n].subquery;go(t,s,r)}}function Df(t){const e=new Set;if(t.usedBy.size>0)return e;e.add(t.id);for(const[r,n]of t.dependsOn.entries()){n.usedBy.delete(t);const s=Df(n);for(const i of s)e.add(i)}return e}function BO(t,e){const r=Df(t);for(const n of r)e.delete(n);return r}function UO(t,e){let r=null;const{views:n,rewrittenQuery:s}=as(structuredClone(t));return!ls(s)&&!yo(s)?(r=Ia(s),e.set(r.id,r),zO(n,e),go(r,s,e)):(r=Ia(t),e.set(r.id,r)),r}function zO(t,e){const r=[];for(const[n,s]of t.entries()){if(e.has(n))continue;const i=Ia(s);e.set(n,i),r.push(i)}for(const n of r)go(n,n.query,e);return e}var VO=function(t,e,r){if(e!=null){if(typeof e!="object"&&typeof e!="function")throw new TypeError("Object expected.");var n,s;if(r){if(!Symbol.asyncDispose)throw new TypeError("Symbol.asyncDispose is not defined.");n=e[Symbol.asyncDispose]}if(n===void 0){if(!Symbol.dispose)throw new TypeError("Symbol.dispose is not defined.");n=e[Symbol.dispose],r&&(s=n)}if(typeof n!="function")throw new TypeError("Object not disposable.");s&&(n=function(){try{s.call(this)}catch(i){return Promise.reject(i)}}),t.stack.push({value:e,dispose:n,async:r})}else r&&t.stack.push({async:!0});return e},HO=function(t){return function(e){function r(a){e.error=e.hasError?new t(a,e.error,"An error was suppressed during disposal."):a,e.hasError=!0}var n,s=0;function i(){for(;n=e.stack.pop();)try{if(!n.async&&s===1)return s=0,e.stack.push(n),Promise.resolve().then(i);if(n.dispose){var a=n.dispose.call(n.value);if(n.async)return s|=2,Promise.resolve(a).then(i,function(o){return r(o),i()})}else s|=1}catch(o){r(o)}if(s===1)return e.hasError?Promise.reject(e.error):Promise.resolve();if(e.hasError)throw e.error}return i()}}(typeof SuppressedError=="function"?SuppressedError:function(t,e,r){var n=new Error(r);return n.name="SuppressedError",n.error=t,n.suppressed=e,n});class WO{constructor(e){b(this,"db");b(this,"storage",new lr);b(this,"entityStore",new mf(["entities"]));b(this,"doubleBuffer",new Af(new Sl,new Sl));b(this,"runningLock");b(this,"subscribedQueries",new Map);b(this,"uninitializedQueries",new Set);b(this,"viewGraph",new Map);this.db=e}subscribe(e,r,n){const s=Xe(e);if(!this.subscribedQueries.has(s)){const a=UO(e,this.viewGraph),o={query:e,listeners:new Set,errorCallbacks:new Set,uninitializedListeners:new WeakSet,rootNode:a};this.subscribedQueries.set(s,o),this.uninitializedQueries.add(s)}const i=this.subscribedQueries.get(s);return i.listeners.add(r),i.uninitializedListeners.add(r),n&&i.errorCallbacks.add(n),()=>{const a=this.subscribedQueries.get(s);if(!a){Kr.warn("Query not found",{rootQueryId:s});return}a.listeners.delete(r),a.uninitializedListeners.delete(r),n&&a.errorCallbacks.delete(n),a.listeners.size===0&&(BO(a.rootNode,this.viewGraph),this.subscribedQueries.delete(s))}}async initializeQueryResults(e){if(e.results)return e.results;let r=e.query;if(e.dependsOn.size>0)if(e.cachedBoundQuery)r=e.cachedBoundQuery;else{const s={};for(const[i,a]of e.dependsOn.entries()){const o=await this.initializeQueryResults(a);s[i.split(".")[0].slice(1)]=o}r=us(r,cs(s)),e.cachedBoundQuery=r}const n=await this.db.rawFetch(r);return e.results=n,n}flushChangesToListeners(){for(const e of this.subscribedQueries.keys()){const r=this.subscribedQueries.get(e);for(const n of r.listeners){if(!r.rootNode.results){Kr.error("Results not found for query",{queryId:e});continue}if(!r.uninitializedListeners.has(n)&&!r.rootNode.hasChanged)continue;const s=r.rootNode.results;r.uninitializedListeners.delete(n),s!=null&&n({results:s})}r.rootNode.hasChanged=!1}}async bufferChanges(e){const r=structuredClone(e);for(const s in r)r[s].sets.size===0&&r[s].deletes.size===0&&delete r[s];if(ar(r))return;const n=this.storage.transact();try{this.subscribedQueries.size>0&&this.doubleBuffer.write(void 0,r)}finally{await n.commit()}}async acquireRunningLock(){var r;for(;this.runningLock!==void 0;)await((r=this.runningLock)==null?void 0:r.promise);this.runningLock=Promise.withResolvers();const e=this.runningLock.resolve;return{[Symbol.dispose]:()=>{this.runningLock=void 0,e()}}}async updateViews(){const e={stack:[],error:void 0,hasError:!1};try{const r=VO(e,await this.acquireRunningLock(),!1);this.doubleBuffer.lockAndSwitchBuffers();const n=await this.doubleBuffer.inactiveBuffer.getChanges(this.storage),s=new Set;for(const o of this.uninitializedQueries){const c=this.subscribedQueries.get(o);c&&c.rootNode.results==null&&(await this.initializeQueryResults(c.rootNode),s.add(c.rootNode)),this.uninitializedQueries.delete(o)}const i=this.getAffectedViewsInTopologicalOrder(n);for(const[o,c]of i){if(s.has(o))continue;if(o.shouldRefetch){o.results=await this.db.rawFetch(o.query),o.hasChanged=!0;continue}let l=!1;for(const y of o.dependsOn.values())if(y.hasChanged){l=!0;break}if(!l){if(o.dependsOn.size>0&&!o.cachedBoundQuery)throw new Error("View node has dependencies but no cached bound query");const{updatedResults:y,hasChanged:h}=await this.updateQueryResultsInPlace(o.results,c,o.cachedBoundQuery??o.query,o.query,o);o.results=y,o.hasChanged=h;continue}const u={};for(const[y,h]of o.dependsOn.entries()){if(!h.results)throw new Error("view results not found during update: "+h.results);u[y.split(".")[0].slice(1)]=h.results}const d=us(o.query,cs(u));o.cachedBoundQuery=d,o.results=await this.db.rawFetch(d),o.hasChanged=!0}const a=this.storage.transact();this.doubleBuffer.inactiveBuffer.clear(a),await a.commit()}catch(r){e.error=r,e.hasError=!0}finally{HO(e)}}async updateQueryResultsInPlace(e,r,n,s,i,a=[]){var N,U;const o=r[n.collectionName];let c=e??[];const l=new Map,u=new Map,d=new Map,y=new Map,{collectionName:h,where:f,order:m,after:v,limit:g,include:S}=n;if(o){const P=new Set,K=o.deletes,G=o.sets,se=z=>m&&m.some(([Y])=>de.Get(z,Y)!==void 0),me=z=>(!f||KO(z,f))&&(!v||wa(z,v,m));if((K.size>0||G.size>0)&&(c=e.filter(z=>{let Y=!0;if(K.has(z.data.id)&&(Y=!1),G.has(z.data.id)){const Re=G.get(z.data.id);ss(z.data,Re,{clone:!1}),d.set(z.data.id,z.data),Y=me(z.data),Y&&(y.set(z.data.id,Re),se(Re)&&P.add(z.data.id))}return Y||l.set(z.data.id,z.data),Y}),g&&e.length===g&&(l.size>0||P.size>0&&m)))return{updatedResults:await this.db.rawFetch(n,{entityStack:a}),hasChanged:!0};for(const[z,Y]of G){if(d.has(z))continue;if(QO(Y)){me(Y)&&(u.set(z,Y),c.push(os(Y)));continue}if(f&&!jf(Y,f)&&!se(Y))continue;const Re=await this.db.entityStore.getEntity(this.db.kv,h,z);Re!=null&&me(Re)&&(u.set(Re.id,Re),c.push(os(Re)))}if(m!=null&&!(u.size===0&&P.size===0)&&Of(c,m),g!=null&&c.length>g){for(let z=g;z<c.length;z++){const Y=c[z];u.has(Y.data.id)&&u.delete(Y.data.id)}c=c.slice(0,g)}}let C=!1;if(S){const P=new Set;u.keys().forEach(G=>{P.add(G)});const K=i.referencedRelationalVariables.get(Xe(s));if(K&&y.entries().forEach(([G,se])=>{for(const me of K)if(de.Get(se,me)!==void 0){P.add(G);break}}),c.length>0)for(const G in S){const{subquery:se,cardinality:me}=S[G],z=(N=s.include)==null?void 0:N[G];if(!z)throw new Error("Inclusion is transformed query not found in original query: "+G);const{subquery:Y}=z,Re=i.collectionsReferencedInSubqueries.get(Xe(Y));if(!Re)throw new Error("Subquery not found in collectionsReferencedInSubqueries");let Wo=!1;for(const zt of Re)if(r[zt]){Wo=!0;break}if(Wo)for(const zt of c){if(P.has(zt.data.id))continue;const Ko=a.concat(zt.data),On=zt.subqueries[G],Zs=await this.updateQueryResultsInPlace(Array.isArray(On)?On:On===null?[]:[On],r,{...se,where:se.where?Mr(se.where,{entityStack:Ko}):void 0},Y,i,Ko),op=me==="one"?((U=Zs.updatedResults)==null?void 0:U[0])??null:Zs.updatedResults;zt.subqueries[G]=op,Zs.hasChanged&&(C=!0)}}if(P.size>0){const G=[["id","in",P]],se=await this.db.rawFetch({...n,where:f?f.concat(G):G},{entityStack:a});for(const me of se){const z=c.findIndex(Y=>Y.data.id===me.data.id);c[z]=me}}}return{updatedResults:c,hasChanged:l.size>0||u.size>0||d.size>0||C}}getAffectedViewsInTopologicalOrder(e){var a;const r=new Map;for(const o of this.viewGraph.values()){const c={};for(const l in e)(a=o.collectionsReferencedInSubqueries.get(o.id))!=null&&a.has(l)&&(c[l]=e[l]);ar(c)||r.set(o,c)}let n=new Set(Array.from(r.keys()));for(;n.size>0;){const o=new Set;for(const c of n)for(const l of c.usedBy)r.has(l)||(r.set(l,{}),o.add(l));n=o}let s=new Map,i=new Set(Array.from(r.keys()));for(;i.size>0;){const o=new Set;for(const c of i)if(c.dependsOn.size===0){s.set(c,r.get(c));continue}else{let l=!0;for(const u of c.dependsOn.values())if(i.has(u)){l=!1;break}if(l){s.set(c,r.get(c));continue}o.add(c)}i=o}return s}resetSubscriptions(){LO(this.viewGraph);for(const e of this.subscribedQueries.keys())this.uninitializedQueries.add(e)}async clear(){await this.storage.clear(),this.subscribedQueries.clear(),this.uninitializedQueries.clear(),this.viewGraph.clear()}}function KO(t,e){return e.every(r=>or(t,r,!0))}function jf(t,e){return e.some(r=>{if(Lt(r))return!1;if(le(r))return jf(t,r.filters);if(oe(r))throw new Error("Subquery filters are not supported in this context");const n=r[0].split(".");return de.Get(t,n)!==void 0})}function QO(t){return t.id!==void 0}function ZO(t,e,r){let n=GO(t,e,r),s=n.next();for(;!s.done;)s=n.next();return s.value}function Ff(t,e,r,n){let s=Ns(e,r);const i=t.split(".");let a=[];for(let o=0;o<i.length;o++){const c=i[o];s=s.get(c),a.push(c);const{valid:l,reason:u}=n(s.current,o,i);if(!l)return{valid:l,path:a.join("."),reason:u}}return{valid:!0}}function GO(t,e,r){let n=Ns(e,r);const s=t[Symbol.iterator]();return{next(){const{value:i,done:a}=s.next();return a?{done:a,value:n.current}:(n=n.get(i),{done:!1,value:n.current})},[Symbol.iterator](){return this}}}function Ur(t,e,r){let n=Ns(e,r),s=[];const i=t[Symbol.iterator]();return{next(){const{value:a,done:o}=i.next();return o?{done:o,value:[s,n.current]}:(n=n.get(a),s.push(a),{done:!1,value:[s,n.current]})},[Symbol.iterator](){return this}}}function Ns(t,e){var i,a;let r=!0,n=(i=t[e])==null?void 0:i.schema;const s=o=>{if(n===void 0)return{get:s,current:n};if(Ae(n))return Ns(t,n.query.collectionName).get(o);let c=n;return r&&o in(t[e].relationships??{})?c=t[e].relationships[o]:n.type==="record"?(c=n.properties[o],r=!1):n.type==="json"?(c=n,r=!1):c=void 0,n=c,{get:s,current:n}};return{get:s,current:(a=t[e])==null?void 0:a.schema}}function Ae(t){return t!==void 0&&"query"in t}function Ds(t){return t.where=qO(t.where),t.include=eC(t.include),t.order=tC(t.order),t}function qO(t){if(!t)return t;if(t=vo(t,"and"),t.length!==0)return t}function vo(t,e){let r=[];for(let n=0;n<t.length;n++){const s=t[n],i=Mf(s);if(i!==void 0)if(le(i)&&i.mod===e)for(const a of i.filters)r.push(a);else r.push(i)}return r=XO(r,e),JO(r,e)}function JO(t,e){const r=new Set,n=[];for(const s of t){const{hash:i}=Sf(s);r.has(i)||(r.add(i),n.push(s))}return n.length!==t.length?vo(n,e):n}function Mf(t){return le(t)?YO(t):oe(t)?{exists:Ds(t.exists)}:t}function YO(t){if(t.filters=vo(t.filters,t.mod),t.filters.length!==0)return t.filters.length===1?Mf(t.filters[0]):t}function XO(t,e){return e==="and"&&t.some(r=>r===!1)?[!1]:e==="or"&&t.some(r=>r===!0)?[!0]:t}function eC(t){if(!t)return t;const e=Object.keys(t);if(e.length!==0){for(const r of e){const n=t[r];n.subquery=Ds(n.subquery)}return t}}function tC(t){if(!t)return t;if(t.length!==0){for(let e=0;e<t.length;e++){const r=t[e];if(r.length===3){const n=r[2];t[e]=[r[0],r[1],{...n,subquery:Ds(n.subquery)}]}}return t}}function Lf(t){return!js(t)&&typeof t=="object"&&"subquery"in t}function js(t){return t===!0||t===null}function Bf(t){return!js(t)&&typeof t=="object"&&"_extends"in t}function rC(t){return t==="one"||t==="many"}const kl=Object.freeze([!1]);function pt(t,e,r,n,s){t.vars&&!r.$query&&(r={...r,$query:t.vars});const i=Fs(t,e,r,n,{applyPermission:s.applyPermission,isExpandingPermission:!1,permissionStack:[],queryStack:[],replaceStaticVariables:s.replaceStaticVariables??!0});return Ds(i)}function Fs(t,e,r,n,s){s.queryStack.push(t);const i={collectionName:sC(t,e),select:iC(t,e),include:aC(t,e,r,n,s),where:oC(t,e,r,n,s),order:cC(t,e,r,n,s),limit:lC(t),after:uC(t,e)};return s.queryStack.pop(),i}function nC(t){return t==="_metadata"}function sC(t,e){const r=t.collectionName;if(!r)throw new er(r,"Collection name must be provided");if(!(typeof r=="string"))throw new er(r,"Collection name must be a string");if(e&&!e[r]&&!nC(r))throw new er(r,`Collection '${r}' does not exist in the schema`);return r}function iC(t,e){if(!t.select)return t.select;for(const r of t.select){if(typeof r!="string")throw new bl(`Select field '${r}' is not a string`);if(e){const{valid:n,path:s,reason:i}=Ff(r,e,t.collectionName,(a,o,c)=>a?Ae(a)?{valid:!1,reason:"Cannot select into relationships, please use 'include' instead"}:{valid:!0}:{valid:!1,reason:"Path not found"});if(!n)throw new bl(`Select field '${r}' is not valid: ${i} at path '${s}'`)}}return[...t.select]}function aC(t,e,r,n,s){if(!t.include)return t.include;const i={};for(let[a,o]of Object.entries(t.include)){if(e){let l,u=null;if(js(o))l=a;else if(Bf(o)){const{_extends:d,...y}=o;l=d,u=y}if(l){const d=ZO(l.split("."),e,t.collectionName);if(d&&Ae(d))o={subquery:dC(d.query,u),cardinality:d.cardinality};else throw d?new BT(l,a,t.collectionName):new LT(l,a,t.collectionName)}}if(!Lf(o))throw new xT(o);if(!rC(o.cardinality))throw new MT(o.cardinality);const c=Fs(o.subquery,e,r,n,s);i[a]={subquery:c,cardinality:o.cardinality}}return i}function oC(t,e,r,n,s){var c;let i=t.where??[];if(!Array.isArray(i))throw new kT(t.where,"Where clause must be an array");i=[...i];const a=Ea(i,t,e,r,n,s);if(s.applyPermission&&(!s.isExpandingPermission||!s.permissionStack.includes(t.collectionName))){const l=ff(e,t.collectionName);if(l){let u=[],d=!1;if(n!=null&&n.roles)for(const h of n.roles){const f=(c=l[h.key])==null?void 0:c[s.applyPermission];if(f!=null&&f.filter)if(Array.isArray(f.filter))if(d=!0,f.filter.length===0)u.push(kl);else{const m={...s,applyPermission:oT(s.applyPermission)?"read":s.applyPermission,isExpandingPermission:!0,permissionStack:[...s.permissionStack??[],t.collectionName]},v=Uf(f.filter);u.push(Ea(v,t,e,{...r,$role:h.roleVars},n,m))}else throw new qe("Invalid permission filter format, expected array")}!d&&s.applyPermission!=="postUpdate"&&(u=[kl]);const y=x(u.map(h=>eO(h)));a.push(y)}}if(a.length)return a}function Uf(t){return t.map(e=>{if(re(e)){const[r,n,s]=e;if(Ie(s)){const i=tt(s);if(i[0]===void 0)return i[0]=0,[r,n,"$"+i.join(".")]}return[r,n,s]}return le(e)?{...e,filters:Uf(e.filters)}:e})}function Ea(t,e,r,n,s,i){return t.map(a=>Zn(a,e,r,n,s,i))}function Zn(t,e,r,n,s,i){if(Lt(t))return t;if(le(t)){if(t.mod!=="and"&&t.mod!=="or")throw new qe(`Invalid filter group mod '${t.mod}'`);return{mod:t.mod,filters:Ea(t.filters,e,r,n,s,i)}}if(re(t)){let[a,o,c]=t;if(r){const l=a.split(".");let u;for(const[d,y]of Ur(l,r,e.collectionName)){if(Ae(y)){const h={...y.query},f=l.slice(d.length).join(".");return Ie(c)&&(c=vf(c)),h.where=[...h.where??[],[f,o,c]],Zn({exists:h},h,r,n,s,i)}u=y}if(!u)throw new qe(`Could not find property '${a}' in the schema`);if(u.type==="set"&&!o.startsWith(ir)&&(o=`${ir}${o}`),!te.supportedOperations(u).includes(o))throw new qe(`Operator '${o}' is not valid for property '${a}' of type '${u.type}'`)}if(Ie(c)){const l=tt(c);let u=l[0];if(u===void 0&&(l[0]=1,u=l[0],c="$"+l.join(".")),co(u)){if(r){const d=i.queryStack[i.queryStack.length-u-1],y=l.slice(1);for(const[h,f]of Ur(y,r,d.collectionName))if(Ae(f)){const m={...f.query},v=bf(m,i.queryStack.length-1),g=y.slice(h.length).join("."),S=Z_(o);let C=`$1.${a}`;return v.where=[...v.where??[],[g,S,C]],Zn({exists:v},m,r,n,s,i)}}}else if(i.replaceStaticVariables){const d=de.Get(n,l);if(d===void 0)return!1;c=d}}return c instanceof Date&&(c=c.toISOString()),Array.isArray(c)&&(c=new Set(c)),[a,o,c]}if(ks(t)){if(!r)throw new qe("A schema is required to execute an exists filter");const{exists:a}=t,{_extends:o,...c}=a,l=o.split(".");let u,d;for(const[m,v]of Ur(l,r,e.collectionName))if(u=m,d=v,Ae(d))break;if(!d)throw new qe(`Could not find property '${o}' in the schema`);if(!Ae(d))throw new qe("Cannot execute an exists filter on a non-relation property");const y={...d.query},f=l.length===u.length?c==null?void 0:c.where:[tO(l.slice(u.length).join("."),c)];return y.where=[...d.query.where??[],...f??[]],Zn({exists:y},y,r,n,s,i)}if(oe(t)){const{exists:a}=t,o={collectionName:a.collectionName,where:a.where};return{exists:Fs(o,r,n,s,i)}}throw new qe("Filter is not valid format")}function cC(t,e,r,n,s){if(!t.order)return t.order;const i=[];for(const[a,o]of t.order){if(o!=="ASC"&&o!=="DESC")throw new vl(`Invalid order direction '${o}'`);if(e){const{valid:c,path:l,reason:u}=Ff(a,e,t.collectionName,(y,h,f)=>y?h===f.length-1&&(Ae(y)||y.type==="set"||y.type==="record")?{valid:!1,reason:"Order by field is not sortable"}:Ae(y)&&y.cardinality!=="one"?{valid:!1,reason:"Order by field is a query with cardinality not equal to one"}:{valid:!0}:{valid:!1,reason:"Path not found"});if(!c)throw new vl(`Order by field '${a}' is not valid: ${u} at path '${l}'`);let d;for(const[y,h]of Ur(a.split("."),e,t.collectionName)){const f=y[y.length-1];if(h&&Ae(h)){const m={...h.query};d?d.include={...d.include,[f]:{subquery:m,cardinality:h.cardinality}}:(d=m,h.cardinality)}else break}if(d){const y=Fs(d,e,r,n,s);i.push([a,o,{subquery:y,cardinality:"one"}]);continue}}i.push([a,o])}return i}function lC(t){if(!t.limit)return t.limit;if(typeof t.limit!="number")throw new ml("Limit must be a number");if(t.limit<0)throw new ml("Limit must be a positive number");return t.limit}function uC(t,e){if(!t.after)return t.after;if(!Array.isArray(t.after))throw new xe("After clause must be an array");if(t.after.length<2)throw new xe("After clause must contain a cursor and inclusive flag");if(t.after.length>2)throw new xe("After clause has too many components - it should contain a cursor and inclusive flag");if(!Array.isArray(t.after[0]))throw new xe("After clause cursor must be an array");if(!t.order)throw new xe("After clause requires an order by clause to be provided");if(t.after[0].length!==t.order.length)throw new xe("After clause cursor must match the elements in the order by clause");if(typeof t.after[1]!="boolean")throw new xe("After clause inclusive flag must be a boolean");const r=[];for(let n=0;n<t.order.length;n++){let s=t.after[0][n];if(s===void 0)throw new xe("Cursor value cannot be undefined");if(e){const i=t.order[n][0].split(".");for(const[a,o]of Ur(i,e,t.collectionName)){if(!o)throw new xe(`Attribute ${t.order[n][0]} not found in schema`);if(Ae(o))throw new xe(`Attribute ${t.order[n][0]} is not allowed in after clause because it is relational`);if(a.length===i.length){if(o.type==="set"||Ae(o)||o.type==="record")throw new xe(`Attribute ${t.order[n][0]} is not allowed in after clause because the type is not sortable`);try{s=te.encode(o,s)}catch(l){throw l instanceof O?new xe(`Error converting cursor value for attribute ${t.order[n][0]}: ${l.message}`):l}}}}s instanceof Date&&(s=s.toISOString()),r.push(s)}return[r,t.after[1]]}function dC(t,e){if(!e)return{...t};const r=t.where||e.where?[...t.where??[],...e.where??[]]:void 0,n=t.select||e.select?[...t.select??[],...e.select??[]]:void 0;return{...t,...e,where:r,select:n}}function bo(t,e,r){return!r&&!e?t:t?e?r:St({},t,r):r}async function*zf(t,e){if(!e){yield*t;return}const r=new Set;for await(const n of t){const s=n.id;r.add(s);const i=bo(n,e.deletes.has(s),e.sets.get(s));i&&(yield i)}for(const[n,s]of e.sets)!r.has(n)&&!e.deletes.has(n)&&(yield s)}class fC{constructor(e){b(this,"kvTx");b(this,"entityStore");b(this,"changes",{});b(this,"schema");b(this,"systemVars");b(this,"session");b(this,"typeConverters");b(this,"skipRules");this.kvTx=e.kvTx,this.entityStore=new hC(e.entityStore,this.changes),this.schema=e.schema,this.systemVars=e.systemVars,this.session=e.session,this.typeConverters=e.typeConverters,this.skipRules=e.skipRules}async fetch(e){var i;const r=pt(e,(i=this.schema)==null?void 0:i.collections,this.systemVars,this.session,{applyPermission:this.skipRules?void 0:"read"});let s=await new Br(this.kvTx,this.entityStore).fetch(r);return zr(s,r,"many",this.typeConverters)}async fetchOne(e){return(await this.fetch({...e,limit:1}))[0]??null}async fetchById(e,r){const n={collectionName:e,where:[["id","=",r]]};return this.fetchOne(n)}async insert(e,r){var a,o;if(this.kvTx.status==="cancelled")throw new Wn;if(!e)throw new er(e,"Collection name must be defined");if(!r)throw new gl("The document being inserted is undefined");if(typeof r!="object"||Array.isArray(r))throw new gl("The document being inserted must be an object.");const n=(o=(a=this.schema)==null?void 0:a.collections[e])==null?void 0:o.schema,s=yC(n,r);return s.id||(s.id=te.defaultValue(p.Id())),this.getOrCreateCollectionChanges(e).sets.set(s.id,s),n?te.decode(n,s):s}async update(e,r,n){var c,l;if(!e)throw new er(e);if(this.kvTx.status==="cancelled")throw new Wn;let s;const i=(l=(c=this.schema)==null?void 0:c.collections[e])==null?void 0:l.schema;if(typeof n=="function"){const u=structuredClone(await this.entityStore.getEntity(this.kvTx,e,r));if(!u)throw new pf(r,e);const d=i?te.decode(i,u):u;s={},await n(wo(d,s,i))}else s=n;if(yf(s))return;if("id"in s)throw new NT(`Attempted to update the id of an entity in the ${e} to ${s.id}. The 'id' attribute of an entity is immutable and cannot be updated.`);const a=this.getOrCreateCollectionChanges(e),o=a.sets.get(r);s=i?te.encode(i,s):s,o&&(s=St({},o,s)),a.sets.set(r,s)}async delete(e,r){if(!e)throw new er(e);if(this.kvTx.status==="cancelled")throw new Wn;const n=this.getOrCreateCollectionChanges(e),s=n.sets.get(r);if(s&&"id"in s){n.sets.delete(r);return}s&&n.sets.delete(r),n.deletes.add(r)}getOrCreateCollectionChanges(e){return this.changes[e]||(this.changes[e]={sets:new Map,deletes:new Set}),this.changes[e]}}class hC{constructor(e,r={}){b(this,"changes");b(this,"baseStore");this.changes=r,this.baseStore=e}async applyChanges(e,r,n){return this.baseStore.applyChanges(e,r,n)}async getEntity(e,r,n){const s=await this.baseStore.getEntity(e,r,n);if(!this.changes[r])return s;const i=this.changes[r],a=i.deletes.has(n);return bo(s,a,i.sets.get(n))}async*getEntitiesInCollection(e,r){yield*zf(this.baseStore.getEntitiesInCollection(e,r),this.changes[r])}async getCollectionStats(e,r){throw new Error("getCollectionStats is not implemented in EntityStoreWithChanges")}}function wo(t,e,r){return new Proxy(t,{get(n,s){const i=(r==null?void 0:r.type)==="record"?r.properties[s]:((r==null?void 0:r.type)==="json",r);return n[s]instanceof Set?(e[s]||(e[s]={}),pC(n[s],e[s],i)):typeof n[s]=="object"&&!(n[s]instanceof Date)&&n[s]!==null?(e[s]||(e[s]={}),wo(n[s],e[s],i)):Reflect.get(n,s)},set(n,s,i){if(typeof s=="symbol")return!0;let a=i;if(i instanceof Set){let o={};if(n[s]instanceof Set)for(const c of n[s])o[c]=!1;for(const c of i)o[c]=!0;a=o}else if(i===void 0)a=null;else if(i instanceof Date)a=i.toISOString();else if(typeof i=="object"&&i!==null&&!Array.isArray(i)){if(e[s]||(e[s]={}),a={},typeof n[s]=="object"&&n[s]!==null)for(const o in n[s])a[o]=null;for(const o in i)a[o]=i[o]}return e[s]=a,Reflect.set(n,s,i)},deleteProperty(n,s){return typeof s=="symbol"||(e[s]=null,n[s]=null),!0}})}function pC(t,e,r){const n=i=>r?te.encode(r.items,i):i,s={add(i){t.has(i)||(e[n(i)]=!0)},clear(){for(const i of t)e[n(i)]=!1},delete(i){t.has(i)&&(e[n(i)]=!1)}};return new Proxy(t,{get(i,a){return typeof i[a]!="function"?Reflect.get(i,a):function(...o){var c;return(c=s[a])==null||c.call(s,...o),i[a](...o)}}})}function yC(t,e){if(!t)return e;const r=te.struct(t),n=te.assign(t,r,e);return Vf(n),te.encode(t,n)}function Vf(t){for(const e in t)if(t[e]===void 0)delete t[e];else{if(typeof t[e]!="object")continue;t[e]!==null&&!Array.isArray(t[e])&&!(t[e]instanceof Date)&&!(t[e]instanceof Set)&&Vf(t[e])}}function mC(t){return typeof t=="string"&&t.startsWith("$")}function Hf(t,e){const r={};for(const n in t){const s=t[n],i=e[n];if(i===void 0)return;if(typeof s=="object"){const a=Hf(s,i);if(a===void 0)return;Object.assign(r,a);continue}if(mC(s)){const a=s.slice(1);r[a]=i;continue}if(s!==i)return}return r}class gC{constructor(e,r){b(this,"vars");b(this,"db");b(this,"_roles");this.db=e,this.vars=Object.freeze(r)}get roles(){return Wf(this.db.schema,this.vars)??[]}}function vC(t,e){const r=new gC(t,e);return new Proxy(t,{get(s,i,a){return i==="session"?r:Reflect.get(s,i,a)},set:Reflect.set,deleteProperty:Reflect.deleteProperty})}function Wf(t,e){if(!t)return;const r=t.roles;if(!r)return[];const n=[];for(const[s,i]of Object.entries(r)){const a=Hf(i.match,e);a!==void 0&&n.push({key:s,roleVars:a})}return n}function Al(t){return!t||t.length===0}function bC(t,e){if(Al(t)&&Al(e))return!0;if((t==null?void 0:t.length)!==(e==null?void 0:e.length))return!1;const r=t==null?void 0:t.map(({key:a})=>a),n=e==null?void 0:e.map(({key:a})=>a);if(r!=null&&r.some(a=>!(n!=null&&n.includes(a))))return!1;const s=Pl(t),i=Pl(e);return r==null?void 0:r.every(a=>s[a]===i[a])}function Pl(t){return t.reduce((e,{key:r,roleVars:n})=>(e[r]=cO(n),e),{})}function Kf(t){const e={};return"x-triplit-user-id"in t&&(e.SESSION_USER_ID=t["x-triplit-user-id"]),Object.assign(e,t),"scope"in e&&!("_scope"in e)&&typeof e.scope=="string"&&(e._scope=e.scope.split(" ")),e}function Qf(t,e=[],r=[],n=[]){for(const[s,i]of Object.entries(t.properties))i.type==="date"&&r.push([...e,s]),i.type==="set"&&n.push([[...e,s],i.items.type]),i.type==="record"&&Qf(i,[...e,s],r,n);return{datePaths:r,setPaths:n}}function Nl(t){if(!t)return;const e=new Map;for(const[r,n]of Object.entries(t.collections))Qf(n.schema),e.set(r,{fromDB:s=>te.decode(n.schema,s)});return e}function ur(t){return new _e(t)}class _e{constructor(e,r){b(this,"collectionName");b(this,"select");b(this,"where");b(this,"limit");b(this,"order");b(this,"include");b(this,"after");b(this,"vars");this.collectionName=e,r&&(this.select=r.select,this.where=r.where,this.limit=r.limit,this.order=r.order,this.include=r.include,this.after=r.after,this.vars=r.vars)}Select(e){const r=e;return new _e(this.collectionName,{...this,select:r})}Where(...e){const r=De().where(this,...e);return new _e(this.collectionName,{...this,where:r})}Id(e){const r=this.where?this.where.filter(n=>!uo(n)):[];return r.push(["id","=",e]),new _e(this.collectionName,{...this,where:r})}Limit(e){const r=e;return new _e(this.collectionName,{...this,limit:r})}Order(...e){const r=De().order(this,...e);return new _e(this.collectionName,{...this,order:r})}After(e,r){const n=De().after(this,e,r);return new _e(this.collectionName,{...this,after:n})}Vars(e){const r=e;return new _e(this.collectionName,{...this,vars:r})}Include(e,r){typeof r=="function"&&(r=r(Zf));const n=De().include(this,e,r);return new _e(this.collectionName,{...this,include:n})}SubqueryOne(e,r){typeof r=="function"&&(r=r(ur));const n=De().include(this,e,{subquery:r,cardinality:"one"});return new _e(this.collectionName,{...this,include:n})}SubqueryMany(e,r){typeof r=="function"&&(r=r(ur));const n=De().include(this,e,{subquery:r,cardinality:"many"});return new _e(this.collectionName,{...this,include:n})}}function Zf(t){return new Ge(t)}class Ge{constructor(e,r){b(this,"_extends");b(this,"select");b(this,"where");b(this,"limit");b(this,"order");b(this,"include");this._extends=e,r&&(this.select=r.select,this.where=r.where,this.limit=r.limit,this.order=r.order,this.include=r.include)}Select(e){const r=e;return new Ge(this._extends,{...this,select:r})}Where(...e){const r=De().where(this,...e);return new Ge(this._extends,{...this,where:r})}Id(e){const r=this.where?this.where.filter(n=>!uo(n)):[];return r.push(["id","=",e]),new Ge(this._extends,{...this,where:r})}Limit(e){const r=e;return new Ge(this._extends,{...this,limit:r})}Order(...e){const r=De().order(this,...e);return new Ge(this._extends,{...this,order:r})}Include(e,r){typeof r=="function"&&(r=r(Zf));const n=De().include(this,e,r);return new Ge(this._extends,{...this,include:n})}SubqueryOne(e,r){typeof r=="function"&&(r=r(ur));const n=De().include(this,e,{subquery:r,cardinality:"one"});return new Ge(this._extends,{...this,include:n})}SubqueryMany(e,r){typeof r=="function"&&(r=r(ur));const n=De().include(this,e,{subquery:r,cardinality:"many"});return new Ge(this._extends,{...this,include:n})}}function wC(t){return Array.isArray(t)&&t[0]===void 0}function SC(t){return re(t)}function Gf(t){return Array.isArray(t)&&t.every(e=>JT(e))}function IC(t){return t.length===1&&Gf(t[0])}const De=()=>({where:(t,...e)=>{let r=[];if(wC(e))return t.where??[];if(SC(e))r=[e];else if(Gf(e))r=e;else if(IC(e))r=e[0];else throw new ji("where",e);return[...t.where??[],...r]},order:(t,...e)=>{if(!e[0])return t.order??[];let r=[];if(e.length===2&&e.every(n=>typeof n=="string"))r=[[...e]];else if(e.length===1&&e[0]instanceof Array&&e[0].every(n=>n instanceof Array))r=e[0];else if(e.every(n=>n instanceof Array))r=e;else throw new ji("order",e);return[...t.order??[],...r]},include(t,e,r){return{...t.include,[e]:r??null}},after(t,e,r){if(!e)return;if(!t.order)throw new zT(e);const n=t.order.map(s=>s[0]);if(e instanceof Array)return[e,r??!1];if(typeof e=="object")return[n.map(s=>de.Get(e,s)),r??!1];throw new ji("after",e)}});function EC(t){if(_(t))return"schema is not defined";if(typeof t!="object")return"schema is not an object";const e=$C(t.roles);if(e)return`schema roles definition is invalid: ${e}`;const r=TC(t.collections);if(r)return`schema collections definition is invalid: ${r}`}function $C(t){if(!_(t)){if(typeof t!="object")return"roles is not an object";for(const e in t){const r=HC(e);if(r)return`role "${e}" is invalid: ${r}`;const n=t[e],s=_C(n);if(s)return`role "${e}" is invalid: ${s}`}}}function _C(t){if(_(t))return"role is not defined";if(typeof t!="object")return"role is not an object";if(_(t.match))return"matcher is not defined";if(typeof t.match!="object")return"matcher is not an object"}function TC(t,e){if(_(t))return"collections is not defined";if(typeof t!="object")return"collections is not an object";for(const r in t){const n=OC(r);if(n)return`"${r}" is not a valid collection name: ${n}`;const s=t[r],i=CC(s);if(i)return`"${r}" is not a valid collection: ${i}`}}function OC(t){if(typeof t!="string")return"collection name is not a string";if(t.length===0)return"collection name is empty";if(t.startsWith("_"))return"collection name cannot start with an underscore";if(/^[0-9]/.test(t))return"collection name cannot start with a numeric character";if(!/^[a-zA-Z0-9_]+$/.test(t))return"collection name contains invalid characters - only alphanumeric characters and underscores are allowed."}function CC(t,e){if(_(t))return"collection is not defined";if(typeof t!="object")return"collection is not an object";const r=RC(t.schema);if(r)return`collection schema is invalid: ${r}`;if("relationships"in t){const n=LC(t.relationships,t);if(n)return`collection relationships is invalid: ${n}`}if("permissions"in t){const n=zC(t.permissions);if(n)return`collection permissions is invalid: ${n}`}}function RC(t){if(_(t))return"schema is not defined";if(typeof t!="object")return"schema is not an object";const e=Jf(t);if(e)return`${e}`;if(_(t.properties.id))return'primary key field "id" is not defined';const r=Yf(t.properties.id);if(r)return`primary key field "id" is invalid: ${r}`}function qf(t){return _(t)?"type is not defined":typeof t!="object"?"type is not a DataType":t.type==="boolean"?xC(t):t.type==="date"?kC(t):t.type==="json"?AC(t):t.type==="number"?PC(t):t.type==="record"?Jf(t):t.type==="set"?NC(t):t.type==="string"?Yf(t):`type "${t.type}" is not recognized`}function xC(t){if(t.type!=="boolean")return"not a boolean type";const e=Bt(t.config);if(e)return`type boolean is invalid: ${e}`}function kC(t){if(t.type!=="date")return"not a date type";const e=Bt(t.config);if(e)return`type date is invalid: ${e}`}function AC(t){if(t.type!=="json")return"not a json type";const e=Bt(t.config);if(e)return`type json is invalid: ${e}`}function PC(t){if(t.type!=="number")return"not a number type";const e=Bt(t.config);if(e)return`type number is invalid: ${e}`}function Jf(t){if(t.type!=="record")return"not a record type";const e=Bt(t.config);if(e)return`type record is invalid: ${e}`;if(_(t.properties))return"type record is missing properties";if(typeof t.properties!="object")return"type record properties is not an object";for(const r in t.properties){const n=DC(r);if(n)return`type record property "${r}" is invalid: ${n}`;const s=t.properties[r],i=qf(s);if(i)return`type record property "${r}" is invalid: ${i}`}}function NC(t){if(t.type!=="set")return"not a set type";const e=Bt(t.config);if(e)return`type set is invalid: ${e}`;if(_(t.items))return"type set is missing items";const r=qf(t.items);if(r)return`type set items is invalid: ${r}`;if(!ya(t.items))return"type set items must be a primitive type"}function Yf(t){var r;if(t.type!=="string")return"not a string type";const e=Bt(t.config);if(e)return`type string is invalid: ${e}`;if(!_((r=t.config)==null?void 0:r.enum)){if(!Array.isArray(t.config.enum))return"type string enum is not an array";for(const n of t.config.enum)if(typeof n!="string")return"type string enum value is not a string"}}function DC(t){if(_(t))return"property name is not defined";if(typeof t!="string")return"property name is not a string";if(t.length===0)return"property name is empty";if(/^[0-9]/.test(t))return"property name cannot start with a numeric character";if(!/^[a-zA-Z0-9_]+$/.test(t))return"property name contains invalid characters - only alphanumeric characters and underscores are allowed."}function Bt(t){if(_(t))return;if(typeof t!="object")return"type config is not an object";if(!_(t.nullable)&&typeof t.nullable!="boolean")return"option nullable is invalid";if(!_(t.optional)&&typeof t.optional!="boolean")return"option optional is invalid";const e=jC(t.default);if(e)return`option default is invalid: ${e}`}function jC(t){if(!_(t)){if(typeof t=="object"){const e=FC(t);if(e)return`default value is invalid: ${e}`}else if(typeof t!="number"&&typeof t!="boolean"&&typeof t!="string")return"default value is not a primitive"}}function FC(t){if(typeof t!="object")return"default function format is invalid";if(_(t.func))return"default function is missing func identifier";const e=t.func;if(!MC(e))return`default function ${t.func} is not recognized`;if(e==="now"&&!_(t.args))return'default function "now" has no args';if(e==="uuid"&&!_(t.args)){if(!Array.isArray(t.args))return'default function "uuid" args is not an array';if(t.args.length>0&&typeof t.args[0]!="number")return'default function "uuid" arg[0] is not a number'}if(e==="Set.empty"&&!_(t.args))return'default function "Set.empty" has no args'}function MC(t){return H_.includes(t)}function LC(t,e){if(!_(t)){if(typeof t!="object")return"relationships is not an object";for(const r in t){const n=BC(r,e);if(n)return`relationship "${r}" is invalid: ${n}`;const s=t[r],i=UC(s);if(i)return`relationship "${r}" is invalid: ${i}`}}}function BC(t,e){if(_(t))return"relationship name is not defined";if(typeof t!="string")return"relationship name is not a string";if(t.length===0)return"relationship name is empty";if(t.startsWith("_"))return"relationship name cannot start with an underscore";if(/^[0-9]/.test(t))return"relationship name cannot start with a numeric character";if(!/^[a-zA-Z0-9_]+$/.test(t))return"relationship name contains invalid characters - only alphanumeric characters and underscores are allowed.";if(e.schema.properties[t])return"relationship name matches a property name"}function UC(t){if(_(t))return"relationship is not defined";if(typeof t!="object")return"relationship is not an object";if(_(t.cardinality))return"cardinality is not defined";if(t.cardinality!=="one"&&t.cardinality!=="many")return"cardinality is invalid";if(_(t.query))return"query is not defined";if(typeof t.query!="object")return"query is not an object"}function zC(t,e){if(!_(t)){if(typeof t!="object")return"permissions is not an object";for(const r in t){const n=t[r],s=VC(n);if(s)return`permissions for role "${r}" is invalid: ${s}`}}}function VC(t){if(!_(t)){if(typeof t!="object")return"not an object";if(t.read){const e=Ar(t.read);if(e)return`"read" permission is invalid: ${e}`}if(t.insert){const e=Ar(t.insert);if(e)return`insert permission is invalid: ${e}`}if(t.update){const e=Ar(t.update);if(e)return`update permission is invalid: ${e}`}if(t.postUpdate){const e=Ar(t.postUpdate);if(e)return`postUpdate permission is invalid: ${e}`}if(t.delete){const e=Ar(t.delete);if(e)return`delete permission is invalid: ${e}`}}}function Ar(t){if(!_(t)){if(typeof t!="object")return"permission is not an object";_(t.filter)}}function HC(t){if(_(t))return"role name is not defined";if(typeof t!="string")return"role name is not a string";if(t.length===0)return"role name is empty";if(t.startsWith("_"))return"role name cannot start with an underscore";if(/^[0-9]/.test(t))return"role name cannot start with a numeric character";if(!/^[a-zA-Z0-9_]+$/.test(t))return"role name contains invalid characters - only alphanumeric characters and underscores are allowed."}class Dl{constructor(e={}){b(this,"entityStore");b(this,"clock");b(this,"session");b(this,"globalVars");b(this,"logger");b(this,"subscribedQueries",new Map);b(this,"clientId");b(this,"ivm");b(this,"schema");b(this,"onCommitListeners",new Set);b(this,"kv");b(this,"typeConverters");b(this,"schemaChangeListeners",[]);this.logger=Kr,this.globalVars=e.variables??{},this.kv=e.kv??new lr,this.entityStore=e.entityStore??new ga,this.clientId=e.clientId||"test-client",this.clock=new tr({clientId:this.clientId}),this.ivm=e.ivm??new WO(this),this.schema=e.schema,this.typeConverters=Nl(this.schema)}static async getSchemaFromStorage(e){const n=await new ga().getEntity(e,"_metadata","_schema");if(ar(n))return;const s={...n};return delete s.id,s}getSchema(){return this.schema}subscribe(e,r,n,s={}){var o;const i=pt(e,(o=this.schema)==null?void 0:o.collections,this.systemVars,this.session,{applyPermission:s.skipRules?void 0:"read"}),a=({results:c})=>{r(zr(c,i,"many",this.typeConverters),s.queryKey)};return this.ivm.subscribe(i,a,n)}subscribeRaw(e,r,n,s={}){const i=({results:a})=>{r(a,s.queryKey)};return this.ivm.subscribe(e,i,n)}subscribeWithChanges(e,r,n,s={}){var o;const i=pt(e,(o=this.schema)==null?void 0:o.collections,this.systemVars,this.session,{applyPermission:s.skipRules?void 0:"read"}),a=({results:c,changes:l})=>{r({results:zr(c,i,"many",this.typeConverters),changes:l})};return this.ivm.subscribe(i,a,n)}subscribeChanges(e,r,n={}){var o;const s=pt(e,(o=this.schema)==null?void 0:o.collections,this.systemVars,this.session,{applyPermission:n.skipRules?void 0:"read"});let i=!0;const a=async({changes:c})=>{var u;let l=c;if(n.queryState&&i){const d={},y={};for(const[h,f]of Object.entries(n.queryState.entityIds))for(const m of f){if(!KC(c,h,m)){y[h]||(y[h]=new Set),y[h].add(m);continue}const v=await this.entityStore.metadataStore.getTimestampForEntity(this.kv,h,m);v&&tr.compare(v,n.queryState.timestamp)<0&&(d[h]||(d[h]=new Set),d[h].add(m))}l={};for(const h in c){l[h]={sets:new Map,deletes:c[h].deletes};for(const[f,m]of c[h].sets)(u=d[h])!=null&&u.has(f)||l[h].sets.set(f,m)}for(const[h,f]of Object.entries(y)){const m=new Set(f);l[h]||(l[h]={sets:new Map,deletes:new Set});const v=await this.fetchChanges({collectionName:h,where:[["id","in",Array.from(f)]]});for(const[g,S]of v[h].sets)m.delete(g),l[h].sets.set(g,S);for(const g of m)l[h].deletes.add(g)}}r(l,n.queryKey),i=!1};return this.ivm.subscribe(s,a,n.errorCallback)}async fetch(e,r){var a;const n=pt(e,(a=this.schema)==null?void 0:a.collections,this.systemVars,this.session,{applyPermission:r!=null&&r.skipRules?void 0:"read"});let i=await new Br(this.kv,this.entityStore).fetch(n);return zr(i,n,"many",this.typeConverters)}async rawFetch(e,r){return new Br(this.kv,this.entityStore).fetch(e,r)}async fetchChanges(e,r){var a;const n=pt(e,(a=this.schema)==null?void 0:a.collections,this.systemVars,this.session,{applyPermission:r!=null&&r.skipRules?void 0:"read"}),s=await this.rawFetch(n);return mo(s,n)}async fetchOne(e,r){e={...e,limit:1};const s=(await this.fetch(e,r))[0];return s||null}async fetchById(e,r,n){const s=this.query(e).Id(r);return this.fetchOne(s,n)}async insert(e,r,n){return this.transact(async s=>await s.insert(e,r),{skipRules:(n==null?void 0:n.skipRules)??!1})}async update(e,r,n,s){return this.transact(async i=>{await i.update(e,r,n)},{skipRules:(s==null?void 0:s.skipRules)??!1})}async delete(e,r,n){return this.transact(async s=>{await s.delete(e,r)},{skipRules:(n==null?void 0:n.skipRules)??!1})}onCommit(e){return this.onCommitListeners.add(e),()=>{this.onCommitListeners.delete(e)}}updateQueryViews(){return this.ivm.updateViews()}broadcastToQuerySubscribers(){return this.ivm.flushChangesToListeners()}async transact(e,r){let n,s;const i=this.kv.transact();try{const a=new fC({schema:this.schema,kvTx:i,entityStore:this.entityStore,systemVars:this.systemVars,session:this.session,typeConverters:this.typeConverters,skipRules:!!(r!=null&&r.skipRules)});s=await e(a),n=await this.entityStore.applyChanges(i,a.changes,{checkWritePermission:r!=null&&r.skipRules?void 0:this.checkWritePermission.bind(this),entityChangeValidator:this.validateEntityChange.bind(this)}),await i.commit()}catch(a){throw i.cancel(),a}await this.ivm.bufferChanges(n);for(const a of this.onCommitListeners)a(n);return s}async applyChanges(e,r){const n=this.kv.transact(),s=await this.entityStore.applyChanges(n,e,{checkWritePermission:r!=null&&r.skipRules?void 0:this.checkWritePermission.bind(this),entityChangeValidator:this.validateEntityChange.bind(this)});await n.commit(),await this.ivm.bufferChanges(s)}async applyChangesWithTimestamp(e,r,n){const s=this.kv.transact(),i=await this.entityStore.applyChangesWithTimestamp(s,e,r,{checkWritePermission:n!=null&&n.skipRules?void 0:this.checkWritePermission.bind(this),entityChangeValidator:this.validateEntityChange.bind(this)});await s.commit(),await this.ivm.bufferChanges(i)}async getCollectionStats(){return this.entityStore.getCollectionStats(this.kv,this.schema?Object.keys(this.schema.collections):void 0)}async overrideSchema(e,r){const n=await this._overrideSchema(e,r);for(const s of this.schemaChangeListeners)await s(n);return n}async _overrideSchema(e,{failOnBackwardsIncompatibleChange:r=!1}={}){let n=this.schema;const s=EC(e);if(s)return{successful:!1,invalid:s,issues:[],diff:[],oldSchema:n,newSchema:e};if(!n)return await this.updateSchema(e),{successful:!0,invalid:void 0,issues:[],diff:[],oldSchema:n,newSchema:e};let i=[];const a=mT(n,e);return a.length===0?{successful:!0,invalid:void 0,issues:i,diff:a,oldSchema:n,newSchema:e}:(i=await wT(o=>this.fetch.bind(this)(o,{skipRules:!0}),a),r&&i.length>0?{successful:!1,invalid:void 0,issues:i,diff:a,oldSchema:n,newSchema:e}:i.length>0&&i.some(o=>o.violatesExistingData)?{successful:!1,invalid:void 0,issues:i,diff:a,oldSchema:n,newSchema:e}:(a.length>0&&this.logger.info(`applying ${a.length} changes to schema`),await this.updateSchema(e),{successful:!0,invalid:void 0,issues:i,diff:a,oldSchema:n,newSchema:e}))}async setMetadata(e,r){const n=this.kv.scope(["_metadata"]),s=this.kv.transact();await n.set(e,r),await s.commit()}async getMetadata(e){return await this.kv.scope(["_metadata"]).get(e)}async updateSchema(e){const r=this.kv.transact();await this.entityStore.dataStore.applyChanges(r,{_metadata:{sets:new Map([["_schema",{id:"_schema",...e}]]),deletes:new Set}},{checkWritePermission:void 0,entityChangeValidator:void 0}),await r.commit(),this.schema=e,this.typeConverters=Nl(this.schema)}withSessionVars(e){return vC(this,Kf(e))}onSchemaChange(e){return this.schemaChangeListeners.push(e),()=>{this.schemaChangeListeners=this.schemaChangeListeners.filter(r=>r!==e)}}query(e){return new _e(e)}Query(e){return this.query(e)}async clear(e){if(await this.kv.clear(),e!=null&&e.full){await this.ivm.clear(),this.schema=void 0;return}this.schema&&await this.updateSchema(this.schema),this.ivm.resetSubscriptions()}updateGlobalVariables(e){this.globalVars=e}get systemVars(){var e;return{$global:this.globalVars,$session:((e=this.session)==null?void 0:e.vars)??{}}}validateEntityChange(e,r,{ignoreRequiredProperties:n=!1}){var o,c;const s=(o=this.schema)==null?void 0:o.collections;if(!s)return;const i=(c=s[e])==null?void 0:c.schema;if(!i)return;const a=te.validateEncoded(i,r,{partial:n});if(!a.valid)throw new ct("record",JSON.stringify(r),a.error)}async checkWritePermission(e,r,n,s){var u,d,y;if(!ff((u=this.schema)==null?void 0:u.collections,r))return;const o=pt({collectionName:r},(d=this.schema)==null?void 0:d.collections,this.systemVars,this.session,{applyPermission:s}).where;if(!o||o.length===0)return;const c=new Br(e,this.entityStore);if(!await ba(n,o,c))throw new DT(r,n.id,s,((y=this.session)==null?void 0:y.roles)??[])}}async function WC(t){let e;t.kv&&(e=await Dl.getSchemaFromStorage(t.kv));const r=new Dl({...t,schema:e});if(t.schema){const n=await r.overrideSchema(t.schema,{failOnBackwardsIncompatibleChange:!0});if(CT(n,{logger:r.logger}),!n.successful)throw new Error("Schema change failed. Review the issues above for more information.")}else e&&await r.updateSchema(e);return r}function KC(t,e,r){return t[e]&&(t[e].sets.has(r)||t[e].deletes.has(r))}function zr(t,e,r,n){if(t===null)return null;const s=n==null?void 0:n.get(e.collectionName),i=c=>(s==null?void 0:s.fromDB(c))??c,a=c=>{if(!e.select)return c;const l={};for(const u of e.select)de.Set(l,u,de.Get(c,u));return l},o=c=>{const l=i(a(c.data)),u=e.include&&Object.entries(e.include).reduce((d,[y,h])=>(c.subqueries[y]!==void 0&&(d[y]=zr(c.subqueries[y],h.subquery,h.cardinality,n)),d),{});return{...l,...u}};return r==="one"?o(t):t.map(o)}function QC(t,e){return t?te.serialize(t,e,"decoded"):e}function $a(t,e,r){const n=e==null?void 0:e[t.collectionName],s=n==null?void 0:n.schema,i=t.include?Object.keys(t.include):[];function a(o){if(!o)return null;const c={};for(const l of i)c[l]=$a(ZC(n,l,t.include[l],"deserialize"),e,o[l]),delete o[l];o=_a(s,o);for(const l of i)o[l]=c[l];return o}if(Array.isArray(r))for(let o=0;o<r.length;o++)r[o]=a(r[o]);else r=a(r);return r}function _a(t,e){return t?te.deserialize(t,e,"decoded"):e}function ZC(t,e,r,n){var s,i;if(js(r)){if(!t)throw new O(`Cannot ${n} inclusion '${e}' without schema`);const a=(s=t.relationships)==null?void 0:s[e];if(!a)throw new O(`Cannot ${n} inclusion '${e}', no relation found for '${e}'`);return a.query}if(Bf(r)){if(!t)throw new O(`Cannot ${n} inclusion '${e}' without schema`);const{_extends:a,...o}=r,c=(i=t.relationships)==null?void 0:i[a];if(!c)throw new O(`Cannot ${n} inclusion '${e}', no relation found for '${a}'`);return{...c.query,...o}}if(Lf(r))return r.subquery;throw new O(`Failed to ${n} inclusion '${e}': invalid format`)}class jl{constructor(e=[]){b(this,"storagePrefix");this.storagePrefix=e}async clear(e){const r=e.scope(this.storagePrefix),n=r.scan({prefix:[]});for await(const[s]of n)await r.delete(s)}async write(e,r){const n=e.scope(this.storagePrefix);for(const s in r){const i=r[s];for(const a of i.deletes){const o=await n.get([s,"sets",a]);o&&(await n.delete([s,"sets",a]),"id"in o)||await n.set([s,"deletes",a],!0)}for(const[a,o]of i.sets){const c=[s,"sets",a],l=await n.get(c);let u=o;l&&(u=St(l,o)),await n.set(c,u)}}}async getChanges(e){const n=e.scope(this.storagePrefix).scan({prefix:[]});let s={};for await(const[i,a]of n){const o=i[1];if(o==="sets"){const[c,l,u]=i;s[c]||(s[c]={sets:new Map,deletes:new Set});let d=a;const y=s[c].sets.get(u);y&&(d=St({},y,a)),s[c].sets.set(u,d)}if(o==="deletes"){const[c,l,u]=i;s[c]||(s[c]={sets:new Map,deletes:new Set}),s[c].deletes.add(u)}}return s||{}}async getChangesForCollection(e,r){const n=e.scope(this.storagePrefix),s={sets:new Map,deletes:new Set};for await(const[i,a]of n.scan({prefix:[r,"sets"]})){const[o]=i;s.sets.set(o,a)}for await(const[i]of n.scan({prefix:[r,"deletes"]})){const[a]=i;s.deletes.add(a)}if(!(s.sets.size===0&&s.deletes.size===0))return s}async getChangesForEntity(e,r,n){const s=e.scope(this.storagePrefix),i=await s.get([r,"sets",n]),a=await s.get([r,"deletes",n]);if(!(i===void 0&&a===void 0))return{update:i,delete:a!==void 0}}async isEmpty(e){const r=await this.getChanges(e);return Object.keys(r).length===0}async clearChangesForEntity(e,r,n){const s=e.scope(this.storagePrefix);await s.delete([r,"sets",n]),await s.delete([r,"deletes",n])}}class GC{constructor(e){b(this,"storage");b(this,"doubleBuffer");b(this,"store");this.storage=e,this.doubleBuffer=new Af(new jl(["buf0"]),new jl(["buf1"])),this.store=new ga}get metadataStore(){return this.store.metadataStore}get dataStore(){return this.store.dataStore}async applyChanges(e,r){return await this.doubleBuffer.write(e,r),r}async applyChangesWithTimestamp(e,r,n,s){const i=await this.store.applyChangesWithTimestamp(e,r,n,s),a=await this.doubleBuffer.getChanges(e);for(const o in a){const c=a[o],l=i[o];if(l){for(const u of c.deletes)l.deletes.delete(u),l.sets.delete(u);for(const[u,d]of c.sets){l.deletes.delete(u);const y=l.sets.get(u);y&&l.sets.set(u,{...y,...d})}}}return i}async getEntity(e,r,n){const s=await this.store.getEntity(e,r,n),i=await this.doubleBuffer.getChangesForEntity(e,r,n);return bo(s,!!(i!=null&&i.delete),i==null?void 0:i.update)}async getCollectionStats(e){throw new Error("Method not implemented.")}async*getEntitiesInCollection(e,r){yield*zf(this.store.getEntitiesInCollection(e,r),await this.doubleBuffer.getChangesForCollection(e,r))}}class Fl{constructor(){b(this,"data",new Map)}get(e,r){var n;return r===void 0?this.data.get(e):(n=this.data.get(e))==null?void 0:n.get(r)}set(e,r,n){this.data.has(e)||this.data.set(e,new Map),this.data.get(e).set(r,n)}delete(e,r){var n;return((n=this.data.get(e))==null?void 0:n.delete(r))??!1}has(e,r){var n;return r===void 0?this.data.has(e):((n=this.data.get(e))==null?void 0:n.has(r))??!1}keys(){return this.data.keys()}values(){return this.data.values()}entries(){return this.data.entries()}[Symbol.iterator](){return this.entries()}}function Pr(t,e){const r=qC(t);return r?((e==null?void 0:e.split("."))??[]).reduce((i,a)=>{if(i&&i[a])return i[a]},r):void 0}function qC(t){if(typeof t!="string")return;const e=t.split(".");if(e.length!==3)return;const r=e[1],n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(Math.ceil(r.length/4)*4,"=");try{const s=typeof atob=="function"?atob(n):Buffer.from(n,"base64").toString("binary"),i=decodeURIComponent(Array.from(s,a=>"%"+a.charCodeAt(0).toString(16).padStart(2,"0")).join(""));return JSON.parse(i)}catch{return}}function Ml(t){return t.exp===void 0?!1:t.exp*1e3<Date.now()}class JC extends O{constructor(e,...r){super(...r),this.name="UnrecognizedFetchPolicyError",this.baseMessage="The fetch policy "+e+" is not recognized.",this.status=L["Bad Request"]}}class Ll extends O{constructor(e,...r){super(...r),this.name="RemoteSyncFailedError",this.baseMessage="Remote sync failed for query: "+JSON.stringify(e,null,2),this.status=L["Internal Server Error"]}}class YC extends O{constructor(...e){super(...e),this.name="IndexedDbUnavailableError",this.baseMessage="IndexedDB is not available in this environment. If you are creating a TriplitClient on the server e.g. prerendering with a SSR framework like Next.js or SvelteKit, you may need to use the `memory` storage provider. Consult our SSR guide (https://triplit.dev/docs/ssr) for more information. If you are running on a non-browser client, like a mobile app, try one of our other storage providers (https://triplit.dev/docs/client/storage).",this.status=L["Service Unavailable"]}}class XC extends O{constructor(...e){super(...e),this.name="WebSocketsUnavailableError",this.baseMessage="The TriplitClient syncs over WebSockets, which are not available in this environment. If you are creating a TriplitClient on the server e.g. prerendering with a SSR framework like Next.js or SvelteKit, you should interact with Triplit over HTTP. Consult our SSR guide (https://triplit.dev/docs/ssr) for more information.",this.status=L["Service Unavailable"]}}class eR extends O{constructor(...e){super(...e),this.name="SessionRoleMismatchError",this.baseMessage="Attempted to use `TriplitClient.updateSessionToken` with a token that does not have the same roles as the current session token. `updateSessionToken` should only be used to refresh the session with the server to prevent token expiry. To connect with a new token with new roles, use `TriplitClient.endSession` and then `TriplitClient.startSession(...)` with the new token.",this.status=L.Forbidden}}class Bl extends O{constructor(...e){super(...e),this.name="TokenExpiredError",this.baseMessage="The provided token has expired. Please ensure that you are using a fresh token when calling `startSession` or `updateSessionToken`.",this.status=L.Unauthorized}}class tR extends O{constructor(...e){super(...e),this.name="NoActiveSessionError",this.baseMessage="Attempted to perform an operation that requires an active session when no session is active. Call `TriplitClient.startSession(...)` to start a new session.",this.status=L.Forbidden}}class rR extends O{constructor(e,...r){super(...r),this.name="TokenDecodingError",this.baseMessage=`The provided token ("${e}") could not be decoded. Please ensure that you are using a valid JWT token.`,this.status=L.Unauthorized}}const nR=1024*1024/2;function sR(){return typeof WebSocket<"u"}class iR{constructor(e={}){b(this,"options");b(this,"ws");b(this,"connectionListeners",new Set);this.options=e,this.options.messagePayloadSizeLimit=this.options.messagePayloadSizeLimit==null?nR:this.options.messagePayloadSizeLimit}get isOpen(){return!!this.ws&&this.ws.readyState===this.ws.OPEN}get connectionStatus(){return this.ws?Xf(this.ws):"UNINITIALIZED"}onOpen(e){this.ws&&(this.ws.onopen=e)}sendMessage(e){if(!this.ws||!this.isOpen)return!1;const r=JSON.stringify(e),n=aR(r);if(this.options.messagePayloadSizeLimit&&n>this.options.messagePayloadSizeLimit){const s=oR(r,Math.ceil(n/this.options.messagePayloadSizeLimit)),i=(Math.random()+1).toString(36).substring(7);for(let a=0;a<s.length;a++)this.ws.send(JSON.stringify({type:"CHUNK",payload:{data:s[a],total:s.length,index:a,id:i}}));return!0}return this.ws.send(JSON.stringify(e)),!0}connect(e){this.close();const{token:r,schema:n,syncSchema:s,server:i}=e,a=new URLSearchParams;n&&a.set("schema",n.toString()),a.set("sync-schema",String(!!s)),a.set("token",r);const o=i.startsWith("https://"),c=i.slice(o?8:7),l=`${o?"wss":"ws"}://${c}?${a.toString()}`;if(!sR())throw new XC;this.ws=new WebSocket(l),this.ws.onconnectionchange=u=>{this.connectionListeners.forEach(d=>d(u))}}onMessage(e){this.ws&&(this.ws.onmessage=e)}onError(e){this.ws&&(this.ws.onerror=e)}close(e){if(this.ws){if(this.ws.readyState===this.ws.OPEN)return this.ws.close(1e3,JSON.stringify(e));if(this.ws.readyState===this.ws.CONNECTING)return this.ws.addEventListener("open",()=>{var r;(r=this.ws)==null||r.close(1e3,JSON.stringify(e))},{once:!0})}}onClose(e){this.ws&&(this.ws.onclose=e)}onConnectionChange(e){return this.connectionListeners.add(e),()=>{this.connectionListeners.delete(e)}}}function aR(t){var e=0;for(let r=0;r<t.length;r++){const n=t.charCodeAt(r);e+=n<128?1:n<2048?2:n<65536?3:4}return e}function oR(t,e){let r=[];const n=Math.ceil(t.length/e);for(let s=0;s<t.length;s+=n)r.push(t.slice(s,s+n));return r}function Xf(t){switch(t.readyState){case t.CONNECTING:return"CONNECTING";case t.OPEN:return"OPEN";case t.CLOSING:return"CLOSING";case t.CLOSED:default:return"CLOSED"}}if(typeof globalThis<"u"&&globalThis.WebSocket){var cR=new Proxy(globalThis.WebSocket,{construct:function(t,e){const r=new t(...e);function n(){r.dispatchEvent(new Event("connectionchange")),r.onconnectionchange&&typeof r.onconnectionchange=="function"&&r.onconnectionchange(Xf(r))}setTimeout(()=>{n()},0);const s=()=>{n()},i=()=>{n(),r.removeEventListener("open",s),r.removeEventListener("close",i)};return r.addEventListener("open",s),r.addEventListener("close",i),r}});globalThis.WebSocket=cR}class lR{constructor(){this.keyToValue=new Map,this.valueToKey=new Map}set(e,r){this.keyToValue.set(e,r),this.valueToKey.set(r,e)}getByKey(e){return this.keyToValue.get(e)}getByValue(e){return this.valueToKey.get(e)}clear(){this.keyToValue.clear(),this.valueToKey.clear()}}class eh{constructor(e){this.generateIdentifier=e,this.kv=new lR}register(e,r){this.kv.getByValue(e)||(r||(r=this.generateIdentifier(e)),this.kv.set(r,e))}clear(){this.kv.clear()}getIdentifier(e){return this.kv.getByValue(e)}getValue(e){return this.kv.getByKey(e)}}class uR extends eh{constructor(){super(e=>e.name),this.classToAllowedProps=new Map}register(e,r){typeof r=="object"?(r.allowProps&&this.classToAllowedProps.set(e,r.allowProps),super.register(e,r.identifier)):super.register(e,r)}getAllowedProps(e){return this.classToAllowedProps.get(e)}}function dR(t){if("values"in Object)return Object.values(t);const e=[];for(const r in t)t.hasOwnProperty(r)&&e.push(t[r]);return e}function fR(t,e){const r=dR(t);if("find"in r)return r.find(e);const n=r;for(let s=0;s<n.length;s++){const i=n[s];if(e(i))return i}}function dr(t,e){Object.entries(t).forEach(([r,n])=>e(n,r))}function Gn(t,e){return t.indexOf(e)!==-1}function Ul(t,e){for(let r=0;r<t.length;r++){const n=t[r];if(e(n))return n}}class hR{constructor(){this.transfomers={}}register(e){this.transfomers[e.name]=e}findApplicable(e){return fR(this.transfomers,r=>r.isApplicable(e))}findByName(e){return this.transfomers[e]}}const pR=t=>Object.prototype.toString.call(t).slice(8,-1),th=t=>typeof t>"u",yR=t=>t===null,Gr=t=>typeof t!="object"||t===null||t===Object.prototype?!1:Object.getPrototypeOf(t)===null?!0:Object.getPrototypeOf(t)===Object.prototype,Ta=t=>Gr(t)&&Object.keys(t).length===0,It=t=>Array.isArray(t),mR=t=>typeof t=="string",gR=t=>typeof t=="number"&&!isNaN(t),vR=t=>typeof t=="boolean",bR=t=>t instanceof RegExp,qr=t=>t instanceof Map,Jr=t=>t instanceof Set,rh=t=>pR(t)==="Symbol",wR=t=>t instanceof Date&&!isNaN(t.valueOf()),SR=t=>t instanceof Error,zl=t=>typeof t=="number"&&isNaN(t),IR=t=>vR(t)||yR(t)||th(t)||gR(t)||mR(t)||rh(t),ER=t=>typeof t=="bigint",$R=t=>t===1/0||t===-1/0,_R=t=>ArrayBuffer.isView(t)&&!(t instanceof DataView),TR=t=>t instanceof URL,nh=t=>t.replace(/\./g,"\\."),Ui=t=>t.map(String).map(nh).join("."),Vr=t=>{const e=[];let r="";for(let s=0;s<t.length;s++){let i=t.charAt(s);if(i==="\\"&&t.charAt(s+1)==="."){r+=".",s++;continue}if(i==="."){e.push(r),r="";continue}r+=i}const n=r;return e.push(n),e};function Ke(t,e,r,n){return{isApplicable:t,annotation:e,transform:r,untransform:n}}const sh=[Ke(th,"undefined",()=>null,()=>{}),Ke(ER,"bigint",t=>t.toString(),t=>typeof BigInt<"u"?BigInt(t):(console.error("Please add a BigInt polyfill."),t)),Ke(wR,"Date",t=>t.toISOString(),t=>new Date(t)),Ke(SR,"Error",(t,e)=>{const r={name:t.name,message:t.message};return e.allowedErrorProps.forEach(n=>{r[n]=t[n]}),r},(t,e)=>{const r=new Error(t.message);return r.name=t.name,r.stack=t.stack,e.allowedErrorProps.forEach(n=>{r[n]=t[n]}),r}),Ke(bR,"regexp",t=>""+t,t=>{const e=t.slice(1,t.lastIndexOf("/")),r=t.slice(t.lastIndexOf("/")+1);return new RegExp(e,r)}),Ke(Jr,"set",t=>[...t.values()],t=>new Set(t)),Ke(qr,"map",t=>[...t.entries()],t=>new Map(t)),Ke(t=>zl(t)||$R(t),"number",t=>zl(t)?"NaN":t>0?"Infinity":"-Infinity",Number),Ke(t=>t===0&&1/t===-1/0,"number",()=>"-0",Number),Ke(TR,"URL",t=>t.toString(),t=>new URL(t))];function Ms(t,e,r,n){return{isApplicable:t,annotation:e,transform:r,untransform:n}}const ih=Ms((t,e)=>rh(t)?!!e.symbolRegistry.getIdentifier(t):!1,(t,e)=>["symbol",e.symbolRegistry.getIdentifier(t)],t=>t.description,(t,e,r)=>{const n=r.symbolRegistry.getValue(e[1]);if(!n)throw new Error("Trying to deserialize unknown symbol");return n}),OR=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Uint8ClampedArray].reduce((t,e)=>(t[e.name]=e,t),{}),ah=Ms(_R,t=>["typed-array",t.constructor.name],t=>[...t],(t,e)=>{const r=OR[e[1]];if(!r)throw new Error("Trying to deserialize unknown typed array");return new r(t)});function oh(t,e){return t!=null&&t.constructor?!!e.classRegistry.getIdentifier(t.constructor):!1}const ch=Ms(oh,(t,e)=>["class",e.classRegistry.getIdentifier(t.constructor)],(t,e)=>{const r=e.classRegistry.getAllowedProps(t.constructor);if(!r)return{...t};const n={};return r.forEach(s=>{n[s]=t[s]}),n},(t,e,r)=>{const n=r.classRegistry.getValue(e[1]);if(!n)throw new Error(`Trying to deserialize unknown class '${e[1]}' - check https://github.com/blitz-js/superjson/issues/116#issuecomment-773996564`);return Object.assign(Object.create(n.prototype),t)}),lh=Ms((t,e)=>!!e.customTransformerRegistry.findApplicable(t),(t,e)=>["custom",e.customTransformerRegistry.findApplicable(t).name],(t,e)=>e.customTransformerRegistry.findApplicable(t).serialize(t),(t,e,r)=>{const n=r.customTransformerRegistry.findByName(e[1]);if(!n)throw new Error("Trying to deserialize unknown custom value");return n.deserialize(t)}),CR=[ch,ih,lh,ah],Vl=(t,e)=>{const r=Ul(CR,s=>s.isApplicable(t,e));if(r)return{value:r.transform(t,e),type:r.annotation(t,e)};const n=Ul(sh,s=>s.isApplicable(t,e));if(n)return{value:n.transform(t,e),type:n.annotation}},uh={};sh.forEach(t=>{uh[t.annotation]=t});const RR=(t,e,r)=>{if(It(e))switch(e[0]){case"symbol":return ih.untransform(t,e,r);case"class":return ch.untransform(t,e,r);case"custom":return lh.untransform(t,e,r);case"typed-array":return ah.untransform(t,e,r);default:throw new Error("Unknown transformation: "+e)}else{const n=uh[e];if(!n)throw new Error("Unknown transformation: "+e);return n.untransform(t,r)}},Jt=(t,e)=>{if(e>t.size)throw new Error("index out of bounds");const r=t.keys();for(;e>0;)r.next(),e--;return r.next().value};function dh(t){if(Gn(t,"__proto__"))throw new Error("__proto__ is not allowed as a property");if(Gn(t,"prototype"))throw new Error("prototype is not allowed as a property");if(Gn(t,"constructor"))throw new Error("constructor is not allowed as a property")}const xR=(t,e)=>{dh(e);for(let r=0;r<e.length;r++){const n=e[r];if(Jr(t))t=Jt(t,+n);else if(qr(t)){const s=+n,i=+e[++r]==0?"key":"value",a=Jt(t,s);switch(i){case"key":t=a;break;case"value":t=t.get(a);break}}else t=t[n]}return t},Oa=(t,e,r)=>{if(dh(e),e.length===0)return r(t);let n=t;for(let i=0;i<e.length-1;i++){const a=e[i];if(It(n)){const o=+a;n=n[o]}else if(Gr(n))n=n[a];else if(Jr(n)){const o=+a;n=Jt(n,o)}else if(qr(n)){if(i===e.length-2)break;const c=+a,l=+e[++i]==0?"key":"value",u=Jt(n,c);switch(l){case"key":n=u;break;case"value":n=n.get(u);break}}}const s=e[e.length-1];if(It(n)?n[+s]=r(n[+s]):Gr(n)&&(n[s]=r(n[s])),Jr(n)){const i=Jt(n,+s),a=r(i);i!==a&&(n.delete(i),n.add(a))}if(qr(n)){const i=+e[e.length-2],a=Jt(n,i);switch(+s==0?"key":"value"){case"key":{const c=r(a);n.set(c,n.get(a)),c!==a&&n.delete(a);break}case"value":{n.set(a,r(n.get(a)));break}}}return t};function Ca(t,e,r=[]){if(!t)return;if(!It(t)){dr(t,(i,a)=>Ca(i,e,[...r,...Vr(a)]));return}const[n,s]=t;s&&dr(s,(i,a)=>{Ca(i,e,[...r,...Vr(a)])}),e(n,r)}function kR(t,e,r){return Ca(e,(n,s)=>{t=Oa(t,s,i=>RR(i,n,r))}),t}function AR(t,e){function r(n,s){const i=xR(t,Vr(s));n.map(Vr).forEach(a=>{t=Oa(t,a,()=>i)})}if(It(e)){const[n,s]=e;n.forEach(i=>{t=Oa(t,Vr(i),()=>t)}),s&&dr(s,r)}else dr(e,r);return t}const PR=(t,e)=>Gr(t)||It(t)||qr(t)||Jr(t)||oh(t,e);function NR(t,e,r){const n=r.get(t);n?n.push(e):r.set(t,[e])}function DR(t,e){const r={};let n;return t.forEach(s=>{if(s.length<=1)return;e||(s=s.map(o=>o.map(String)).sort((o,c)=>o.length-c.length));const[i,...a]=s;i.length===0?n=a.map(Ui):r[Ui(i)]=a.map(Ui)}),n?Ta(r)?[n]:[n,r]:Ta(r)?void 0:r}const fh=(t,e,r,n,s=[],i=[],a=new Map)=>{const o=IR(t);if(!o){NR(t,s,e);const h=a.get(t);if(h)return n?{transformedValue:null}:h}if(!PR(t,r)){const h=Vl(t,r),f=h?{transformedValue:h.value,annotations:[h.type]}:{transformedValue:t};return o||a.set(t,f),f}if(Gn(i,t))return{transformedValue:null};const c=Vl(t,r),l=(c==null?void 0:c.value)??t,u=It(l)?[]:{},d={};dr(l,(h,f)=>{if(f==="__proto__"||f==="constructor"||f==="prototype")throw new Error(`Detected property ${f}. This is a prototype pollution risk, please remove it from your object.`);const m=fh(h,e,r,n,[...s,f],[...i,t],a);u[f]=m.transformedValue,It(m.annotations)?d[f]=m.annotations:Gr(m.annotations)&&dr(m.annotations,(v,g)=>{d[nh(f)+"."+g]=v})});const y=Ta(d)?{transformedValue:u,annotations:c?[c.type]:void 0}:{transformedValue:u,annotations:c?[c.type,d]:d};return o||a.set(t,y),y};function hh(t){return Object.prototype.toString.call(t).slice(8,-1)}function Hl(t){return hh(t)==="Array"}function jR(t){if(hh(t)!=="Object")return!1;const e=Object.getPrototypeOf(t);return!!e&&e.constructor===Object&&e===Object.prototype}function FR(t,e,r,n,s){const i={}.propertyIsEnumerable.call(n,e)?"enumerable":"nonenumerable";i==="enumerable"&&(t[e]=r),s&&i==="nonenumerable"&&Object.defineProperty(t,e,{value:r,enumerable:!1,writable:!0,configurable:!0})}function Ra(t,e={}){if(Hl(t))return t.map(s=>Ra(s,e));if(!jR(t))return t;const r=Object.getOwnPropertyNames(t),n=Object.getOwnPropertySymbols(t);return[...r,...n].reduce((s,i)=>{if(Hl(e.props)&&!e.props.includes(i))return s;const a=t[i],o=Ra(a,e);return FR(s,i,o,t,e.nonenumerable),s},{})}class M{constructor({dedupe:e=!1}={}){this.classRegistry=new uR,this.symbolRegistry=new eh(r=>r.description??""),this.customTransformerRegistry=new hR,this.allowedErrorProps=[],this.dedupe=e}serialize(e){const r=new Map,n=fh(e,r,this,this.dedupe),s={json:n.transformedValue};n.annotations&&(s.meta={...s.meta,values:n.annotations});const i=DR(r,this.dedupe);return i&&(s.meta={...s.meta,referentialEqualities:i}),s}deserialize(e){const{json:r,meta:n}=e;let s=Ra(r);return n!=null&&n.values&&(s=kR(s,n.values,this)),n!=null&&n.referentialEqualities&&(s=AR(s,n.referentialEqualities)),s}stringify(e){return JSON.stringify(this.serialize(e))}parse(e){return this.deserialize(JSON.parse(e))}registerClass(e,r){this.classRegistry.register(e,r)}registerSymbol(e,r){this.symbolRegistry.register(e,r)}registerCustom(e,r){this.customTransformerRegistry.register({name:r,...e})}allowErrorProps(...e){this.allowedErrorProps.push(...e)}}M.defaultInstance=new M;M.serialize=M.defaultInstance.serialize.bind(M.defaultInstance);M.deserialize=M.defaultInstance.deserialize.bind(M.defaultInstance);M.stringify=M.defaultInstance.stringify.bind(M.defaultInstance);M.parse=M.defaultInstance.parse.bind(M.defaultInstance);M.registerClass=M.defaultInstance.registerClass.bind(M.defaultInstance);M.registerSymbol=M.defaultInstance.registerSymbol.bind(M.defaultInstance);M.registerCustom=M.defaultInstance.registerCustom.bind(M.defaultInstance);M.allowErrorProps=M.defaultInstance.allowErrorProps.bind(M.defaultInstance);M.serialize;M.deserialize;M.stringify;M.parse;M.registerClass;M.registerCustom;M.registerSymbol;M.allowErrorProps;const Wl="query-state";function MR(t){for(const e in t)if(Object.hasOwn(t,e))return!1;return!0}class LR{constructor(e,r){b(this,"transport");b(this,"client");b(this,"connectionChangeHandlers",new Set);b(this,"messageReceivedSubscribers",new Set);b(this,"messageSentSubscribers",new Set);b(this,"sessionErrorSubscribers",new Set);b(this,"entitySyncErrorSubscribers",new Fl);b(this,"entitySyncSuccessSubscribers",new Fl);b(this,"onFailureToSyncWritesSubscribers",new Set);b(this,"logger");b(this,"syncInProgress",!1);b(this,"reconnectTimeoutDelay",250);b(this,"reconnectTimeout");b(this,"serverReady",!1);b(this,"queries",new Map);b(this,"clientId",null);b(this,"connectionAbort",!1);b(this,"lastParamsHash");if(this.client=e,this.logger=r.logger,this.client.onConnectionOptionsChange(n=>{this.connectionStatus==="OPEN"&&("serverUrl"in n||"token"in n&&!n.tokenRefresh)&&(this.logger.warn("You are updating the connection options while the connection is open. To avoid unexpected behavior the connection will be closed and you should call `connect()` again after the update. To hide this warning, call `disconnect()` before updating the connection options."),this.disconnect())}),this.transport=r.transport??new iR,this.transport.onConnectionChange(n=>{(n==="CLOSING"||n==="CLOSED")&&this.lastParamsHash!==void 0&&(this.lastParamsHash=void 0)}),r.pingInterval){const n=setInterval(()=>{this.connectionStatus==="OPEN"&&this.serverReady&&this.sendMessage({type:"PING",payload:{}})},r.pingInterval*1e3);typeof n=="object"&&"unref"in n&&n.unref()}}async sendChanges(e){this.sendMessage({type:"CHANGES",payload:{changes:M.serialize(e)}})}async syncWrites(){return this.client.awaitReady&&await this.client.awaitReady,this.syncInProgress?{didSync:!1,syncFailureReason:"Sync in progress"}:this.connectionStatus!=="OPEN"?{didSync:!1,syncFailureReason:"Connection not open"}:this.serverReady?(await this.client.db.entityStore.doubleBuffer.getLockedBuffer().isEmpty(this.client.db.kv)&&this.client.db.entityStore.doubleBuffer.lockAndSwitchBuffers(),await this.trySyncLockedBuffer(),{didSync:!0}):{didSync:!1,syncFailureReason:"Server not ready"}}async trySyncLockedBuffer(){this.syncInProgress=!0;try{const e=await this.client.db.entityStore.doubleBuffer.getLockedBuffer().getChanges(this.client.db.kv);if(MR(e))this.syncInProgress=!1;else return this.syncInProgress=!0,this.sendChanges(e)}catch(e){throw this.syncInProgress=!1,e}}async createRollbackBufferFromChanges(e){const r={};for(const[n,{sets:s,deletes:i}]of Object.entries(e)){r[n]={sets:new Map,deletes:new Set};const a=this.client.db.entityStore.dataStore,o=this.client.db.kv;for(const c of i){const l=await a.getEntity(o,n,c);l&&r[n].sets.set(c,l)}for(const c of s.keys()){if(r[n].sets.has(c))continue;const l=await a.getEntity(o,n,c);l?r[n].sets.set(c,l):r[n].deletes.add(c)}}return r}async clearPendingChangesForEntity(e,r){this.client.awaitReady&&await this.client.awaitReady;const n=this.client.db.kv.transact(),s=await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().getChangesForEntity(n,e,r),i={[e]:{sets:new Map,deletes:new Set}};s&&(s.delete&&i[e].deletes.add(r),s.update&&i[e].sets.set(r,s.update));const a=await this.createRollbackBufferFromChanges(i);return await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().clearChangesForEntity(n,e,r),await n.commit(),await this.client.db.ivm.bufferChanges(a),await this.client.db.updateQueryViews(),this.client.db.broadcastToQuerySubscribers(),this.syncWrites()}async clearPendingChangesAll(){this.client.awaitReady&&await this.client.awaitReady;const e=this.client.db.kv.transact(),r=await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().getChanges(this.client.db.kv),n=await this.createRollbackBufferFromChanges(r);await this.client.db.entityStore.doubleBuffer.getUnlockedBuffer().clear(e),await e.commit(),await this.client.db.ivm.bufferChanges(n),await this.client.db.updateQueryViews(),this.client.db.broadcastToQuerySubscribers()}async updateTokenForSession(e){try{return await fetch(`${this.client.serverUrl}/update-token`,{method:"POST",body:JSON.stringify({clientId:this.clientId}),headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}),!0}catch(r){return console.error(r),this.logger.error("Failed to update token",r),!1}}onSyncMessageReceived(e){return this.messageReceivedSubscribers.add(e),()=>{this.messageReceivedSubscribers.delete(e)}}onSyncMessageSent(e){return this.messageSentSubscribers.add(e),()=>{this.messageSentSubscribers.delete(e)}}onEntitySyncSuccess(e,r,n){return this.entitySyncSuccessSubscribers.set(e,r,n),()=>{this.entitySyncSuccessSubscribers.delete(e,r)}}onEntitySyncError(e,r,n){return this.entitySyncErrorSubscribers.set(e,r,n),()=>{this.entitySyncErrorSubscribers.delete(e,r)}}onFailureToSyncWrites(e){return this.onFailureToSyncWritesSubscribers.add(e),()=>{this.onFailureToSyncWritesSubscribers.delete(e)}}onSessionError(e){return this.sessionErrorSubscribers.add(e),()=>{this.sessionErrorSubscribers.delete(e)}}async getConnectionParams(){var n;this.client.awaitReady&&await this.client.awaitReady;const e=(n=this.client.db.getSchema())==null?void 0:n.collections;return{schema:e?is(e):void 0,syncSchema:this.client.syncSchema,token:this.client.token,server:this.client.serverUrl}}async isFirstTimeFetchingQuery(e){return this.client.awaitReady&&await this.client.awaitReady,!await this.client.db.getMetadata([Wl,Mi(e)])}async markQueryAsSeen(e){return this.client.awaitReady&&await this.client.awaitReady,this.client.db.setMetadata([Wl,e],!0)}async subscribe(e,r={}){const{onQueryFulfilled:n,onQueryError:s,onQuerySyncStateChange:i}=r,a=Mi(e),o=this.queries.has(a);o||this.queries.set(a,{params:e,syncState:"NOT_STARTED",syncStateCallbacks:new Set,subCount:0,hasSent:!1,abortController:new AbortController});const c=this.queries.get(a);c.subCount++,i&&c.syncStateCallbacks.add(i);let l;n&&(c.syncState==="FULFILLED"&&n(),l=d=>{d==="FULFILLED"&&n()},c.syncStateCallbacks.add(l));let u;return s&&(u=(d,y)=>{d==="ERROR"&&s(y)},c.syncStateCallbacks.add(u)),o||await this.connectQuery(a),()=>{const d=this.queries.get(a);if(!d){this.disconnectQuery(a);return}if(d.subCount--,l&&d.syncStateCallbacks.delete(l),u&&d.syncStateCallbacks.delete(u),i&&d.syncStateCallbacks.delete(i),d.subCount===0){this.disconnectQuery(a);return}}}async connectQuery(e){var a;if(this.client.awaitReady&&await this.client.awaitReady,!this.queries.has(e))return;const r=this.queries.get(e);if(!r||r.hasSent||r.abortController.signal.aborted||!this.serverReady)return;const n=await this.client.db.getMetadata(["latest_server_timestamp"]);let s;if(n){const o=MO(Nf(pt(r.params,(a=this.client.db.schema)==null?void 0:a.collections,{},void 0,{applyPermission:void 0}))),l=await new Br(this.client.db.kv,this.client.db.entityStore.dataStore).fetch(o),u=mo(l,o),d=BR(u);s={timestamp:n,entityIds:d}}const i=this.sendMessage({type:"CONNECT_QUERY",payload:{id:e,params:r.params,state:s}});if(i){r.syncState="IN_FLIGHT";for(const o of r.syncStateCallbacks)o("IN_FLIGHT",void 0);r.hasSent=!0}return i}hasServerRespondedForQuery(e){const r=Mi(e),n=this.queries.get(r);return(n&&n.syncState==="FULFILLED")??!1}disconnectQuery(e){if(!this.queries.has(e))return;const r=this.queries.get(e);r.hasSent?this.sendMessage({type:"DISCONNECT_QUERY",payload:{id:e}}):r.abortController.abort(),this.queries.delete(e)}async connect(){this.connectionAbort=!1;const e=await this.getConnectionParams();this.createConnection(e)}createConnection(e){if(this.connectionAbort||!this.validateConnectionParamsWithWarning(e))return;const r=is(e);this.connectionStatus!=="OPEN"&&this.connectionStatus!=="CONNECTING"&&(this.lastParamsHash=void 0),this.lastParamsHash!==r&&(this.lastParamsHash=r,this.transport.connect(e),this.transport.onMessage(this.onMessageHandler.bind(this)),this.transport.onOpen(this.onOpenHandler.bind(this)),this.transport.onClose(this.onCloseHandler.bind(this)),this.transport.onError(this.onErrorHandler.bind(this)),this.transport.onConnectionChange(this.onConnectionChangeHandler.bind(this)))}async initializeSync(){const e=await this.syncWrites();e.didSync||this.logger.warn(`Failed to send changes on initialization: ${e.syncFailureReason}`);for(const[r]of this.queries)this.connectQuery(r)}async onMessageHandler(e){const r=JSON.parse(e.data);this.logger.debug("received",r);for(const n of this.messageReceivedSubscribers)n(r);if(r.type==="ERROR"&&await this.handleErrorMessage(r),r.type==="ENTITY_DATA"){const{changes:n,timestamp:s,forQueries:i}=r.payload,a=M.deserialize(n);this.client.awaitReady&&await this.client.awaitReady,await this.client.db.applyChangesWithTimestamp(a,s,{skipRules:!0}),await this.client.db.setMetadata(["latest_server_timestamp"],s);for(const o of i){const c=this.queries.get(o);c&&c.syncState!=="FULFILLED"&&(await this.markQueryAsSeen(o),c.syncState="FULFILLED")}await this.client.db.updateQueryViews(),this.client.db.broadcastToQuerySubscribers();for(const o of i){const c=this.queries.get(o);if(c)for(const l of c.syncStateCallbacks)l("FULFILLED",r.payload)}}if(r.type==="CHANGES_ACK"){this.client.awaitReady&&await this.client.awaitReady;const n=await this.client.db.entityStore.doubleBuffer.getLockedBuffer().getChanges(this.client.db.kv),s=this.client.db.kv.transact();await this.client.db.entityStore.applyChangesWithTimestamp(s,n,r.payload.timestamp,{checkWritePermission:void 0,entityChangeValidator:void 0}),await this.client.db.entityStore.doubleBuffer.getLockedBuffer().clear(s),await s.commit();for(const[i,a]of this.entitySyncSuccessSubscribers){const o=n[i];if(o)for(const[c,l]of a)(o.sets.has(c)||o.deletes.has(c))&&l()}this.syncInProgress=!1,await this.syncWrites()}if(r.type==="CLOSE"){const{payload:n}=r;this.logger.info(`Closing connection${n!=null&&n.message?`: ${n.message}`:"."}`);const{type:s,retry:i}=n;this.closeConnection({type:s,retry:i})}if(r.type==="SCHEMA_REQUEST"){const n=await this.client.getSchema();this.sendMessage({type:"SCHEMA_RESPONSE",payload:{schema:n}})}if(r.type==="READY"){const{payload:n}=r,{clientId:s}=n;this.clientId=s,this.serverReady||(this.serverReady=!0,await this.initializeSync())}}onOpenHandler(){this.logger.info("sync connection has opened",{status:this.connectionStatus}),this.resetReconnectTimeout()}onCloseHandler(e){if(this.resetSyncConnectionState(),this.serverReady=!1,e.reason){let n,s;try{const{type:i,retry:a}=JSON.parse(e.reason);n=i,s=a}catch{n="UNKNOWN",s=!0}if(n==="UNAUTHORIZED"&&this.logger.error("The server has closed the connection because the client is unauthorized. Please provide a valid token."),n==="SCHEMA_MISMATCH"&&this.logger.error("The server has closed the connection because the client schema does not match the server schema. Please update your client schema."),n==="TOKEN_EXPIRED"&&this.logger.error("The server has closed the connection because the token has expired. Fetch a new token from your authentication provider and call `TriplitClient.endSession()` and `TriplitClient.startSession(token)` to restart the session."),n==="ROLES_MISMATCH"&&this.logger.error("The server has closed the connection because the client attempted to update the session with a token that has different roles than the existing token. Call `TriplitClient.endSession()` and `TriplitClient.startSession(token)` to restart the session with the new token."),["ROLES_MISMATCH","TOKEN_EXPIRED","SCHEMA_MISMATCH","UNAUTHORIZED"].includes(n))for(const i of this.sessionErrorSubscribers)i(n);if(!s){this.logger.warn("The connection has closed. Based on the signal, the connection will not automatically retry. If you would like to reconnect, please call `connect()`.");return}}const r=this.connect.bind(this);this.reconnectTimeout=setTimeout(r,this.reconnectTimeoutDelay),this.reconnectTimeoutDelay=Math.min(3e5,this.reconnectTimeoutDelay*2)}onErrorHandler(e){this.logger.error("An error occurred during the connection to the server. Retrying connection..."),this.closeConnection()}onConnectionChangeHandler(e){for(const r of this.connectionChangeHandlers)r(e)}get connectionStatus(){return this.transport.connectionStatus}disconnect(){this.closeConnection({type:"MANUAL_DISCONNECT",retry:!1})}resetQueryState(){this.connectionStatus==="OPEN"&&(this.logger.warn("You are resetting the sync engine while the connection is open. To avoid unexpected behavior the connection will be closed and you should call `connect()` again after resetting. To hide this warning, call `disconnect()` before resetting."),this.disconnect()),this.resetSyncConnectionState()}resetSyncConnectionState(){this.syncInProgress=!1;for(const e of this.queries.values())e.hasSent=!1,e.syncState="NOT_STARTED"}async handleErrorMessage(e){var i;const{error:r,metadata:n,messageType:s}=e.payload;switch(this.logger.error(r.name,n),r.name){case"MalformedMessagePayloadError":case"UnrecognizedMessageTypeError":this.logger.warn("You sent a malformed message to the server. This might occur if your client is not up to date with the server. Please ensure your client is updated.");break;case"QuerySyncError":const a=n==null?void 0:n.queryKey;if(a){const o=this.queries.get(a);if(o){const c=O.fromJson(r);o.syncState="ERROR";for(const l of o.syncStateCallbacks)await l("ERROR",c)}this.disconnectQuery(a)}}if(s==="CHANGES"){this.client.awaitReady&&await this.client.awaitReady;const a=this.client.db.kv.transact(),o=this.client.db.entityStore.doubleBuffer,c=await o.getLockedBuffer().getChanges(a);await o.getLockedBuffer().write(a,await o.getUnlockedBuffer().getChanges(a)),await o.getUnlockedBuffer().clear(a),await a.commit(),o.lockAndSwitchBuffers(),this.syncInProgress=!1;for(const l of this.onFailureToSyncWritesSubscribers)await l(r,c);for(const l in c)for(const[u,d]of c[l].sets){const y=this.entitySyncErrorSubscribers.get(l,u);y&&await y((i=n==null?void 0:n.failures[0])==null?void 0:i.error,d)}}}sendMessage(e){const r=this.transport.sendMessage(e);if(r){this.logger.debug("sent",e);for(const n of this.messageSentSubscribers)n(e)}return r}onConnectionStatusChange(e,r=!1){return this.connectionChangeHandlers.add(e),r&&e(this.transport.connectionStatus),()=>{this.connectionChangeHandlers.delete(e)}}closeConnection(e){this.connectionAbort=!0,this.transport.close(e)}resetReconnectTimeout(){clearTimeout(this.reconnectTimeout),this.reconnectTimeoutDelay=250}async syncQuery(e){try{let r,n;const s=new Promise((a,o)=>{r=a,n=o}),i=this.subscribe(e,{onQueryFulfilled:async()=>{const a=await i;r(void 0),a()}});return s}catch(r){throw r instanceof O?r:r instanceof Error?new Ll(e,r.message):new Ll(e,"An unknown error occurred.")}}validateConnectionParamsWithWarning(e){const r=[];return e.token||r.push("token"),e.server||r.push("serverUrl"),r.length?(this.logger.warn(`You are attempting to connect but the connection cannot be opened because the required parameters are missing: [${r.join(", ")}].`),!1):!0}}function BR(t){const e={};for(const[r,n]of Object.entries(t)){const s=[...n.sets.keys(),...n.deletes];e[r]=s}return e}function UR(t){try{const e=JSON.parse(t);return O.fromJson(e)}catch{return new O(`Failed to parse remote error response: ${t}`)}}class zR{constructor(e={}){b(this,"options");b(this,"_schemaInitialized",!1);this.options=e}async schema(){return this._schemaInitialized||(this.options.schema||(this.options.schema=await(this.options.schemaFactory?this.options.schemaFactory():void 0)),this._schemaInitialized=!0),this.options.schema}updateOptions(e){this.options={...this.options,...e}}async sendRequest(e,r,n,s={isFile:!1}){const i=this.options.serverUrl;if(!i)throw new O("No server url provided");if(!this.options.token)throw new O("No token provided");const a={Authorization:"Bearer "+this.options.token,"Content-Type":"application/json"},o=JSON.stringify(n);let c;s.isFile&&(c=new FormData,c.append("data",o),delete a["Content-Type"]);const l=await fetch(i+e,{method:r,headers:a,body:s.isFile?c:o});return l.ok?{data:await l.json(),error:void 0}:{data:void 0,error:UR(await l.text())}}async fetch(e){const{data:r,error:n}=await this.sendRequest("/fetch","POST",{query:e});if(n)throw n;return $a(e,await this.schema(),r)}async fetchOne(e){e={...e,limit:1};const{data:r,error:n}=await this.sendRequest("/fetch","POST",{query:e});if(n)throw n;const i=$a(e,await this.schema(),r)[0];return i||null}async fetchById(e,r){const n=this.query(e).Id(r);return this.fetchOne(n)}async insert(e,r){const n=await this.schema(),s=n==null?void 0:n[e].schema,i=s?te.serialize(s,r,"decoded"):r,{data:a,error:o}=await this.sendRequest("/insert","POST",{collectionName:e,entity:i});if(o)throw o;return _a(s,a)}async bulkInsert(e){const r=await this.schema();let n=e;if(r){const o={};for(const c in e){const l=c,u=e[l],d=r==null?void 0:r[l].schema;u&&(o[l]=u.map(y=>QC(d,y)))}n=o}const{data:s,error:i}=await this.sendRequest("/bulk-insert-file","POST",n,{isFile:!0});if(i)throw i;const a={};for(const o in s){const c=o,l=r==null?void 0:r[c].schema;a[c]=s[o].map(u=>_a(l,u))}return a}async update(e,r,n){var l;let s;const i=await this.schema(),a=(l=i==null?void 0:i[e])==null?void 0:l.schema;if(typeof n=="function"){const u=await this.fetchById(e,r);if(!u)throw new pf(r,e);s={},await n(wo(u,s,a))}else s=n;const{data:o,error:c}=await this.sendRequest("/update","POST",{collectionName:e,entityId:r,changes:s});if(c)throw c;return o}async delete(e,r){const{data:n,error:s}=await this.sendRequest("/delete","POST",{collectionName:e,entityId:r});if(s)throw s;return n}async deleteAll(e){const{data:r,error:n}=await this.sendRequest("/delete-all","POST",{collectionName:e});if(n)throw n;return r}query(e){return ur(e)}}class VR{constructor(e){b(this,"formatter");this.formatter=e.formatter??(r=>[r])}log(e){const{level:r}=e,n=this.formatter(e);(r==="ERROR"||r==="FATAL")&&Bn(console.error)?console.error(...n):r==="WARN"&&Bn(console.warn)?console.warn(...n):r==="INFO"&&Bn(console.info)?console.info(...n):r==="DEBUG"&&Bn(console.debug)?console.debug(...n):console.log(...n)}startSpan(e,r,n){return console.log(`Starting span "${e}" in context="${r}"`,n),{name:e,context:r,attributes:n,startTime:Date.now()}}endSpan(e){if(!e)return;const r=Date.now()-e.startTime;console.log(`Ending span "${e.name}". Duration: ${r}ms`)}recordMetric(e,r,n){console.log(`Metric [${e}]: ${r}`,n||"")}}function Bn(t){return typeof t=="function"}function HR(){return new VR({formatter:t=>{const{level:e,message:r,timestamp:n,context:s,attributes:i}=t,a=s?[`%c${s}`,"color: #888"]:[];if(e==="DEBUG"&&s==="sync"){if(r==="sent")return["%c OUT ","background: #228; color: #51acff",i==null?void 0:i.type,i==null?void 0:i.payload];if(r==="received")return["%c IN ","background: #ccc; color: #333",i==null?void 0:i.type,i==null?void 0:i.payload]}return[...a,r,i||""]}})}class WR{constructor(){b(this,"logs",[])}log(e){this.logs.push(e)}startSpan(e,r,n){return this.logs.push(`Starting span "${e}" in context="${r??""}" ${n?JSON.stringify(n):""}`),{name:e,context:r,attributes:n,startTime:Date.now()}}endSpan(e){if(!e)return;const r=Date.now()-e.startTime;this.logs.push(`Ending span "${e.name}". Duration: ${r}ms`)}recordMetric(e,r,n){this.logs.push(`Metric [${e}]: ${r} ${n?JSON.stringify(n):""}`)}}function KR(t,e){if(!t&&!e)return 0;if(!t)return-1;if(!e)return 1;let r=t[0],n=e[0];return r instanceof Date&&(r=r.getTime()),n instanceof Date&&(n=n.getTime()),ke(r,n)}const QR=1,X="triplit";class zi{constructor(e,r={useCache:!0}){b(this,"db");b(this,"cache");b(this,"options");this.options=r,r.useCache&&(this.cache=new lr),this.db=typeof e=="string"?new Promise((n,s)=>{const i=indexedDB.open(e,QR);i.onupgradeneeded=a=>{const o=a.target.result;this.setupSchema(o)},i.onsuccess=async a=>{const o=a.target.result;n(await this.populateCache(o))},i.onerror=a=>{console.error(`Error opening database: ${a.target.error}`),s(a.target.error)}}):e.then(this.populateCache)}async populateCache(e){const n=e.transaction(X,"readonly").objectStore(X),s=await new Promise((a,o)=>{const c=n.getAllKeys();c.onerror=()=>o(c.error),c.onsuccess=()=>a(c.result)}),i=await new Promise((a,o)=>{const c=n.getAll();c.onerror=()=>o(c.error),c.onsuccess=()=>a(c.result)});if(s.length!==i.length)throw new Error("IndexedDB keys and values length mismatch");for(let a=0;a<s.length;a++){const o=s[a],c=i[a];this.cache&&this.cache.data.set(o,c)}return e}setupSchema(e){e.objectStoreNames.contains(X)||e.createObjectStore(X)}async get(e,r){const n=await this.db;if(this.cache)return this.cache.get(e,r);const s=r?[...r,...e]:e;return new Promise((i,a)=>{const l=n.transaction(X,"readonly",{durability:"relaxed"}).objectStore(X).get(s);l.onsuccess=()=>i(l.result),l.onerror=()=>a(l.error)})}async set(e,r,n){const s=await this.db,i=n?[...n,...e]:e;return new Promise((a,o)=>{const u=s.transaction(X,"readwrite",{durability:"relaxed"}).objectStore(X).put(r,i);u.onsuccess=async()=>{this.cache&&await this.cache.set(e,r,n),a()},u.onerror=()=>o(u.error)})}async delete(e,r){const n=await this.db,s=r?[...r,...e]:e;return new Promise((i,a)=>{const l=n.transaction(X,"readwrite",{durability:"relaxed"}).objectStore(X).delete(s);l.onsuccess=async()=>{this.cache&&await this.cache.delete(e,r),i()},l.onerror=()=>a(l.error)})}async*scan(e,r){const n=await this.db;if(this.cache){yield*this.cache.scan(e,r);return}const s=r?[...r,...e.prefix]:e.prefix,i=[...s,"ï¿¿"],o=n.transaction(X,"readonly",{durability:"relaxed"}).objectStore(X),c=this.options.batchSize??1e3;let l=s,u=!0;for(;!(ns(l,i)>=0);){const d=IDBKeyRange.bound(l,i,u,!0),y=await Kl(o,d,c);if(!y.length)break;const h=await Ql(o,d,c);if(!h.length)break;for(let v=0;v<y.length;v++){const g=((r==null?void 0:r.length)??0)+e.prefix.length,S=g>0?y[v].slice(g):y[v];if(S.length===0)break;yield[S,h[v]]}if(h.length<c)break;l=y.at(-1)}}async*scanValues(e,r){if(await this.db,this.cache){yield*this.cache.scanValues(e,r);return}const n=await this.db,s=r?[...r,...e.prefix]:e.prefix,i=[...s,"ï¿¿"],o=n.transaction(X,"readonly",{durability:"relaxed"}).objectStore(X),c=this.options.batchSize??1e3;let l=s,u=!0;for(;!(ns(l,i)>=0);){const d=IDBKeyRange.bound(l,i,u,!0),y=await Ql(o,d,c);if(!y.length)break;for(const m of y)yield m;if(y.length<c)break;const f=await ZR(o,d,c);if(!f)break;l=f,u=!1}}async clear(e){const s=(await this.db).transaction(X,"readwrite",{durability:"relaxed"}).objectStore(X);if(e!=null&&e.length){const i=e,a=[...i,"ï¿¿"],o=IDBKeyRange.bound(i,a,!1,!0);return new Promise((c,l)=>{const u=s.delete(o);u.onsuccess=async()=>{this.cache&&await this.cache.clear(e),c()},u.onerror=()=>l(u.error)})}else{const i=s.clear();return new Promise((a,o)=>{i.onsuccess=async()=>{this.cache&&await this.cache.clear(e),a()},i.onerror=()=>o(i.error)})}}scope(e){return new Ps(this,e)}transact(){return new As(this)}async count(e,r){const n=await this.db;if(this.cache)return this.cache.count(e,r);const s=r?[...r,...e.prefix]:e.prefix,i=[...s,"ï¿¿"],a=IDBKeyRange.bound(s,i,!1,!0);return new Promise((o,c)=>{const d=n.transaction(X,"readonly",{durability:"relaxed"}).objectStore(X).count(a);d.onsuccess=()=>o(d.result),d.onerror=()=>c(d.error)})}async applyEdits(e,r){const n=await this.db;await new Promise(async(s,i)=>{const o=n.transaction(X,"readwrite",{durability:"relaxed"}).objectStore(X);let c=null;const l=[],u=[];for await(const d of r)c=o.delete(d),l.push(d);for await(const[d,y]of e)c=o.put(y,d),u.push([d,y]);c?(c.onsuccess=async()=>{this.cache&&await this.cache.applyEdits(u,l),s()},c.onerror=()=>i(c.error)):(this.cache&&await this.cache.applyEdits(u,l),s())})}async getBatchKeys(e,r){const i=(await this.db).transaction(X,"readonly",{durability:"relaxed"}).objectStore(X);return Kl(i,e,r)}}function ZR(t,e,r=0){return new Promise((n,s)=>{const i=t.openKeyCursor(e,"next");let a=!1;i.onsuccess=o=>{const c=o.target,l=c==null?void 0:c.result;if(!l){n(void 0);return}if(!a&&r>1){a=!0,l.advance(r);return}n(l.key)},i.onerror=o=>{const c=o.target;s(c.error)}})}function Kl(t,e,r){return new Promise((n,s)=>{const i=t.getAllKeys(e,r);i.onerror=()=>s(i.error),i.onsuccess=()=>n(i.result)})}function Ql(t,e,r){return new Promise((n,s)=>{const i=t.getAll(e,r);i.onerror=()=>s(i.error),i.onsuccess=()=>n(i.result)})}function GR(t){return typeof t=="string"||"type"in t}function qR(t){return typeof t=="string"&&t==="memory"||typeof t=="object"&&t.type==="memory"}function JR(t){return typeof t=="string"&&t==="indexeddb"||typeof t=="object"&&t.type==="indexeddb"}function YR(t){if(!GR(t))return t;if(qR(t))return new lr;if(JR(t)){if(typeof indexedDB>"u")throw new YC;return typeof t=="object"?t.options?new zi(t.name??"triplit",t.options):new zi(t.name??"triplit"):new zi("triplit")}throw new O("Failed to parse storage input")}const XR="memory",ph=!0,ex={policy:"local-first",skipRules:ph};class tx{constructor(e={}){b(this,"awaitReady",null);b(this,"db");b(this,"syncEngine");b(this,"tokenRefreshTimer",null);b(this,"_token");b(this,"claimsPath");b(this,"_serverUrl");b(this,"skipRules",ph);b(this,"statusSubs",new Set);b(this,"syncSchema");b(this,"http");b(this,"defaultFetchOptions");b(this,"logger");b(this,"connectOnInitialization");b(this,"connectionOptionsChangeHandlers",[]);this.connectOnInitialization=e.autoConnect??!0;const r=e.schema?{collections:e.schema,roles:e.roles}:void 0,n=YR((e==null?void 0:e.storage)??XR);this.syncSchema=e.syncSchema??!1,this.awaitReady=WC({schema:r,variables:e.variables,entityStore:new GC(n),kv:n,clientId:Math.random().toString(36).substring(7)}).then(i=>{const a=this.token?Pr(this.token,this.claimsPath):void 0;return this.db=a?i.withSessionVars(a):i,this.onConnectionOptionsChange(o=>{if("token"in o){const c=o.token?Pr(o.token,this.claimsPath):{};this.db=c?this.db.withSessionVars(c):this.db}}),this.db.onCommit(rx(async o=>{await this.db.updateQueryViews(),this.db.broadcastToQuerySubscribers(),this.syncEngine.connectionStatus==="OPEN"&&await this.syncEngine.syncWrites()},20)),this.db.onSchemaChange(o=>{o.successful&&this.http.updateOptions({schema:o.newSchema.collections})}),this.syncSchema&&this.subscribeBackground(this.db.query("_metadata").Id("_schema"),{onError:()=>{this.logger.warn("Schema sync disconnected")}}),Promise.resolve().then(()=>{this.awaitReady=null})}),this.logger=e.logger??new xs([HR()]),e.logLevel&&this.logger.setLogLevel(e.logLevel),e.logLevel==="debug"&&this.logger.registerHandler(new WR),this.claimsPath=e.claimsPath,this.defaultFetchOptions={fetch:ex,...e.defaultQueryOptions},Zl(e.serverUrl),this._serverUrl=e.serverUrl,this.http=new zR({serverUrl:this._serverUrl,token:this._token,schemaFactory:async()=>{var i;return(i=await this.getSchema())==null?void 0:i.collections}}),this.onConnectionOptionsChange(i=>{this.http.updateOptions(i)});const s=e.pingInterval||45;this.syncEngine=new LR(this,{transport:e.transport,logger:this.logger.context("sync"),pingInterval:s}),e.onSessionError&&this.onSessionError(e.onSessionError),this.startSession(e.token,!1,e.refreshOptions).then(async()=>{if(this.connectOnInitialization){const i=await this.syncEngine.getConnectionParams();this.syncEngine.createConnection(i)}})}async getSchema(){return this.awaitReady&&await this.awaitReady,this.db.getSchema()}async transact(e,r={}){this.awaitReady&&await this.awaitReady,this.logger.debug("transact START");const n=await this.db.transact(e,{...r,skipRules:this.skipRules});return this.logger.debug("transact END",{txOutput:n}),n}query(e){return ur(e)}async fetch(e,r){this.awaitReady&&await this.awaitReady,e=Vi(e);const n={...this.defaultFetchOptions.fetch,...r??{}};if(n.policy==="local-only")return this.fetchLocal(e,n);if(n.policy==="local-first"){if(!(await this.syncEngine.isFirstTimeFetchingQuery(e)&&this.probablyIntendsToConnect))return await this.fetchLocal(e,n);try{await this.syncEngine.syncQuery(e)}catch(i){this.warnError(i)}return this.fetchLocal(e,n)}if(n.policy==="remote-first"){if(this.probablyIntendsToConnect)try{await this.syncEngine.syncQuery(e)}catch(s){this.warnError(s)}return this.fetchLocal(e,n)}if(n.policy==="remote-only")return this.http.fetch(e);if(n.policy==="local-and-remote"){const s=n.timeout??0;return await Promise.race([this.syncEngine.syncQuery(e),new Promise(i=>setTimeout(i,s))]).catch(this.warnError),this.fetchLocal(e,n)}throw new JC(n.policy)}async fetchLocal(e,r){this.logger.debug("fetchLocal START",e);const n=await this.db.fetch(e,{skipRules:this.skipRules,...r??{}});return this.logger.debug("fetchLocal END",n),n}async fetchById(e,r,n){this.logger.debug("fetchById START",{collectionName:e,id:r,options:n});const s=this.query(e).Id(r),i=await this.fetchOne(s,n);return this.logger.debug("fetchById END",{collectionName:e,id:r,options:n,result:i}),i}async clear(e={full:!1}){this.awaitReady&&await this.awaitReady,await this.db.clear(e);for(const r of this.statusSubs)r.unsub(),r.unsub=this._subscribeWithStatus(r.query,r.callback,r.options)}async reset(e={}){await this.clear(e)}async fetchOne(e,r){e=Vi(e),e={...e,limit:1};const s=[...(await this.fetch(e,r)).values()][0];return s||null}async insert(e,r){this.awaitReady&&await this.awaitReady,this.logger.debug("insert START",{collectionName:e,object:r});const n=await this.db.insert(e,r,{skipRules:this.skipRules});return this.logger.debug("insert END",{txOutput:n}),n}async update(e,r,n){this.awaitReady&&await this.awaitReady,this.logger.debug("update START",{collectionName:e,entityId:r});const s=await this.db.update(e,r,n,{skipRules:this.skipRules});return this.logger.debug("update END",{txOutput:s}),s}async delete(e,r){this.awaitReady&&await this.awaitReady,this.logger.debug("delete START",{collectionName:e,entityId:r});const n=await this.db.delete(e,r,{skipRules:this.skipRules});return this.logger.debug("delete END",{txOutput:n}),n}async entityIsInCache(e,r){return!!this.db.entityStore.doubleBuffer.getChangesForEntity(this.db.kv,e,r)}subscribe(e,r,n,s){let i=!1;const a=(async()=>{this.awaitReady&&await this.awaitReady;const o={localOnly:!1,...s??{}};e=Vi(e),this.logger.debug("subscribe start",e);const c=r,l=n;r=async y=>{let h=y;i||(s!=null&&s.syncStatus&&s.syncStatus!=="all"&&(h=await this.filterResultsWithSyncStatus(y,e.collectionName,s.syncStatus)),c(h))},n=l?y=>{i||l(y)}:void 0;const u=this.db.subscribe(e,r,n,{skipRules:this.skipRules,...o});await this.db.updateQueryViews(),this.db.broadcastToQuerySubscribers();let d=Promise.resolve(()=>{});return o.localOnly||(d=this.syncEngine.subscribe(e,{onQueryFulfilled:o.onRemoteFulfilled,onQueryError:n,onQuerySyncStateChange:o.onQuerySyncStateChange})),()=>{i=!0,u(),d.then(y=>y())}})();return()=>{a.then(o=>o())}}get probablyIntendsToConnect(){return this.connectionStatus==="OPEN"||this.connectionStatus==="CONNECTING"||!!this.connectOnInitialization&&!!this.token&&!!this.serverUrl&&this.connectionStatus!=="CLOSED"&&this.connectionStatus!=="CLOSING"}subscribeWithStatus(e,r,n){const s={query:e,callback:r,options:n,unsub:this._subscribeWithStatus(e,r,n)};return this.statusSubs.add(s),()=>{s.unsub(),this.statusSubs.delete(s)}}_subscribeWithStatus(e,r,n){let s,i=this.probablyIntendsToConnect&&!(n!=null&&n.localOnly),a=!0,o=!1,c,l=!0;const u=()=>a||l&&i;function d(){r({results:s,error:c,fetching:u(),fetchingLocal:a,fetchingRemote:o})}d();const y=this.onConnectionStatusChange(f=>{if(f==="CLOSING"||f==="CLOSED"){let m=!1;o&&(o=!1,m=!0),i&&(i=!1,m=!0),m&&d();return}},!0);this.isFirstTimeFetchingQuery(e).then(f=>{if(l!==f){const m=u();l=f,u()!==m&&d()}});const h=this.subscribe(e,f=>{s=f,a=!1,c=void 0,o&&(o=!this.syncEngine.hasServerRespondedForQuery(e),i=o),d()},f=>{c=f,a=!1,d()},{...n??{},onQuerySyncStateChange:f=>{if(f==="FULFILLED"||f==="ERROR"){if(!o)return;o=!1,i=!1,d()}f==="IN_FLIGHT"&&!o&&(o=!0,d())}});return()=>{h(),y()}}async filterResultsWithSyncStatus(e,r,n){const s=await this.db.entityStore.doubleBuffer.getChangesForCollection(this.db.kv,r);return s?n==="pending"?e.filter(i=>s.sets.has(i.id)):e.filter(i=>!s.sets.has(i.id)):n==="pending"?[]:e}subscribeBackground(e,r={}){const n=(async()=>(this.awaitReady&&await this.awaitReady,this.syncEngine.subscribe(e,{onQueryFulfilled:r.onFulfilled,onQueryError:r.onError})))();return()=>{n.then(s=>s())}}subscribeWithPagination(e,r,n,s){e.order&&e.order.length>0&&e.order.at(-1)[0]!=="id"&&(e.order=[...e.order,["id","ASC"]]);const i={},a=e.limit;let o=d=>{r(d,{hasNextPage:!1,hasPreviousPage:!1})};i.nextPage=()=>{this.logger.warn("There is no limit set on the query, so nextPage() is a no-op")},i.prevPage=()=>{this.logger.warn("There is no limit set on the query, so prevPage() is a no-op")};let c,l,u="forward";return e.limit&&(e={...e},e.limit=a+1+(e.after?1:0),o=d=>{var N,U,P;if(!((U=(N=e.order)==null?void 0:N[0])==null?void 0:U[0]))throw new O("No cursor attribute found in query order");const h=d.at(0),f=!!e.after&&!!h&&KR(e.after[0],e.order.map(K=>de.Get(h,K[0].split("."))))>-1,m=d.length>=e.limit,v=u==="reversed"?m:f,g=u==="forward"?m:f;d=d.slice(f?1:0,m?-1:void 0);const S=d.at(0),C=d.at(a-1);c=S?e.order.map(K=>de.Get(S,K[0].split("."))):void 0,l=C?e.order.map(K=>de.Get(C,K[0].split("."))):void 0,u==="reversed"&&(d=d.reverse()),!v&&e.after?((P=i.unsubscribe)==null||P.call(i),e={...e},e.after=void 0,e.limit=a+1,u==="reversed"&&(e.order=Hi(e.order)),u="forward",i.unsubscribe=this.subscribe(e,o,n,s)):r(d,{hasNextPage:g,hasPreviousPage:v})},i.nextPage=()=>{var d;(d=i.unsubscribe)==null||d.call(i),e={...e},u==="reversed"?(e.order=Hi(e.order),e.after=c?[c,!0]:void 0):(e.after||(e.limit=e.limit+1),e.after=l?[l,!0]:void 0),u="forward",i.unsubscribe=this.subscribe(e,o,n,s)},i.prevPage=()=>{var d;(d=i.unsubscribe)==null||d.call(i),e={...e},u==="forward"?(e.order=Hi(e.order),e.after=c?[c,!0]:void 0):e.after=l?[l,!0]:void 0,u="reversed",i.unsubscribe=this.subscribe(e,o,n,s)}),i.unsubscribe=this.subscribe(e,o,n,s),i}subscribeWithExpand(e,r,n,s){var o;const i={};let a=c=>{r(c,{hasMore:!1})};if(i.loadMore=()=>{this.logger.warn("There is no limit set on the query, so loadMore is a no-op")},e.limit){(!e.order||((o=e.order.at(-1))==null?void 0:o[0])!=="id")&&(e.order=[...e.order??[],["id","ASC"]]);const c=e.limit;e={...e},e.limit=e.limit+1,a=l=>{const u=l.length>=e.limit;l=Array.from(l),u&&(l=l.slice(0,-1)),r(l,{hasMore:u})},i.loadMore=l=>{var u;(u=i.unsubscribe)==null||u.call(i),e={...e},e.limit=(e.limit??1)+(l??c),i.unsubscribe=this.subscribe(e,a,n,s)}}return i.unsubscribe=this.subscribe(e,a,n,s),i}updateConnectionOptions(e){const{token:r,serverUrl:n,tokenRefresh:s}=e,i=e.hasOwnProperty("token")&&r!==this.token,a=e.hasOwnProperty("serverUrl")&&n!==this.serverUrl;let o={};if(i&&(o={...o,token:r,tokenRefresh:s}),a&&(Zl(n),o={...o,serverUrl:n}),i||a){i&&(this._token=r),a&&(this._serverUrl=n);for(const c of this.connectionOptionsChangeHandlers)c(o)}}async startSession(e,r=!0,n){const s=Pr(e);if(s&&Ml(s)){if(!(n!=null&&n.refreshHandler))throw new Bl;const c=await n.refreshHandler();if(!c){this.logger.warn("An expired token was passed to startSession, and the refreshHandler was unable to provide a new token. Session will not be started");return}e=c}if(e===this.token||(this.token&&await this.endSession(),this.updateToken(e),r&&await this.connect(),!n||!this.token))return;const{interval:i,refreshHandler:a}=n,o=c=>{const l=Pr(c);if(!l||!l.exp&&!i)return;let u=i??l.exp*1e3-Date.now()-1e3;u<1e3&&(this.logger.warn(`The minimum allowed refresh interval is 1000ms, the ${i?"provided interval":"interval determined from the provided token"} was ${Math.round(u)}ms.`),u=1e3),this.tokenRefreshTimer=setTimeout(async()=>{const d=await a();if(!d){this.logger.warn("The token refresh handler did not return a new token, ending the session."),await this.endSession();return}await this.updateSessionToken(d),o(d)},u)};return o(this.token),()=>{this.resetTokenRefreshHandler()}}async endSession(){this.resetTokenRefreshHandler(),this.disconnect(),this.updateToken(void 0),this.syncEngine.resetQueryState()}async updateSessionToken(e){var i;if(this.awaitReady&&await this.awaitReady,!this.token)throw new tR;const r=Pr(e);if(!r)throw new rR(r);if(Ml(r))throw new Bl;const n=Wf(this.db.schema,Kf(r));if(!bC((i=this.db.session)==null?void 0:i.roles,n))throw new eR;if(this.updateToken(e,!0),!this.syncEngine.updateTokenForSession(e)&&!await new Promise((o,c)=>setTimeout(()=>o(this.syncEngine.updateTokenForSession(e)),1e3)))throw new O("Failed to update the session token for the current session.")}resetTokenRefreshHandler(){this.tokenRefreshTimer&&(clearTimeout(this.tokenRefreshTimer),this.tokenRefreshTimer=null)}onSessionError(e){return this.syncEngine.onSessionError(e)}async updateGlobalVariables(e){this.awaitReady&&await this.awaitReady,this.db.updateGlobalVariables(e)}updateToken(e,r){this.updateConnectionOptions({token:e,tokenRefresh:r})}updateServerUrl(e){this.updateConnectionOptions({serverUrl:e})}onConnectionStatusChange(...e){return this.syncEngine.onConnectionStatusChange(...e)}connect(){return this.syncEngine.connect()}disconnect(){return this.syncEngine.disconnect()}get token(){return this._token}get serverUrl(){return this._serverUrl}get vars(){return{...this.db.systemVars,$token:this.db.systemVars.$session}}onSyncMessageReceived(...e){return this.syncEngine.onSyncMessageReceived(...e)}onSyncMessageSent(...e){return this.syncEngine.onSyncMessageSent(...e)}onEntitySyncSuccess(...e){return this.syncEngine.onEntitySyncSuccess(...e)}onEntitySyncError(...e){return this.syncEngine.onEntitySyncError(...e)}onFailureToSyncWrites(...e){return this.syncEngine.onFailureToSyncWrites(...e)}syncWrites(...e){return this.syncEngine.syncWrites(...e)}get connectionStatus(){return this.syncEngine.connectionStatus}isFirstTimeFetchingQuery(...e){return this.syncEngine.isFirstTimeFetchingQuery(...e)}async clearPendingChangesForEntity(...e){return this.syncEngine.clearPendingChangesForEntity(...e)}async clearPendingChangesAll(...e){return this.syncEngine.clearPendingChangesAll(...e)}onConnectionOptionsChange(e){return this.connectionOptionsChangeHandlers.push(e),()=>{this.connectionOptionsChangeHandlers=this.connectionOptionsChangeHandlers.filter(r=>r!==e)}}warnError(e){e instanceof O?this.logger.warn(e.toJSON()):this.logger.warn(e)}}function Vi(t){return{traceId:Math.random().toString().slice(2),...t}}function Hi(t){if(t)return t.map(e=>[e[0],e[1]==="ASC"?"DESC":"ASC"])}function rx(t,e,r){let n,s=null;return function(){const i=arguments;n?s=i:(s=i,n=!0,setTimeout(()=>{s&&(t(s),s=null),n=!1},e))}}function Zl(t){if(t&&!t.startsWith("http://")&&!t.startsWith("https://"))throw new O("Invalid serverUrl provided")}var B;(function(t){t.assertEqual=s=>s;function e(s){}t.assertIs=e;function r(s){throw new Error}t.assertNever=r,t.arrayToEnum=s=>{const i={};for(const a of s)i[a]=a;return i},t.getValidEnumValues=s=>{const i=t.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),a={};for(const o of i)a[o]=s[o];return t.objectValues(a)},t.objectValues=s=>t.objectKeys(s).map(function(i){return s[i]}),t.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{const i=[];for(const a in s)Object.prototype.hasOwnProperty.call(s,a)&&i.push(a);return i},t.find=(s,i)=>{for(const a of s)if(i(a))return a},t.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&isFinite(s)&&Math.floor(s)===s;function n(s,i=" | "){return s.map(a=>typeof a=="string"?`'${a}'`:a).join(i)}t.joinValues=n,t.jsonStringifyReplacer=(s,i)=>typeof i=="bigint"?i.toString():i})(B||(B={}));var xa;(function(t){t.mergeShapes=(e,r)=>({...e,...r})})(xa||(xa={}));const T=B.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),dt=t=>{switch(typeof t){case"undefined":return T.undefined;case"string":return T.string;case"number":return isNaN(t)?T.nan:T.number;case"boolean":return T.boolean;case"function":return T.function;case"bigint":return T.bigint;case"symbol":return T.symbol;case"object":return Array.isArray(t)?T.array:t===null?T.null:t.then&&typeof t.then=="function"&&t.catch&&typeof t.catch=="function"?T.promise:typeof Map<"u"&&t instanceof Map?T.map:typeof Set<"u"&&t instanceof Set?T.set:typeof Date<"u"&&t instanceof Date?T.date:T.object;default:return T.unknown}},E=B.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),nx=t=>JSON.stringify(t,null,2).replace(/"([^"]+)":/g,"$1:");class Oe extends Error{get errors(){return this.issues}constructor(e){super(),this.issues=[],this.addIssue=n=>{this.issues=[...this.issues,n]},this.addIssues=(n=[])=>{this.issues=[...this.issues,...n]};const r=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,r):this.__proto__=r,this.name="ZodError",this.issues=e}format(e){const r=e||function(i){return i.message},n={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)n._errors.push(r(a));else{let o=n,c=0;for(;c<a.path.length;){const l=a.path[c];c===a.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(r(a))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return s(this),n}static assert(e){if(!(e instanceof Oe))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,B.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=r=>r.message){const r={},n=[];for(const s of this.issues)s.path.length>0?(r[s.path[0]]=r[s.path[0]]||[],r[s.path[0]].push(e(s))):n.push(e(s));return{formErrors:n,fieldErrors:r}}get formErrors(){return this.flatten()}}Oe.create=t=>new Oe(t);const fr=(t,e)=>{let r;switch(t.code){case E.invalid_type:t.received===T.undefined?r="Required":r=`Expected ${t.expected}, received ${t.received}`;break;case E.invalid_literal:r=`Invalid literal value, expected ${JSON.stringify(t.expected,B.jsonStringifyReplacer)}`;break;case E.unrecognized_keys:r=`Unrecognized key(s) in object: ${B.joinValues(t.keys,", ")}`;break;case E.invalid_union:r="Invalid input";break;case E.invalid_union_discriminator:r=`Invalid discriminator value. Expected ${B.joinValues(t.options)}`;break;case E.invalid_enum_value:r=`Invalid enum value. Expected ${B.joinValues(t.options)}, received '${t.received}'`;break;case E.invalid_arguments:r="Invalid function arguments";break;case E.invalid_return_type:r="Invalid function return type";break;case E.invalid_date:r="Invalid date";break;case E.invalid_string:typeof t.validation=="object"?"includes"in t.validation?(r=`Invalid input: must include "${t.validation.includes}"`,typeof t.validation.position=="number"&&(r=`${r} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?r=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?r=`Invalid input: must end with "${t.validation.endsWith}"`:B.assertNever(t.validation):t.validation!=="regex"?r=`Invalid ${t.validation}`:r="Invalid";break;case E.too_small:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:r="Invalid input";break;case E.too_big:t.type==="array"?r=`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:t.type==="string"?r=`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:t.type==="number"?r=`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="bigint"?r=`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:t.type==="date"?r=`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:r="Invalid input";break;case E.custom:r="Invalid input";break;case E.invalid_intersection_types:r="Intersection results could not be merged";break;case E.not_multiple_of:r=`Number must be a multiple of ${t.multipleOf}`;break;case E.not_finite:r="Number must be finite";break;default:r=e.defaultError,B.assertNever(t)}return{message:r}};let yh=fr;function sx(t){yh=t}function ds(){return yh}const fs=t=>{const{data:e,path:r,errorMaps:n,issueData:s}=t,i=[...r,...s.path||[]],a={...s,path:i};if(s.message!==void 0)return{...s,path:i,message:s.message};let o="";const c=n.filter(l=>!!l).slice().reverse();for(const l of c)o=l(a,{data:e,defaultError:o}).message;return{...s,path:i,message:o}},ix=[];function $(t,e){const r=ds(),n=fs({issueData:e,data:t.data,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,r,r===fr?void 0:fr].filter(s=>!!s)});t.common.issues.push(n)}class fe{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,r){const n=[];for(const s of r){if(s.status==="aborted")return A;s.status==="dirty"&&e.dirty(),n.push(s.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,r){const n=[];for(const s of r){const i=await s.key,a=await s.value;n.push({key:i,value:a})}return fe.mergeObjectSync(e,n)}static mergeObjectSync(e,r){const n={};for(const s of r){const{key:i,value:a}=s;if(i.status==="aborted"||a.status==="aborted")return A;i.status==="dirty"&&e.dirty(),a.status==="dirty"&&e.dirty(),i.value!=="__proto__"&&(typeof a.value<"u"||s.alwaysSet)&&(n[i.value]=a.value)}return{status:e.value,value:n}}}const A=Object.freeze({status:"aborted"}),Yt=t=>({status:"dirty",value:t}),pe=t=>({status:"valid",value:t}),ka=t=>t.status==="aborted",Aa=t=>t.status==="dirty",Dt=t=>t.status==="valid",Yr=t=>typeof Promise<"u"&&t instanceof Promise;function hs(t,e,r,n){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return e.get(t)}function mh(t,e,r,n,s){if(typeof e=="function"?t!==e||!0:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return e.set(t,r),r}var R;(function(t){t.errToObj=e=>typeof e=="string"?{message:e}:e||{},t.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(R||(R={}));var jr,Fr;class nt{constructor(e,r,n,s){this._cachedPath=[],this.parent=e,this.data=r,this._path=n,this._key=s}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const Gl=(t,e)=>{if(Dt(e))return{success:!0,data:e.value};if(!t.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const r=new Oe(t.common.issues);return this._error=r,this._error}}};function j(t){if(!t)return{};const{errorMap:e,invalid_type_error:r,required_error:n,description:s}=t;if(e&&(r||n))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(a,o)=>{var c,l;const{message:u}=t;return a.code==="invalid_enum_value"?{message:u??o.defaultError}:typeof o.data>"u"?{message:(c=u??n)!==null&&c!==void 0?c:o.defaultError}:a.code!=="invalid_type"?{message:o.defaultError}:{message:(l=u??r)!==null&&l!==void 0?l:o.defaultError}},description:s}}class F{get description(){return this._def.description}_getType(e){return dt(e.data)}_getOrReturnCtx(e,r){return r||{common:e.parent.common,data:e.data,parsedType:dt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new fe,ctx:{common:e.parent.common,data:e.data,parsedType:dt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const r=this._parse(e);if(Yr(r))throw new Error("Synchronous parse encountered promise.");return r}_parseAsync(e){const r=this._parse(e);return Promise.resolve(r)}parse(e,r){const n=this.safeParse(e,r);if(n.success)return n.data;throw n.error}safeParse(e,r){var n;const s={common:{issues:[],async:(n=r==null?void 0:r.async)!==null&&n!==void 0?n:!1,contextualErrorMap:r==null?void 0:r.errorMap},path:(r==null?void 0:r.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:dt(e)},i=this._parseSync({data:e,path:s.path,parent:s});return Gl(s,i)}"~validate"(e){var r,n;const s={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:dt(e)};if(!this["~standard"].async)try{const i=this._parseSync({data:e,path:[],parent:s});return Dt(i)?{value:i.value}:{issues:s.common.issues}}catch(i){!((n=(r=i==null?void 0:i.message)===null||r===void 0?void 0:r.toLowerCase())===null||n===void 0)&&n.includes("encountered")&&(this["~standard"].async=!0),s.common={issues:[],async:!0}}return this._parseAsync({data:e,path:[],parent:s}).then(i=>Dt(i)?{value:i.value}:{issues:s.common.issues})}async parseAsync(e,r){const n=await this.safeParseAsync(e,r);if(n.success)return n.data;throw n.error}async safeParseAsync(e,r){const n={common:{issues:[],contextualErrorMap:r==null?void 0:r.errorMap,async:!0},path:(r==null?void 0:r.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:dt(e)},s=this._parse({data:e,path:n.path,parent:n}),i=await(Yr(s)?s:Promise.resolve(s));return Gl(n,i)}refine(e,r){const n=s=>typeof r=="string"||typeof r>"u"?{message:r}:typeof r=="function"?r(s):r;return this._refinement((s,i)=>{const a=e(s),o=()=>i.addIssue({code:E.custom,...n(s)});return typeof Promise<"u"&&a instanceof Promise?a.then(c=>c?!0:(o(),!1)):a?!0:(o(),!1)})}refinement(e,r){return this._refinement((n,s)=>e(n)?!0:(s.addIssue(typeof r=="function"?r(n,s):r),!1))}_refinement(e){return new Le({schema:this,typeName:k.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:r=>this["~validate"](r)}}optional(){return et.create(this,this._def)}nullable(){return Tt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Me.create(this)}promise(){return pr.create(this,this._def)}or(e){return rn.create([this,e],this._def)}and(e){return nn.create(this,e,this._def)}transform(e){return new Le({...j(this._def),schema:this,typeName:k.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const r=typeof e=="function"?e:()=>e;return new ln({...j(this._def),innerType:this,defaultValue:r,typeName:k.ZodDefault})}brand(){return new So({typeName:k.ZodBranded,type:this,...j(this._def)})}catch(e){const r=typeof e=="function"?e:()=>e;return new un({...j(this._def),innerType:this,catchValue:r,typeName:k.ZodCatch})}describe(e){const r=this.constructor;return new r({...this._def,description:e})}pipe(e){return En.create(this,e)}readonly(){return dn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const ax=/^c[^\s-]{8,}$/i,ox=/^[0-9a-z]+$/,cx=/^[0-9A-HJKMNP-TV-Z]{26}$/i,lx=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,ux=/^[a-z0-9_-]{21}$/i,dx=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,fx=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,hx=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,px="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let Wi;const yx=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,mx=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,gx=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,vx=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,bx=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,wx=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,gh="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Sx=new RegExp(`^${gh}$`);function vh(t){let e="[0-5]\\d";t.precision?e=`${e}\\.\\d{${t.precision}}`:t.precision==null&&(e=`${e}(\\.\\d+)?`);const r=t.precision?"+":"?";return`([01]\\d|2[0-3]):[0-5]\\d(:${e})${r}`}function Ix(t){return new RegExp(`^${vh(t)}$`)}function bh(t){let e=`${gh}T${vh(t)}`;const r=[];return r.push(t.local?"Z?":"Z"),t.offset&&r.push("([+-]\\d{2}:?\\d{2})"),e=`${e}(${r.join("|")})`,new RegExp(`^${e}$`)}function Ex(t,e){return!!((e==="v4"||!e)&&yx.test(t)||(e==="v6"||!e)&&gx.test(t))}function $x(t,e){if(!dx.test(t))return!1;try{const[r]=t.split("."),n=r.replace(/-/g,"+").replace(/_/g,"/").padEnd(r.length+(4-r.length%4)%4,"="),s=JSON.parse(atob(n));return!(typeof s!="object"||s===null||!s.typ||!s.alg||e&&s.alg!==e)}catch{return!1}}function _x(t,e){return!!((e==="v4"||!e)&&mx.test(t)||(e==="v6"||!e)&&vx.test(t))}class je extends F{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==T.string){const i=this._getOrReturnCtx(e);return $(i,{code:E.invalid_type,expected:T.string,received:i.parsedType}),A}const n=new fe;let s;for(const i of this._def.checks)if(i.kind==="min")e.data.length<i.value&&(s=this._getOrReturnCtx(e,s),$(s,{code:E.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="max")e.data.length>i.value&&(s=this._getOrReturnCtx(e,s),$(s,{code:E.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!1,message:i.message}),n.dirty());else if(i.kind==="length"){const a=e.data.length>i.value,o=e.data.length<i.value;(a||o)&&(s=this._getOrReturnCtx(e,s),a?$(s,{code:E.too_big,maximum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}):o&&$(s,{code:E.too_small,minimum:i.value,type:"string",inclusive:!0,exact:!0,message:i.message}),n.dirty())}else if(i.kind==="email")hx.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"email",code:E.invalid_string,message:i.message}),n.dirty());else if(i.kind==="emoji")Wi||(Wi=new RegExp(px,"u")),Wi.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"emoji",code:E.invalid_string,message:i.message}),n.dirty());else if(i.kind==="uuid")lx.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"uuid",code:E.invalid_string,message:i.message}),n.dirty());else if(i.kind==="nanoid")ux.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"nanoid",code:E.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid")ax.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"cuid",code:E.invalid_string,message:i.message}),n.dirty());else if(i.kind==="cuid2")ox.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"cuid2",code:E.invalid_string,message:i.message}),n.dirty());else if(i.kind==="ulid")cx.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"ulid",code:E.invalid_string,message:i.message}),n.dirty());else if(i.kind==="url")try{new URL(e.data)}catch{s=this._getOrReturnCtx(e,s),$(s,{validation:"url",code:E.invalid_string,message:i.message}),n.dirty()}else i.kind==="regex"?(i.regex.lastIndex=0,i.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"regex",code:E.invalid_string,message:i.message}),n.dirty())):i.kind==="trim"?e.data=e.data.trim():i.kind==="includes"?e.data.includes(i.value,i.position)||(s=this._getOrReturnCtx(e,s),$(s,{code:E.invalid_string,validation:{includes:i.value,position:i.position},message:i.message}),n.dirty()):i.kind==="toLowerCase"?e.data=e.data.toLowerCase():i.kind==="toUpperCase"?e.data=e.data.toUpperCase():i.kind==="startsWith"?e.data.startsWith(i.value)||(s=this._getOrReturnCtx(e,s),$(s,{code:E.invalid_string,validation:{startsWith:i.value},message:i.message}),n.dirty()):i.kind==="endsWith"?e.data.endsWith(i.value)||(s=this._getOrReturnCtx(e,s),$(s,{code:E.invalid_string,validation:{endsWith:i.value},message:i.message}),n.dirty()):i.kind==="datetime"?bh(i).test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{code:E.invalid_string,validation:"datetime",message:i.message}),n.dirty()):i.kind==="date"?Sx.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{code:E.invalid_string,validation:"date",message:i.message}),n.dirty()):i.kind==="time"?Ix(i).test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{code:E.invalid_string,validation:"time",message:i.message}),n.dirty()):i.kind==="duration"?fx.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"duration",code:E.invalid_string,message:i.message}),n.dirty()):i.kind==="ip"?Ex(e.data,i.version)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"ip",code:E.invalid_string,message:i.message}),n.dirty()):i.kind==="jwt"?$x(e.data,i.alg)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"jwt",code:E.invalid_string,message:i.message}),n.dirty()):i.kind==="cidr"?_x(e.data,i.version)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"cidr",code:E.invalid_string,message:i.message}),n.dirty()):i.kind==="base64"?bx.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"base64",code:E.invalid_string,message:i.message}),n.dirty()):i.kind==="base64url"?wx.test(e.data)||(s=this._getOrReturnCtx(e,s),$(s,{validation:"base64url",code:E.invalid_string,message:i.message}),n.dirty()):B.assertNever(i);return{status:n.value,value:e.data}}_regex(e,r,n){return this.refinement(s=>e.test(s),{validation:r,code:E.invalid_string,...R.errToObj(n)})}_addCheck(e){return new je({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...R.errToObj(e)})}url(e){return this._addCheck({kind:"url",...R.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...R.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...R.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...R.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...R.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...R.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...R.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...R.errToObj(e)})}base64url(e){return this._addCheck({kind:"base64url",...R.errToObj(e)})}jwt(e){return this._addCheck({kind:"jwt",...R.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...R.errToObj(e)})}cidr(e){return this._addCheck({kind:"cidr",...R.errToObj(e)})}datetime(e){var r,n;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,offset:(r=e==null?void 0:e.offset)!==null&&r!==void 0?r:!1,local:(n=e==null?void 0:e.local)!==null&&n!==void 0?n:!1,...R.errToObj(e==null?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return typeof e=="string"?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:typeof(e==null?void 0:e.precision)>"u"?null:e==null?void 0:e.precision,...R.errToObj(e==null?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...R.errToObj(e)})}regex(e,r){return this._addCheck({kind:"regex",regex:e,...R.errToObj(r)})}includes(e,r){return this._addCheck({kind:"includes",value:e,position:r==null?void 0:r.position,...R.errToObj(r==null?void 0:r.message)})}startsWith(e,r){return this._addCheck({kind:"startsWith",value:e,...R.errToObj(r)})}endsWith(e,r){return this._addCheck({kind:"endsWith",value:e,...R.errToObj(r)})}min(e,r){return this._addCheck({kind:"min",value:e,...R.errToObj(r)})}max(e,r){return this._addCheck({kind:"max",value:e,...R.errToObj(r)})}length(e,r){return this._addCheck({kind:"length",value:e,...R.errToObj(r)})}nonempty(e){return this.min(1,R.errToObj(e))}trim(){return new je({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new je({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new je({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isDate(){return!!this._def.checks.find(e=>e.kind==="date")}get isTime(){return!!this._def.checks.find(e=>e.kind==="time")}get isDuration(){return!!this._def.checks.find(e=>e.kind==="duration")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(e=>e.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get isCIDR(){return!!this._def.checks.find(e=>e.kind==="cidr")}get isBase64(){return!!this._def.checks.find(e=>e.kind==="base64")}get isBase64url(){return!!this._def.checks.find(e=>e.kind==="base64url")}get minLength(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxLength(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}}je.create=t=>{var e;return new je({checks:[],typeName:k.ZodString,coerce:(e=t==null?void 0:t.coerce)!==null&&e!==void 0?e:!1,...j(t)})};function Tx(t,e){const r=(t.toString().split(".")[1]||"").length,n=(e.toString().split(".")[1]||"").length,s=r>n?r:n,i=parseInt(t.toFixed(s).replace(".","")),a=parseInt(e.toFixed(s).replace(".",""));return i%a/Math.pow(10,s)}class Et extends F{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==T.number){const i=this._getOrReturnCtx(e);return $(i,{code:E.invalid_type,expected:T.number,received:i.parsedType}),A}let n;const s=new fe;for(const i of this._def.checks)i.kind==="int"?B.isInteger(e.data)||(n=this._getOrReturnCtx(e,n),$(n,{code:E.invalid_type,expected:"integer",received:"float",message:i.message}),s.dirty()):i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),$(n,{code:E.too_small,minimum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),$(n,{code:E.too_big,maximum:i.value,type:"number",inclusive:i.inclusive,exact:!1,message:i.message}),s.dirty()):i.kind==="multipleOf"?Tx(e.data,i.value)!==0&&(n=this._getOrReturnCtx(e,n),$(n,{code:E.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):i.kind==="finite"?Number.isFinite(e.data)||(n=this._getOrReturnCtx(e,n),$(n,{code:E.not_finite,message:i.message}),s.dirty()):B.assertNever(i);return{status:s.value,value:e.data}}gte(e,r){return this.setLimit("min",e,!0,R.toString(r))}gt(e,r){return this.setLimit("min",e,!1,R.toString(r))}lte(e,r){return this.setLimit("max",e,!0,R.toString(r))}lt(e,r){return this.setLimit("max",e,!1,R.toString(r))}setLimit(e,r,n,s){return new Et({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:R.toString(s)}]})}_addCheck(e){return new Et({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:R.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:R.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:R.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:R.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:R.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:R.toString(r)})}finite(e){return this._addCheck({kind:"finite",message:R.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:R.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:R.toString(e)})}get minValue(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&B.isInteger(e.value))}get isFinite(){let e=null,r=null;for(const n of this._def.checks){if(n.kind==="finite"||n.kind==="int"||n.kind==="multipleOf")return!0;n.kind==="min"?(r===null||n.value>r)&&(r=n.value):n.kind==="max"&&(e===null||n.value<e)&&(e=n.value)}return Number.isFinite(r)&&Number.isFinite(e)}}Et.create=t=>new Et({checks:[],typeName:k.ZodNumber,coerce:(t==null?void 0:t.coerce)||!1,...j(t)});class $t extends F{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce)try{e.data=BigInt(e.data)}catch{return this._getInvalidInput(e)}if(this._getType(e)!==T.bigint)return this._getInvalidInput(e);let n;const s=new fe;for(const i of this._def.checks)i.kind==="min"?(i.inclusive?e.data<i.value:e.data<=i.value)&&(n=this._getOrReturnCtx(e,n),$(n,{code:E.too_small,type:"bigint",minimum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="max"?(i.inclusive?e.data>i.value:e.data>=i.value)&&(n=this._getOrReturnCtx(e,n),$(n,{code:E.too_big,type:"bigint",maximum:i.value,inclusive:i.inclusive,message:i.message}),s.dirty()):i.kind==="multipleOf"?e.data%i.value!==BigInt(0)&&(n=this._getOrReturnCtx(e,n),$(n,{code:E.not_multiple_of,multipleOf:i.value,message:i.message}),s.dirty()):B.assertNever(i);return{status:s.value,value:e.data}}_getInvalidInput(e){const r=this._getOrReturnCtx(e);return $(r,{code:E.invalid_type,expected:T.bigint,received:r.parsedType}),A}gte(e,r){return this.setLimit("min",e,!0,R.toString(r))}gt(e,r){return this.setLimit("min",e,!1,R.toString(r))}lte(e,r){return this.setLimit("max",e,!0,R.toString(r))}lt(e,r){return this.setLimit("max",e,!1,R.toString(r))}setLimit(e,r,n,s){return new $t({...this._def,checks:[...this._def.checks,{kind:e,value:r,inclusive:n,message:R.toString(s)}]})}_addCheck(e){return new $t({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:R.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:R.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:R.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:R.toString(e)})}multipleOf(e,r){return this._addCheck({kind:"multipleOf",value:e,message:R.toString(r)})}get minValue(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e}get maxValue(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e}}$t.create=t=>{var e;return new $t({checks:[],typeName:k.ZodBigInt,coerce:(e=t==null?void 0:t.coerce)!==null&&e!==void 0?e:!1,...j(t)})};class Xr extends F{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==T.boolean){const n=this._getOrReturnCtx(e);return $(n,{code:E.invalid_type,expected:T.boolean,received:n.parsedType}),A}return pe(e.data)}}Xr.create=t=>new Xr({typeName:k.ZodBoolean,coerce:(t==null?void 0:t.coerce)||!1,...j(t)});class jt extends F{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==T.date){const i=this._getOrReturnCtx(e);return $(i,{code:E.invalid_type,expected:T.date,received:i.parsedType}),A}if(isNaN(e.data.getTime())){const i=this._getOrReturnCtx(e);return $(i,{code:E.invalid_date}),A}const n=new fe;let s;for(const i of this._def.checks)i.kind==="min"?e.data.getTime()<i.value&&(s=this._getOrReturnCtx(e,s),$(s,{code:E.too_small,message:i.message,inclusive:!0,exact:!1,minimum:i.value,type:"date"}),n.dirty()):i.kind==="max"?e.data.getTime()>i.value&&(s=this._getOrReturnCtx(e,s),$(s,{code:E.too_big,message:i.message,inclusive:!0,exact:!1,maximum:i.value,type:"date"}),n.dirty()):B.assertNever(i);return{status:n.value,value:new Date(e.data.getTime())}}_addCheck(e){return new jt({...this._def,checks:[...this._def.checks,e]})}min(e,r){return this._addCheck({kind:"min",value:e.getTime(),message:R.toString(r)})}max(e,r){return this._addCheck({kind:"max",value:e.getTime(),message:R.toString(r)})}get minDate(){let e=null;for(const r of this._def.checks)r.kind==="min"&&(e===null||r.value>e)&&(e=r.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(const r of this._def.checks)r.kind==="max"&&(e===null||r.value<e)&&(e=r.value);return e!=null?new Date(e):null}}jt.create=t=>new jt({checks:[],coerce:(t==null?void 0:t.coerce)||!1,typeName:k.ZodDate,...j(t)});class ps extends F{_parse(e){if(this._getType(e)!==T.symbol){const n=this._getOrReturnCtx(e);return $(n,{code:E.invalid_type,expected:T.symbol,received:n.parsedType}),A}return pe(e.data)}}ps.create=t=>new ps({typeName:k.ZodSymbol,...j(t)});class en extends F{_parse(e){if(this._getType(e)!==T.undefined){const n=this._getOrReturnCtx(e);return $(n,{code:E.invalid_type,expected:T.undefined,received:n.parsedType}),A}return pe(e.data)}}en.create=t=>new en({typeName:k.ZodUndefined,...j(t)});class tn extends F{_parse(e){if(this._getType(e)!==T.null){const n=this._getOrReturnCtx(e);return $(n,{code:E.invalid_type,expected:T.null,received:n.parsedType}),A}return pe(e.data)}}tn.create=t=>new tn({typeName:k.ZodNull,...j(t)});class hr extends F{constructor(){super(...arguments),this._any=!0}_parse(e){return pe(e.data)}}hr.create=t=>new hr({typeName:k.ZodAny,...j(t)});class kt extends F{constructor(){super(...arguments),this._unknown=!0}_parse(e){return pe(e.data)}}kt.create=t=>new kt({typeName:k.ZodUnknown,...j(t)});class ht extends F{_parse(e){const r=this._getOrReturnCtx(e);return $(r,{code:E.invalid_type,expected:T.never,received:r.parsedType}),A}}ht.create=t=>new ht({typeName:k.ZodNever,...j(t)});class ys extends F{_parse(e){if(this._getType(e)!==T.undefined){const n=this._getOrReturnCtx(e);return $(n,{code:E.invalid_type,expected:T.void,received:n.parsedType}),A}return pe(e.data)}}ys.create=t=>new ys({typeName:k.ZodVoid,...j(t)});class Me extends F{_parse(e){const{ctx:r,status:n}=this._processInputParams(e),s=this._def;if(r.parsedType!==T.array)return $(r,{code:E.invalid_type,expected:T.array,received:r.parsedType}),A;if(s.exactLength!==null){const a=r.data.length>s.exactLength.value,o=r.data.length<s.exactLength.value;(a||o)&&($(r,{code:a?E.too_big:E.too_small,minimum:o?s.exactLength.value:void 0,maximum:a?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),n.dirty())}if(s.minLength!==null&&r.data.length<s.minLength.value&&($(r,{code:E.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),n.dirty()),s.maxLength!==null&&r.data.length>s.maxLength.value&&($(r,{code:E.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),n.dirty()),r.common.async)return Promise.all([...r.data].map((a,o)=>s.type._parseAsync(new nt(r,a,r.path,o)))).then(a=>fe.mergeArray(n,a));const i=[...r.data].map((a,o)=>s.type._parseSync(new nt(r,a,r.path,o)));return fe.mergeArray(n,i)}get element(){return this._def.type}min(e,r){return new Me({...this._def,minLength:{value:e,message:R.toString(r)}})}max(e,r){return new Me({...this._def,maxLength:{value:e,message:R.toString(r)}})}length(e,r){return new Me({...this._def,exactLength:{value:e,message:R.toString(r)}})}nonempty(e){return this.min(1,e)}}Me.create=(t,e)=>new Me({type:t,minLength:null,maxLength:null,exactLength:null,typeName:k.ZodArray,...j(e)});function Kt(t){if(t instanceof q){const e={};for(const r in t.shape){const n=t.shape[r];e[r]=et.create(Kt(n))}return new q({...t._def,shape:()=>e})}else return t instanceof Me?new Me({...t._def,type:Kt(t.element)}):t instanceof et?et.create(Kt(t.unwrap())):t instanceof Tt?Tt.create(Kt(t.unwrap())):t instanceof st?st.create(t.items.map(e=>Kt(e))):t}class q extends F{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const e=this._def.shape(),r=B.objectKeys(e);return this._cached={shape:e,keys:r}}_parse(e){if(this._getType(e)!==T.object){const l=this._getOrReturnCtx(e);return $(l,{code:E.invalid_type,expected:T.object,received:l.parsedType}),A}const{status:n,ctx:s}=this._processInputParams(e),{shape:i,keys:a}=this._getCached(),o=[];if(!(this._def.catchall instanceof ht&&this._def.unknownKeys==="strip"))for(const l in s.data)a.includes(l)||o.push(l);const c=[];for(const l of a){const u=i[l],d=s.data[l];c.push({key:{status:"valid",value:l},value:u._parse(new nt(s,d,s.path,l)),alwaysSet:l in s.data})}if(this._def.catchall instanceof ht){const l=this._def.unknownKeys;if(l==="passthrough")for(const u of o)c.push({key:{status:"valid",value:u},value:{status:"valid",value:s.data[u]}});else if(l==="strict")o.length>0&&($(s,{code:E.unrecognized_keys,keys:o}),n.dirty());else if(l!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const l=this._def.catchall;for(const u of o){const d=s.data[u];c.push({key:{status:"valid",value:u},value:l._parse(new nt(s,d,s.path,u)),alwaysSet:u in s.data})}}return s.common.async?Promise.resolve().then(async()=>{const l=[];for(const u of c){const d=await u.key,y=await u.value;l.push({key:d,value:y,alwaysSet:u.alwaysSet})}return l}).then(l=>fe.mergeObjectSync(n,l)):fe.mergeObjectSync(n,c)}get shape(){return this._def.shape()}strict(e){return R.errToObj,new q({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(r,n)=>{var s,i,a,o;const c=(a=(i=(s=this._def).errorMap)===null||i===void 0?void 0:i.call(s,r,n).message)!==null&&a!==void 0?a:n.defaultError;return r.code==="unrecognized_keys"?{message:(o=R.errToObj(e).message)!==null&&o!==void 0?o:c}:{message:c}}}:{}})}strip(){return new q({...this._def,unknownKeys:"strip"})}passthrough(){return new q({...this._def,unknownKeys:"passthrough"})}extend(e){return new q({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new q({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:k.ZodObject})}setKey(e,r){return this.augment({[e]:r})}catchall(e){return new q({...this._def,catchall:e})}pick(e){const r={};return B.objectKeys(e).forEach(n=>{e[n]&&this.shape[n]&&(r[n]=this.shape[n])}),new q({...this._def,shape:()=>r})}omit(e){const r={};return B.objectKeys(this.shape).forEach(n=>{e[n]||(r[n]=this.shape[n])}),new q({...this._def,shape:()=>r})}deepPartial(){return Kt(this)}partial(e){const r={};return B.objectKeys(this.shape).forEach(n=>{const s=this.shape[n];e&&!e[n]?r[n]=s:r[n]=s.optional()}),new q({...this._def,shape:()=>r})}required(e){const r={};return B.objectKeys(this.shape).forEach(n=>{if(e&&!e[n])r[n]=this.shape[n];else{let i=this.shape[n];for(;i instanceof et;)i=i._def.innerType;r[n]=i}}),new q({...this._def,shape:()=>r})}keyof(){return wh(B.objectKeys(this.shape))}}q.create=(t,e)=>new q({shape:()=>t,unknownKeys:"strip",catchall:ht.create(),typeName:k.ZodObject,...j(e)});q.strictCreate=(t,e)=>new q({shape:()=>t,unknownKeys:"strict",catchall:ht.create(),typeName:k.ZodObject,...j(e)});q.lazycreate=(t,e)=>new q({shape:t,unknownKeys:"strip",catchall:ht.create(),typeName:k.ZodObject,...j(e)});class rn extends F{_parse(e){const{ctx:r}=this._processInputParams(e),n=this._def.options;function s(i){for(const o of i)if(o.result.status==="valid")return o.result;for(const o of i)if(o.result.status==="dirty")return r.common.issues.push(...o.ctx.common.issues),o.result;const a=i.map(o=>new Oe(o.ctx.common.issues));return $(r,{code:E.invalid_union,unionErrors:a}),A}if(r.common.async)return Promise.all(n.map(async i=>{const a={...r,common:{...r.common,issues:[]},parent:null};return{result:await i._parseAsync({data:r.data,path:r.path,parent:a}),ctx:a}})).then(s);{let i;const a=[];for(const c of n){const l={...r,common:{...r.common,issues:[]},parent:null},u=c._parseSync({data:r.data,path:r.path,parent:l});if(u.status==="valid")return u;u.status==="dirty"&&!i&&(i={result:u,ctx:l}),l.common.issues.length&&a.push(l.common.issues)}if(i)return r.common.issues.push(...i.ctx.common.issues),i.result;const o=a.map(c=>new Oe(c));return $(r,{code:E.invalid_union,unionErrors:o}),A}}get options(){return this._def.options}}rn.create=(t,e)=>new rn({options:t,typeName:k.ZodUnion,...j(e)});const lt=t=>t instanceof an?lt(t.schema):t instanceof Le?lt(t.innerType()):t instanceof on?[t.value]:t instanceof _t?t.options:t instanceof cn?B.objectValues(t.enum):t instanceof ln?lt(t._def.innerType):t instanceof en?[void 0]:t instanceof tn?[null]:t instanceof et?[void 0,...lt(t.unwrap())]:t instanceof Tt?[null,...lt(t.unwrap())]:t instanceof So||t instanceof dn?lt(t.unwrap()):t instanceof un?lt(t._def.innerType):[];class Ls extends F{_parse(e){const{ctx:r}=this._processInputParams(e);if(r.parsedType!==T.object)return $(r,{code:E.invalid_type,expected:T.object,received:r.parsedType}),A;const n=this.discriminator,s=r.data[n],i=this.optionsMap.get(s);return i?r.common.async?i._parseAsync({data:r.data,path:r.path,parent:r}):i._parseSync({data:r.data,path:r.path,parent:r}):($(r,{code:E.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),A)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,r,n){const s=new Map;for(const i of r){const a=lt(i.shape[e]);if(!a.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const o of a){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,i)}}return new Ls({typeName:k.ZodDiscriminatedUnion,discriminator:e,options:r,optionsMap:s,...j(n)})}}function Pa(t,e){const r=dt(t),n=dt(e);if(t===e)return{valid:!0,data:t};if(r===T.object&&n===T.object){const s=B.objectKeys(e),i=B.objectKeys(t).filter(o=>s.indexOf(o)!==-1),a={...t,...e};for(const o of i){const c=Pa(t[o],e[o]);if(!c.valid)return{valid:!1};a[o]=c.data}return{valid:!0,data:a}}else if(r===T.array&&n===T.array){if(t.length!==e.length)return{valid:!1};const s=[];for(let i=0;i<t.length;i++){const a=t[i],o=e[i],c=Pa(a,o);if(!c.valid)return{valid:!1};s.push(c.data)}return{valid:!0,data:s}}else return r===T.date&&n===T.date&&+t==+e?{valid:!0,data:t}:{valid:!1}}class nn extends F{_parse(e){const{status:r,ctx:n}=this._processInputParams(e),s=(i,a)=>{if(ka(i)||ka(a))return A;const o=Pa(i.value,a.value);return o.valid?((Aa(i)||Aa(a))&&r.dirty(),{status:r.value,value:o.data}):($(n,{code:E.invalid_intersection_types}),A)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then(([i,a])=>s(i,a)):s(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}nn.create=(t,e,r)=>new nn({left:t,right:e,typeName:k.ZodIntersection,...j(r)});class st extends F{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==T.array)return $(n,{code:E.invalid_type,expected:T.array,received:n.parsedType}),A;if(n.data.length<this._def.items.length)return $(n,{code:E.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),A;!this._def.rest&&n.data.length>this._def.items.length&&($(n,{code:E.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),r.dirty());const i=[...n.data].map((a,o)=>{const c=this._def.items[o]||this._def.rest;return c?c._parse(new nt(n,a,n.path,o)):null}).filter(a=>!!a);return n.common.async?Promise.all(i).then(a=>fe.mergeArray(r,a)):fe.mergeArray(r,i)}get items(){return this._def.items}rest(e){return new st({...this._def,rest:e})}}st.create=(t,e)=>{if(!Array.isArray(t))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new st({items:t,typeName:k.ZodTuple,rest:null,...j(e)})};class sn extends F{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==T.object)return $(n,{code:E.invalid_type,expected:T.object,received:n.parsedType}),A;const s=[],i=this._def.keyType,a=this._def.valueType;for(const o in n.data)s.push({key:i._parse(new nt(n,o,n.path,o)),value:a._parse(new nt(n,n.data[o],n.path,o)),alwaysSet:o in n.data});return n.common.async?fe.mergeObjectAsync(r,s):fe.mergeObjectSync(r,s)}get element(){return this._def.valueType}static create(e,r,n){return r instanceof F?new sn({keyType:e,valueType:r,typeName:k.ZodRecord,...j(n)}):new sn({keyType:je.create(),valueType:e,typeName:k.ZodRecord,...j(r)})}}class ms extends F{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==T.map)return $(n,{code:E.invalid_type,expected:T.map,received:n.parsedType}),A;const s=this._def.keyType,i=this._def.valueType,a=[...n.data.entries()].map(([o,c],l)=>({key:s._parse(new nt(n,o,n.path,[l,"key"])),value:i._parse(new nt(n,c,n.path,[l,"value"]))}));if(n.common.async){const o=new Map;return Promise.resolve().then(async()=>{for(const c of a){const l=await c.key,u=await c.value;if(l.status==="aborted"||u.status==="aborted")return A;(l.status==="dirty"||u.status==="dirty")&&r.dirty(),o.set(l.value,u.value)}return{status:r.value,value:o}})}else{const o=new Map;for(const c of a){const l=c.key,u=c.value;if(l.status==="aborted"||u.status==="aborted")return A;(l.status==="dirty"||u.status==="dirty")&&r.dirty(),o.set(l.value,u.value)}return{status:r.value,value:o}}}}ms.create=(t,e,r)=>new ms({valueType:e,keyType:t,typeName:k.ZodMap,...j(r)});class Ft extends F{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.parsedType!==T.set)return $(n,{code:E.invalid_type,expected:T.set,received:n.parsedType}),A;const s=this._def;s.minSize!==null&&n.data.size<s.minSize.value&&($(n,{code:E.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),r.dirty()),s.maxSize!==null&&n.data.size>s.maxSize.value&&($(n,{code:E.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),r.dirty());const i=this._def.valueType;function a(c){const l=new Set;for(const u of c){if(u.status==="aborted")return A;u.status==="dirty"&&r.dirty(),l.add(u.value)}return{status:r.value,value:l}}const o=[...n.data.values()].map((c,l)=>i._parse(new nt(n,c,n.path,l)));return n.common.async?Promise.all(o).then(c=>a(c)):a(o)}min(e,r){return new Ft({...this._def,minSize:{value:e,message:R.toString(r)}})}max(e,r){return new Ft({...this._def,maxSize:{value:e,message:R.toString(r)}})}size(e,r){return this.min(e,r).max(e,r)}nonempty(e){return this.min(1,e)}}Ft.create=(t,e)=>new Ft({valueType:t,minSize:null,maxSize:null,typeName:k.ZodSet,...j(e)});class rr extends F{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:r}=this._processInputParams(e);if(r.parsedType!==T.function)return $(r,{code:E.invalid_type,expected:T.function,received:r.parsedType}),A;function n(o,c){return fs({data:o,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,ds(),fr].filter(l=>!!l),issueData:{code:E.invalid_arguments,argumentsError:c}})}function s(o,c){return fs({data:o,path:r.path,errorMaps:[r.common.contextualErrorMap,r.schemaErrorMap,ds(),fr].filter(l=>!!l),issueData:{code:E.invalid_return_type,returnTypeError:c}})}const i={errorMap:r.common.contextualErrorMap},a=r.data;if(this._def.returns instanceof pr){const o=this;return pe(async function(...c){const l=new Oe([]),u=await o._def.args.parseAsync(c,i).catch(h=>{throw l.addIssue(n(c,h)),l}),d=await Reflect.apply(a,this,u);return await o._def.returns._def.type.parseAsync(d,i).catch(h=>{throw l.addIssue(s(d,h)),l})})}else{const o=this;return pe(function(...c){const l=o._def.args.safeParse(c,i);if(!l.success)throw new Oe([n(c,l.error)]);const u=Reflect.apply(a,this,l.data),d=o._def.returns.safeParse(u,i);if(!d.success)throw new Oe([s(u,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new rr({...this._def,args:st.create(e).rest(kt.create())})}returns(e){return new rr({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,r,n){return new rr({args:e||st.create([]).rest(kt.create()),returns:r||kt.create(),typeName:k.ZodFunction,...j(n)})}}class an extends F{get schema(){return this._def.getter()}_parse(e){const{ctx:r}=this._processInputParams(e);return this._def.getter()._parse({data:r.data,path:r.path,parent:r})}}an.create=(t,e)=>new an({getter:t,typeName:k.ZodLazy,...j(e)});class on extends F{_parse(e){if(e.data!==this._def.value){const r=this._getOrReturnCtx(e);return $(r,{received:r.data,code:E.invalid_literal,expected:this._def.value}),A}return{status:"valid",value:e.data}}get value(){return this._def.value}}on.create=(t,e)=>new on({value:t,typeName:k.ZodLiteral,...j(e)});function wh(t,e){return new _t({values:t,typeName:k.ZodEnum,...j(e)})}class _t extends F{constructor(){super(...arguments),jr.set(this,void 0)}_parse(e){if(typeof e.data!="string"){const r=this._getOrReturnCtx(e),n=this._def.values;return $(r,{expected:B.joinValues(n),received:r.parsedType,code:E.invalid_type}),A}if(hs(this,jr)||mh(this,jr,new Set(this._def.values)),!hs(this,jr).has(e.data)){const r=this._getOrReturnCtx(e),n=this._def.values;return $(r,{received:r.data,code:E.invalid_enum_value,options:n}),A}return pe(e.data)}get options(){return this._def.values}get enum(){const e={};for(const r of this._def.values)e[r]=r;return e}get Values(){const e={};for(const r of this._def.values)e[r]=r;return e}get Enum(){const e={};for(const r of this._def.values)e[r]=r;return e}extract(e,r=this._def){return _t.create(e,{...this._def,...r})}exclude(e,r=this._def){return _t.create(this.options.filter(n=>!e.includes(n)),{...this._def,...r})}}jr=new WeakMap;_t.create=wh;class cn extends F{constructor(){super(...arguments),Fr.set(this,void 0)}_parse(e){const r=B.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==T.string&&n.parsedType!==T.number){const s=B.objectValues(r);return $(n,{expected:B.joinValues(s),received:n.parsedType,code:E.invalid_type}),A}if(hs(this,Fr)||mh(this,Fr,new Set(B.getValidEnumValues(this._def.values))),!hs(this,Fr).has(e.data)){const s=B.objectValues(r);return $(n,{received:n.data,code:E.invalid_enum_value,options:s}),A}return pe(e.data)}get enum(){return this._def.values}}Fr=new WeakMap;cn.create=(t,e)=>new cn({values:t,typeName:k.ZodNativeEnum,...j(e)});class pr extends F{unwrap(){return this._def.type}_parse(e){const{ctx:r}=this._processInputParams(e);if(r.parsedType!==T.promise&&r.common.async===!1)return $(r,{code:E.invalid_type,expected:T.promise,received:r.parsedType}),A;const n=r.parsedType===T.promise?r.data:Promise.resolve(r.data);return pe(n.then(s=>this._def.type.parseAsync(s,{path:r.path,errorMap:r.common.contextualErrorMap})))}}pr.create=(t,e)=>new pr({type:t,typeName:k.ZodPromise,...j(e)});class Le extends F{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===k.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:r,ctx:n}=this._processInputParams(e),s=this._def.effect||null,i={addIssue:a=>{$(n,a),a.fatal?r.abort():r.dirty()},get path(){return n.path}};if(i.addIssue=i.addIssue.bind(i),s.type==="preprocess"){const a=s.transform(n.data,i);if(n.common.async)return Promise.resolve(a).then(async o=>{if(r.value==="aborted")return A;const c=await this._def.schema._parseAsync({data:o,path:n.path,parent:n});return c.status==="aborted"?A:c.status==="dirty"||r.value==="dirty"?Yt(c.value):c});{if(r.value==="aborted")return A;const o=this._def.schema._parseSync({data:a,path:n.path,parent:n});return o.status==="aborted"?A:o.status==="dirty"||r.value==="dirty"?Yt(o.value):o}}if(s.type==="refinement"){const a=o=>{const c=s.refinement(o,i);if(n.common.async)return Promise.resolve(c);if(c instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(n.common.async===!1){const o=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return o.status==="aborted"?A:(o.status==="dirty"&&r.dirty(),a(o.value),{status:r.value,value:o.value})}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(o=>o.status==="aborted"?A:(o.status==="dirty"&&r.dirty(),a(o.value).then(()=>({status:r.value,value:o.value}))))}if(s.type==="transform")if(n.common.async===!1){const a=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Dt(a))return a;const o=s.transform(a.value,i);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:r.value,value:o}}else return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then(a=>Dt(a)?Promise.resolve(s.transform(a.value,i)).then(o=>({status:r.value,value:o})):a);B.assertNever(s)}}Le.create=(t,e,r)=>new Le({schema:t,typeName:k.ZodEffects,effect:e,...j(r)});Le.createWithPreprocess=(t,e,r)=>new Le({schema:e,effect:{type:"preprocess",transform:t},typeName:k.ZodEffects,...j(r)});class et extends F{_parse(e){return this._getType(e)===T.undefined?pe(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}et.create=(t,e)=>new et({innerType:t,typeName:k.ZodOptional,...j(e)});class Tt extends F{_parse(e){return this._getType(e)===T.null?pe(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Tt.create=(t,e)=>new Tt({innerType:t,typeName:k.ZodNullable,...j(e)});class ln extends F{_parse(e){const{ctx:r}=this._processInputParams(e);let n=r.data;return r.parsedType===T.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:r.path,parent:r})}removeDefault(){return this._def.innerType}}ln.create=(t,e)=>new ln({innerType:t,typeName:k.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...j(e)});class un extends F{_parse(e){const{ctx:r}=this._processInputParams(e),n={...r,common:{...r.common,issues:[]}},s=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Yr(s)?s.then(i=>({status:"valid",value:i.status==="valid"?i.value:this._def.catchValue({get error(){return new Oe(n.common.issues)},input:n.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new Oe(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}un.create=(t,e)=>new un({innerType:t,typeName:k.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...j(e)});class gs extends F{_parse(e){if(this._getType(e)!==T.nan){const n=this._getOrReturnCtx(e);return $(n,{code:E.invalid_type,expected:T.nan,received:n.parsedType}),A}return{status:"valid",value:e.data}}}gs.create=t=>new gs({typeName:k.ZodNaN,...j(t)});const Ox=Symbol("zod_brand");class So extends F{_parse(e){const{ctx:r}=this._processInputParams(e),n=r.data;return this._def.type._parse({data:n,path:r.path,parent:r})}unwrap(){return this._def.type}}class En extends F{_parse(e){const{status:r,ctx:n}=this._processInputParams(e);if(n.common.async)return(async()=>{const i=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return i.status==="aborted"?A:i.status==="dirty"?(r.dirty(),Yt(i.value)):this._def.out._parseAsync({data:i.value,path:n.path,parent:n})})();{const s=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return s.status==="aborted"?A:s.status==="dirty"?(r.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:n.path,parent:n})}}static create(e,r){return new En({in:e,out:r,typeName:k.ZodPipeline})}}class dn extends F{_parse(e){const r=this._def.innerType._parse(e),n=s=>(Dt(s)&&(s.value=Object.freeze(s.value)),s);return Yr(r)?r.then(s=>n(s)):n(r)}unwrap(){return this._def.innerType}}dn.create=(t,e)=>new dn({innerType:t,typeName:k.ZodReadonly,...j(e)});function ql(t,e){const r=typeof t=="function"?t(e):typeof t=="string"?{message:t}:t;return typeof r=="string"?{message:r}:r}function Sh(t,e={},r){return t?hr.create().superRefine((n,s)=>{var i,a;const o=t(n);if(o instanceof Promise)return o.then(c=>{var l,u;if(!c){const d=ql(e,n),y=(u=(l=d.fatal)!==null&&l!==void 0?l:r)!==null&&u!==void 0?u:!0;s.addIssue({code:"custom",...d,fatal:y})}});if(!o){const c=ql(e,n),l=(a=(i=c.fatal)!==null&&i!==void 0?i:r)!==null&&a!==void 0?a:!0;s.addIssue({code:"custom",...c,fatal:l})}}):hr.create()}const Cx={object:q.lazycreate};var k;(function(t){t.ZodString="ZodString",t.ZodNumber="ZodNumber",t.ZodNaN="ZodNaN",t.ZodBigInt="ZodBigInt",t.ZodBoolean="ZodBoolean",t.ZodDate="ZodDate",t.ZodSymbol="ZodSymbol",t.ZodUndefined="ZodUndefined",t.ZodNull="ZodNull",t.ZodAny="ZodAny",t.ZodUnknown="ZodUnknown",t.ZodNever="ZodNever",t.ZodVoid="ZodVoid",t.ZodArray="ZodArray",t.ZodObject="ZodObject",t.ZodUnion="ZodUnion",t.ZodDiscriminatedUnion="ZodDiscriminatedUnion",t.ZodIntersection="ZodIntersection",t.ZodTuple="ZodTuple",t.ZodRecord="ZodRecord",t.ZodMap="ZodMap",t.ZodSet="ZodSet",t.ZodFunction="ZodFunction",t.ZodLazy="ZodLazy",t.ZodLiteral="ZodLiteral",t.ZodEnum="ZodEnum",t.ZodEffects="ZodEffects",t.ZodNativeEnum="ZodNativeEnum",t.ZodOptional="ZodOptional",t.ZodNullable="ZodNullable",t.ZodDefault="ZodDefault",t.ZodCatch="ZodCatch",t.ZodPromise="ZodPromise",t.ZodBranded="ZodBranded",t.ZodPipeline="ZodPipeline",t.ZodReadonly="ZodReadonly"})(k||(k={}));const Rx=(t,e={message:`Input not instance of ${t.name}`})=>Sh(r=>r instanceof t,e),Ih=je.create,Eh=Et.create,xx=gs.create,kx=$t.create,$h=Xr.create,Ax=jt.create,Px=ps.create,Nx=en.create,Dx=tn.create,jx=hr.create,Fx=kt.create,Mx=ht.create,Lx=ys.create,Bx=Me.create,Ux=q.create,zx=q.strictCreate,Vx=rn.create,Hx=Ls.create,Wx=nn.create,Kx=st.create,Qx=sn.create,Zx=ms.create,Gx=Ft.create,qx=rr.create,Jx=an.create,Yx=on.create,Xx=_t.create,e0=cn.create,t0=pr.create,Jl=Le.create,r0=et.create,n0=Tt.create,s0=Le.createWithPreprocess,i0=En.create,a0=()=>Ih().optional(),o0=()=>Eh().optional(),c0=()=>$h().optional(),l0={string:t=>je.create({...t,coerce:!0}),number:t=>Et.create({...t,coerce:!0}),boolean:t=>Xr.create({...t,coerce:!0}),bigint:t=>$t.create({...t,coerce:!0}),date:t=>jt.create({...t,coerce:!0})},u0=A;var I=Object.freeze({__proto__:null,defaultErrorMap:fr,setErrorMap:sx,getErrorMap:ds,makeIssue:fs,EMPTY_PATH:ix,addIssueToContext:$,ParseStatus:fe,INVALID:A,DIRTY:Yt,OK:pe,isAborted:ka,isDirty:Aa,isValid:Dt,isAsync:Yr,get util(){return B},get objectUtil(){return xa},ZodParsedType:T,getParsedType:dt,ZodType:F,datetimeRegex:bh,ZodString:je,ZodNumber:Et,ZodBigInt:$t,ZodBoolean:Xr,ZodDate:jt,ZodSymbol:ps,ZodUndefined:en,ZodNull:tn,ZodAny:hr,ZodUnknown:kt,ZodNever:ht,ZodVoid:ys,ZodArray:Me,ZodObject:q,ZodUnion:rn,ZodDiscriminatedUnion:Ls,ZodIntersection:nn,ZodTuple:st,ZodRecord:sn,ZodMap:ms,ZodSet:Ft,ZodFunction:rr,ZodLazy:an,ZodLiteral:on,ZodEnum:_t,ZodNativeEnum:cn,ZodPromise:pr,ZodEffects:Le,ZodTransformer:Le,ZodOptional:et,ZodNullable:Tt,ZodDefault:ln,ZodCatch:un,ZodNaN:gs,BRAND:Ox,ZodBranded:So,ZodPipeline:En,ZodReadonly:dn,custom:Sh,Schema:F,ZodSchema:F,late:Cx,get ZodFirstPartyTypeKind(){return k},coerce:l0,any:jx,array:Bx,bigint:kx,boolean:$h,date:Ax,discriminatedUnion:Hx,effect:Jl,enum:Xx,function:qx,instanceof:Rx,intersection:Wx,lazy:Jx,literal:Yx,map:Zx,nan:xx,nativeEnum:e0,never:Mx,null:Dx,nullable:n0,number:Eh,object:Ux,oboolean:c0,onumber:o0,optional:r0,ostring:a0,pipeline:i0,preprocess:s0,promise:t0,record:Qx,set:Gx,strictObject:zx,string:Ih,symbol:Px,transformer:Jl,tuple:Kx,undefined:Nx,union:Vx,unknown:Fx,void:Lx,NEVER:u0,ZodIssueCode:E,quotelessJson:nx,ZodError:Oe});const d0=I.number().min(0,"May not be negative.").describe("The expected amount of days from starting a seed to its germination."),f0=I.number().min(0,"May not be negative.").describe("The expected amount of days from the germination of a seed to when it will be ready for transplant.             For cultivars which are not able to be transplanted, this value is unused."),h0=I.number().min(0,"May not be negative.").describe("The expected amount of days the germination of a seed to when it will be ready for a harvest."),p0=I.number().min(0,"May not be negative.").describe("The expected amount of days the first and last harvest of a plant.             For plants which only have one harvest, this value is zero."),y0=I.object({sowToGerm:d0.optional(),germToTransplant:f0.optional(),germToFirstHarvest:h0.optional(),firstToLastHarvest:p0.optional()}).describe("The annual lifecycle defines the length of the stages of life for annual plants."),m0=p.Record({sowToGerm:p.Optional(p.Number()),germToTransplant:p.Optional(p.Number()),germToFirstHarvest:p.Optional(p.Number()),firstToLastHarvest:p.Optional(p.Number())}),g0=I.number().describe("The amount of days between the last frost and the beginning of the planting window. 			Positive values indicate the window begins after the last frost date. 			For example, a value of -15 indicates the cultivar may be planted 15 days before the last frost date."),v0=I.number().describe("The amount of days between the last frost and the end of the planting window. 			Positive values indicate the window begins after the last frost date. 			For example, a value of 15 indicates the cultivar must be planted before 15 days after the last frost date."),b0=I.number().describe("The amount of days between the first frost and the beginning of the planting window. 			Positive values indicate the window begins after the first frost date. 			For example, a value of -15 indicates the cultivar may be planted 15 days before the first frost date."),w0=I.number().describe("The amount of days between the first frost and the end of the planting window. 			Positive values indicate the window begins after the first frost date. 			For example, a value of 15 indicates the cultivar must be planted before 15 days after the first frost date."),S0=I.object({lastFrostWindowOpen:g0.optional(),lastFrostWindowClose:v0.optional(),firstFrostWindowOpen:b0.optional(),firstFrostWindowClose:w0.optional()}).describe("A planting window defines a period of time within an environment that a cultivar should be planted. 		These attributes define an allowed planting window of time relative to the first and last frost dates. 		These planting windows are used for incdicating within the Verdagraph when plants are suggested to be planted."),I0=p.Record({lastFrostWindowOpen:p.Optional(p.Number()),lastFrostWindowClose:p.Optional(p.Number()),firstFrostWindowOpen:p.Optional(p.Number()),firstFrostWindowClose:p.Optional(p.Number())}),E0=I.boolean().describe("Defines whether a plant may be started as a seed in one location and transplanted to another. 		Some plants, such as carrots, don't tolerate transplants, and so must be started directly."),$0=I.object({transplantable:E0.optional()}).describe("The origin refers to the method used to create plants."),_0=p.Record({transplantable:p.Optional(p.Boolean())}),_h=p.Record({annualLifeCycle:p.Optional(m0),frostDatePlantingWindows:p.Optional(I0),origin:p.Optional(_0)});I.object({annualLifeCycle:y0.optional(),frostDatePlantingWindows:S0.optional(),osrigin:$0.optional()});const T0={anon:{match:{"x-triplit-token-type":"anon"}},user:{match:{type:"user",accountId:"$accountId",profileId:"$profileId",username:"$username"}}},O0=p.Collections({profiles:{schema:p.Schema({id:p.Id(),username:p.String(),createdAt:p.Date({default:p.Default.now()})}),permissions:{anon:{read:{filter:[!0]}},user:{read:{filter:[!0]}}}},accounts:{schema:p.Schema({id:p.Id(),profileId:p.String(),passwordHash:p.String(),verifiedEmail:p.String({nullable:!0}),unverifiedEmail:p.Record({address:p.String({nullable:!0,default:null}),token:p.String({nullable:!0,default:null})}),passwordResetToken:p.String({nullable:!0,default:null}),isActive:p.Boolean({default:!0})}),relationships:{profile:p.RelationById("profiles","$profileId")},permissions:{user:{read:{filter:[["id","=","$role.accountId"]]}}}}}),Th=["HIDDEN","UNLISTED","PUBLIC"],Oh=["ADMIN","EDITOR","VIEWER"],C0=["CREATED","PENDING","ACCEPTED"],R0=p.Collections({...O0,gardens:{schema:p.Schema({id:p.Id(),name:p.String(),visibility:p.String({enum:[...Th]}),description:p.String({nullable:!0,default:null}),isActive:p.Boolean({default:!0}),creatorId:p.String({nullable:!0}),adminIds:p.Set(p.String()),editorIds:p.Set(p.String(),{default:p.Default.Set.empty()}),viewerIds:p.Set(p.String(),{default:p.Default.Set.empty()}),createdAt:p.Date({default:p.Default.now()})}),relationships:{creator:p.RelationById("profiles","$creatorId"),adminMemberships:p.RelationMany("gardenMemberships",{where:[["userId","in","$adminIds"]]}),editorMemberships:p.RelationMany("gardenMemberships",{where:[["userId","in","$adminIds"]]}),viewerMemberships:p.RelationMany("gardenMemberships",{where:[["userId","in","$adminIds"]]})},permissions:{anon:{read:{filter:[["visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["visibility","!=","HIDDEN"],["adminIds","has","$role.profileId"],["editorIds","has","$role.profileId"],["viewerIds","has","$role.profileId"]])]},insert:{filter:[["creatorId","=","$role.profileId"]]},update:{filter:[["adminIds","has","$role.profileId"]]}}}},gardenMemberships:{schema:p.Schema({id:p.Id(),gardenId:p.String(),userId:p.String(),role:p.String({enum:[...Oh]}),inviterId:p.String({nullable:!0}),status:p.String({enum:[...C0]}),acceptedAt:p.Date({nullable:!0,default:null}),favorite:p.Boolean({default:!1})}),relationships:{garden:p.RelationById("gardens","$gardenId"),user:p.RelationById("profiles","$userId"),inviter:p.RelationById("profiles","$inviterId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[["garden.adminIds","has","$role.profileId"]]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["userId","=","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["userId","=","$role.accountId"]])]}}}}}),x0=I.string().trim().min(2,"Must be at least 3 characters.").max(50,"May be at most 50 characters.").regex(/[0-9A-Za-z _-]+/,"Must contain only letters, numbers, spaces, underscores, and hyphens."),k0=I.string().max(1400,"May be at most 1400 characters."),ze={nameSchema:x0,descriptionSchema:k0},Io=I.string().trim().min(3,"Must be at least 3 characters.").max(50,"May be at most 50 characters.").regex(/^[a-zA-Z0-9-_]*$/,"Must contain only letters, numbers, hyphens, and underscores.").describe("Unique username to identify yourself in the application. May be changed later."),Er=I.string().email("Must be a valid email address.").describe("Must be a valid email address."),wt=I.string().min(6,"Must be at least 6 characters.").max(255,"Must be at most 255 characters.").describe("Must be between 6 and 255 characters long."),A0={usernameSchema:Io,emailSchema:Er,passwordSchema:wt},P0=I.object({email:Er,password:I.string()}),aP=I.object({email:Er,password1:wt,password2:wt,username:Io}).refine(t=>t.password1==t.password2,{message:"Passwords must match",path:["password2"]});I.object({newEmail:Er.optional(),newPassword1:wt.optional(),newPassword2:wt.optional(),newUsername:Io.optional(),password:wt}).refine(t=>t.newPassword1==t.newPassword2,{message:"Passwords must match",path:["newPassword2"]});const oP=I.object({email:Er});I.object({token:I.string()});const cP=I.object({email:Er}),lP=I.object({userId:I.string().nanoid(),token:I.string(),password1:wt,password2:wt}).refine(t=>t.password1==t.password2,{message:"Passwords must match",path:["password2"]}),N0=I.string().trim().toLowerCase().min(4,"Must be at least 4 characters.").max(21,"May be at most 21 characters.").regex(/[0-9A-Za-z-]+/,"Must contain only alphanumeric characters and hyphens.").describe("Unique shorthand name for the garden used in URLs."),Ch=ze.nameSchema.describe("Name of the garden."),Rh=ze.descriptionSchema.describe("Optional description."),xh=I.enum(Th),D0=I.enum(Oh),nr=I.array(A0.usernameSchema).max(10,"A maximum of 10 users can be invited at once."),uP={gardenNameSchema:Ch,gardenDescriptionSchema:Rh,gardenVisibilitySchema:xh},dP=I.object({id:N0,name:Ch,description:Rh.default(""),visibility:xh.default("HIDDEN"),adminInvites:nr.describe("A list of usernames to invite as admins. A maximum of 10 users can be invited at once.").default([]),editorInvites:nr.describe("A list of usernames to invite as editors. A maximum of 10 users can be invited at once.").default([]),viewerInvites:nr.describe("A list of usernames to invite as viewers. A maximum of 10 users can be invited at once.").default([])});I.object({gardenId:I.string(),adminInvites:nr.describe("A list of usernames to invite as admins.").default([]),editorInvites:nr.describe("A list of usernames to invite as editors.").default([]),viewerInvites:nr.describe("A list of usernames to invite as viewers.").default([])});I.object({gardenId:I.string()});I.object({gardenId:I.string()});I.object({gardenId:I.string(),profileId:I.string()});I.object({gardenId:I.string(),profileId:I.string(),newRole:D0});const kh=["RECTANGLE","POLYGON","ELLIPSE","LINES"],j0=p.Collections({...R0,coordinates:{schema:p.Schema({id:p.Id(),gardenId:p.String(),x:p.Number(),y:p.Number(),z:p.Number({nullable:!0,default:0}),createdAt:p.Date({default:p.Default.now()})}),relationships:{garden:p.RelationById("gardens","$gardenId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},geometries:{schema:p.Schema({id:p.Id(),gardenId:p.String(),type:p.String({enum:[...kh]}),date:p.Date(),scaleFactor:p.Number({default:1}),rotation:p.Number({default:0}),rectangleLength:p.Number({default:1}),rectangleWidth:p.Number({default:1}),polygonNumSides:p.Number({default:3}),polygonRadius:p.Number({default:1}),ellipseLength:p.Number({default:1}),ellipseWidth:p.Number({default:1}),linesCoordinateIds:p.Set(p.String(),{default:p.Default.Set.empty()}),linesClosed:p.Boolean({default:!0})}),relationships:{garden:p.RelationById("gardens","$gardenId"),linesCoordinates:p.RelationMany("coordinates",{where:[["id","in","$linesCoordinateIds"]],order:[["createdAt","ASC"]]})},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},geometryHistories:{schema:p.Schema({id:p.Id(),gardenId:p.String(),geometryIds:p.Set(p.String())}),relationships:{garden:p.RelationById("gardens","$gardenId"),geometries:p.RelationMany("geometries",{where:[["id","in","$geometryIds"]],order:[["date","ASC"]]})},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},locations:{schema:p.Schema({id:p.Id(),gardenId:p.String(),workspaceId:p.String(),x:p.Number(),y:p.Number(),z:p.Number({nullable:!0,default:0}),date:p.Date()}),relationships:{garden:p.RelationById("gardens","$gardenId"),workspace:p.RelationById("workspaces","$workspaceId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},locationHistories:{schema:p.Schema({id:p.Id(),gardenId:p.String(),locationIds:p.Set(p.String()),workspaceIds:p.Set(p.String())}),relationships:{garden:p.RelationById("gardens","$gardenId"),locations:p.RelationMany("locations",{where:[["id","in","$locationIds"]],order:[["date","ASC"]]})},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},plantingAreas:{schema:p.Schema({id:p.Id(),gardenId:p.String(),name:p.String(),geometryId:p.String(),locationHistoryId:p.String(),depth:p.Number({default:0}),description:p.String({default:""})}),relationships:{garden:p.RelationById("gardens","$gardenId"),geometry:p.RelationById("geometries","$geometryId"),locationHistory:p.RelationById("locationHistories","$locationHistoryId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[["garden.adminIds","has","$role.profileId"]]},update:{filter:[["garden.adminIds","has","$role.profileId"]]},delete:{filter:[["garden.adminIds","has","$role.profileId"]]}}}},workspaces:{schema:p.Schema({id:p.Id(),gardenId:p.String(),name:p.String(),slug:p.String(),description:p.String({default:""})}),relationships:{garden:p.RelationById("gardens","$gardenId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[["garden.adminIds","has","$role.profileId"]]},update:{filter:[["garden.adminIds","has","$role.profileId"]]},delete:{filter:[["garden.adminIds","has","$role.profileId"]]}}}}}),F0=I.number().describe("The minimum temperature that is expected to occur within a year in the environment."),M0=I.number().describe("The maxmium temperature that is expected to occur within a year in the environment."),L0=I.object({minimum:F0.optional(),maximum:M0.optional()}).describe("Defines the expected range of temperatures over a year."),B0=p.Record({minimum:p.Optional(p.Number()),maximum:p.Optional(p.Number())}),U0=I.date().describe("The date within the environment when the last frost of the year is expected to occur."),z0=I.date().describe("The date within the environment when the first frost of the year is expected to occur."),V0=I.object({lastFrostDate:U0.optional(),firstFrostDate:z0.optional()}).describe("Defines when the first and last frost are expected to occur within a year."),H0=p.Record({lastFrostDate:p.Optional(p.Date()),firstFrostDate:p.Optional(p.Date())}),W0=p.Record({frostDates:p.Optional(H0),annualTemperature:p.Optional(B0)});I.object({frostDates:V0.optional(),annualTemperature:L0.optional()});const Ah=["GARDEN","WORKSPACE","PLANTING_AREA","INDEPENDENT"],Ph=p.Collections({...j0,environments:{schema:p.Schema({id:p.Id(),name:p.String(),description:p.String({default:""}),parentType:p.String({enum:[...Ah],default:"GARDEN"}),gardenId:p.String(),workspaceIds:p.Optional(p.Set(p.String())),plantingAreaIds:p.Optional(p.Set(p.String())),geometryHistoryId:p.Optional(p.String()),locationHistoryId:p.Optional(p.String()),inherit:p.Boolean({default:!0}),attributes:W0}),relationships:{garden:p.RelationById("gardens","$gardenId"),workspaces:p.RelationMany("workspaces",{where:[["id","in","$workspaceIds"]]}),plantingAreas:p.RelationMany("plantingAreas",{where:[["id","in","$plantingAreaIds"]]}),geometriHistory:p.RelationById("geometryHistories","$geometryHistoryId"),locationHistory:p.RelationById("locationHistories","$locationHistoryId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}}}),K0=["DIRECT_SEED","SEED_TO_TRANSPLANT","SEEDLING_TO_TRANSPLANT"],Q0=["COMPOST","LOW","MEDIUM","HIGH","PERFECT"],Z0=p.Collections({...Ph,harvests:{schema:p.Schema({id:p.Id(),gardenId:p.String(),date:p.Date(),mass:p.Optional(p.Number()),units:p.Optional(p.Number()),quality:p.Optional(p.String({enum:[...Q0]})),description:p.String({default:""})}),relationships:{garden:p.RelationById("gardens","$gardenId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},lifespans:{schema:p.Schema({id:p.Id(),gardenId:p.String(),origin:p.String({enum:[...K0]}),geometryHistoryId:p.Optional(p.String()),locationHistoryId:p.Optional(p.String()),dates:p.Record({seedDate:p.Optional(p.Date()),germDate:p.Optional(p.Date()),expiryDate:p.Optional(p.Date()),dormancyDates:p.Optional(p.Set(p.Date())),growthDates:p.Optional(p.Set(p.Date()))}),harvestIds:p.Set(p.String())}),relationships:{garden:p.RelationById("gardens","$gardenId"),geometryHistory:p.RelationById("geometryHistories","$geometryHistoryId"),locationHistory:p.RelationById("locationHistories","$locationHistoryId"),harvests:p.RelationMany("harvests",{where:[["id","in","$harvestIds"]]})},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},plants:{schema:p.Schema({id:p.Id(),gardenId:p.String(),cultivarName:p.String(),cultivarAttributes:_h,expectedLifespanId:p.String(),recordedLifespanId:p.String(),aggregate:p.Boolean({default:!1})}),relationships:{garden:p.RelationById("gardens","$gardenId"),expectedLifespan:p.RelationById("lifespans","$expectedLifespanId"),recordedLifespan:p.RelationById("lifespans","$recordedLifespanId")},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}},plantGroups:{schema:p.Schema({id:p.Id(),gardenId:p.String(),name:p.String(),plantIds:p.Set(p.String()),description:p.String({default:""})}),relationships:{garden:p.RelationById("gardens","$gardenId"),plants:p.RelationMany("plants",{where:[["id","in","$plantIds"]]})},permissions:{anon:{read:{filter:[["garden.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["garden.visibility","!=","HIDDEN"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},update:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]},delete:{filter:[x([["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"]])]}}}}}),Eo=ze.nameSchema.describe("Name of the workspace. Must be unique within a garden."),$o=ze.descriptionSchema.describe("Optional description."),_o=ze.nameSchema.describe("The name of the planting area."),To=ze.descriptionSchema.describe("Optional description."),Oo=I.number().min(0,"May not be negative").max(1e3,"May be at most 1000m.").describe("The depth of the planting area."),G0=I.number().min(-1e6,"Limited to 1 000 000 meters.").max(1e6,"Limited to 1 000 000 meters.").describe("The horizontal X component of the coordinate."),q0=I.number().min(-1e6,"Limited to 1 000 000 meters.").max(1e6,"Limited to 1 000 000 meters.").describe("The vertical Y component of the coordinate."),$n=I.object({x:G0,y:q0}).describe("A position relative to the origin of a workspace or a geometry."),Bs=I.date().describe("The date at which the location applies."),Co=I.enum(kh).describe("Describes the type of geometry. Each type has a unique set of attributes associated with it."),Ro=I.date().describe("The date at which the geometry applies to the object."),xo=I.number().min(.01,"Must be at least 1%.").max(100,"May be at most 10000%").describe("Factor used to scale the geometry up or down. Must be within 1 and 1000 percent."),ko=I.number().min(-360,"Must be at least negative 360 degrees.").max(360,"May be at most 360 degrees.").describe("The rotation of the geometry in degrees. Must be between 0 and 360 degrees."),Ao=I.number().min(.01,"May not be negative or zero.").max(1e3,"May be at most 1000m").describe("The horizontal, or x-axis length of the rectangle."),Po=I.number().min(.01,"May not be negative or zero.").max(1e3,"May be at most 1000m").describe("The vertical, or y-axis width of the rectangle."),No=I.number().min(3,"Must have at least 3 sides.").max(20,"May have at most 20 sides.").describe("The amount of sides the polygon has."),Do=I.number().min(.01,"May not be negative or zero.").max(1e3,"May be at most 1000m").describe("The distance from the center to any vertex of the polygon."),jo=I.number().min(.01,"May not be negative or zero.").max(1e3,"May be at most 1000m.").describe("The horizontal, or x-axis diameter of the ellipse."),Fo=I.number().min(.01,"May not be negative or zero.").max(1e3,"May be at most 1000m").describe("The vertical, or y-axis diameter of the ellipse. Must be between 0 and 1000 meters."),Nh=I.array($n).min(3,"Must have at least 3 points.").describe("A list of coordinates relative to the position of the geometry which define an irregular polygonal."),Mo=I.boolean().describe("If true, the line segments form a closed shape."),fP={workspaceNameSchema:Eo,workspaceDescriptionSchema:$o,plantingAreaNameSchema:_o,plantingAreaDescriptionSchema:To,plantingAreaDepthSchema:Oo,coordinateSchema:$n,locationDateSchema:Bs,geometryTypeSchema:Co,geometryDateSchema:Ro,geometryScaleFactorSchema:xo,geometryRotationSchema:ko,geometryRectangleLengthSchema:Ao,geometryRectangleWidthSchema:Po,geometryPolygonNumSidesSchema:No,geometryPolygonRadiusSchema:Do,geometryEllipseLengthSchema:jo,geometryEllipseWidthSchema:Fo,geometryLinesClosedSchema:Mo},J0=I.object({gardenId:I.string(),workspaceId:I.string(),coordinate:$n,date:Bs});I.object({id:I.string(),workspaceId:I.string(),coordinate:$n,date:Bs});I.object({coordinate:$n.optional(),date:Bs.optional(),workspaceId:I.string().optional(),delete:I.boolean().optional()});const Y0=I.object({type:Co.default("RECTANGLE"),date:Ro,scaleFactor:xo.default(1),rotation:ko.default(0),rectangleLength:Ao.default(1),rectangleWidth:Po.default(1),polygonNumSides:No.default(3),polygonRadius:Do.default(1),ellipseLength:jo.default(1),ellipseWidth:Fo.default(1),linesCoordinates:Nh.default([{x:-1,y:0},{x:0,y:1},{x:1,y:0}]),linesClosed:Mo.default(!0)});I.object({type:Co.optional(),date:Ro.optional(),scaleFactor:xo.optional(),rotation:ko.optional(),rectangleLength:Ao.optional(),rectangleWidth:Po.optional(),polygonNumSides:No.optional(),polygonRadius:Do.optional(),ellipseLength:jo.optional(),ellipseWidth:Fo.optional(),linesCoordinates:Nh.optional(),linesClosed:Mo.optional(),delete:I.boolean().optional()});const hP=I.object({gardenId:I.string(),name:Eo,description:$o.optional()});I.object({name:Eo.optional(),description:$o.optional()});const pP=I.object({gardenId:I.string(),workspaceId:I.string(),name:_o,description:To.default(""),location:J0,geometry:Y0,depth:Oo.default(0)});I.object({name:_o.optional(),description:To.optional(),depth:Oo.optional()});const Dh=["HIDDEN","UNLISTED","PUBLIC"];p.Collections({...Ph,cultivarCollections:{schema:p.Schema({id:p.Id(),name:p.String(),slug:p.String(),visibility:p.String({enum:[...Dh]}),userId:p.String(),gardenId:p.String(),description:p.String({default:""}),parentId:p.String({nullable:!0,default:null})}),relationships:{user:p.RelationById("profiles","userId"),garden:p.RelationById("gardens","$gardenId"),parent:p.RelationById("cultivarCollections","$parentId")},permissions:{anon:{read:{filter:[["visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["visibility","!=","HIDDEN"],["userId","=","$role.profileId"],["garden.adminIds","has","$role.profileId"],["garden.editorIds","has","$role.profileId"],["garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["userId","=","$role.profileId"],["garden.adminIds","has","$role.profileId"]])]},update:{filter:[x([["userId","=","$role.profileId"],["garden.adminIds","has","$role.profileId"]])]},delete:{filter:[x([["userId","=","$role.profileId"],["garden.adminIds","has","$role.profileId"]])]}}}},cultivars:{schema:p.Schema({id:p.Id(),collectionId:p.String(),names:p.Set(p.String()),abbreviation:p.String(),scientificName:p.Optional(p.String()),description:p.String({default:""}),parentId:p.String({nullable:!0,default:null}),attributes:_h}),relationships:{collection:p.RelationById("cultivarCollections","$collectionId"),parent:p.RelationById("cultivars","$parentId")},permissions:{anon:{read:{filter:[["collection.visibility","!=","HIDDEN"]]}},user:{read:{filter:[x([["collection.visibility","!=","HIDDEN"],["collection.userId","=","$role.profileId"],["collection.garden.adminIds","has","$role.profileId"],["collection.garden.editorIds","has","$role.profileId"],["collection.garden.viewerIds","has","$role.profileId"]])]},insert:{filter:[x([["collection.userId","=","$role.profileId"],["collection.garden.adminIds","has","$role.profileId"]])]},update:{filter:[x([["collection.userId","=","$role.profileId"],["collection.garden.adminIds","has","$role.profileId"]])]},delete:{filter:[x([["collection.userId","=","$role.profileId"],["collection.garden.adminIds","has","$role.profileId"]])]}}}}});const X0=I.string().trim().min(3,"Must be at least 3 characters.").max(30,"May be at most 30 characters.").regex(/^[0-9A-Za-z _-]+$/,"Must contain only letters, numbers, spaces, hyphens, and underscores.").describe("A common name of this plant species."),ek=I.array(X0).min(1,"Must contain at least 1 name.").max(10,"May contain at most 10 names.").describe("A set of common names associated with this plant species."),tk=I.string().trim().min(1,"Must be at least 1 character.").max(6,"May be at most 6 characters.").regex(/^[0-9A-Za-z]+$/,"Must contain only alphanumeric characters.").describe("A very short abbreviation for this plant species."),rk=I.string().trim().max(60,"May be at most 60 characters.").describe("The scientific name of this plant species."),nk=ze.descriptionSchema.describe("Optional description."),sk=ze.descriptionSchema.describe("The name of the collection."),ik=ze.descriptionSchema.describe("Optional description."),ak=I.enum(Dh).describe("Public collections may be viewed by anyone and are publicly searchable.             Unlisted collections may be viewed by anyone with the link.             Private collections may only be accessed by the creator or members of the associated garden."),ok=I.string().trim().max(150,"Must be at most 150 characters.").regex(/^[0-9A-Za-z ]+$/,"Must contain only alphanumeric characters and spaces.").describe("A metadata tag."),ck=I.array(ok).max(150,"Must contain at most 150 tags.").describe("A set of metadata tags.");I.object({collectionId:I.string(),names:ek,abbreviation:tk,scientificName:rk.optional(),description:nk.default(""),parentId:I.string().optional()});I.object({name:sk,visibility:ak.default("HIDDEN"),description:ik.default(""),tags:ck.default([]),parentId:I.string().optional(),gardenId:I.string().optional(),userId:I.string().optional()}).refine(t=>t.gardenId&&t.parentId,{message:"A cultivar collection must be connected to a garden or a user..",path:["gardenId","userId"]});const lk=ze.nameSchema.describe("Name of the environment. Must be unique."),uk=ze.descriptionSchema.describe("Optional description."),dk=I.enum(Ah);I.object({gardenId:I.string(),parendId:I.string(),parentType:dk.default("GARDEN"),name:lk,description:uk.default("")});const fk=Z0,Yl=typeof document<"u";function Xl(t){const e=fp(t);function r(s){Yl&&e.set(s)}function n(s){Yl&&e.update(s)}return{subscribe:e.subscribe,set:r,update:n}}let eu=0;function hk(){const t=Xl([]),e=Xl([]);function r(g){t.update(S=>[g,...S])}function n(g){var se;const{message:S,...C}=g,N=typeof(g==null?void 0:g.id)=="number"||g.id&&((se=g.id)==null?void 0:se.length)>0?g.id:eu++,U=g.dismissable===void 0?!0:g.dismissable,P=g.type===void 0?"default":g.type;return Go(t).find(me=>me.id===N)?t.update(me=>me.map(z=>z.id===N?{...z,...g,id:N,title:S,dismissable:U,type:P,updated:!0}:{...z,updated:!1})):r({...C,id:N,title:S,dismissable:U,type:P}),N}function s(g){if(g===void 0){t.update(S=>S.map(C=>({...C,dismiss:!0})));return}return t.update(S=>S.map(C=>C.id===g?{...C,dismiss:!0}:C)),g}function i(g){if(g===void 0){t.set([]);return}return t.update(S=>S.filter(C=>C.id!==g)),g}function a(g,S){return n({...S,type:"default",message:g})}function o(g,S){return n({...S,type:"error",message:g})}function c(g,S){return n({...S,type:"success",message:g})}function l(g,S){return n({...S,type:"info",message:g})}function u(g,S){return n({...S,type:"warning",message:g})}function d(g,S){return n({...S,type:"loading",message:g})}function y(g,S){if(!S)return;let C;S.loading!==void 0&&(C=n({...S,promise:g,type:"loading",message:S.loading}));const N=g instanceof Promise?g:g();let U=C!==void 0;return N.then(P=>{if(P&&typeof P.ok=="boolean"&&!P.ok){U=!1;const K=typeof S.error=="function"?S.error(`HTTP error! status: ${P.status}`):S.error;n({id:C,type:"error",message:K})}else if(S.success!==void 0){U=!1;const K=typeof S.success=="function"?S.success(P):S.success;n({id:C,type:"success",message:K})}}).catch(P=>{if(S.error!==void 0){U=!1;const K=typeof S.error=="function"?S.error(P):S.error;n({id:C,type:"error",message:K})}}).finally(()=>{var P;U&&(s(C),C=void 0),(P=S.finally)==null||P.call(S)}),C}function h(g,S){const C=(S==null?void 0:S.id)||eu++;return n({component:g,id:C,...S}),C}function f(g){e.update(S=>S.filter(C=>C.toastId!==g))}function m(g){if(Go(e).find(C=>C.toastId===g.toastId)===void 0){e.update(C=>[g,...C]);return}e.update(C=>C.map(N=>N.toastId===g.toastId?g:N))}function v(){t.set([]),e.set([])}return{create:n,addToast:r,dismiss:s,remove:i,message:a,error:o,success:c,info:l,warning:u,loading:d,promise:y,custom:h,removeHeight:f,setHeight:m,reset:v,toasts:t,heights:e}}const Ze=hk();function pk(t,e){return Ze.create({message:t,...e})}const yk=pk,mk=Object.assign(yk,{success:Ze.success,info:Ze.info,warning:Ze.warning,error:Ze.error,custom:Ze.custom,message:Ze.message,promise:Ze.promise,dismiss:Ze.dismiss,loading:Ze.loading});function tu(t){if(t.nonFormErrors)for(const e of t.nonFormErrors)mk.error(e)}function jh(t,e){return function(){return t.apply(e,arguments)}}const{toString:gk}=Object.prototype,{getPrototypeOf:Lo}=Object,{iterator:Us,toStringTag:Fh}=Symbol,zs=(t=>e=>{const r=gk.call(e);return t[r]||(t[r]=r.slice(8,-1).toLowerCase())})(Object.create(null)),Ve=t=>(t=t.toLowerCase(),e=>zs(e)===t),Vs=t=>e=>typeof e===t,{isArray:$r}=Array,fn=Vs("undefined");function vk(t){return t!==null&&!fn(t)&&t.constructor!==null&&!fn(t.constructor)&&be(t.constructor.isBuffer)&&t.constructor.isBuffer(t)}const Mh=Ve("ArrayBuffer");function bk(t){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(t):e=t&&t.buffer&&Mh(t.buffer),e}const wk=Vs("string"),be=Vs("function"),Lh=Vs("number"),Hs=t=>t!==null&&typeof t=="object",Sk=t=>t===!0||t===!1,qn=t=>{if(zs(t)!=="object")return!1;const e=Lo(t);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Fh in t)&&!(Us in t)},Ik=Ve("Date"),Ek=Ve("File"),$k=Ve("Blob"),_k=Ve("FileList"),Tk=t=>Hs(t)&&be(t.pipe),Ok=t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||be(t.append)&&((e=zs(t))==="formdata"||e==="object"&&be(t.toString)&&t.toString()==="[object FormData]"))},Ck=Ve("URLSearchParams"),[Rk,xk,kk,Ak]=["ReadableStream","Request","Response","Headers"].map(Ve),Pk=t=>t.trim?t.trim():t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function _n(t,e,{allOwnKeys:r=!1}={}){if(t===null||typeof t>"u")return;let n,s;if(typeof t!="object"&&(t=[t]),$r(t))for(n=0,s=t.length;n<s;n++)e.call(null,t[n],n,t);else{const i=r?Object.getOwnPropertyNames(t):Object.keys(t),a=i.length;let o;for(n=0;n<a;n++)o=i[n],e.call(null,t[o],o,t)}}function Bh(t,e){e=e.toLowerCase();const r=Object.keys(t);let n=r.length,s;for(;n-- >0;)if(s=r[n],e===s.toLowerCase())return s;return null}const xt=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,Uh=t=>!fn(t)&&t!==xt;function Na(){const{caseless:t}=Uh(this)&&this||{},e={},r=(n,s)=>{const i=t&&Bh(e,s)||s;qn(e[i])&&qn(n)?e[i]=Na(e[i],n):qn(n)?e[i]=Na({},n):$r(n)?e[i]=n.slice():e[i]=n};for(let n=0,s=arguments.length;n<s;n++)arguments[n]&&_n(arguments[n],r);return e}const Nk=(t,e,r,{allOwnKeys:n}={})=>(_n(e,(s,i)=>{r&&be(s)?t[i]=jh(s,r):t[i]=s},{allOwnKeys:n}),t),Dk=t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),jk=(t,e,r,n)=>{t.prototype=Object.create(e.prototype,n),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),r&&Object.assign(t.prototype,r)},Fk=(t,e,r,n)=>{let s,i,a;const o={};if(e=e||{},t==null)return e;do{for(s=Object.getOwnPropertyNames(t),i=s.length;i-- >0;)a=s[i],(!n||n(a,t,e))&&!o[a]&&(e[a]=t[a],o[a]=!0);t=r!==!1&&Lo(t)}while(t&&(!r||r(t,e))&&t!==Object.prototype);return e},Mk=(t,e,r)=>{t=String(t),(r===void 0||r>t.length)&&(r=t.length),r-=e.length;const n=t.indexOf(e,r);return n!==-1&&n===r},Lk=t=>{if(!t)return null;if($r(t))return t;let e=t.length;if(!Lh(e))return null;const r=new Array(e);for(;e-- >0;)r[e]=t[e];return r},Bk=(t=>e=>t&&e instanceof t)(typeof Uint8Array<"u"&&Lo(Uint8Array)),Uk=(t,e)=>{const n=(t&&t[Us]).call(t);let s;for(;(s=n.next())&&!s.done;){const i=s.value;e.call(t,i[0],i[1])}},zk=(t,e)=>{let r;const n=[];for(;(r=t.exec(e))!==null;)n.push(r);return n},Vk=Ve("HTMLFormElement"),Hk=t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(r,n,s){return n.toUpperCase()+s}),ru=(({hasOwnProperty:t})=>(e,r)=>t.call(e,r))(Object.prototype),Wk=Ve("RegExp"),zh=(t,e)=>{const r=Object.getOwnPropertyDescriptors(t),n={};_n(r,(s,i)=>{let a;(a=e(s,i,t))!==!1&&(n[i]=a||s)}),Object.defineProperties(t,n)},Kk=t=>{zh(t,(e,r)=>{if(be(t)&&["arguments","caller","callee"].indexOf(r)!==-1)return!1;const n=t[r];if(be(n)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+r+"'")})}})},Qk=(t,e)=>{const r={},n=s=>{s.forEach(i=>{r[i]=!0})};return $r(t)?n(t):n(String(t).split(e)),r},Zk=()=>{},Gk=(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e;function qk(t){return!!(t&&be(t.append)&&t[Fh]==="FormData"&&t[Us])}const Jk=t=>{const e=new Array(10),r=(n,s)=>{if(Hs(n)){if(e.indexOf(n)>=0)return;if(!("toJSON"in n)){e[s]=n;const i=$r(n)?[]:{};return _n(n,(a,o)=>{const c=r(a,s+1);!fn(c)&&(i[o]=c)}),e[s]=void 0,i}}return n};return r(t,0)},Yk=Ve("AsyncFunction"),Xk=t=>t&&(Hs(t)||be(t))&&be(t.then)&&be(t.catch),Vh=((t,e)=>t?setImmediate:e?((r,n)=>(xt.addEventListener("message",({source:s,data:i})=>{s===xt&&i===r&&n.length&&n.shift()()},!1),s=>{n.push(s),xt.postMessage(r,"*")}))(`axios@${Math.random()}`,[]):r=>setTimeout(r))(typeof setImmediate=="function",be(xt.postMessage)),eA=typeof queueMicrotask<"u"?queueMicrotask.bind(xt):typeof process<"u"&&process.nextTick||Vh,tA=t=>t!=null&&be(t[Us]),w={isArray:$r,isArrayBuffer:Mh,isBuffer:vk,isFormData:Ok,isArrayBufferView:bk,isString:wk,isNumber:Lh,isBoolean:Sk,isObject:Hs,isPlainObject:qn,isReadableStream:Rk,isRequest:xk,isResponse:kk,isHeaders:Ak,isUndefined:fn,isDate:Ik,isFile:Ek,isBlob:$k,isRegExp:Wk,isFunction:be,isStream:Tk,isURLSearchParams:Ck,isTypedArray:Bk,isFileList:_k,forEach:_n,merge:Na,extend:Nk,trim:Pk,stripBOM:Dk,inherits:jk,toFlatObject:Fk,kindOf:zs,kindOfTest:Ve,endsWith:Mk,toArray:Lk,forEachEntry:Uk,matchAll:zk,isHTMLForm:Vk,hasOwnProperty:ru,hasOwnProp:ru,reduceDescriptors:zh,freezeMethods:Kk,toObjectSet:Qk,toCamelCase:Hk,noop:Zk,toFiniteNumber:Gk,findKey:Bh,global:xt,isContextDefined:Uh,isSpecCompliantForm:qk,toJSONObject:Jk,isAsyncFn:Yk,isThenable:Xk,setImmediate:Vh,asap:eA,isIterable:tA};function D(t,e,r,n,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),r&&(this.config=r),n&&(this.request=n),s&&(this.response=s,this.status=s.status?s.status:null)}w.inherits(D,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:w.toJSONObject(this.config),code:this.code,status:this.status}}});const Hh=D.prototype,Wh={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Wh[t]={value:t}});Object.defineProperties(D,Wh);Object.defineProperty(Hh,"isAxiosError",{value:!0});D.from=(t,e,r,n,s,i)=>{const a=Object.create(Hh);return w.toFlatObject(t,a,function(c){return c!==Error.prototype},o=>o!=="isAxiosError"),D.call(a,t.message,e,r,n,s),a.cause=t,a.name=t.name,i&&Object.assign(a,i),a};const rA=null;function Da(t){return w.isPlainObject(t)||w.isArray(t)}function Kh(t){return w.endsWith(t,"[]")?t.slice(0,-2):t}function nu(t,e,r){return t?t.concat(e).map(function(s,i){return s=Kh(s),!r&&i?"["+s+"]":s}).join(r?".":""):e}function nA(t){return w.isArray(t)&&!t.some(Da)}const sA=w.toFlatObject(w,{},null,function(e){return/^is[A-Z]/.test(e)});function Ws(t,e,r){if(!w.isObject(t))throw new TypeError("target must be an object");e=e||new FormData,r=w.toFlatObject(r,{metaTokens:!0,dots:!1,indexes:!1},!1,function(m,v){return!w.isUndefined(v[m])});const n=r.metaTokens,s=r.visitor||u,i=r.dots,a=r.indexes,c=(r.Blob||typeof Blob<"u"&&Blob)&&w.isSpecCompliantForm(e);if(!w.isFunction(s))throw new TypeError("visitor must be a function");function l(f){if(f===null)return"";if(w.isDate(f))return f.toISOString();if(!c&&w.isBlob(f))throw new D("Blob is not supported. Use a Buffer instead.");return w.isArrayBuffer(f)||w.isTypedArray(f)?c&&typeof Blob=="function"?new Blob([f]):Buffer.from(f):f}function u(f,m,v){let g=f;if(f&&!v&&typeof f=="object"){if(w.endsWith(m,"{}"))m=n?m:m.slice(0,-2),f=JSON.stringify(f);else if(w.isArray(f)&&nA(f)||(w.isFileList(f)||w.endsWith(m,"[]"))&&(g=w.toArray(f)))return m=Kh(m),g.forEach(function(C,N){!(w.isUndefined(C)||C===null)&&e.append(a===!0?nu([m],N,i):a===null?m:m+"[]",l(C))}),!1}return Da(f)?!0:(e.append(nu(v,m,i),l(f)),!1)}const d=[],y=Object.assign(sA,{defaultVisitor:u,convertValue:l,isVisitable:Da});function h(f,m){if(!w.isUndefined(f)){if(d.indexOf(f)!==-1)throw Error("Circular reference detected in "+m.join("."));d.push(f),w.forEach(f,function(g,S){(!(w.isUndefined(g)||g===null)&&s.call(e,g,w.isString(S)?S.trim():S,m,y))===!0&&h(g,m?m.concat(S):[S])}),d.pop()}}if(!w.isObject(t))throw new TypeError("data must be an object");return h(t),e}function su(t){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(n){return e[n]})}function Bo(t,e){this._pairs=[],t&&Ws(t,this,e)}const Qh=Bo.prototype;Qh.append=function(e,r){this._pairs.push([e,r])};Qh.toString=function(e){const r=e?function(n){return e.call(this,n,su)}:su;return this._pairs.map(function(s){return r(s[0])+"="+r(s[1])},"").join("&")};function iA(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Zh(t,e,r){if(!e)return t;const n=r&&r.encode||iA;w.isFunction(r)&&(r={serialize:r});const s=r&&r.serialize;let i;if(s?i=s(e,r):i=w.isURLSearchParams(e)?e.toString():new Bo(e,r).toString(n),i){const a=t.indexOf("#");a!==-1&&(t=t.slice(0,a)),t+=(t.indexOf("?")===-1?"?":"&")+i}return t}class iu{constructor(){this.handlers=[]}use(e,r,n){return this.handlers.push({fulfilled:e,rejected:r,synchronous:n?n.synchronous:!1,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){w.forEach(this.handlers,function(n){n!==null&&e(n)})}}const Gh={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},aA=typeof URLSearchParams<"u"?URLSearchParams:Bo,oA=typeof FormData<"u"?FormData:null,cA=typeof Blob<"u"?Blob:null,lA={isBrowser:!0,classes:{URLSearchParams:aA,FormData:oA,Blob:cA},protocols:["http","https","file","blob","url","data"]},Uo=typeof window<"u"&&typeof document<"u",ja=typeof navigator=="object"&&navigator||void 0,uA=Uo&&(!ja||["ReactNative","NativeScript","NS"].indexOf(ja.product)<0),dA=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",fA=Uo&&window.location.href||"http://localhost",hA=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:Uo,hasStandardBrowserEnv:uA,hasStandardBrowserWebWorkerEnv:dA,navigator:ja,origin:fA},Symbol.toStringTag,{value:"Module"})),ue={...hA,...lA};function pA(t,e){return Ws(t,new ue.classes.URLSearchParams,Object.assign({visitor:function(r,n,s,i){return ue.isNode&&w.isBuffer(r)?(this.append(n,r.toString("base64")),!1):i.defaultVisitor.apply(this,arguments)}},e))}function yA(t){return w.matchAll(/\w+|\[(\w*)]/g,t).map(e=>e[0]==="[]"?"":e[1]||e[0])}function mA(t){const e={},r=Object.keys(t);let n;const s=r.length;let i;for(n=0;n<s;n++)i=r[n],e[i]=t[i];return e}function qh(t){function e(r,n,s,i){let a=r[i++];if(a==="__proto__")return!0;const o=Number.isFinite(+a),c=i>=r.length;return a=!a&&w.isArray(s)?s.length:a,c?(w.hasOwnProp(s,a)?s[a]=[s[a],n]:s[a]=n,!o):((!s[a]||!w.isObject(s[a]))&&(s[a]=[]),e(r,n,s[a],i)&&w.isArray(s[a])&&(s[a]=mA(s[a])),!o)}if(w.isFormData(t)&&w.isFunction(t.entries)){const r={};return w.forEachEntry(t,(n,s)=>{e(yA(n),s,r,0)}),r}return null}function gA(t,e,r){if(w.isString(t))try{return(e||JSON.parse)(t),w.trim(t)}catch(n){if(n.name!=="SyntaxError")throw n}return(r||JSON.stringify)(t)}const Tn={transitional:Gh,adapter:["xhr","http","fetch"],transformRequest:[function(e,r){const n=r.getContentType()||"",s=n.indexOf("application/json")>-1,i=w.isObject(e);if(i&&w.isHTMLForm(e)&&(e=new FormData(e)),w.isFormData(e))return s?JSON.stringify(qh(e)):e;if(w.isArrayBuffer(e)||w.isBuffer(e)||w.isStream(e)||w.isFile(e)||w.isBlob(e)||w.isReadableStream(e))return e;if(w.isArrayBufferView(e))return e.buffer;if(w.isURLSearchParams(e))return r.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(i){if(n.indexOf("application/x-www-form-urlencoded")>-1)return pA(e,this.formSerializer).toString();if((o=w.isFileList(e))||n.indexOf("multipart/form-data")>-1){const c=this.env&&this.env.FormData;return Ws(o?{"files[]":e}:e,c&&new c,this.formSerializer)}}return i||s?(r.setContentType("application/json",!1),gA(e)):e}],transformResponse:[function(e){const r=this.transitional||Tn.transitional,n=r&&r.forcedJSONParsing,s=this.responseType==="json";if(w.isResponse(e)||w.isReadableStream(e))return e;if(e&&w.isString(e)&&(n&&!this.responseType||s)){const a=!(r&&r.silentJSONParsing)&&s;try{return JSON.parse(e)}catch(o){if(a)throw o.name==="SyntaxError"?D.from(o,D.ERR_BAD_RESPONSE,this,null,this.response):o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:ue.classes.FormData,Blob:ue.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};w.forEach(["delete","get","head","post","put","patch"],t=>{Tn.headers[t]={}});const vA=w.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),bA=t=>{const e={};let r,n,s;return t&&t.split(`
`).forEach(function(a){s=a.indexOf(":"),r=a.substring(0,s).trim().toLowerCase(),n=a.substring(s+1).trim(),!(!r||e[r]&&vA[r])&&(r==="set-cookie"?e[r]?e[r].push(n):e[r]=[n]:e[r]=e[r]?e[r]+", "+n:n)}),e},au=Symbol("internals");function Nr(t){return t&&String(t).trim().toLowerCase()}function Jn(t){return t===!1||t==null?t:w.isArray(t)?t.map(Jn):String(t)}function wA(t){const e=Object.create(null),r=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=r.exec(t);)e[n[1]]=n[2];return e}const SA=t=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(t.trim());function Ki(t,e,r,n,s){if(w.isFunction(n))return n.call(this,e,r);if(s&&(e=r),!!w.isString(e)){if(w.isString(n))return e.indexOf(n)!==-1;if(w.isRegExp(n))return n.test(e)}}function IA(t){return t.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,r,n)=>r.toUpperCase()+n)}function EA(t,e){const r=w.toCamelCase(" "+e);["get","set","has"].forEach(n=>{Object.defineProperty(t,n+r,{value:function(s,i,a){return this[n].call(this,e,s,i,a)},configurable:!0})})}let we=class{constructor(e){e&&this.set(e)}set(e,r,n){const s=this;function i(o,c,l){const u=Nr(c);if(!u)throw new Error("header name must be a non-empty string");const d=w.findKey(s,u);(!d||s[d]===void 0||l===!0||l===void 0&&s[d]!==!1)&&(s[d||c]=Jn(o))}const a=(o,c)=>w.forEach(o,(l,u)=>i(l,u,c));if(w.isPlainObject(e)||e instanceof this.constructor)a(e,r);else if(w.isString(e)&&(e=e.trim())&&!SA(e))a(bA(e),r);else if(w.isObject(e)&&w.isIterable(e)){let o={},c,l;for(const u of e){if(!w.isArray(u))throw TypeError("Object iterator must return a key-value pair");o[l=u[0]]=(c=o[l])?w.isArray(c)?[...c,u[1]]:[c,u[1]]:u[1]}a(o,r)}else e!=null&&i(r,e,n);return this}get(e,r){if(e=Nr(e),e){const n=w.findKey(this,e);if(n){const s=this[n];if(!r)return s;if(r===!0)return wA(s);if(w.isFunction(r))return r.call(this,s,n);if(w.isRegExp(r))return r.exec(s);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,r){if(e=Nr(e),e){const n=w.findKey(this,e);return!!(n&&this[n]!==void 0&&(!r||Ki(this,this[n],n,r)))}return!1}delete(e,r){const n=this;let s=!1;function i(a){if(a=Nr(a),a){const o=w.findKey(n,a);o&&(!r||Ki(n,n[o],o,r))&&(delete n[o],s=!0)}}return w.isArray(e)?e.forEach(i):i(e),s}clear(e){const r=Object.keys(this);let n=r.length,s=!1;for(;n--;){const i=r[n];(!e||Ki(this,this[i],i,e,!0))&&(delete this[i],s=!0)}return s}normalize(e){const r=this,n={};return w.forEach(this,(s,i)=>{const a=w.findKey(n,i);if(a){r[a]=Jn(s),delete r[i];return}const o=e?IA(i):String(i).trim();o!==i&&delete r[i],r[o]=Jn(s),n[o]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const r=Object.create(null);return w.forEach(this,(n,s)=>{n!=null&&n!==!1&&(r[s]=e&&w.isArray(n)?n.join(", "):n)}),r}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,r])=>e+": "+r).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...r){const n=new this(e);return r.forEach(s=>n.set(s)),n}static accessor(e){const n=(this[au]=this[au]={accessors:{}}).accessors,s=this.prototype;function i(a){const o=Nr(a);n[o]||(EA(s,a),n[o]=!0)}return w.isArray(e)?e.forEach(i):i(e),this}};we.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);w.reduceDescriptors(we.prototype,({value:t},e)=>{let r=e[0].toUpperCase()+e.slice(1);return{get:()=>t,set(n){this[r]=n}}});w.freezeMethods(we);function Qi(t,e){const r=this||Tn,n=e||r,s=we.from(n.headers);let i=n.data;return w.forEach(t,function(o){i=o.call(r,i,s.normalize(),e?e.status:void 0)}),s.normalize(),i}function Jh(t){return!!(t&&t.__CANCEL__)}function _r(t,e,r){D.call(this,t??"canceled",D.ERR_CANCELED,e,r),this.name="CanceledError"}w.inherits(_r,D,{__CANCEL__:!0});function Yh(t,e,r){const n=r.config.validateStatus;!r.status||!n||n(r.status)?t(r):e(new D("Request failed with status code "+r.status,[D.ERR_BAD_REQUEST,D.ERR_BAD_RESPONSE][Math.floor(r.status/100)-4],r.config,r.request,r))}function $A(t){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(t);return e&&e[1]||""}function _A(t,e){t=t||10;const r=new Array(t),n=new Array(t);let s=0,i=0,a;return e=e!==void 0?e:1e3,function(c){const l=Date.now(),u=n[i];a||(a=l),r[s]=c,n[s]=l;let d=i,y=0;for(;d!==s;)y+=r[d++],d=d%t;if(s=(s+1)%t,s===i&&(i=(i+1)%t),l-a<e)return;const h=u&&l-u;return h?Math.round(y*1e3/h):void 0}}function TA(t,e){let r=0,n=1e3/e,s,i;const a=(l,u=Date.now())=>{r=u,s=null,i&&(clearTimeout(i),i=null),t.apply(null,l)};return[(...l)=>{const u=Date.now(),d=u-r;d>=n?a(l,u):(s=l,i||(i=setTimeout(()=>{i=null,a(s)},n-d)))},()=>s&&a(s)]}const vs=(t,e,r=3)=>{let n=0;const s=_A(50,250);return TA(i=>{const a=i.loaded,o=i.lengthComputable?i.total:void 0,c=a-n,l=s(c),u=a<=o;n=a;const d={loaded:a,total:o,progress:o?a/o:void 0,bytes:c,rate:l||void 0,estimated:l&&o&&u?(o-a)/l:void 0,event:i,lengthComputable:o!=null,[e?"download":"upload"]:!0};t(d)},r)},ou=(t,e)=>{const r=t!=null;return[n=>e[0]({lengthComputable:r,total:t,loaded:n}),e[1]]},cu=t=>(...e)=>w.asap(()=>t(...e)),OA=ue.hasStandardBrowserEnv?((t,e)=>r=>(r=new URL(r,ue.origin),t.protocol===r.protocol&&t.host===r.host&&(e||t.port===r.port)))(new URL(ue.origin),ue.navigator&&/(msie|trident)/i.test(ue.navigator.userAgent)):()=>!0,CA=ue.hasStandardBrowserEnv?{write(t,e,r,n,s,i){const a=[t+"="+encodeURIComponent(e)];w.isNumber(r)&&a.push("expires="+new Date(r).toGMTString()),w.isString(n)&&a.push("path="+n),w.isString(s)&&a.push("domain="+s),i===!0&&a.push("secure"),document.cookie=a.join("; ")},read(t){const e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function RA(t){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)}function xA(t,e){return e?t.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):t}function Xh(t,e,r){let n=!RA(e);return t&&(n||r==!1)?xA(t,e):e}const lu=t=>t instanceof we?{...t}:t;function Mt(t,e){e=e||{};const r={};function n(l,u,d,y){return w.isPlainObject(l)&&w.isPlainObject(u)?w.merge.call({caseless:y},l,u):w.isPlainObject(u)?w.merge({},u):w.isArray(u)?u.slice():u}function s(l,u,d,y){if(w.isUndefined(u)){if(!w.isUndefined(l))return n(void 0,l,d,y)}else return n(l,u,d,y)}function i(l,u){if(!w.isUndefined(u))return n(void 0,u)}function a(l,u){if(w.isUndefined(u)){if(!w.isUndefined(l))return n(void 0,l)}else return n(void 0,u)}function o(l,u,d){if(d in e)return n(l,u);if(d in t)return n(void 0,l)}const c={url:i,method:i,data:i,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,withXSRFToken:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:o,headers:(l,u,d)=>s(lu(l),lu(u),d,!0)};return w.forEach(Object.keys(Object.assign({},t,e)),function(u){const d=c[u]||s,y=d(t[u],e[u],u);w.isUndefined(y)&&d!==o||(r[u]=y)}),r}const ep=t=>{const e=Mt({},t);let{data:r,withXSRFToken:n,xsrfHeaderName:s,xsrfCookieName:i,headers:a,auth:o}=e;e.headers=a=we.from(a),e.url=Zh(Xh(e.baseURL,e.url,e.allowAbsoluteUrls),t.params,t.paramsSerializer),o&&a.set("Authorization","Basic "+btoa((o.username||"")+":"+(o.password?unescape(encodeURIComponent(o.password)):"")));let c;if(w.isFormData(r)){if(ue.hasStandardBrowserEnv||ue.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if((c=a.getContentType())!==!1){const[l,...u]=c?c.split(";").map(d=>d.trim()).filter(Boolean):[];a.setContentType([l||"multipart/form-data",...u].join("; "))}}if(ue.hasStandardBrowserEnv&&(n&&w.isFunction(n)&&(n=n(e)),n||n!==!1&&OA(e.url))){const l=s&&i&&CA.read(i);l&&a.set(s,l)}return e},kA=typeof XMLHttpRequest<"u",AA=kA&&function(t){return new Promise(function(r,n){const s=ep(t);let i=s.data;const a=we.from(s.headers).normalize();let{responseType:o,onUploadProgress:c,onDownloadProgress:l}=s,u,d,y,h,f;function m(){h&&h(),f&&f(),s.cancelToken&&s.cancelToken.unsubscribe(u),s.signal&&s.signal.removeEventListener("abort",u)}let v=new XMLHttpRequest;v.open(s.method.toUpperCase(),s.url,!0),v.timeout=s.timeout;function g(){if(!v)return;const C=we.from("getAllResponseHeaders"in v&&v.getAllResponseHeaders()),U={data:!o||o==="text"||o==="json"?v.responseText:v.response,status:v.status,statusText:v.statusText,headers:C,config:t,request:v};Yh(function(K){r(K),m()},function(K){n(K),m()},U),v=null}"onloadend"in v?v.onloadend=g:v.onreadystatechange=function(){!v||v.readyState!==4||v.status===0&&!(v.responseURL&&v.responseURL.indexOf("file:")===0)||setTimeout(g)},v.onabort=function(){v&&(n(new D("Request aborted",D.ECONNABORTED,t,v)),v=null)},v.onerror=function(){n(new D("Network Error",D.ERR_NETWORK,t,v)),v=null},v.ontimeout=function(){let N=s.timeout?"timeout of "+s.timeout+"ms exceeded":"timeout exceeded";const U=s.transitional||Gh;s.timeoutErrorMessage&&(N=s.timeoutErrorMessage),n(new D(N,U.clarifyTimeoutError?D.ETIMEDOUT:D.ECONNABORTED,t,v)),v=null},i===void 0&&a.setContentType(null),"setRequestHeader"in v&&w.forEach(a.toJSON(),function(N,U){v.setRequestHeader(U,N)}),w.isUndefined(s.withCredentials)||(v.withCredentials=!!s.withCredentials),o&&o!=="json"&&(v.responseType=s.responseType),l&&([y,f]=vs(l,!0),v.addEventListener("progress",y)),c&&v.upload&&([d,h]=vs(c),v.upload.addEventListener("progress",d),v.upload.addEventListener("loadend",h)),(s.cancelToken||s.signal)&&(u=C=>{v&&(n(!C||C.type?new _r(null,t,v):C),v.abort(),v=null)},s.cancelToken&&s.cancelToken.subscribe(u),s.signal&&(s.signal.aborted?u():s.signal.addEventListener("abort",u)));const S=$A(s.url);if(S&&ue.protocols.indexOf(S)===-1){n(new D("Unsupported protocol "+S+":",D.ERR_BAD_REQUEST,t));return}v.send(i||null)})},PA=(t,e)=>{const{length:r}=t=t?t.filter(Boolean):[];if(e||r){let n=new AbortController,s;const i=function(l){if(!s){s=!0,o();const u=l instanceof Error?l:this.reason;n.abort(u instanceof D?u:new _r(u instanceof Error?u.message:u))}};let a=e&&setTimeout(()=>{a=null,i(new D(`timeout ${e} of ms exceeded`,D.ETIMEDOUT))},e);const o=()=>{t&&(a&&clearTimeout(a),a=null,t.forEach(l=>{l.unsubscribe?l.unsubscribe(i):l.removeEventListener("abort",i)}),t=null)};t.forEach(l=>l.addEventListener("abort",i));const{signal:c}=n;return c.unsubscribe=()=>w.asap(o),c}},NA=function*(t,e){let r=t.byteLength;if(r<e){yield t;return}let n=0,s;for(;n<r;)s=n+e,yield t.slice(n,s),n=s},DA=async function*(t,e){for await(const r of jA(t))yield*NA(r,e)},jA=async function*(t){if(t[Symbol.asyncIterator]){yield*t;return}const e=t.getReader();try{for(;;){const{done:r,value:n}=await e.read();if(r)break;yield n}}finally{await e.cancel()}},uu=(t,e,r,n)=>{const s=DA(t,e);let i=0,a,o=c=>{a||(a=!0,n&&n(c))};return new ReadableStream({async pull(c){try{const{done:l,value:u}=await s.next();if(l){o(),c.close();return}let d=u.byteLength;if(r){let y=i+=d;r(y)}c.enqueue(new Uint8Array(u))}catch(l){throw o(l),l}},cancel(c){return o(c),s.return()}},{highWaterMark:2})},Ks=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",tp=Ks&&typeof ReadableStream=="function",FA=Ks&&(typeof TextEncoder=="function"?(t=>e=>t.encode(e))(new TextEncoder):async t=>new Uint8Array(await new Response(t).arrayBuffer())),rp=(t,...e)=>{try{return!!t(...e)}catch{return!1}},MA=tp&&rp(()=>{let t=!1;const e=new Request(ue.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),du=64*1024,Fa=tp&&rp(()=>w.isReadableStream(new Response("").body)),bs={stream:Fa&&(t=>t.body)};Ks&&(t=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!bs[e]&&(bs[e]=w.isFunction(t[e])?r=>r[e]():(r,n)=>{throw new D(`Response type '${e}' is not supported`,D.ERR_NOT_SUPPORT,n)})})})(new Response);const LA=async t=>{if(t==null)return 0;if(w.isBlob(t))return t.size;if(w.isSpecCompliantForm(t))return(await new Request(ue.origin,{method:"POST",body:t}).arrayBuffer()).byteLength;if(w.isArrayBufferView(t)||w.isArrayBuffer(t))return t.byteLength;if(w.isURLSearchParams(t)&&(t=t+""),w.isString(t))return(await FA(t)).byteLength},BA=async(t,e)=>{const r=w.toFiniteNumber(t.getContentLength());return r??LA(e)},UA=Ks&&(async t=>{let{url:e,method:r,data:n,signal:s,cancelToken:i,timeout:a,onDownloadProgress:o,onUploadProgress:c,responseType:l,headers:u,withCredentials:d="same-origin",fetchOptions:y}=ep(t);l=l?(l+"").toLowerCase():"text";let h=PA([s,i&&i.toAbortSignal()],a),f;const m=h&&h.unsubscribe&&(()=>{h.unsubscribe()});let v;try{if(c&&MA&&r!=="get"&&r!=="head"&&(v=await BA(u,n))!==0){let U=new Request(e,{method:"POST",body:n,duplex:"half"}),P;if(w.isFormData(n)&&(P=U.headers.get("content-type"))&&u.setContentType(P),U.body){const[K,G]=ou(v,vs(cu(c)));n=uu(U.body,du,K,G)}}w.isString(d)||(d=d?"include":"omit");const g="credentials"in Request.prototype;f=new Request(e,{...y,signal:h,method:r.toUpperCase(),headers:u.normalize().toJSON(),body:n,duplex:"half",credentials:g?d:void 0});let S=await fetch(f);const C=Fa&&(l==="stream"||l==="response");if(Fa&&(o||C&&m)){const U={};["status","statusText","headers"].forEach(se=>{U[se]=S[se]});const P=w.toFiniteNumber(S.headers.get("content-length")),[K,G]=o&&ou(P,vs(cu(o),!0))||[];S=new Response(uu(S.body,du,K,()=>{G&&G(),m&&m()}),U)}l=l||"text";let N=await bs[w.findKey(bs,l)||"text"](S,t);return!C&&m&&m(),await new Promise((U,P)=>{Yh(U,P,{data:N,headers:we.from(S.headers),status:S.status,statusText:S.statusText,config:t,request:f})})}catch(g){throw m&&m(),g&&g.name==="TypeError"&&/Load failed|fetch/i.test(g.message)?Object.assign(new D("Network Error",D.ERR_NETWORK,t,f),{cause:g.cause||g}):D.from(g,g&&g.code,t,f)}}),Ma={http:rA,xhr:AA,fetch:UA};w.forEach(Ma,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});const fu=t=>`- ${t}`,zA=t=>w.isFunction(t)||t===null||t===!1,np={getAdapter:t=>{t=w.isArray(t)?t:[t];const{length:e}=t;let r,n;const s={};for(let i=0;i<e;i++){r=t[i];let a;if(n=r,!zA(r)&&(n=Ma[(a=String(r)).toLowerCase()],n===void 0))throw new D(`Unknown adapter '${a}'`);if(n)break;s[a||"#"+i]=n}if(!n){const i=Object.entries(s).map(([o,c])=>`adapter ${o} `+(c===!1?"is not supported by the environment":"is not available in the build"));let a=e?i.length>1?`since :
`+i.map(fu).join(`
`):" "+fu(i[0]):"as no adapter specified";throw new D("There is no suitable adapter to dispatch the request "+a,"ERR_NOT_SUPPORT")}return n},adapters:Ma};function Zi(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new _r(null,t)}function hu(t){return Zi(t),t.headers=we.from(t.headers),t.data=Qi.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),np.getAdapter(t.adapter||Tn.adapter)(t).then(function(n){return Zi(t),n.data=Qi.call(t,t.transformResponse,n),n.headers=we.from(n.headers),n},function(n){return Jh(n)||(Zi(t),n&&n.response&&(n.response.data=Qi.call(t,t.transformResponse,n.response),n.response.headers=we.from(n.response.headers))),Promise.reject(n)})}const sp="1.9.0",Qs={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{Qs[t]=function(n){return typeof n===t||"a"+(e<1?"n ":" ")+t}});const pu={};Qs.transitional=function(e,r,n){function s(i,a){return"[Axios v"+sp+"] Transitional option '"+i+"'"+a+(n?". "+n:"")}return(i,a,o)=>{if(e===!1)throw new D(s(a," has been removed"+(r?" in "+r:"")),D.ERR_DEPRECATED);return r&&!pu[a]&&(pu[a]=!0,console.warn(s(a," has been deprecated since v"+r+" and will be removed in the near future"))),e?e(i,a,o):!0}};Qs.spelling=function(e){return(r,n)=>(console.warn(`${n} is likely a misspelling of ${e}`),!0)};function VA(t,e,r){if(typeof t!="object")throw new D("options must be an object",D.ERR_BAD_OPTION_VALUE);const n=Object.keys(t);let s=n.length;for(;s-- >0;){const i=n[s],a=e[i];if(a){const o=t[i],c=o===void 0||a(o,i,t);if(c!==!0)throw new D("option "+i+" must be "+c,D.ERR_BAD_OPTION_VALUE);continue}if(r!==!0)throw new D("Unknown option "+i,D.ERR_BAD_OPTION)}}const Yn={assertOptions:VA,validators:Qs},Qe=Yn.validators;let At=class{constructor(e){this.defaults=e||{},this.interceptors={request:new iu,response:new iu}}async request(e,r){try{return await this._request(e,r)}catch(n){if(n instanceof Error){let s={};Error.captureStackTrace?Error.captureStackTrace(s):s=new Error;const i=s.stack?s.stack.replace(/^.+\n/,""):"";try{n.stack?i&&!String(n.stack).endsWith(i.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+i):n.stack=i}catch{}}throw n}}_request(e,r){typeof e=="string"?(r=r||{},r.url=e):r=e||{},r=Mt(this.defaults,r);const{transitional:n,paramsSerializer:s,headers:i}=r;n!==void 0&&Yn.assertOptions(n,{silentJSONParsing:Qe.transitional(Qe.boolean),forcedJSONParsing:Qe.transitional(Qe.boolean),clarifyTimeoutError:Qe.transitional(Qe.boolean)},!1),s!=null&&(w.isFunction(s)?r.paramsSerializer={serialize:s}:Yn.assertOptions(s,{encode:Qe.function,serialize:Qe.function},!0)),r.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?r.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:r.allowAbsoluteUrls=!0),Yn.assertOptions(r,{baseUrl:Qe.spelling("baseURL"),withXsrfToken:Qe.spelling("withXSRFToken")},!0),r.method=(r.method||this.defaults.method||"get").toLowerCase();let a=i&&w.merge(i.common,i[r.method]);i&&w.forEach(["delete","get","head","post","put","patch","common"],f=>{delete i[f]}),r.headers=we.concat(a,i);const o=[];let c=!0;this.interceptors.request.forEach(function(m){typeof m.runWhen=="function"&&m.runWhen(r)===!1||(c=c&&m.synchronous,o.unshift(m.fulfilled,m.rejected))});const l=[];this.interceptors.response.forEach(function(m){l.push(m.fulfilled,m.rejected)});let u,d=0,y;if(!c){const f=[hu.bind(this),void 0];for(f.unshift.apply(f,o),f.push.apply(f,l),y=f.length,u=Promise.resolve(r);d<y;)u=u.then(f[d++],f[d++]);return u}y=o.length;let h=r;for(d=0;d<y;){const f=o[d++],m=o[d++];try{h=f(h)}catch(v){m.call(this,v);break}}try{u=hu.call(this,h)}catch(f){return Promise.reject(f)}for(d=0,y=l.length;d<y;)u=u.then(l[d++],l[d++]);return u}getUri(e){e=Mt(this.defaults,e);const r=Xh(e.baseURL,e.url,e.allowAbsoluteUrls);return Zh(r,e.params,e.paramsSerializer)}};w.forEach(["delete","get","head","options"],function(e){At.prototype[e]=function(r,n){return this.request(Mt(n||{},{method:e,url:r,data:(n||{}).data}))}});w.forEach(["post","put","patch"],function(e){function r(n){return function(i,a,o){return this.request(Mt(o||{},{method:e,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:a}))}}At.prototype[e]=r(),At.prototype[e+"Form"]=r(!0)});let HA=class ip{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let r;this.promise=new Promise(function(i){r=i});const n=this;this.promise.then(s=>{if(!n._listeners)return;let i=n._listeners.length;for(;i-- >0;)n._listeners[i](s);n._listeners=null}),this.promise.then=s=>{let i;const a=new Promise(o=>{n.subscribe(o),i=o}).then(s);return a.cancel=function(){n.unsubscribe(i)},a},e(function(i,a,o){n.reason||(n.reason=new _r(i,a,o),r(n.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const r=this._listeners.indexOf(e);r!==-1&&this._listeners.splice(r,1)}toAbortSignal(){const e=new AbortController,r=n=>{e.abort(n)};return this.subscribe(r),e.signal.unsubscribe=()=>this.unsubscribe(r),e.signal}static source(){let e;return{token:new ip(function(s){e=s}),cancel:e}}};function WA(t){return function(r){return t.apply(null,r)}}function KA(t){return w.isObject(t)&&t.isAxiosError===!0}const La={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(La).forEach(([t,e])=>{La[e]=t});function ap(t){const e=new At(t),r=jh(At.prototype.request,e);return w.extend(r,At.prototype,e,{allOwnKeys:!0}),w.extend(r,e,null,{allOwnKeys:!0}),r.create=function(s){return ap(Mt(t,s))},r}const ee=ap(Tn);ee.Axios=At;ee.CanceledError=_r;ee.CancelToken=HA;ee.isCancel=Jh;ee.VERSION=sp;ee.toFormData=Ws;ee.AxiosError=D;ee.Cancel=ee.CanceledError;ee.all=function(e){return Promise.all(e)};ee.spread=WA;ee.isAxiosError=KA;ee.mergeConfig=Mt;ee.AxiosHeaders=we;ee.formToJSON=t=>qh(w.isHTMLForm(t)?new FormData(t):t);ee.getAdapter=np.getAdapter;ee.HttpStatusCode=La;ee.default=ee;const{Axios:gP,AxiosError:vP,CanceledError:bP,isCancel:wP,CancelToken:SP,VERSION:IP,all:EP,Cancel:$P,isAxiosError:_P,spread:TP,toFormData:OP,AxiosHeaders:CP,HttpStatusCode:RP,formToJSON:xP,getAdapter:kP,mergeConfig:AP}=ee,zo=ee.create({baseURL:"http://localhost:8000",withCredentials:!0});zo.interceptors.request.use(t=>(t.headers.Authorization=Fe.token,t));zo.interceptors.response.use(t=>t.data,t=>{throw t.response?t:new Hr("Axios error occurred without a response.",{nonFormErrors:["Something unexpected happened with the server."]})});const Ut=t=>zo({...t}),QA=t=>Ut({url:"/users/login",method:"POST",headers:{"Content-Type":"application/json"},data:t}),ZA=()=>Ut({url:"/users/refresh",method:"POST"}),PP=t=>Ut({url:"/users/create",method:"POST",headers:{"Content-Type":"application/json"},data:t}),NP=t=>Ut({url:"/users/requestEmailConfirmationOp",method:"POST",headers:{"Content-Type":"application/json"},data:t}),DP=t=>Ut({url:"/users/confirmEmail",method:"POST",headers:{"Content-Type":"application/json"},data:t}),jP=t=>Ut({url:"/users/requestPasswordReset",method:"POST",headers:{"Content-Type":"application/json"},data:t}),FP=t=>Ut({url:"/users/confirmPasswordReset",method:"POST",headers:{"Content-Type":"application/json"},data:t}),MP={schema:P0,mutation:async function(t){if(Fe.token!=null&&Fe.token!=Vo)throw new Hr("Current token does not match anon token - already logged in.",{nonFormErrors:["Already logged in."]});const e=await QA(t);return await Fe.endSession(),await Fe.startSession(e),Ho.updateAuth(),e}},GA={mutation:async function(){const t=await ZA();return Ho.updateAuth(),t}},qA=async()=>{if(!Ho.isAuthenticated)return null;const t=await Fe.fetchOne(Fe.query("accounts").Id("$session.accountId").Include("profile"));return!t||!t.profile?null:{account:t,profile:t.profile}},LP=async()=>{const t=await qA();if(t)return t;throw new Hr("Authentication failed.",{nonFormErrors:["Authentication failed. A login is required."]})},Vo="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ4LXRyaXBsaXQtdG9rZW4tdHlwZSI6ImFub24iLCJ4LXRyaXBsaXQtcHJvamVjdC1pZCI6ImxvY2FsLXByb2plY3QtaWQifQ.9xYxsdR7ecDQ251Iv6oF7GrjBXAe1WcXY849g-soXVU",JA="http://localhost:6543",Fe=new tx({schema:fk,roles:T0,token:Vo,serverUrl:JA,autoConnect:pp,refreshOptions:{refreshHandler:async()=>{const t=await GA.mutation();if(t)return t;throw new Error("Failed to refresh access token.")}},onSessionError:t=>{if(Fe.endSession(),Fe.clear(),t==="TOKEN_EXPIRED"||t==="UNAUTHORIZED"||t==="ROLES_MISMATCH"){const e=new Hr(`Triplit session error of type ${t}.`,{nonFormErrors:["Authentication error. Log in again."]});throw tu(e.details),e}else if(t==="SCHEMA_MISMATCH"){const e=new Hr(`Triplit session error of type ${t}.`,{nonFormErrors:["Failed to synchronize data structures with the server. Please refresh the application."]});throw tu(e.details),e}}});let Ba=dp(!1);function YA(){!Fe.token||Fe.token===Vo?Qo(Ba,!1):Qo(Ba,!0)}const Ho={get isAuthenticated(){return up(Ba)},updateAuth:YA};export{Hr as A,dP as G,pP as P,cP as U,hP as W,k as Z,lP as a,FP as b,aP as c,PP as d,oP as e,NP as f,DP as g,tu as h,_P as i,qA as j,MP as k,A0 as l,Ho as m,LP as n,uP as o,et as p,mk as q,Fe as t,jP as u,fP as w};
